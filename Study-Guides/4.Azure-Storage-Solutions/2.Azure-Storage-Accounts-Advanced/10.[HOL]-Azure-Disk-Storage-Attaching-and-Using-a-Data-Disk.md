# Lab: Azure Disk Storage - Attaching and Using a Data Disk ðŸ’¾ðŸ’¿

## Lab Scenario ðŸš€

You are managing an Azure Virtual Machine and need to add more persistent storage for application data or a database. 

Instead of storing data on the OS disk, it's best practice to attach separate data disks. 

This lab will guide you through creating a new Managed Disk, attaching it to an existing (or newly created) Azure VM, and preparing it for use.

In this lab, you will:

1.  Reuse (or create) an Azure Resource Group.
2.  Provision a new Azure Virtual Machine (Windows Server) to serve as the host.
3.  Create a new Azure Managed Disk.
4.  Attach the Managed Disk as a data disk to the Azure VM.
5.  Connect to the VM via RDP.
6.  Initialize, partition, and format the new data disk from within the VM.
7.  Test file access on the new disk.
8.  Clean up all created resources.

**Resources you'll be creating in Azure:**

  * **Existing/New Resource Group**: `rg-storage-lab` (or similar from previous labs)
  * **New Virtual Network**: `vnet-disk-lab`
  * **New Subnet**: `default`
  * **New Public IP Address**: For the VM
  * **New Network Security Group**: For the VM
  * **New Azure Virtual Machine**: `vm-disk-test` (Windows Server)
  * **New Azure Managed Disk**: `datadisk-01`

-----

## Part 1: Prerequisites

1.  **Azure Account**: An active Azure subscription.
2.  **Azure CLI or Azure PowerShell**: Installed and logged in. We'll provide commands for both.

-----

## Part 2: Create the Resource Group and Azure Virtual Machine

We'll start by ensuring we have a resource group and then create a fresh Windows Server VM. If you still have `rg-storage-lab` and `vm-fileshare-test` from Lab 1 and it's running, you could reuse that VM for attaching the disk, but creating a new one ensures a clean start for this specific lab.

**(Choose one method for Resource Group and VM Creation: Azure Portal, Azure CLI, or Azure PowerShell)**

**2.1. Azure Portal Method**

1.  Sign in to the [Azure Portal](https://portal.azure.com/).
2.  **Create Resource Group**:
      * In the left navigation pane, select **Resource groups**.
      * Click **+ Create**.
      * **Subscription**: Select your Azure subscription.
      * **Resource group name**: Enter `rg-storage-lab`.
      * **Region**: Select a region close to you (e.g., `East US`).
      * Click **Review + create**, then **Create**.
3.  **Create Virtual Machine**:
      * Search for `Virtual machines` and select it.
      * Click **+ Create** -\> **Azure virtual machine**.
      * **Basics Tab**:
          * **Subscription**: Your subscription.
          * **Resource group**: Select `rg-storage-lab`.
          * **Virtual machine name**: `vm-disk-test`
          * **Region**: Same as your resource group (e.g., `East US`).
          * **Image**: Select `Windows Server 2019 Datacenter - Gen2` (or a similar recent Windows Server image).
          * **Size**: Choose a small size like `Standard_B2s` (cost-effective).
          * **Username**: `azureuser` (or your preferred admin username).
          * **Password**: Choose a strong password and remember it.
          * **Public inbound ports**: Select `Allow selected ports`.
          * **Select inbound ports**: Check `RDP (3389)`.
      * **Networking Tab**:
          * **Virtual network**: Click `Create new` and accept the default name (e.g., `vnet-disk-test-vnet`).
          * **Subnet**: Accept the default.
          * Leave other defaults.
      * Click **Review + create**.
      * After validation passes, click **Create**.
      * Wait for the deployment (this may take several minutes). Once complete, go to the VM resource.

**2.2. Azure CLI Method**

1.  Open your terminal or Cloud Shell.
2.  Set variables:
    ```bash
    RESOURCE_GROUP="rg-storage-lab"
    LOCATION="eastus" # Choose your preferred region
    VM_NAME="vm-disk-test"
    VM_USER="azureuser" # Your admin username
    VM_PASSWORD="YourStrongPassword123!" # Replace with a strong, secure password!
    ```
3.  Create the resource group:
    ```bash
    az group create --name $RESOURCE_GROUP --location $LOCATION
    ```
4.  Create the VM (this will also create VNet, Public IP, NSG):
    ```bash
    az vm create \
      --resource-group $RESOURCE_GROUP \
      --name $VM_NAME \
      --image Win2019Datacenter \
      --admin-username $VM_USER \
      --admin-password "$VM_PASSWORD" \
      --location $LOCATION \
      --size Standard_B2s \
      --public-ip-sku Standard \
      --nsg-rule RDP \
      --output none
    echo "VM '$VM_NAME' created. Getting public IP..."
    az vm show -d --name $VM_NAME --resource-group $RESOURCE_GROUP --query publicIps --output tsv
    ```
5.  Note the `publicIps` output. This is the IP address you'll use to connect via RDP.

**2.3. Azure PowerShell Method**

1.  Open PowerShell.
2.  Set variables:
    ```powershell
    $resourceGroupName = "rg-storage-lab"
    $location = "EastUS" # Choose your preferred region
    $vmName = "vm-disk-test"
    $vmUser = "azureuser"
    $vmPassword = "YourStrongPassword123!" # Replace with a strong, secure password!

    # Create a credential object
    $cred = Get-Credential -UserName $vmUser -Message "Enter VM password"
    ```
3.  Create the resource group:
    ```powershell
    New-AzResourceGroup -Name $resourceGroupName -Location $location
    ```
4.  Create the VM (this will also create VNet, Public IP, NSG):
    ```powersershell
    New-AzVM -ResourceGroupName $resourceGroupName `
      -Name $vmName `
      -Location $location `
      -Image "MicrosoftWindowsServer:WindowsServer:2019-Datacenter:latest" `
      -Size "Standard_B2s" `
      -Credential $cred `
      -PublicIpAddressName "$vmName-ip" `
      -OpenPorts 3389
    Write-Host "VM '$vmName' created."
    (Get-AzPublicIpAddress -ResourceGroupName $resourceGroupName -Name "$vmName-ip").IpAddress
    ```
5.  Note the public IP address outputted.

-----

## Part 3: Create and Attach a Managed Disk

Now, we'll create a new Managed Disk and attach it to our VM. We'll use a **Standard SSD** for cost-effectiveness in this lab.

**(Choose one method: Azure Portal, Azure CLI, or Azure PowerShell)**

**3.1. Azure Portal Method**

1.  In the Azure Portal, navigate to your VM (`vm-disk-test`).
2.  In the left menu, under **Settings**, select **Disks**.
3.  Click **+ Create and attach a new disk**.
4.  **Disk name**: `datadisk-01`
5.  **Source type**: `None` (empty disk)
6.  **Size (GiB)**: Choose `64 GiB` (or 128 GiB if preferred).
7.  **Performance tier**: Select `Standard SSD`.
8.  Leave other defaults.
9.  Click **Save**.
10. The disk will be created and attached. This may take a few moments. You'll see it listed under "Data disks" on the VM's Disks blade.

**3.2. Azure CLI Method**

1.  Open your terminal or Cloud Shell.
2.  Set variables:
    ```bash
    RESOURCE_GROUP="rg-storage-lab"
    VM_NAME="vm-disk-test"
    DISK_NAME="datadisk-01"
    DISK_SIZE_GB=64 # Or 128
    DISK_SKU="Standard_LRS" # Standard SSD LRS
    ```
3.  Create and attach the disk:
    ```bash
    az vm disk attach \
      --resource-group $RESOURCE_GROUP \
      --vm-name $VM_NAME \
      --name $DISK_NAME \
      --sku $DISK_SKU \
      --size-gb $DISK_SIZE_GB \
      --new \
      --output none
    echo "Managed disk '$DISK_NAME' created and attached to '$VM_NAME'."
    ```

**3.3. Azure PowerShell Method**

1.  Open PowerShell.
2.  Set variables:
    ```powershell
    $resourceGroupName = "rg-storage-lab"
    $vmName = "vm-disk-test"
    $diskName = "datadisk-01"
    $diskSizeGB = 64 # Or 128
    $diskSku = "StandardSSD_LRS" # Standard SSD LRS

    $vm = Get-AzVM -ResourceGroupName $resourceGroupName -Name $vmName
    ```
3.  Add data disk to VM configuration:
    ```powershell
    Add-AzVMDataDisk -VM $vm -Name $diskName -CreateOption Empty -DiskSizeInGB $diskSizeGB -Caching None -Lun 0 -StorageAccountType $diskSku
    ```
4.  Update the VM to apply the changes:
    ```powershell
    Update-AzVM -ResourceGroupName $resourceGroupName -VM $vm
    Write-Host "Managed disk '$diskName' created and attached to '$vmName'."
    ```

-----

## Part 4: Initialize and Format the Disk on the VM

The disk is attached, but the operating system inside the VM needs to recognize, initialize, partition, and format it before it can be used.

**4.1. Connect to the Azure VM via RDP**

1.  In the Azure Portal, navigate to your VM (`vm-disk-test`).
2.  Click **Connect** -\> **RDP**.
3.  Click **Download RDP File**.
4.  Open the downloaded `.rdp` file.
5.  When prompted, enter the username (`azureuser`) and password you set for the VM.
6.  You might get a certificate warning; click **Yes** to connect.
7.  Once connected, you'll be on the Windows Server desktop.

**4.2. Initialize, Partition, and Format the Disk (from within VM)**

1.  On the Azure VM's desktop, click the **Start button** (Windows logo).
2.  Type `diskmgmt.msc` and press Enter to open **Disk Management**.
3.  When Disk Management opens, it should automatically prompt you to **Initialize Disk**.
      * Ensure the new disk (likely Disk 1 or Disk 2, depending on how many disks your VM has by default) is selected.
      * For **Partition style**, choose **GPT (GUID Partition Table)** (recommended for disks larger than 2TB, but good practice even for smaller disks). Click **OK**.
4.  Now, the disk will appear as `Online` but `Unallocated`.
5.  Right-click on the **Unallocated space** of the new disk.
6.  Select **New Simple Volume...**.
7.  The **New Simple Volume Wizard** will open.
      * Click **Next**.
      * **Specify Volume Size**: Accept the maximum size (default, which is the whole disk). Click **Next**.
      * **Assign Drive Letter**: Choose a drive letter (e.g., `D:`). Click **Next**.
      * **Format Partition**:
          * **File system**: `NTFS` (default).
          * **Allocation unit size**: `Default`.
          * **Volume label**: `DataDisk` (or any name you prefer).
          * Check `Perform a quick format`.
          * Check `Enable file and folder compression` (optional, leave unchecked for performance).
      * Click **Next**.
      * Click **Finish**.
8.  The disk will now be formatted and appear as a new drive (e.g., `DataDisk (D:)`) in Disk Management and File Explorer.

-----

## Part 5: Test Disk Access

1.  On the Azure VM, open **File Explorer**.
2.  Navigate to your newly created drive (e.g., `D:`).
3.  Right-click in the drive, select **New** -\> **Text Document**.
4.  Name the file `disk-test-file.txt`.
5.  Open `disk-test-file.txt`, type "Hello from the new data disk\!" and save it.
6.  This confirms that the disk is fully operational and ready for use by your applications.

-----

## Part 6: Cleaning Up Resources (Critical\!)

To avoid incurring ongoing costs, it's crucial to delete all resources created for this lab. The easiest way is to delete the resource group.

**(Choose one method: Azure Portal, Azure CLI, or Azure PowerShell)**

**6.1. Azure Portal Method**

1.  In the Azure Portal, search for `Resource groups` and select it.
2.  Find and click on your resource group: `rg-storage-lab`.
3.  On the resource group's Overview blade, click **Delete resource group**.
4.  Type the resource group name (`rg-storage-lab`) to confirm, then click \*\*Delete\`.
5.  This will delete your VM, the attached data disk, the VNet, Public IP, NSG, and any other resources within that group.

**6.2. Azure CLI Method**

1.  Open your terminal or Cloud Shell.
2.  ```bash
    RESOURCE_GROUP="rg-storage-lab"
    az group delete --name $RESOURCE_GROUP --no-wait --yes
    echo "Resource group '$RESOURCE_GROUP' deletion initiated."
    ```

**6.3. Azure PowerShell Method**

1.  Open PowerShell.
2.  ```powershell
    $resourceGroupName = "rg-storage-lab"
    Remove-AzResourceGroup -Name $resourceGroupName -Force -AsJob
    Write-Host "Resource group '$resourceGroupName' deletion initiated."
    ```

-----

Congratulations\! You have successfully created, attached, and configured an Azure Managed Disk as a data disk for your Azure Virtual Machine. 

This hands-on experience is fundamental for managing persistent storage for VM-based workloads in Azure.