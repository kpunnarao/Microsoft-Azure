# Lab: Azure File Shares - Mounting a Network Drive 💾💻

## Lab Scenario 🌐

You need to demonstrate how to use Azure File Shares to provide a centralized network file share that can be accessed by an Azure Virtual Machine. 

This mimics a common "lift and shift" scenario where applications expect access to a traditional file share.

In this lab, you will:

1.  Reuse (or create) an Azure Storage Account.
2.  Create an Azure File Share within that storage account.
3.  Provision a new Azure Virtual Machine (Windows Server, for easy SMB mounting demonstration).
4.  Mount the Azure File Share as a network drive on the Azure VM.
5.  Test file access by creating a file on the mounted drive.
6.  Verify the file in the Azure Portal.
7.  Clean up all created resources.

**Resources you'll be creating in Azure:**

  * **Existing/New Resource Group**: `rg-storage-lab` (or similar from Previous Lab)
  * **Existing/New Storage Account**: `storagenameyouruniqueid` (from Previous Lab or a new one)
  * **New Virtual Network**: `vnet-storage-lab`
  * **New Subnet**: `default`
  * **New Public IP Address**: For the VM
  * **New Network Security Group**: For the VM
  * **New Azure Virtual Machine**: `vm-fileshare-test` (Windows Server)
  * **New Azure File Share**: `appfiles`

-----

## Part 1: Prerequisites

1.  **Azure Account**: An active Azure subscription.

2.  **Azure CLI or Azure PowerShell**: Installed and logged in. We'll provide commands for both.

3.  **An Existing Azure Storage Account**:

      * If you completed Previous Lab, you can reuse `storagenameyouruniqueid` in `rg-storage-lab`.
      * **If you don't have one, or deleted it**: Please run the steps in **[HOL]-Creating-an-Azure-Storage-Account** to create a new `Standard_LRS` General-Purpose v2 storage account (e.g., `storagenameyouruniqueid` within `rg-storage-lab`) before proceeding. Make sure to use a globally unique name.

    *Example command to re-create if needed (replace placeholders):*

    ```bash
    # Azure CLI
    az group create --name rg-storage-lab --location eastus
    az storage account create \
      --name storagenameyouruniqueid \
      --resource-group rg-storage-lab \
      --location eastus \
      --sku Standard_LRS \
      --kind StorageV2 \
      --access-tier Hot
    ```

    ```powershell
    # Azure PowerShell
    New-AzResourceGroup -Name "rg-storage-lab" -Location "EastUS"
    New-AzStorageAccount -ResourceGroupName "rg-storage-lab" `
      -Name "storagenameyouruniqueid" `
      -Location "EastUS" `
      -SkuName "Standard_LRS" `
      -Kind "StorageV2" `
      -AccessTier "Hot"
    ```

-----

## Part 2: Create an Azure File Share

We'll create a file share named `appfiles`.

**(Choose one method: Azure Portal, Azure CLI, or Azure PowerShell)**

**2.1. Azure Portal Method**

1.  Sign in to the [Azure Portal](https://portal.azure.com/).
2.  Navigate to your Storage Account (e.g., `storagenameyouruniqueid` in `rg-storage-lab`).
3.  In the left menu of the storage account, under **Data storage**, select **File shares**.
4.  Click **+ File share**.
5.  **Name**: Enter `appfiles`.
6.  **Tier**: Select `Transaction optimized` (good balance for general purpose and cost).
7.  **Quota**: Enter `100` GB (you can adjust this; max 5 TB for Standard, 100 TB for Premium).
8.  Click **Create**.
9.  You should see `appfiles` listed in your file shares.

**2.2. Azure CLI Method**

1.  Open your terminal or Cloud Shell.
2.  Set variables (replace `storagenameyouruniqueid`):
    ```bash
    RESOURCE_GROUP="rg-storage-lab"
    STORAGE_ACCOUNT_NAME="storagenameyouruniqueid" # Your unique name from Part 1
    FILE_SHARE_NAME="appfiles"
    ```
3.  Create the file share:
    ```bash
    az storage share create \
      --name $FILE_SHARE_NAME \
      --account-name $STORAGE_ACCOUNT_NAME \
      --resource-group $RESOURCE_GROUP \
      --quota 100 \
      --output none # Prevents large JSON output
    echo "File share '$FILE_SHARE_NAME' created."
    ```

**2.3. Azure PowerShell Method**

1.  Open PowerShell.
2.  Set variables (replace `storagenameyouruniqueid` and `rg-storage-lab`):
    ```powershell
    $resourceGroupName = "rg-storage-lab"
    $storageAccountName = "storagenameyouruniqueid" # Your unique name from Part 1
    $fileShareName = "appfiles"

    $ctx = (Get-AzStorageAccount -ResourceGroupName $resourceGroupName -Name $storageAccountName).Context
    ```
3.  Create the file share:
    ```powershell
    New-AzStorageShare -Name $fileShareName -Context $ctx -Quota 100
    Write-Host "File share '$fileShareName' created."
    ```

-----

## Part 3: Create an Azure Virtual Machine (Windows Server)

We need a VM to mount the file share. We'll create a basic Windows Server VM.

**(Choose one method: Azure Portal, Azure CLI, or Azure PowerShell)**

**3.1. Azure Portal Method**

1.  In the Azure Portal, search for `Virtual machines` and select it.
2.  Click **+ Create** -\> **Azure virtual machine**.
3.  **Basics Tab**:
      * **Subscription**: Your subscription.
      * **Resource group**: Select `rg-storage-lab`.
      * **Virtual machine name**: `vm-fileshare-test`
      * **Region**: Same as your storage account (e.g., `East US`).
      * **Image**: Select `Windows Server 2019 Datacenter - Gen2` (or a similar recent Windows Server image).
      * **Size**: Choose a small size like `Standard_B2s` (cost-effective).
      * **Username**: `azureuser` (or your preferred admin username).
      * **Password**: Choose a strong password and remember it.
      * **Public inbound ports**: Select `Allow selected ports`.
      * **Select inbound ports**: Check `RDP (3389)`.
4.  **Networking Tab**:
      * **Virtual network**: Click `Create new` and accept the default name (e.g., `vnet-fileshare-test-vnet`).
      * **Subnet**: Accept the default.
      * Leave other defaults.
5.  Click **Review + create**.
6.  After validation passes, click **Create**.
7.  Wait for the deployment (this may take several minutes). Once complete, go to the VM resource.

**3.2. Azure CLI Method**

1.  Open your terminal or Cloud Shell.
2.  Set variables (replace `rg-storage-lab` and `eastus` if different):
    ```bash
    RESOURCE_GROUP="rg-storage-lab"
    LOCATION="eastus"
    VM_NAME="vm-fileshare-test"
    VM_USER="azureuser" # Your admin username
    VM_PASSWORD="YourStrongPassword123!" # Replace with a strong password!
    ```
3.  Create the VM (this will also create VNet, Public IP, NSG):
    ```bash
    az vm create \
      --resource-group $RESOURCE_GROUP \
      --name $VM_NAME \
      --image Win2019Datacenter \
      --admin-username $VM_USER \
      --admin-password "$VM_PASSWORD" \
      --location $LOCATION \
      --size Standard_B2s \
      --public-ip-sku Standard \
      --nsg-rule RDP \
      --output none
    echo "VM '$VM_NAME' created. Getting public IP..."
    az vm show -d --name $VM_NAME --resource-group $RESOURCE_GROUP --query publicIps --output tsv
    ```
4.  Note the `publicIps` output. This is the IP address you'll use to connect via RDP.

**3.3. Azure PowerShell Method**

1.  Open PowerShell.
2.  Set variables (replace `rg-storage-lab`, `eastus`, and `YourStrongPassword123!`):
    ```powershell
    $resourceGroupName = "rg-storage-lab"
    $location = "EastUS"
    $vmName = "vm-fileshare-test"
    $vmUser = "azureuser"
    $vmPassword = "YourStrongPassword123!" # Replace with a strong password!

    # Create a credential object
    $cred = Get-Credential -UserName $vmUser -Message "Enter VM password"
    ```
3.  Create the VM (this will also create VNet, Public IP, NSG):
    ```powershell
    New-AzVM -ResourceGroupName $resourceGroupName `
      -Name $vmName `
      -Location $location `
      -Image "MicrosoftWindowsServer:WindowsServer:2019-Datacenter:latest" `
      -Size "Standard_B2s" `
      -Credential $cred `
      -PublicIpAddressName "$vmName-ip" `
      -OpenPorts 3389
    Write-Host "VM '$vmName' created."
    (Get-AzPublicIpAddress -ResourceGroupName $resourceGroupName -Name "$vmName-ip").IpAddress
    ```
4.  Note the public IP address outputted.

-----

## Part 4: Mount the Azure File Share on the VM

Now, the core of the lab: connecting the VM to the file share.

**Important Note on Port 445**: SMB uses TCP port 445. Some ISPs block this port. If you have trouble mounting, ensure your local network/firewall (if connecting from your local machine to the VM) or the VM's network (if connecting from within the VM to Azure Files) allows outbound traffic on port 445. Azure itself allows it.

**4.1. Get Mount Command for the File Share**

1.  In the Azure Portal, navigate to your Storage Account -\> **File shares** -\> `appfiles`.
2.  Click **Connect**.
3.  Ensure `Windows` is selected and choose a drive letter (e.g., `Z:`).
4.  **Copy the script provided.** It will look something like this (do NOT run this locally on your machine, save it for the VM\!):
    ```powershell
    net use Z: \\storagenameyouruniqueid.file.core.windows.net\appfiles /user:AZURE\storagenameyouruniqueid <YourStorageAccountKey>
    ```
    *Keep this command handy.* It contains your storage account name and key.

**4.2. Connect to the Azure VM via RDP**

1.  In the Azure Portal, navigate to your VM (`vm-fileshare-test`).
2.  Click **Connect** -\> **RDP**.
3.  Click **Download RDP File**.
4.  Open the downloaded `.rdp` file.
5.  When prompted, enter the username (`azureuser`) and password you set for the VM.
6.  You might get a certificate warning; click **Yes** to connect.
7.  Once connected, you'll be on the Windows Server desktop.

**4.3. Run the Mount Command on the VM**

1.  On the Azure VM's desktop, open **PowerShell (as Administrator)** or **Command Prompt (as Administrator)**.

2.  **Paste the mount command** you copied from the Azure Portal (from step 4.1).

      * It will be similar to:
        ```powershell
        net use Z: \\storagenameyouruniqueid.file.core.windows.net\appfiles /user:AZURE\storagenameyouruniqueid <YourStorageAccountKey>
        ```
      * **Replace `<YourStorageAccountKey>`** with one of your storage account access keys. You can find this key in the Azure Portal under your Storage Account -\> **Access keys** (show keys and copy `key1` or `key2`).

3.  Press Enter. If successful, you should see "The command completed successfully."

4.  **Verify Mounted Drive**:

      * Open **File Explorer** on the VM.
      * You should now see a new network drive, typically `Z:`, mapped to `\\storagenameyouruniqueid.file.core.windows.net\appfiles`.

-----

## Part 5: Test File Access

1.  On the Azure VM, open the newly mounted `Z:` drive in File Explorer.
2.  Right-click in the drive, select **New** -\> **Text Document**.
3.  Name the file `vm-test-file.txt`.
4.  Open `vm-test-file.txt`, type "Hello from Azure VM\!" and save it.

**5.1. Verify File in Azure Portal**

1.  Back on your local machine, open the [Azure Portal](https://portal.azure.com/).
2.  Navigate to your Storage Account -\> **File shares** -\> `appfiles`.
3.  You should now see `vm-test-file.txt` listed within your file share. Click on it to view its properties or download it.

This confirms that the Azure File Share is correctly mounted and accessible from the VM\!

-----

## Part 6: Cleaning Up Resources (Critical\!)

To avoid incurring ongoing costs, it's crucial to delete all resources created for this lab. The easiest way is to delete the resource group.

**(Choose one method: Azure Portal, Azure CLI, or Azure PowerShell)**

**6.1. Azure Portal Method**

1.  In the Azure Portal, search for `Resource groups` and select it.
2.  Find and click on your resource group: `rg-storage-lab`.
3.  On the resource group's Overview blade, click **Delete resource group**.
4.  Type the resource group name (`rg-storage-lab`) to confirm, then click **Delete**.
5.  This will delete the VM, VNet, Public IP, NSG, Storage Account, and the File Share within it.

**6.2. Azure CLI Method**

1.  Open your terminal or Cloud Shell.
2.  ```bash
    RESOURCE_GROUP="rg-storage-lab"
    az group delete --name $RESOURCE_GROUP --no-wait --yes
    echo "Resource group '$RESOURCE_GROUP' deletion initiated."
    ```

**6.3. Azure PowerShell Method**

1.  Open PowerShell.
2.  ```powershell
    $resourceGroupName = "rg-storage-lab"
    Remove-AzResourceGroup -Name $resourceGroupName -Force -AsJob
    Write-Host "Resource group '$resourceGroupName' deletion initiated."
    ```

-----

Congratulations\! You have successfully created an Azure File Share, provisioned an Azure VM, mounted the file share as a network drive, and demonstrated file access. 

This lab provides hands-on experience with a key feature of Azure Storage.