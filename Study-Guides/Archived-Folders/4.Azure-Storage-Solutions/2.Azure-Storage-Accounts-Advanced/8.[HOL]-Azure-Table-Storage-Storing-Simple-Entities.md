# Lab: Azure Table Storage - Storing Simple Entities üìä

## Lab Scenario üóÑÔ∏è

You need to store user profile data for a new application. This data is semi-structured, meaning that not all user profiles will have the exact same set of attributes. 

You also anticipate a very large number of users and need a highly scalable, cost-effective solution that allows for quick lookups based on user ID and geographical region. Azure Table Storage is a strong candidate for this.

In this lab, you will:

1.  Reuse (or create) an Azure Storage Account.
2.  Create an Azure Table within that storage account.
3.  Insert several "entities" (rows) into the table, demonstrating its schemaless nature by adding different properties to different entities.
4.  Query the table to retrieve specific entities using `PartitionKey` and `RowKey`.
5.  Perform a simple filtered query.
6.  Clean up all created resources.

**Resources you'll be creating in Azure:**

  * **Existing/New Resource Group**: `rg-storage-lab` (or similar from previous labs)
  * **Existing/New Storage Account**: `storagenameyouruniqueid` (from previous labs or a new one)
  * **New Azure Table**: `UserProfiles`

-----

## Part 1: Prerequisites

1.  **Azure Account**: An active Azure subscription.

2.  **Azure CLI or Azure PowerShell**: Installed and logged in.

3.  **An Existing Azure Storage Account**:

      * You can reuse the storage account from previous labs (`storagenameyouruniqueid` in `rg-storage-lab`).
      * **If you deleted it or don't have one**: Please re-create it by following **4.[HOL]-Creating-an-Azure-Storage-Account** steps. Make sure to use a globally unique name.

    *Example command to re-create if needed (replace placeholders):*

    ```bash
    # Azure CLI
    az group create --name rg-storage-lab --location eastus
    az storage account create \
      --name storagenameyouruniqueid \
      --resource-group rg-storage-lab \
      --location eastus \
      --sku Standard_LRS \
      --kind StorageV2 \
      --access-tier Hot
    ```

    ```powershell
    # Azure PowerShell
    New-AzResourceGroup -Name "rg-storage-lab" -Location "EastUS"
    New-AzStorageAccount -ResourceGroupName "rg-storage-lab" `
      -Name "storagenameyouruniqueid" `
      -Location "EastUS" `
      -SkuName "Standard_LRS" `
      -Kind "StorageV2" `
      -AccessTier "Hot"
    ```

-----

## Part 2: Create an Azure Table

We'll create a table named `UserProfiles`.

**(Choose one method: Azure Portal, Azure CLI, or Azure PowerShell)**

**2.1. Azure Portal Method**

1.  Sign in to the [Azure Portal](https://portal.azure.com/).
2.  Navigate to your Storage Account (e.g., `storagenameyouruniqueid` in `rg-storage-lab`).
3.  In the left menu of the storage account, under **Data storage**, select **Tables**.
4.  Click **+ Table**.
5.  **Name**: Enter `UserProfiles`.
6.  Click **OK**.
7.  You should see `UserProfiles` listed in your tables.

**2.2. Azure CLI Method**

1.  Open your terminal or Cloud Shell.
2.  Set variables (replace `storagenameyouruniqueid`):
    ```bash
    RESOURCE_GROUP="rg-storage-lab"
    STORAGE_ACCOUNT_NAME="storagenameyouruniqueid" # Your unique name from Part 1
    TABLE_NAME="UserProfiles"
    ```
3.  Create the table:
    ```bash
    az storage table create \
      --name $TABLE_NAME \
      --account-name $STORAGE_ACCOUNT_NAME \
      --resource-group $RESOURCE_GROUP \
      --output none
    echo "Table '$TABLE_NAME' created."
    ```

**2.3. Azure PowerShell Method**

1.  Open PowerShell.
2.  Set variables (replace `storagenameyouruniqueid` and `rg-storage-lab`):
    ```powershell
    $resourceGroupName = "rg-storage-lab"
    $storageAccountName = "storagenameyouruniqueid" # Your unique name from Part 1
    $tableName = "UserProfiles"

    $ctx = (Get-AzStorageAccount -ResourceGroupName $resourceGroupName -Name $storageAccountName).Context
    ```
3.  Create the table:
    ```powershell
    New-AzStorageTable -Name $tableName -Context $ctx
    Write-Host "Table '$tableName' created."
    ```

-----

## Part 3: Insert Entities into the Table

We'll insert several entities. Note how each entity can have different properties (columns) ‚Äì this is the "schemaless" nature of Table Storage.

**Important**: For `PartitionKey` and `RowKey`, choose values that make sense for your data access patterns.

  * `PartitionKey`: Used for logical grouping and distribution across storage servers. Queries based on `PartitionKey` are efficient.
  * `RowKey`: Uniquely identifies an entity within a partition. `PartitionKey` + `RowKey` form the primary key for the entity, allowing for extremely fast "point queries."

**3.1. Get Storage Account Connection String**

You'll need the connection string for your storage account to interact with the table. (You might already have this from Lab 2).

**(Choose one method: Azure Portal, Azure CLI, or Azure PowerShell)**

**Portal:**

1.  Navigate to your Storage Account.
2.  In the left menu, under **Security + networking**, select **Access keys**.
3.  Click **Show keys**.
4.  Copy the **Connection string** for `key1`.

**Azure CLI:**

```bash
RESOURCE_GROUP="rg-storage-lab"
STORAGE_ACCOUNT_NAME="storagenameyouruniqueid"
CONNECTION_STRING=$(az storage account show-connection-string \
  --name $STORAGE_ACCOUNT_NAME \
  --resource-group $RESOURCE_GROUP \
  --query 'connectionString' \
  --output tsv)
echo "Connection String: $CONNECTION_STRING"
```

**Azure PowerShell:**

```powershell
$resourceGroupName = "rg-storage-lab"
$storageAccountName = "storagenameyouruniqueid"
$connectionString = (Get-AzStorageAccount -ResourceGroupName $resourceGroupName -Name $storageAccountName).Context.ConnectionString
Write-Host "Connection String: $connectionString"
```

**Copy this connection string; you will need it shortly.**

**3.2. Set Environment Variable**

1.  Open your terminal or Cloud Shell.
2.  Set the `AZURE_STORAGE_CONNECTION_STRING` environment variable:
      * **Bash/Zsh (Linux/macOS/Cloud Shell):**
        ```bash
        export AZURE_STORAGE_CONNECTION_STRING="<YourStorageAccountConnectionString>"
        ```
      * **PowerShell:**
        ```powershell
        $env:AZURE_STORAGE_CONNECTION_STRING="<YourStorageAccountConnectionString>"
        ```
      * **Windows Command Prompt:**
        ```cmd
        set AZURE_STORAGE_CONNECTION_STRING="<YourStorageAccountConnectionString>"
        ```
      * **Important**: Replace `<YourStorageAccountConnectionString>` with the actual connection string.

**3.3. Insert Entities using Azure CLI**

Use `az storage entity insert`. The `--entity` parameter takes key-value pairs separated by spaces.

  * We'll use `Country` as `PartitionKey` and `UserID` as `RowKey`.

<!-- end list -->

1.  **Insert User 1 (Full Profile)**:

    ```bash
    az storage entity insert \
      --table-name UserProfiles \
      --partition-key "USA" \
      --row-key "user001" \
      --entity Name="Alice Johnson" Email="alice@example.com" Age=30 City="New York" IsPremiumUser=true \
      --output table
    ```

2.  **Insert User 2 (Partial Profile)**:

    ```bash
    az storage entity insert \
      --table-name UserProfiles \
      --partition-key "USA" \
      --row-key "user002" \
      --entity Name="Bob Smith" City="Los Angeles" LastLogin="2025-07-23T10:00:00Z" \
      --output table
    ```

3.  **Insert User 3 (Different Country, Different Fields)**:

    ```bash
    az storage entity insert \
      --table-name UserProfiles \
      --partition-key "Canada" \
      --row-key "user003" \
      --entity Name="Charlie Brown" Province="Ontario" SubscriptionTier="Gold" \
      --output table
    ```

4.  **Insert User 4 (Another USA user, different fields)**:

    ```bash
    az storage entity insert \
      --table-name UserProfiles \
      --partition-key "USA" \
      --row-key "user004" \
      --entity Name="Diana Prince" Status="Active" Department="Marketing" \
      --output table
    ```

    *You'll notice that the output for each `insert` operation shows the `PartitionKey`, `RowKey`, and `Timestamp` (automatically added) along with your custom properties.*

**3.4. Verify Entities in Portal (Optional)**

1.  In the Azure Portal, navigate to your Storage Account -\> **Tables** -\> `UserProfiles`.
2.  Click **Query**.
3.  You'll see a default query. Click **Run Query** to see all entities you just inserted.
4.  Notice how some entities have properties like `Age` and `Email`, while others have `Province` or `SubscriptionTier`. This showcases the schemaless nature.

-----

## Part 4: Query Entities

Now, let's retrieve data from the table using various query methods.

**4.1. Retrieve a Specific Entity (Point Query - Most Efficient)**

Retrieve `user001` from `USA` partition:

```bash
az storage entity show \
  --table-name UserProfiles \
  --partition-key "USA" \
  --row-key "user001" \
  --output yaml # or json, table
```

*Expected Output:* You should see the full details for Alice Johnson.

**4.2. Retrieve All Entities in a Partition (Partition Scan - Efficient)**

Retrieve all users from the `USA` partition:

```bash
az storage entity query \
  --table-name UserProfiles \
  --partition-key "USA" \
  --output table
```

*Expected Output:* You should see `user001`, `user002`, and `user004`.

**4.3. Retrieve Entities with a Filter (Using OData Filter Syntax)**

Retrieve all users from the `USA` partition who are `IsPremiumUser`.

**Note:** For filtering on non-key properties, it's generally less efficient than using `PartitionKey` and `RowKey`, as it might involve scanning the partition.

```bash
az storage entity query \
  --table-name UserProfiles \
  --partition-key "USA" \
  --filter "IsPremiumUser eq true" \
  --output table
```

*Expected Output:* You should only see `user001` (Alice Johnson).

**4.4. Attempt a Cross-Partition Query (Less Efficient)**

Querying without a `PartitionKey` or with a filter across partitions is typically much slower for large tables. This command attempts to get all entities where `City` is "New York" (which will involve a full table scan if the table is large and not specifically filtered by PartitionKey).

```bash
# This query does NOT specify a partition key. For very large tables, this is inefficient.
az storage entity query \
  --table-name UserProfiles \
  --filter "City eq 'New York'" \
  --output table
```

*Expected Output:* You should see `user001` (Alice Johnson).

-----

## Part 5: Cleaning Up Resources (Critical\!)

To avoid incurring ongoing costs, it's crucial to delete all resources created for this lab. The easiest way is to delete the resource group.

**(Choose one method: Azure Portal, Azure CLI, or Azure PowerShell)**

**5.1. Azure Portal Method**

1.  In the Azure Portal, search for `Resource groups` and select it.
2.  Find and click on your resource group: `rg-storage-lab`.
3.  On the resource group's Overview blade, click **Delete resource group**.
4.  Type the resource group name (`rg-storage-lab`) to confirm, then click \*\*Delete\`.
5.  This will delete your Storage Account, Table, and any other resources within that group.

**5.2. Azure CLI Method**

1.  Open your terminal or Cloud Shell.
2.  ```bash
    RESOURCE_GROUP="rg-storage-lab"
    az group delete --name $RESOURCE_GROUP --no-wait --yes
    echo "Resource group '$RESOURCE_GROUP' deletion initiated."
    ```

**5.3. Azure PowerShell Method**

1.  Open PowerShell.
2.  ```powershell
    $resourceGroupName = "rg-storage-lab"
    Remove-AzResourceGroup -Name $resourceGroupName -Force -AsJob
    Write-Host "Resource group '$resourceGroupName' deletion initiated."
    ```

-----

Congratulations\! You have successfully created an Azure Table, inserted diverse entities, and performed various queries. 

This lab provides hands-on experience with the schemaless nature and key-based access patterns of Azure Table Storage, demonstrating its utility for scalable, structured non-relational data.