# Lab 4: Shared Access Signatures (SAS) - Securely Sharing a Blob 🔐🔗

## Lab Scenario 🛡️

You need to provide temporary, limited access to a specific file (a "blob") in your Azure Storage account without sharing your full storage account keys. 

For example, you might want to give a partner read-only access to a report for a few hours, or allow a mobile app to upload images directly to a specific container. Shared Access Signatures (SAS) are the perfect solution for this.

In this lab, you will:

1.  Reuse (or create) an Azure Storage Account.
2.  Create a new Blob Container.
3.  Upload a sample "secret" text file (blob) to the container.
4.  Generate a **User Delegation SAS** for this specific blob, granting read-only access for a limited time.
5.  Attempt to access the blob using the generated SAS URL.
6.  (Optional) Wait for the SAS to expire and observe access failure.
7.  Clean up all created resources.

**Resources you'll be creating in Azure:**

  * **Existing/New Resource Group**: `rg-storage-lab` (or similar from previous labs)
  * **Existing/New Storage Account**: `storagenameyouruniqueid` (from previous labs or a new one)
  * **New Blob Container**: `secret-data`
  * **New Blob**: `secret_report.txt`

-----

## Part 1: Prerequisites

1.  **Azure Account**: An active Azure subscription.

2.  **Azure CLI or Azure PowerShell**: Installed and logged in.

3.  **An Existing Azure Storage Account**:

      * You can reuse the storage account from previous labs (`storagenameyouruniqueid` in `rg-storage-lab`).
      * **If you deleted it or don't have one**: Please re-create it by following **4.[HOL]-Creating-an-Azure-Storage-Account** steps. Make sure to use a globally unique name.

    *Example command to re-create if needed (replace placeholders):*

    ```bash
    # Azure CLI
    az group create --name rg-storage-lab --location eastus
    az storage account create \
      --name storagenameyouruniqueid \
      --resource-group rg-storage-lab \
      --location eastus \
      --sku Standard_LRS \
      --kind StorageV2 \
      --access-tier Hot
    ```

    ```powershell
    # Azure PowerShell
    New-AzResourceGroup -Name "rg-storage-lab" -Location "EastUS"
    New-AzStorageAccount -ResourceGroupName "rg-storage-lab" `
      -Name "storagenameyouruniqueid" `
      -Location "EastUS" `
      -SkuName "Standard_LRS" `
      -Kind "StorageV2" `
      -AccessTier "Hot"
    ```

-----

## Part 2: Create a Blob Container and Upload a Blob

We'll create a container and upload a simple text file.

**(Choose one method: Azure Portal, Azure CLI, or Azure PowerShell)**

**2.1. Azure Portal Method**

1.  Sign in to the [Azure Portal](https://portal.azure.com/).
2.  Navigate to your Storage Account (e.g., `storagenameyouruniqueid` in `rg-storage-lab`).
3.  In the left menu of the storage account, under **Data storage**, select **Containers**.
4.  Click **+ Container**.
5.  **Name**: Enter `secret-data`.
6.  **Public access level**: Select `Private (no anonymous access)`. This is important for security, as we'll use SAS for access.
7.  Click **Create**.
8.  Click on the newly created `secret-data` container.
9.  Click **Upload**.
10. Create a simple text file on your local machine named `secret_report.txt` with content like "This is a confidential report for limited access."
11. Click **Browse for files** and select `secret_report.txt`.
12. Click **Upload**.

**2.2. Azure CLI Method**

1.  Open your terminal or Cloud Shell.
2.  Set variables (replace `storagenameyouruniqueid`):
    ```bash
    RESOURCE_GROUP="rg-storage-lab"
    STORAGE_ACCOUNT_NAME="storagenameyouruniqueid" # Your unique name from Part 1
    CONTAINER_NAME="secret-data"
    BLOB_NAME="secret_report.txt"
    LOCAL_FILE="secret_report.txt"
    ```
3.  Create a local file for the blob:
    ```bash
    echo "This is a confidential report for limited access." > $LOCAL_FILE
    echo "Local file '$LOCAL_FILE' created."
    ```
4.  Create the container:
    ```bash
    az storage container create \
      --name $CONTAINER_NAME \
      --account-name $STORAGE_ACCOUNT_NAME \
      --resource-group $RESOURCE_GROUP \
      --public-access off \
      --output none
    echo "Container '$CONTAINER_NAME' created."
    ```
5.  Upload the blob:
    ```bash
    az storage blob upload \
      --container-name $CONTAINER_NAME \
      --file $LOCAL_FILE \
      --name $BLOB_NAME \
      --account-name $STORAGE_ACCOUNT_NAME \
      --resource-group $RESOURCE_GROUP \
      --output none
    echo "Blob '$BLOB_NAME' uploaded."
    ```

**2.3. Azure PowerShell Method**

1.  Open PowerShell.
2.  Set variables (replace `storagenameyouruniqueid` and `rg-storage-lab`):
    ```powershell
    $resourceGroupName = "rg-storage-lab"
    $storageAccountName = "storagenameyouruniqueid" # Your unique name from Part 1
    $containerName = "secret-data"
    $blobName = "secret_report.txt"
    $localFile = "secret_report.txt"

    $ctx = (Get-AzStorageAccount -ResourceGroupName $resourceGroupName -Name $storageAccountName).Context
    ```
3.  Create a local file for the blob:
    ```powershell
    Set-Content -Path $localFile -Value "This is a confidential report for limited access."
    Write-Host "Local file '$localFile' created."
    ```
4.  Create the container:
    ```powershell
    New-AzStorageContainer -Name $containerName -Context $ctx -Permission Off
    Write-Host "Container '$containerName' created."
    ```
5.  Upload the blob:
    ```powershell
    Set-AzStorageBlobContent -Container $containerName -File $localFile -Blob $blobName -Context $ctx -Force
    Write-Host "Blob '$blobName' uploaded."
    ```

-----

## Part 3: Generate a User Delegation SAS for the Blob

We will generate a User Delegation SAS, which is the recommended and more secure way to create SAS tokens, as it uses Azure AD credentials instead of storage account keys.

**Important**: Ensure your Azure CLI/PowerShell user has the `Storage Blob Data Contributor` role (or similar data plane role) on the storage account to generate a User Delegation SAS. If you are using your subscription owner/contributor account, you should have this by default.

**(Choose one method: Azure Portal, Azure CLI, or Azure PowerShell)**

**3.1. Azure Portal Method**

1.  In the Azure Portal, navigate to your Storage Account -\> **Containers** -\> `secret-data`.
2.  Click on `secret_report.txt`.
3.  In the left menu, select **Generate SAS**.
4.  **Signing method**: Select `User delegation key (recommended)`.
5.  **Permissions**: Check `Read`. Uncheck all others.
6.  **Start and expiry date/time**:
      * **Start date/time**: Set to current date/time.
      * **Expiry date/time**: Set to a few minutes from now (e.g., 10 minutes in the future). This is crucial for demonstrating expiration.
7.  **Allowed IP addresses**: Leave blank (or specify your current public IP for stricter security).
8.  **Allowed protocols**: Leave `HTTPS only`.
9.  Click **Generate SAS token and URL**.
10. **Copy the "Blob SAS URL"**. It will look something like `https://storagenameyouruniqueid.blob.core.windows.net/secret-data/secret_report.txt?sv=...&sr=b&sig=...`.
      * **Keep this URL handy\!**

**3.2. Azure CLI Method**

1.  Open your terminal or Cloud Shell.
2.  Set variables (replace `storagenameyouruniqueid` and adjust `expiry_time`):
    ```bash
    STORAGE_ACCOUNT_NAME="storagenameyouruniqueid"
    CONTAINER_NAME="secret-data"
    BLOB_NAME="secret_report.txt"
    # Set expiry time to 10 minutes from now (adjust as needed)
    EXPIRY_TIME=$(date -u -v+10M +"%Y-%m-%dT%H:%MZ")
    echo "SAS will expire at: $EXPIRY_TIME"
    ```
3.  Generate the User Delegation SAS:
    ```bash
    SAS_URL=$(az storage blob generate-sas \
      --account-name $STORAGE_ACCOUNT_NAME \
      --container-name $CONTAINER_NAME \
      --name $BLOB_NAME \
      --permissions r \
      --expiry $EXPIRY_TIME \
      --auth-mode login \
      --as-user \
      --full-uri \
      --output tsv)
    echo "Generated SAS URL: $SAS_URL"
    ```
      * **Copy the `SAS_URL` output.**

**3.3. Azure PowerShell Method**

1.  Open PowerShell.
2.  Set variables (replace `storagenameyouruniqueid` and adjust `expiry_time`):
    ```powershell
    $storageAccountName = "storagenameyouruniqueid"
    $containerName = "secret-data"
    $blobName = "secret_report.txt"
    # Set expiry time to 10 minutes from now
    $expiryTime = (Get-Date).AddMinutes(10).ToUniversalTime().ToString("yyyy-MM-ddTHH:mmZ")
    Write-Host "SAS will expire at: $expiryTime"

    $ctx = (Get-AzStorageAccount -ResourceGroupName $resourceGroupName -Name $storageAccountName).Context
    ```
3.  Generate the User Delegation SAS:
    ```powershell
    $sas = New-AzStorageBlobSASToken -Container $containerName -Blob $blobName -Permission r -Context $ctx -ExpiryTime $expiryTime -FullUri -AsUser
    Write-Host "Generated SAS URL: $($sas.AbsoluteUri)"
    ```
      * **Copy the `AbsoluteUri` output.**

-----

## Part 4: Test Access with SAS

Now, use the generated SAS URL to access the blob.

1.  **Open a web browser** (or use `curl` in your terminal).

2.  **Paste the copied Blob SAS URL** into the address bar and press Enter.

3.  **Expected result**: The browser should display the content of `secret_report.txt` ("This is a confidential report for limited access."). This confirms that the SAS token successfully granted access.

4.  **(Optional) Test SAS Expiration**:

      * Wait until the expiry time you set for the SAS token has passed (e.g., 10 minutes).
      * Try to access the same SAS URL again in your browser.
      * **Expected result**: You should receive an error message, typically "AuthenticationFailed" or "Signature did not match" with a 403 Forbidden status, indicating that the SAS token has expired and access is no longer granted.

-----

## Part 5: Cleaning Up Resources (Critical\!)

To avoid incurring ongoing costs, it's crucial to delete all resources created for this lab. The easiest way is to delete the resource group.

**(Choose one method: Azure Portal, Azure CLI, or Azure PowerShell)**

**5.1. Azure Portal Method**

1.  In the Azure Portal, search for `Resource groups` and select it.
2.  Find and click on your resource group: `rg-storage-lab`.
3.  On the resource group's Overview blade, click **Delete resource group**.
4.  Type the resource group name (`rg-storage-lab`) to confirm, then click **Delete**.
5.  This will delete your Storage Account, Container, Blob, and any other resources within that group.

**5.2. Azure CLI Method**

1.  Open your terminal or Cloud Shell.
2.  ```bash
    RESOURCE_GROUP="rg-storage-lab"
    az group delete --name $RESOURCE_GROUP --no-wait --yes
    echo "Resource group '$RESOURCE_GROUP' deletion initiated."
    ```

**5.3. Azure PowerShell Method**

1.  Open PowerShell.
2.  ```powershell
    $resourceGroupName = "rg-storage-lab"
    Remove-AzResourceGroup -Name $resourceGroupName -Force -AsJob
    Write-Host "Resource group '$resourceGroupName' deletion initiated."
    ```

-----

Congratulations\! You have successfully completed all four labs for Day 22's advanced Azure Storage topics. You've gained hands-on experience with:

  * **Azure File Shares**: Mounting network drives for traditional file access.
  * **Azure Queue Storage**: Implementing a producer-consumer pattern for asynchronous messaging.
  * **Azure Table Storage**: Storing and querying schemaless, structured NoSQL data.
  * **Shared Access Signatures (SAS)**: Securely granting granular, time-limited access to individual storage resources.

These labs provide a solid foundation for working with these specialized Azure Storage services in real-world applications.