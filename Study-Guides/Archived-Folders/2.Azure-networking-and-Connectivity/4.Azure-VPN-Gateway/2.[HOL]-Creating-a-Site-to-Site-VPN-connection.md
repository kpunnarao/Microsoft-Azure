# Creating a Site-to-Site VPN Connection (Conceptual and Configuration Steps) üõ†Ô∏è

Establishing a **Site-to-Site (S2S) VPN connection** in Azure creates a secure, encrypted tunnel between your on-premises network and an Azure Virtual Network (VNet). 

This allows resources in both locations to communicate using private IP addresses as if they were part of the same extended network.

-----

## Conceptual Overview üí°

Imagine your on-premises network as one building and your Azure VNet as another. A Site-to-Site VPN acts like building a secure, private tunnel directly between these two buildings. Data entering one end of the tunnel is encrypted, travels across the internet, and is then decrypted at the other end.

Here's what happens at a high level:

1.  **Traffic Initiation**: A device in your on-premises network (e.g., a server at `192.168.1.10`) tries to reach a server in Azure (e.g., a VM at `10.0.0.4`).
2.  **On-Premises VPN Device**: Your on-premises VPN device (firewall or router) is configured to recognize that `10.0.0.0/16` (the Azure VNet's address space) is reachable via the VPN tunnel. It encrypts the traffic.
3.  **Azure VPN Gateway**: The encrypted traffic travels over the public internet to the public IP address of your Azure VPN Gateway.
4.  **Decryption and Routing**: The Azure VPN Gateway decrypts the traffic and routes it to the target VM (`10.0.0.4`) within your Azure VNet.
5.  **Return Traffic**: The process reverses for return traffic from Azure to on-premises.

The connection relies on **IPsec (Internet Protocol Security)** for encryption and **IKE (Internet Key Exchange)** for establishing the security associations and managing encryption keys.

-----

## Key Components Involved üß©

Before diving into configuration, it's vital to understand the core components you'll be setting up in Azure:

1.  **Virtual Network (VNet)**: Your primary network in Azure where your VMs and other resources reside.
      * Example: `vnet-prod` (Address space: `10.0.0.0/16`)
2.  **GatewaySubnet**: A dedicated, specially named subnet within your VNet where the VPN Gateway itself is deployed.
      * **Name MUST be `GatewaySubnet`**.
      * Recommended size: `/27` or larger (e.g., `10.0.100.0/27`).
3.  **Virtual Network Gateway**: The Azure resource that acts as the VPN endpoint in Azure.
      * **Type**: `VPN`
      * **VPN Type**: **`Route-based`** (most common for S2S, supports IKEv2 and BGP) or `Policy-based` (legacy, IKEv1, requires static IPsec policy on both ends). For modern S2S, always choose **Route-based**.
      * **SKU**: Determines performance (bandwidth, tunnels) and cost (e.g., `VpnGw1`, `VpnGw2`, `VpnGw3`).
      * **Public IP Address**: The gateway needs a public IP address to be accessible from external networks (either on-premises or remote clients).
4.  **Local Network Gateway**: An Azure object that logically represents your **on-premises network**.
      * **Name**: A descriptive name for your on-premises site.
      * **IP Address**: The public IP address of your on-premises VPN device (router/firewall).
      * **Address Spaces**: The IP address ranges of your on-premises network(s) that will be accessible through the VPN tunnel.
5.  **Connection**: The Azure resource that links your **Virtual Network Gateway** to your **Local Network Gateway**.
      * **Type**: `IPsec (Site-to-Site)`
      * **Shared Key (PSK)**: A secret key that must match on both the Azure Connection and your on-premises VPN device for authentication.

-----

## Configuration Steps (Azure Side) üõ†Ô∏è

### Part 1: Plan Your IP Address Spaces

  * **Azure VNet**: e.g., `10.0.0.0/16`
  * **Azure GatewaySubnet**: e.g., `10.0.100.0/27` (within your VNet)
  * **On-Premises Network**: e.g., `192.168.1.0/24`

**Crucial**: Your on-premises network address space and your Azure VNet address space **MUST NOT OVERLAP**.

-----

### Method 1: Azure Portal üåê

#### 1\. Create a Virtual Network (if not already existing)

1.  Search for "Virtual networks" and click "+ Create".
2.  Fill in **Subscription**, **Resource Group** (e.g., `rg-vnet-prod`), **Name** (e.g., `vnet-prod`), and **Region** (e.g., `East US`).
3.  On the **IP Addresses** tab, configure your VNet address space (e.g., `10.0.0.0/16`) and add your initial subnet (e.g., `snet-app` with prefix `10.0.0.0/24`).
4.  Click **Review + create** and then **Create**.

#### 2\. Add the GatewaySubnet to your VNet

1.  Navigate to your `vnet-prod` VNet.
2.  In the left-hand menu, under **Settings**, select **Subnets**.
3.  Click **+ Gateway subnet**.
4.  The name will automatically be `GatewaySubnet`.
5.  Set the **Address range** (e.g., `10.0.100.0/27`). Ensure it's at least `/27`.
6.  Click **Add**.

#### 3\. Create a Virtual Network Gateway

1.  Search for "Virtual network gateways" and click "+ Create".
2.  **Basics Tab**:
      * **Subscription**: Your subscription.
      * **Resource Group**: `rg-vnet-prod`.
      * **Name**: `vgw-prod`.
      * **Region**: `East US` (must match your VNet's region).
      * **Gateway type**: Select `VPN`.
      * **VPN type**: Select `Route-based`.
      * **SKU**: Choose a SKU based on your performance needs (e.g., `VpnGw1`).
      * **Generation**: Select `Generation1` or `Generation2` (Gen2 offers more features and better performance for some SKUs).
      * **Virtual network**: Select `vnet-prod`.
      * **Public IP address**: Select "Create new".
          * **Public IP address name**: `pip-vpngateway`.
          * **Assignment**: `Dynamic`.
          * **SKU**: `Basic` (for VpnGw1) or `Standard` (for VpnGw2 and higher).
      * **Enable active-active mode**: Leave unchecked for a simple setup.
      * **Configure BGP**: Leave unchecked for a simple setup.
3.  Click **Review + create** and then **Create**.
      * **Note**: This step takes **30-45 minutes** to complete.

#### 4\. Create a Local Network Gateway

1.  Search for "Local network gateways" and click "+ Create".
2.  **Basics Tab**:
      * **Subscription**: Your subscription.
      * **Resource Group**: `rg-vnet-prod`.
      * **Name**: `lgw-onprem`.
      * **Region**: `East US` (can be different from your on-prem location, but usually same as VNet Gateway).
      * **Endpoint**: Select `IP address`.
          * **IP address**: Enter the **public IP address of your on-premises VPN device** (e.g., `203.0.113.5`).
      * **Address space**: Add the **CIDR block(s) of your on-premises network(s)** (e.g., `192.168.1.0/24`).
      * **Configure BGP settings**: Leave unchecked for a simple setup.
3.  Click **Review + create** and then **Create**.

#### 5\. Create the Site-to-Site Connection

1.  Navigate to your **Virtual Network Gateway** (`vgw-prod`).
2.  In the left-hand menu, under **Settings**, select **Connections**.
3.  Click **+ Add**.
4.  **Add connection**:
      * **Name**: `conn-onprem-to-azure`.
      * **Connection type**: `Site-to-site (IPsec)`.
      * **Virtual network gateway**: Automatically populated (`vgw-prod`).
      * **Local network gateway**: Choose `lgw-onprem`.
      * **Shared key (PSK)**: Enter a strong, complex shared key (e.g., `MyS2SSecretKey!23`). **This must be identical to the key you configure on your on-premises VPN device.**
      * **IKE Protocol**: `IKEv2` (recommended for Route-based).
      * **Enable BGP**: Leave unchecked for a simple setup.
5.  Click **OK**.

-----

### Method 2: Azure PowerShell üíª

Open Azure Cloud Shell (PowerShell environment) or a local PowerShell installation with the Az module.

```powershell
# --- 1. Define Variables ---
$resourceGroupName = "rg-vnet-prod"
$location = "eastus"
$vnetName = "vnet-prod"
$vnetPrefix = "10.0.0.0/16"
$appSubnetName = "snet-app"
$appSubnetPrefix = "10.0.0.0/24"
$gatewaySubnetName = "GatewaySubnet"
$gatewaySubnetPrefix = "10.0.100.0/27" # Must be /27 or larger

$vgwName = "vgw-prod"
$publicIpName = "pip-vpngateway"
$lgwName = "lgw-onprem"
$onPremPublicIp = "203.0.113.5" # Replace with your actual on-premises public IP
$onPremPrefixes = @("192.168.1.0/24") # Replace with your actual on-premises network CIDRs
$connectionName = "conn-onprem-to-azure"
$sharedKey = "YourComplexSharedKeyHere123!" # Replace with a strong, unique key

# --- 2. Create Resource Group (if it doesn't exist) ---
New-AzResourceGroup -Name $resourceGroupName -Location $location -ErrorAction SilentlyContinue

# --- 3. Create Virtual Network and Subnets ---
$subnetApp = New-AzVirtualNetworkSubnetConfig -Name $appSubnetName -AddressPrefix $appSubnetPrefix
$subnetGateway = New-AzVirtualNetworkSubnetConfig -Name $gatewaySubnetName -AddressPrefix $gatewaySubnetPrefix

$vnet = New-AzVirtualNetwork -Name $vnetName `
    -ResourceGroupName $resourceGroupName `
    -Location $location `
    -AddressPrefix $vnetPrefix `
    -Subnet $subnetApp,$subnetGateway

Write-Host "VNet '$vnetName' created with subnets."

# --- 4. Create Public IP Address for the VPN Gateway ---
$publicIP = New-AzPublicIpAddress -Name $publicIpName `
    -ResourceGroupName $resourceGroupName `
    -Location $location `
    -AllocationMethod Dynamic `
    -Sku Basic # For VpnGw2+ use Standard

Write-Host "Public IP '$publicIpName' created."

# --- 5. Create Virtual Network Gateway IP Configuration ---
$gwIpConfig = New-AzVirtualNetworkGatewayIpConfig -Name "vnetGatewayIpConfig" `
    -SubnetId $vnet.Subnets[1].Id ` # Assumes GatewaySubnet is the second subnet created
    -PublicIpAddressId $publicIP.Id

# --- 6. Create the Virtual Network Gateway (This takes 30-45 minutes) ---
$vnetGateway = New-AzVirtualNetworkGateway -Name $vgwName `
    -ResourceGroupName $resourceGroupName `
    -Location $location `
    -IpConfigurations $gwIpConfig `
    -GatewayType Vpn `
    -VpnType RouteBased `
    -GatewaySku VpnGw1 ` # Adjust SKU as needed (VpnGw2, VpnGw3 etc.)
    -AsJob # Runs as a background job, allowing you to continue other tasks or monitor

Write-Host "Virtual Network Gateway '$vgwName' creation initiated. This will take ~30-45 minutes."
Write-Host "You can check status with: Get-Job -Name '$vgwName'"
# Wait for the job to complete if you need to continue immediately
# Wait-Job -Name $vgwName
# $vnetGateway = Receive-Job -Name $vgwName

# After creation, retrieve the gateway object if you used -AsJob initially
# $vnetGateway = Get-AzVirtualNetworkGateway -Name $vgwName -ResourceGroupName $resourceGroupName

# --- 7. Create the Local Network Gateway ---
$localGateway = New-AzLocalNetworkGateway -Name $lgwName `
    -ResourceGroupName $resourceGroupName `
    -Location $location `
    -GatewayIpAddress $onPremPublicIp `
    -AddressPrefix $onPremPrefixes

Write-Host "Local Network Gateway '$lgwName' created."

# --- 8. Create the S2S VPN Connection ---
New-AzVirtualNetworkGatewayConnection -Name $connectionName `
    -ResourceGroupName $resourceGroupName `
    -Location $location `
    -VirtualNetworkGateway1 $vnetGateway `
    -LocalNetworkGateway2 $localGateway `
    -ConnectionType IPsec `
    -RoutingWeight 10 ` # Optional: Adjust for multiple connections
    -SharedKey $sharedKey

Write-Host "VPN Connection '$connectionName' created. Please configure your on-premises VPN device with the shared key and connection parameters."
```

-----

### Method 3: Azure CLI üñ•Ô∏è

Open Azure Cloud Shell (Bash environment) or a local Azure CLI installation.

```bash
# --- 1. Define Variables ---
resourceGroupName="rg-vnet-prod"
location="eastus"
vnetName="vnet-prod"
vnetPrefix="10.0.0.0/16"
appSubnetName="snet-app"
appSubnetPrefix="10.0.0.0/24"
gatewaySubnetName="GatewaySubnet"
gatewaySubnetPrefix="10.0.100.0/27" # Must be /27 or larger

vgwName="vgw-prod"
publicIpName="pip-vpngateway"
lgwName="lgw-onprem"
onPremPublicIp="203.0.113.5" # Replace with your actual on-premises public IP
onPremPrefix="192.168.1.0/24" # Replace with your actual on-premises network CIDR(s) - for multiple, repeat --address-prefixes

connectionName="conn-onprem-to-azure"
sharedKey="YourComplexSharedKeyHere123!" # Replace with a strong, unique key

# --- 2. Create Resource Group (if it doesn't exist) ---
az group create --name $resourceGroupName --location $location

# --- 3. Create Virtual Network and Subnets (including GatewaySubnet) ---
az network vnet create \
    --name $vnetName \
    --resource-group $resourceGroupName \
    --location $location \
    --address-prefix $vnetPrefix \
    --subnet-name $appSubnetName \
    --subnet-prefix $appSubnetPrefix

az network vnet subnet create \
    --name $gatewaySubnetName \
    --resource-group $resourceGroupName \
    --vnet-name $vnetName \
    --address-prefix $gatewaySubnetPrefix

echo "VNet '$vnetName' created with subnets."

# --- 4. Create Public IP Address for the VPN Gateway ---
az network public-ip create \
    --name $publicIpName \
    --resource-group $resourceGroupName \
    --location $location \
    --allocation-method Dynamic \
    --sku Basic # For VpnGw2+ use Standard

echo "Public IP '$publicIpName' created."

# --- 5. Create the Virtual Network Gateway (This takes 30-45 minutes) ---
az network vnet gateway create \
    --name $vgwName \
    --resource-group $resourceGroupName \
    --location $location \
    --public-ip-address $publicIpName \
    --vnet $vnetName \
    --gateway-type Vpn \
    --vpn-type RouteBased \
    --sku VpnGw1 \
    --no-wait # Allows command to return while deployment continues in background

echo "Virtual Network Gateway '$vgwName' creation initiated. This will take ~30-45 minutes."
echo "You can check status with: az network vnet gateway show -g $resourceGroupName -n $vgwName --query provisioningState -o tsv"

# Wait for gateway provisioningState to be 'Succeeded' before proceeding
# while [ "$(az network vnet gateway show -g $resourceGroupName -n $vgwName --query provisioningState -o tsv)" != "Succeeded" ]; do
#     echo "Waiting for VPN Gateway to provision..."
#     sleep 30
# done
# echo "VPN Gateway provisioned."

# --- 6. Create the Local Network Gateway ---
az network local-gateway create \
    --name $lgwName \
    --resource-group $resourceGroupName \
    --location $location \
    --gateway-ip-address $onPremPublicIp \
    --address-prefixes $onPremPrefix

echo "Local Network Gateway '$lgwName' created."

# --- 7. Create the S2S VPN Connection ---
az network vnet gateway connection create \
    --name $connectionName \
    --resource-group $resourceGroupName \
    --vnet-gateway1 $vgwName \
    --local-gateway2 $lgwName \
    --connection-type IPsec \
    --shared-key $sharedKey \
    --enable-bgp false # Set to true if using BGP for dynamic routing

echo "VPN Connection '$connectionName' created. Please configure your on-premises VPN device with the shared key and connection parameters."
```

-----

## Part 2: On-Premises VPN Device Configuration ‚öôÔ∏è

This is the most variable part, as it depends entirely on your specific on-premises VPN device (e.g., Cisco ASA, Palo Alto, Fortinet, pfSense, Windows Server VPN, etc.).

**General Steps for On-Premises Configuration**:

1.  **Identify Azure VPN Gateway Public IP**: Get the public IP of your `pip-vpngateway` created in Azure (e.g., from the Azure portal, or `az network public-ip show -g rg-vnet-prod -n pip-vpngateway --query ipAddress -o tsv`).
2.  **Configure VPN Tunnel Interface**: Set up a new VPN tunnel interface on your device.
3.  **Define Phase 1 (IKE) Parameters**:
      * **Authentication Method**: Pre-Shared Key (PSK) or Certificate.
      * **Encryption**: AES256, AES128, 3DES (match Azure's supported IKE Phase 1 proposals).
      * **Hashing**: SHA256, SHA1 (match Azure).
      * **DH Group (Diffie-Hellman)**: Group 2, 14, 24 (match Azure, higher numbers are more secure).
      * **Lifetime**: Typically 28800 seconds (8 hours).
      * **PFS (Perfect Forward Secrecy)**: Optional, but recommended.
4.  **Define Phase 2 (IPsec) Parameters**:
      * **Encryption**: AES256, AES128, 3DES (match Azure's supported IKE Phase 2 proposals).
      * **Hashing**: SHA256, SHA1 (match Azure).
      * **PFS DH Group**: (Same as IKE Phase 1 or disabled).
      * **Lifetime**: Typically 3600 seconds (1 hour).
      * **Selectors/Traffic Selectors**: Define the traffic that will go over the VPN.
          * **Local Network**: Your on-premises address space (e.g., `192.168.1.0/24`).
          * **Remote Network**: Your Azure VNet address space (e.g., `10.0.0.0/16`).
5.  **Enter Shared Key**: Input the **exact same** shared key you used when creating the Azure connection.
6.  **Configure Routing**:
      * Add a static route on your on-premises device that directs traffic destined for your Azure VNet's address space (`10.0.0.0/16`) to the VPN tunnel interface.
      * If using BGP, configure BGP peering with the Azure VPN Gateway's BGP IP address (requires specific gateway SKUs and configuration).
7.  **Enable VPN Tunnel**: Activate the configured VPN tunnel.

**Important Resources**:

  * **Azure VPN Device Configurations**: Microsoft provides specific configuration instructions for many popular VPN devices. Always check these first: [https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpn-devices](https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpn-devices)

-----

## Part 3: Verification & Troubleshooting ‚úÖ

1.  **Check Connection Status in Azure**:
      * In the Azure portal, navigate to your Virtual Network Gateway (`vgw-prod`).
      * Select **Connections** under **Settings**.
      * The connection (`conn-onprem-to-azure`) should show a **Status** of **Connected**. If it's `Unknown` or `Not Connected`, there's an issue.
2.  **Test Connectivity**:
      * From a VM in your Azure VNet, try to ping or RDP/SSH to a server in your on-premises network.
      * From a server in your on-premises network, try to ping or RDP/SSH to a VM in your Azure VNet.
3.  **Troubleshooting**:
      * **Shared Key Mismatch**: The most common issue. Ensure the shared key is identical on both sides.
      * **IPsec/IKE Parameter Mismatch**: Encryption, hashing, DH Group, and lifetimes must match. Check the Azure Gateway's supported parameters in documentation and compare with your device's configuration.
      * **IP Address Overlap**: Double-check that no IP ranges overlap between on-premises and Azure.
      * **Routing Issues**: Ensure traffic is being directed into the VPN tunnel on both ends.
      * **Firewall Rules**: Ensure no local firewalls (on VMs or on-premises servers) are blocking ICMP (ping) or other traffic.
      * **On-Premises Public IP Changes**: If your on-premises public IP changes, you must update the Local Network Gateway in Azure.

By carefully following these steps and ensuring all parameters match, you can successfully establish a secure Site-to-Site VPN connection between your on-premises network and Azure.