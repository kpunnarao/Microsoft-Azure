# Lab: Implementing Azure Front Door (Standard Tier) üåê

This lab guides you through setting up an Azure Front Door (Standard tier) profile to globally distribute user traffic to two web applications located in different Azure regions. We'll configure it for basic performance routing and verify its functionality.

## Lab Scenario üöÄ

We will create two simple web applications in two different Azure regions and use Azure Front Door to act as the global entry point, directing users to the closest healthy backend.

  * **Resource Group**: `rg-frontdoor-lab`
  * **Regions**: `East US 2` (Primary) and `West US 2` (Secondary)
  * **Web App 1 (East US 2)**: `webapp-afd-eus2`
  * **Web App 2 (West US 2)**: `webapp-afd-wus2`
  * **Front Door Profile Name**: `my-global-afd` (or a globally unique name like `my-global-afd-XXXXX`)
  * **Front Door Tier**: `Standard`

-----

## Part 1: Prerequisites & Initial Setup

Before you begin, ensure you have:

  * An active Azure Subscription.
  * The Azure CLI or Azure PowerShell installed and configured, or use Azure Cloud Shell.
  * **Create the Resource Group**:

### Method 1: Azure Portal üåê

1.  Search for "Resource groups" and click **"+ Create"**.
2.  Subscription: Your subscription.
3.  Resource Group name: `rg-frontdoor-lab`.
4.  Region: `East US 2` (This is just for the RG metadata).
5.  Review + create, then Create.

### Method 2: Azure PowerShell üíª

```powershell
# --- Define Variables ---
$resourceGroupName = "rg-frontdoor-lab"
$locationEastUS2 = "eastus2"
$locationWestUS2 = "westus2"

# --- Create Resource Group ---
Write-Host "Creating Resource Group: $resourceGroupName..."
New-AzResourceGroup -Name $resourceGroupName -Location $locationEastUS2

Write-Host "Resource Group created."
```

### Method 3: Azure CLI üñ•Ô∏è

```bash
# --- Define Variables ---
resourceGroupName="rg-frontdoor-lab"
locationEastUS2="eastus2"
locationWestUS2="westus2"

# --- Create Resource Group ---
echo "Creating Resource Group: $resourceGroupName..."
az group create --name $resourceGroupName --location $locationEastUS2

echo "Resource Group created."
```

-----

## Part 2: Create Web Applications (Backends)

We'll create two basic Azure Web Apps (App Services) to serve as the backend origins for Front Door. We'll put a simple HTML file on each to easily identify which region we're hitting.

### Method 1: Azure Portal üåê

1.  Search for "App Services" and click **"+ Create"** -\> "Web App".

2.  **Web App 1 (`webapp-afd-eus2`)**:

      * Basics Tab:
          * Subscription: Your subscription.
          * Resource Group: `rg-frontdoor-lab`.
          * Name: `webapp-afd-eus2` (Must be globally unique).
          * Publish: `Code`.
          * Runtime stack: `.NET 8 (LTS)` (or any other, doesn't matter for this lab).
          * Operating System: `Windows`.
          * Region: `East US 2`.
          * App Service Plan: "Create new", Name: `plan-afd-eus2`, SKU and size: `Basic B1`.
      * Review + create, then Create.

3.  **Web App 2 (`webapp-afd-wus2`)**: Repeat steps for Web App 1 but with:

      * Name: `webapp-afd-wus2` (Must be globally unique).
      * Region: `West US 2`.
      * App Service Plan: "Create new", Name: `plan-afd-wus2`, SKU and size: `Basic B1`.
      * Review + create, then Create.

4.  **Deploy Simple Content to Web Apps (Optional but Recommended for Testing)**:

      * For each web app (`webapp-afd-eus2` and `webapp-afd-wus2`):
          * Navigate to the App Service.
          * Under **Development Tools**, select **Advanced Tools (Kudu)**. Click "Go".
          * In Kudu, go to **Debug console** -\> **CMD**.
          * Navigate to `site\wwwroot`.
          * Click the `+` icon next to `wwwroot` and select "New file". Name it `index.html`.
          * Click the pencil icon next to `index.html` to edit.
          * For `webapp-afd-eus2` (East US 2), paste this content:
            ```html
            <!DOCTYPE html>
            <html>
            <head>
                <title>Azure Front Door Lab</title>
                <style>
                    body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
                    h1 { color: #0078D4; }
                    .region { font-size: 2em; color: #E81123; }
                </style>
            </head>
            <body>
                <h1>Welcome to the Azure Front Door Lab!</h1>
                <p>You are connected to the application in:</p>
                <div class="region">EAST US 2</div>
                <p>Powered by Azure App Service</p>
            </body>
            </html>
            ```
          * Save the file.
          * For `webapp-afd-wus2` (West US 2), paste similar content, but change "EAST US 2" to "WEST US 2".
          * Save the file.

### Method 2: Azure PowerShell üíª

```powershell
# --- Define Web App Variables ---
$webappEUSName = "webapp-afd-eus2-$(Get-Random)" # Ensures global uniqueness
$webappWUSName = "webapp-afd-wus2-$(Get-Random)" # Ensures global uniqueness
$appServicePlanNameEUS2 = "plan-afd-eus2"
$appServicePlanNameWUS2 = "plan-afd-wus2"

# --- Create App Service Plan (East US 2) ---
Write-Host "Creating App Service Plan for Web App in East US 2..."
New-AzAppServicePlan -Name $appServicePlanNameEUS2 `
    -ResourceGroupName $resourceGroupName `
    -Location $locationEastUS2 `
    -Tier Basic `
    -IsLinux $false

# --- Create Web App (East US 2) ---
Write-Host "Creating Web App: $webappEUSName in East US 2..."
$webappEUS = New-AzWebApp -Name $webappEUSName `
    -ResourceGroupName $resourceGroupName `
    -Location $locationEastUS2 `
    -AppServicePlan $appServicePlanNameEUS2

# --- Create App Service Plan (West US 2) ---
Write-Host "Creating App Service Plan for Web App in West US 2..."
New-AzAppServicePlan -Name $appServicePlanNameWUS2 `
    -ResourceGroupName $resourceGroupName `
    -Location $locationWestUS2 `
    -Tier Basic `
    -IsLinux $false

# --- Create Web App (West US 2) ---
Write-Host "Creating Web App: $webappWUSName in West US 2..."
$webappWUS = New-AzWebApp -Name $webappWUSName `
    -ResourceGroupName $resourceGroupName `
    -Location $locationWestUS2 `
    -AppServicePlan $appServicePlanNameWUS2

Write-Host "Web Apps creation initiated. This will take a few minutes."
Write-Host "You will need to manually deploy content to these Web Apps for testing or use a deployment method."
```

### Method 3: Azure CLI üñ•Ô∏è

```bash
# --- Define Web App Variables ---
webappEUSName="webapp-afd-eus2-$RANDOM" # Ensures global uniqueness
webappWUSName="webapp-afd-wus2-$RANDOM" # Ensures global uniqueness
appServicePlanNameEUS2="plan-afd-eus2"
appServicePlanNameWUS2="plan-afd-wus2"

# --- Create App Service Plan (East US 2) ---
echo "Creating App Service Plan for Web App in East US 2..."
az appservice plan create \
    --name $appServicePlanNameEUS2 \
    --resource-group $resourceGroupName \
    --location $locationEastUS2 \
    --sku B1 # Basic B1

# --- Create Web App (East US 2) ---
echo "Creating Web App: $webappEUSName in East US 2..."
az webapp create \
    --resource-group $resourceGroupName \
    --plan $appServicePlanNameEUS2 \
    --name $webappEUSName \
    --deployment-container-image-names mcr.microsoft.com/azure-app-service/samples/aspnethelloworld # Basic demo image

# --- Create App Service Plan (West US 2) ---
echo "Creating App Service Plan for Web App in West US 2..."
az appservice plan create \
    --name $appServicePlanNameWUS2 \
    --resource-group $resourceGroupName \
    --location $locationWestUS2 \
    --sku B1

# --- Create Web App (West US 2) ---
echo "Creating Web App: $webappWUSName in West US 2..."
az webapp create \
    --resource-group $resourceGroupName \
    --plan $appServicePlanNameWUS2 \
    --name $webappWUSName \
    --deployment-container-image-names mcr.microsoft.com/azure-app-service/samples/aspnethelloworld

echo "Web Apps creation initiated. This will take a few minutes."
echo "You can check their status with: az webapp list -g $resourceGroupName --query '[].{Name:name,State:state}' -o table"
echo "Note: For a better testing experience, you would typically deploy custom content to these web apps."
```

-----

## Part 3: Create Azure Front Door Profile

Now we'll create the Azure Front Door Standard profile and add our two web apps as origins.

### Method 1: Azure Portal üåê

1.  Search for "Front Door and CDN profiles" and click **"+ Create"**.
2.  On the "Compare offerings" page, select **"Quick create"** (or "Custom create" if you want to explore more options later), then click **"Continue to create a Front Door"**.
3.  **Basics Tab**:
      * Subscription: Your subscription.
      * Resource Group: `rg-frontdoor-lab`.
      * Name: `my-global-afd-` followed by a unique string (e.g., `my-global-afd-00123`). This name must be globally unique.
      * Tier: Select `Standard`.
      * **Endpoint name**: Enter a globally unique name for your endpoint (e.g., `myafdeuswus`). This will form your primary Front Door URL (`myafdeuswus-xxxx.z01.azurefd.net`).
      * Origin type: `App Service`.
      * Origin host name: Select `webapp-afd-eus2.azurewebsites.net`.
      * Caching: Leave unchecked for now.
      * WAF policy: `(None)` for this basic lab.
4.  Click **"Review + Create"**, then **"Create"**.
5.  Once the Front Door profile is deployed, navigate to it.
6.  In the left-hand menu, under **Settings**, select **Front Door manager**.
7.  You'll see your default endpoint and a default route.
8.  Select your **Origin group** (e.g., `default-origin-group`). Click **"+ Add an origin"**.
      * Name: `webapp-afd-wus2-origin`
      * Origin Type: `App Services`
      * Host name: Select `webapp-afd-wus2.azurewebsites.net` (your West US 2 web app).
      * Priority: `1`
      * Weight: `1000`
      * Add.
      * Click **"Update"** on the origin group to save changes.
9.  Back in the **Front Door manager**, expand your endpoint if it's collapsed. Then, select your **Route** (e.g., `default-route`).
      * Verify the `Origin group` is `default-origin-group`.
      * You can enable Caching if you deployed static content, but for basic web apps, it's not strictly necessary to test routing.
      * Click **"Update"** if you made changes.

-----

### Method 2: Azure PowerShell üíª

```powershell
# --- Define Front Door Variables ---
$fdProfileName = "my-global-afd-$(Get-Random -Minimum 1000 -Maximum 9999)" # Ensures global uniqueness
$endpointName = "myafdeuswus$(Get-Random -Minimum 1000 -Maximum 9999)" # Ensures global uniqueness for endpoint

# --- Get Web App details for origins ---
$webappEUS = Get-AzWebApp -Name $webappEUSName -ResourceGroupName $resourceGroupName
$webappWUS = Get-AzWebApp -Name $webappWUSName -ResourceGroupName $resourceGroupName

# --- Create Azure Front Door Standard Profile ---
Write-Host "Creating Azure Front Door Profile: $fdProfileName..."
$frontDoorProfile = New-AzFrontDoorCdnProfile `
    -ProfileName $fdProfileName `
    -ResourceGroupName $resourceGroupName `
    -Location Global ` # Front Door is a global resource, location is logical
    -SkuName Standard_AzureFrontDoor

# --- Create Endpoint ---
Write-Host "Creating Front Door Endpoint: $endpointName..."
$frontDoorEndpoint = New-AzFrontDoorCdnEndpoint `
    -EndpointName $endpointName `
    -ProfileName $fdProfileName `
    -ResourceGroupName $resourceGroupName `
    -Location Global ` # Endpoint location is also logical

# --- Create Origin Group ---
Write-Host "Creating Origin Group..."
$originGroup = New-AzFrontDoorCdnOriginGroup `
    -OriginGroupName "my-afd-origin-group" `
    -ProfileName $fdProfileName `
    -ResourceGroupName $resourceGroupName `
    -HealthProbePath "/" `
    -HealthProbeProtocol Https ` # Use HTTPS for App Services if possible
    -HealthProbeIntervalInSeconds 100 `
    -ProbeMethod HEAD `
    -LoadBalancingSampleDuration 10 `
    -LoadBalancingSampleSize 4 `
    -LoadBalancingSuccessfulSamplesRequired 3

# --- Add Origins to Origin Group ---
Write-Host "Adding Primary Origin ($webappEUSName) to Origin Group..."
New-AzFrontDoorCdnOrigin `
    -OriginName "origin-eus2" `
    -OriginGroupName $originGroup.Name `
    -ProfileName $fdProfileName `
    -ResourceGroupName $resourceGroupName `
    -HostName $webappEUS.DefaultHostName `
    -HttpPort 80 `
    -HttpsPort 443 `
    -Weight 100 ` # Priority 1 (implicitly highest if other is 2)
    -Priority 1 `
    -HttpsProtocolType HttpsOnly # Ensure Front Door connects to origin using HTTPS

Write-Host "Adding Secondary Origin ($webappWUSName) to Origin Group..."
New-AzFrontDoorCdnOrigin `
    -OriginName "origin-wus2" `
    -OriginGroupName $originGroup.Name `
    -ProfileName $fdProfileName `
    -ResourceGroupName $resourceGroupName `
    -HostName $webappWUS.DefaultHostName `
    -HttpPort 80 `
    -HttpsPort 443 `
    -Weight 100 `
    -Priority 2 ` # Lower priority for failover
    -HttpsProtocolType HttpsOnly

# --- Create Route ---
Write-Host "Creating Route for Endpoint..."
New-AzFrontDoorCdnRoute `
    -RouteName "default-route" `
    -EndpointName $endpointName `
    -ProfileName $fdProfileName `
    -ResourceGroupName $resourceGroupName `
    -OriginGroupName $originGroup.Name `
    -PatternToMatch "/*" ` # Matches all paths
    -ForwardingProtocol MatchRequest ` # Match incoming protocol (HTTP or HTTPS)
    -AcceptedProtocol @("Http", "Https") `
    -LinkToDefaultDomain $true # Link to the default Front Door generated domain

Write-Host "Azure Front Door setup initiated. It may take some time for the configuration to propagate globally."
```

### Method 3: Azure CLI üñ•Ô∏è

```bash
# --- Define Front Door Variables ---
fdProfileName="my-global-afd-$RANDOM" # Ensures global uniqueness
endpointName="myafdeuswus$RANDOM" # Ensures global uniqueness for endpoint

# --- Get Web App hostnames for origins ---
webappEUSHostname=$(az webapp show -g $resourceGroupName -n $webappEUSName --query defaultHostName -o tsv)
webappWUSHostname=$(az webapp show -g $resourceGroupName -n $webappWUSName --query defaultHostName -o tsv)

# --- Create Azure Front Door Standard Profile ---
echo "Creating Azure Front Door Profile: $fdProfileName..."
az afd profile create \
    --profile-name $fdProfileName \
    --resource-group $resourceGroupName \
    --sku Standard_AzureFrontDoor

# --- Create Endpoint ---
echo "Creating Front Door Endpoint: $endpointName..."
az afd endpoint create \
    --endpoint-name $endpointName \
    --profile-name $fdProfileName \
    --resource-group $resourceGroupName

# --- Create Origin Group ---
echo "Creating Origin Group..."
az afd origin-group create \
    --origin-group-name "my-afd-origin-group" \
    --profile-name $fdProfileName \
    --resource-group $resourceGroupName \
    --probe-path "/" \
    --probe-protocol Https \
    --probe-interval 100 \
    --probe-method HEAD \
    --sample-duration 10 \
    --successful-samples-required 3

# --- Add Origins to Origin Group ---
echo "Adding Primary Origin ($webappEUSName) to Origin Group..."
az afd origin create \
    --origin-name "origin-eus2" \
    --origin-group-name "my-afd-origin-group" \
    --profile-name $fdProfileName \
    --resource-group $resourceGroupName \
    --host-name $webappEUSHostname \
    --http-port 80 \
    --https-port 443 \
    --weight 1000 \
    --priority 1 \
    --https-protocol-type HttpsOnly

echo "Adding Secondary Origin ($webappWUSName) to Origin Group..."
az afd origin create \
    --origin-name "origin-wus2" \
    --origin-group-name "my-afd-origin-group" \
    --profile-name $fdProfileName \
    --resource-group $resourceGroupName \
    --host-name $webappWUSHostname \
    --http-port 80 \
    --https-port 443 \
    --weight 1000 \
    --priority 2 \
    --https-protocol-type HttpsOnly

# --- Create Route ---
echo "Creating Route for Endpoint..."
az afd route create \
    --route-name "default-route" \
    --endpoint-name $endpointName \
    --profile-name $fdProfileName \
    --resource-group $resourceGroupName \
    --origin-group "my-afd-origin-group" \
    --pattern-to-match "/*" \
    --forwarding-protocol MatchRequest \
    --accepted-protocols Http Https \
    --link-to-default-domain true

echo "Azure Front Door setup initiated. It may take some time for the configuration to propagate globally."
echo "You can get the Front Door hostname with: az afd endpoint show -g $resourceGroupName -n $endpointName --profile-name $fdProfileName --query hostName -o tsv"
```

-----

## Part 4: Test Azure Front Door

After deployment, it can take **5-10 minutes (or sometimes more)** for Front Door's configuration to propagate across all edge locations. Patience is key\!

### 1\. Get Front Door Endpoint Hostname

1.  **Portal**: Navigate to your `my-global-afd-XXXXX` Front Door profile. Under **Front Door manager**, expand your endpoint. The **Endpoint hostname** (e.g., `myafdeuswus-xxxx.z01.azurefd.net`) will be displayed.
2.  **PowerShell (after commands complete)**: `$frontDoorEndpoint.HostName`
3.  **CLI (after commands complete)**: Use the command from the end of the CLI section: `az afd endpoint show -g $resourceGroupName -n $endpointName --profile-name $fdProfileName --query hostName -o tsv`

### 2\. Access the Application

1.  Open a web browser and navigate to the **Endpoint hostname** you obtained (e.g., `http://myafdeuswus-xxxx.z01.azurefd.net`).
2.  **Observe the Region**:
      * If you're physically closer to `East US 2`, you should see the content from `webapp-afd-eus2`.
      * If you're physically closer to `West US 2`, you should see the content from `webapp-afd-wus2`.
      * Front Door intelligently routes your request to the geographically (and network-latency) closest healthy backend.

### 3\. Simulate Failover (Disable Primary Web App)

1.  **Disable Primary Web App (Portal)**:
      * Navigate to your `webapp-afd-eus2` App Service.
      * In the **Overview** pane, click **"Stop"**. Confirm the stop.
2.  **Wait for Health Probes**: Wait **at least 2-5 minutes**. Front Door's health probes will detect that `webapp-afd-eus2` is no longer responding.
3.  **Test Failover**: Open a **new browser tab/window** (or clear your browser's DNS cache if you're not getting a different result immediately) and navigate to the Front Door's Endpoint hostname again.
4.  **Verify Secondary**: You should now be routed to the **secondary (West US 2)** web app (`webapp-afd-wus2`), demonstrating Front Door's automatic global failover capabilities.
5.  **Re-enable Primary (Optional)**: If you re-enable `webapp-afd-eus2`, after a few minutes, Front Door will detect it's healthy again and resume routing traffic to it based on optimal performance.

This lab provides a hands-on experience with Azure Front Door's core functionality as a global entry point and intelligent traffic router.

-----

## Part 5: Clean Up Resources

To avoid incurring unnecessary costs, delete the resource group created in this lab.

### Method 1: Azure Portal üåê

1.  Search for "Resource groups" and select `rg-frontdoor-lab`.
2.  Click **"Delete resource group"**.
3.  Type `rg-frontdoor-lab` to confirm, then click **"Delete"**.

### Method 2: Azure PowerShell üíª

```powershell
Remove-AzResourceGroup -Name "rg-frontdoor-lab" -Force -AsJob
Write-Host "Resource group 'rg-frontdoor-lab' deletion initiated."
```

### Method 3: Azure CLI üñ•Ô∏è

```bash
az group delete --name "rg-frontdoor-lab" --yes --no-wait
echo "Resource group 'rg-frontdoor-lab' deletion initiated."
```