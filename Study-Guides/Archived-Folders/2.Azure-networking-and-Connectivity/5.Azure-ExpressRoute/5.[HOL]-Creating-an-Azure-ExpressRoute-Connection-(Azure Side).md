# Lab: Creating an Azure ExpressRoute Connection (Azure Side) üöÑ

This lab document outlines the steps to configure the Azure components for an ExpressRoute Site-to-Site connection. We will create an ExpressRoute circuit, provision a Virtual Network Gateway for ExpressRoute, and connect them to your Azure Virtual Network.

**Important Note**: This lab covers the **Azure-side configuration only**. A complete ExpressRoute connection requires a physical or logical circuit provided by a third-party ExpressRoute connectivity partner and corresponding configuration on your on-premises network and VPN/router device. This lab will simulate the Azure-side readiness.

## Lab Scenario üåê

We will set up an ExpressRoute connection for an existing Azure Virtual Network.

  * **Azure VNet**: `vnet-prod` (Address space: `10.0.0.0/16`)
  * **Azure GatewaySubnet**: `GatewaySubnet` (Address range: `10.0.100.0/27`)
  * **Resource Group**: `rg-expressroute-lab`
  * **Region**: `East US`
  * **ExpressRoute Circuit Name**: `er-circuit-prod`
  * **ExpressRoute Circuit Provider**: `Equinix` (Example)
  * **ExpressRoute Peering Location**: `Washington DC` (Example, usually matches provider's peering locations)
  * **ExpressRoute Bandwidth**: `50 Mbps` (Example, choose based on needs)
  * **ExpressRoute SKU**: `Standard`
  * **ExpressRoute Gateway Name**: `er-vgw-prod`

-----

## Part 1: Prerequisites & Initial Setup

Before creating the ExpressRoute components, ensure you have:

  * An active Azure Subscription.
  * An existing **Azure Virtual Network (VNet)** where you want to connect ExpressRoute (e.g., `vnet-prod`). If not, create one.
  * A dedicated subnet named **`GatewaySubnet`** within your VNet. This subnet *must* be named `GatewaySubnet` and needs an address prefix of at least `/27` (e.g., `10.0.100.0/27`).
      * If you don't have it, create it first.

Let's assume `vnet-prod` with `10.0.0.0/16` and a `GatewaySubnet` of `10.0.100.0/27` already exist in `rg-expressroute-lab`.

-----

## Part 2: Create the ExpressRoute Circuit

This is the first step on the Azure side, representing your order with the connectivity provider.

### Method 1: Azure Portal üåê

1.  In the Azure Portal, search for and select **"ExpressRoute circuits"**.
2.  Click **"+ Create"**.
3.  **Basics Tab**:
      * **Subscription**: Select your Azure subscription.
      * **Resource Group**: Select `rg-expressroute-lab`.
      * **Region**: Select `East US`.
      * **Name**: Enter `er-circuit-prod`.
      * **Port type**: Select `Provider`.
      * **Create new or import from classic**: Select `Create new`.
      * **Connectivity provider**: Select your chosen provider (e.g., `Equinix`).
      * **Peering location**: Select the desired peering location (e.g., `Washington DC`). This is where your provider connects to Microsoft.
      * **Bandwidth**: Select your desired bandwidth (e.g., `50 Mbps`).
      * **SKU**: Select `Standard` (or `Premium` if needed for global connectivity/more routes).
      * **Billing model**: Select `Unlimited data` (or `Metered data` if preferred).
      * **Allow Classic operations**: `No`.
4.  Click **"Review + create"** and then **"Create"**.
5.  Once deployed, navigate to the `er-circuit-prod` circuit. Note its **Service Key**. You will need to provide this key to your connectivity provider to complete their side of the circuit provisioning. The **Provider status** will initially be `Not Provisioned`. It will change to `Provisioned` once the provider completes their setup.

-----

### Method 2: Azure PowerShell üíª

```powershell
# --- Define Variables ---
$resourceGroupName = "rg-expressroute-lab"
$location = "eastus"
$circuitName = "er-circuit-prod"
$bandwidth = 50 # In Mbps
$skuTier = "Standard"
$skuFamily = "UnlimitedData" # "MeteredData" for metered billing
$peeringLocation = "Washington DC" # Must match your provider's available locations
$serviceProviderName = "Equinix" # Must match your provider's name

# --- Create Resource Group (if it doesn't exist) ---
New-AzResourceGroup -Name $resourceGroupName -Location $location -ErrorAction SilentlyContinue

# --- Create ExpressRoute Circuit ---
$circuit = New-AzExpressRouteCircuit -Name $circuitName `
    -ResourceGroupName $resourceGroupName `
    -Location $location `
    -ServiceProviderName $serviceProviderName `
    -PeeringLocation $peeringLocation `
    -BandwidthInMbps $bandwidth `
    -SkuTier $skuTier `
    -SkuFamily $skuFamily

Write-Host "ExpressRoute circuit '$circuitName' created. Service Key: $($circuit.ServiceKey)"
Write-Host "Provide this Service Key to your connectivity provider to complete the circuit provisioning."

# You can get the circuit details later using:
# Get-AzExpressRouteCircuit -Name $circuitName -ResourceGroupName $resourceGroupName
```

-----

### Method 3: Azure CLI üñ•Ô∏è

```bash
# --- Define Variables ---
resourceGroupName="rg-expressroute-lab"
location="eastus"
circuitName="er-circuit-prod"
bandwidth="50" # In Mbps
skuTier="Standard"
skuFamily="UnlimitedData" # "MeteredData" for metered billing
peeringLocation="Washington DC" # Must match your provider's available locations
serviceProviderName="Equinix" # Must match your provider's name

# --- Create Resource Group (if it doesn't exist) ---
az group create --name $resourceGroupName --location $location

# --- Create ExpressRoute Circuit ---
az network express-route circuit create \
    --resource-group $resourceGroupName \
    --name $circuitName \
    --location $location \
    --provider $serviceProviderName \
    --peering-location $peeringLocation \
    --bandwidth $bandwidth \
    --sku-tier $skuTier \
    --sku-family $skuFamily \
    --tags "Purpose=ExpressRouteLab"

echo "ExpressRoute circuit '$circuitName' created."
echo "Service Key:"
az network express-route circuit show \
    --resource-group $resourceGroupName \
    --name $circuitName \
    --query serviceKey \
    --output tsv

echo "Provide this Service Key to your connectivity provider to complete the circuit provisioning."

# You can get the circuit details later using:
# az network express-route circuit show -g $resourceGroupName -n $circuitName
```

-----

## Part 3: Create the ExpressRoute Virtual Network Gateway

This gateway connects your Azure VNet to the ExpressRoute circuit. It's different from a VPN Gateway.

### Method 1: Azure Portal üåê

1.  Search for "Virtual network gateways" and click **"+ Create"**.
2.  **Basics Tab**:
      * **Subscription**: Your subscription.
      * **Resource Group**: `rg-expressroute-lab`.
      * **Name**: `er-vgw-prod`.
      * **Region**: `East US` (must match your VNet's region).
      * **Gateway type**: Select `ExpressRoute`.
      * **SKU**: Choose a SKU. For ExpressRoute, common SKUs are `Standard`, `HighPerformance`, `UltraPerformance`, `ErGw1Az`, `ErGw2Az`, `ErGw3Az`. Start with `Standard` for this lab.
      * **Virtual network**: Select `vnet-prod`.
      * **Public IP address**: Select "Create new".
          * **Public IP address name**: `pip-er-vgw`.
          * **Assignment**: `Dynamic`.
          * **SKU**: `Basic` for `Standard` SKU gateway, or `Standard` for higher SKUs.
      * **Enable active-active mode**: Leave unchecked for a basic setup.
3.  Click **"Review + create"** and then **"Create"**.
      * **Note**: This deployment takes **30-45 minutes** to complete.

-----

### Method 2: Azure PowerShell üíª

```powershell
# --- Define Variables ---
$vgwName = "er-vgw-prod"
$publicIpName = "pip-er-vgw"
$vnetName = "vnet-prod"
$vnetResourceGroup = "rg-expressroute-lab" # Resource group of your VNet
$location = "eastus"
$vgwSku = "Standard" # ErGw1Az, ErGw2Az, ErGw3Az for Zone Redundant

# --- Get VNet and GatewaySubnet ---
$vnet = Get-AzVirtualNetwork -Name $vnetName -ResourceGroupName $vnetResourceGroup
$subnet = Get-AzVirtualNetworkSubnetConfig -Name "GatewaySubnet" -VirtualNetwork $vnet

# --- Create Public IP Address for the ExpressRoute Gateway ---
$publicIP = New-AzPublicIpAddress -Name $publicIpName `
    -ResourceGroupName $resourceGroupName `
    -Location $location `
    -AllocationMethod Dynamic `
    -Sku Basic # For higher SKUs like ErGw1Az, use Standard

# --- Create Virtual Network Gateway IP Configuration ---
$gwIpConfig = New-AzVirtualNetworkGatewayIpConfig -Name "erGatewayIpConfig" `
    -SubnetId $subnet.Id `
    -PublicIpAddressId $publicIP.Id

# --- Create the ExpressRoute Virtual Network Gateway (This takes 30-45 minutes) ---
New-AzVirtualNetworkGateway -Name $vgwName `
    -ResourceGroupName $resourceGroupName `
    -Location $location `
    -IpConfigurations $gwIpConfig `
    -GatewayType ExpressRoute `
    -GatewaySku $vgwSku `
    -AsJob # Runs as a background job

Write-Host "ExpressRoute Virtual Network Gateway '$vgwName' creation initiated. This will take ~30-45 minutes."
Write-Host "You can check status with: Get-Job -Name '$vgwName'"
# You would typically wait for this job to complete before proceeding.
# Wait-Job -Name $vgwName
# $erVnetGateway = Get-AzVirtualNetworkGateway -Name $vgwName -ResourceGroupName $resourceGroupName
```

-----

### Method 3: Azure CLI üñ•Ô∏è

```bash
# --- Define Variables ---
vgwName="er-vgw-prod"
publicIpName="pip-er-vgw"
vnetName="vnet-prod"
vnetResourceGroup="rg-expressroute-lab"
location="eastus"
vgwSku="Standard" # ErGw1Az, ErGw2Az, ErGw3Az for Zone Redundant

# --- Get VNet ID (assuming it exists in the specified resource group) ---
vnetId=$(az network vnet show -g $vnetResourceGroup -n $vnetName --query id -o tsv)

# --- Create Public IP Address for the ExpressRoute Gateway ---
az network public-ip create \
    --name $publicIpName \
    --resource-group $resourceGroupName \
    --location $location \
    --allocation-method Dynamic \
    --sku Basic # For higher SKUs like ErGw1Az, use Standard

# --- Create the ExpressRoute Virtual Network Gateway (This takes 30-45 minutes) ---
az network vnet gateway create \
    --name $vgwName \
    --resource-group $resourceGroupName \
    --location $location \
    --public-ip-address $publicIpName \
    --vnet $vnetId \
    --gateway-type ExpressRoute \
    --sku $vgwSku \
    --no-wait # Allows command to return while deployment continues in background

echo "ExpressRoute Virtual Network Gateway '$vgwName' creation initiated. This will take ~30-45 minutes."
echo "You can check status with: az network vnet gateway show -g $resourceGroupName -n $vgwName --query provisioningState -o tsv"

# You would typically wait for gateway provisioningState to be 'Succeeded' before proceeding
# while [ "$(az network vnet gateway show -g $resourceGroupName -n $vgwName --query provisioningState -o tsv)" != "Succeeded" ]; do
#     echo "Waiting for ExpressRoute Gateway to provision..."
#     sleep 30
# done
# echo "ExpressRoute Gateway provisioned."
```

-----

## Part 4: Link the ExpressRoute Circuit to the Virtual Network Gateway

This step establishes the connection between your ExpressRoute circuit and your Azure VNet via the gateway. This connection defines the **Private Peering**.

**Pre-requisite**: The **Provider status** of your ExpressRoute circuit must be `Provisioned` before you can link it. This means your connectivity provider has completed their setup using the Service Key you provided. For lab purposes, you'll need to assume this has happened for the Azure-side steps to work fully.

### Method 1: Azure Portal üåê

1.  Navigate to your **ExpressRoute circuit** (`er-circuit-prod`).
2.  In the left-hand menu, under **Settings**, select **Connections**.
3.  Click **"+ Add"**.
4.  **Add connection**:
      * **Name**: `conn-er-to-vnetprod`.
      * **Virtual network gateway**: Select your ExpressRoute Virtual Network Gateway (`er-vgw-prod`).
      * **Circuit**: Automatically populated (`er-circuit-prod`).
      * **Authorization key**: Leave blank unless you're connecting a VNet from a different subscription and need an authorization from the circuit owner.
      * **Weight**: Leave default (can be used for routing preferences if multiple connections).
5.  Click **"OK"**.
      * The connection status will show as `Connected` once the link is successfully established and the circuit is provisioned by the provider.

-----

### Method 2: Azure PowerShell üíª

```powershell
# --- Define Variables ---
$connectionName = "conn-er-to-vnetprod"
$vgwName = "er-vgw-prod"
$circuitName = "er-circuit-prod"
$resourceGroupName = "rg-expressroute-lab"

# --- Get ExpressRoute Circuit and Virtual Network Gateway objects ---
$circuit = Get-AzExpressRouteCircuit -Name $circuitName -ResourceGroupName $resourceGroupName
$vgw = Get-AzVirtualNetworkGateway -Name $vgwName -ResourceGroupName $resourceGroupName

# --- Create the Connection ---
New-AzVirtualNetworkGatewayConnection -Name $connectionName `
    -ResourceGroupName $resourceGroupName `
    -Location $vgw.Location `
    -VirtualNetworkGateway1 $vgw `
    -PeerId $circuit.Id ` # Link to the ExpressRoute Circuit
    -ConnectionType ExpressRoute `
    -RoutingWeight 10 # Optional: Adjust for routing preference

Write-Host "Connection '$connectionName' linking ExpressRoute circuit to VNet Gateway created."
Write-Host "The connection status will be 'Connected' once the ExpressRoute circuit's provider status is 'Provisioned'."
```

-----

### Method 3: Azure CLI üñ•Ô∏è

```bash
# --- Define Variables ---
connectionName="conn-er-to-vnetprod"
vgwName="er-vgw-prod"
circuitName="er-circuit-prod"
resourceGroupName="rg-expressroute-lab"

# --- Get ExpressRoute Circuit ID and Virtual Network Gateway ID ---
circuitId=$(az network express-route circuit show -g $resourceGroupName -n $circuitName --query id -o tsv)
vgwId=$(az network vnet gateway show -g $resourceGroupName -n $vgwName --query id -o tsv)

# --- Create the Connection ---
az network vnet gateway connection create \
    --name $connectionName \
    --resource-group $resourceGroupName \
    --vnet-gateway1 $vgwId \
    --express-route-circuit2 $circuitId \
    --connection-type ExpressRoute \
    --location $location # Location of the gateway

echo "Connection '$connectionName' linking ExpressRoute circuit to VNet Gateway created."
echo "The connection status will be 'Connected' once the ExpressRoute circuit's provider status is 'Provisioned'."
```

-----

## Part 5: Conceptual - On-Premises & Provider Side Interactions

Once the Azure-side configuration is complete and your ExpressRoute circuit's **Provider status** is `Provisioned`:

1.  **Provide Service Key**: You would have already given the **Service Key** (from Part 2) to your chosen ExpressRoute connectivity provider.
2.  **Provider Configuration**: The provider uses this key to provision the logical connection on their side, linking their network to Microsoft's network at the peering location.
3.  **On-Premises Configuration**:
      * Your network team/provider will configure your on-premises VPN device/router to establish **BGP peering sessions** with Microsoft's edge routers over the ExpressRoute circuit.
      * They will advertise your on-premises network IP ranges to Azure via BGP.
      * Azure will advertise your VNet IP ranges (and optionally public PaaS service routes via Microsoft Peering) to your on-premises network.
4.  **Traffic Flow**: Once BGP peering is established and routes are exchanged, traffic between your on-premises network and your Azure VNet will flow securely and privately over the ExpressRoute circuit.

This lab provides the essential Azure-side foundation for an ExpressRoute connection, preparing your Azure environment for high-performance, private connectivity.