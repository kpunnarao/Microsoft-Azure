# Configuring a Simple Azure Load Balancer üõ†Ô∏è

Configuring a simple Azure Load Balancer involves setting up its core components: a frontend IP, a backend pool, a health probe, and load balancing rules. 

We'll focus on the **Standard Load Balancer** as it's the recommended SKU for new deployments.

-----

## Scenario: Load Balancing Web Traffic

  * **Goal**: Distribute incoming HTTP (port 80) traffic to two backend web servers (VMs).
  * **Load Balancer SKU**: Standard
  * **Frontend IP**: Public IP address
  * **Backend Pool**: Two Windows Server VMs with IIS installed (listening on port 80).

### Prerequisites üìã

Before you start, ensure you have:

1.  **An Azure Virtual Network (VNet)**: For example, `vnet-web-prod` (e.g., `10.0.0.0/16`).
2.  **A Subnet within the VNet**: For example, `snet-webservers` (e.g., `10.0.0.0/24`).
3.  **Two Virtual Machines (VMs)**: Deployed into the `snet-webservers` subnet.
      * Ensure each VM has a **Network Interface Card (NIC)**.
      * Ensure each VM has an **IIS (web server)** running and listening on port 80.
      * **Crucially**: For a **Standard Load Balancer**, **NSGs (Network Security Groups)** must be configured on the VM's NICs or the subnet to allow inbound traffic on port 80 (and potentially 3389 for RDP if you need to manage them). Standard Load Balancers are secure by default, meaning they deny all inbound traffic unless explicitly allowed by an NSG.

-----

## Method 1: Azure Portal üåê

The Azure portal provides a user-friendly graphical interface for creating and managing resources.

### 1\. Create the Load Balancer Resource

1.  **Search**: In the Azure portal, search for "Load balancers" and select it.
2.  **Create**: Click "+ Create" or "Create load balancer".
3.  **Basics Tab**:
      * **Subscription**: Select your Azure subscription.
      * **Resource group**: Choose an existing or create a new one (e.g., `rg-lb-prod`).
      * **Name**: Give your Load Balancer a descriptive name (e.g., `lb-web-prod`).
      * **Region**: Select the region where your VNet and VMs are located (e.g., `East US`).
      * **SKU**: Select **Standard**.
      * **Type**: Select **Public** (for internet-facing access). If you wanted an internal LB, you'd choose `Internal`.
      * **Tier**: Leave as `Regional`.
4.  Click **"Review + create"** and then **"Create"**. This deploys the basic Load Balancer resource.

### 2\. Configure Frontend IP Configuration

This is the public IP address clients will use to reach your application.

1.  Navigate to your newly created Load Balancer (`lb-web-prod`) in the Azure portal.
2.  In the left-hand menu, under **Settings**, select **Frontend IP configuration**.
3.  Click **"+ Add"**.
4.  **Add frontend IP configuration**:
      * **Name**: `feip-web-public`
      * **IP version**: `IPv4`
      * **IP type**: `IP address`
      * **Public IP address**: Select "Create new".
          * **Name**: `pip-web-lb`
          * **SKU**: `Standard` (must match LB SKU).
          * **Availability zone**: Choose `No zone`, `Zone-redundant`, or a specific zone (e.g., `Zone 1`). For simplicity, `No zone` works for a basic setup.
      * Click **"Add"**.

### 3\. Configure Backend Pool

This defines the group of VMs that will receive the load-balanced traffic.

1.  In the Load Balancer's menu, under **Settings**, select **Backend pools**.
2.  Click **"+ Add"**.
3.  **Add backend pool**:
      * **Name**: `bepool-webservers`
      * **Virtual network**: Select your VNet (e.g., `vnet-web-prod`).
      * **Backend Pool Configuration**: Select `IP Address`. (Note: for Basic LB, this would be NIC).
      * **IP Version**: `IPv4`
      * **Add**: Click **"+ Add"** to add your virtual machines.
          * For each VM:
              * **Virtual machine**: Select one of your web server VMs (e.g., `vm-web-01`).
              * **IP address**: Select its private IP from the dropdown (e.g., `10.0.0.4`).
          * Repeat for all VMs in your backend.
      * Click **"Add"**.
      * Click **"Save"**.

### 4\. Configure Health Probe

This monitors the health of your backend VMs so the Load Balancer only sends traffic to healthy instances.

1.  In the Load Balancer's menu, under **Settings**, select **Health probes**.
2.  Click **"+ Add"**.
3.  **Add health probe**:
      * **Name**: `hp-http-80`
      * **Protocol**: `HTTP` (or `TCP` if you don't have a web server).
      * **Port**: `80` (the port your web server listens on).
      * **Path**: `/` (for HTTP, points to the root of your website).
      * **Interval**: `5` (seconds, how often to probe).
      * **Unhealthy threshold**: `2` (consecutive failures before an instance is marked unhealthy).
      * Click **"Add"**.

### 5\. Configure Load Balancing Rule

This defines how incoming traffic from the frontend is distributed to the backend pool based on the health probe.

1.  In the Load Balancer's menu, under **Settings**, select **Load balancing rules**.
2.  Click **"+ Add"**.
3.  **Add load balancing rule**:
      * **Name**: `lbrule-http-80`
      * **Frontend IP address**: Select `feip-web-public` (the public frontend IP you created).
      * **Backend pool**: Select `bepool-webservers`.
      * **Protocol**: `TCP`.
      * **Port**: `80` (the port the Load Balancer listens on).
      * **Backend port**: `80` (the port on the backend VMs).
      * **Health probe**: Select `hp-http-80`.
      * **Session persistence**: `None` (default, round-robin), or `Client IP` if you need stickiness.
      * **Idle timeout (minutes)**: `4` (default).
      * **Enable TCP reset**: Check this box (recommended for Standard LB).
      * **Floating IP (Direct Server Return)**: `Disabled` (unless you have specific advanced scenarios like SQL AlwaysOn availability groups).
      * Click **"Add"**.

-----

## Method 2: Azure PowerShell üíª

Azure PowerShell allows you to manage Azure resources using cmdlets. You can run these commands in Azure Cloud Shell (PowerShell environment) or a local PowerShell installation with the Azure Az module.

```powershell
# --- 1. Define Variables ---
$resourceGroupName = "rg-lb-prod"
$location = "eastus"
$vnetName = "vnet-web-prod"
$subnetName = "snet-webservers"
$lbName = "lb-web-prod"
$publicIpName = "pip-web-lb"
$feIpConfigName = "feip-web-public"
$backendPoolName = "bepool-webservers"
$healthProbeName = "hp-http-80"
$lbRuleName = "lbrule-http-80"

# --- 2. Create Resource Group (if it doesn't exist) ---
New-AzResourceGroup -Name $resourceGroupName -Location $location -ErrorAction SilentlyContinue

# --- 3. Create Public IP Address for Load Balancer Frontend ---
$publicIP = New-AzPublicIpAddress -ResourceGroupName $resourceGroupName `
    -Name $publicIpName `
    -Location $location `
    -AllocationMethod Static `
    -Sku Standard `
    -Zone 1 # Can use 'NoZone' or specify a zone (e.g., '1') for Zonal LB

# --- 4. Create Load Balancer Frontend IP Configuration ---
$frontendIP = New-AzLoadBalancerFrontendIpConfig -Name $feIpConfigName `
    -PublicIpAddress $publicIP

# --- 5. Create Backend Pool Configuration ---
$backendPool = New-AzLoadBalancerBackendAddressPoolConfig -Name $backendPoolName

# --- 6. Create Health Probe Configuration ---
$healthProbe = New-AzLoadBalancerProbeConfig -Name $healthProbeName `
    -RequestPath "/" `
    -Port 80 `
    -Protocol Http `
    -IntervalInSeconds 5 `
    -ProbeCount 2

# --- 7. Create Load Balancing Rule Configuration ---
$lbRule = New-AzLoadBalancerRuleConfig -Name $lbRuleName `
    -FrontendIpConfiguration $frontendIP `
    -BackendAddressPool $backendPool `
    -Probe $healthProbe `
    -Protocol Tcp `
    -FrontendPort 80 `
    -BackendPort 80 `
    -LoadDistribution Default `
    -IdleTimeoutInMinutes 4 `
    -EnableTcpReset $true

# --- 8. Create the Standard Load Balancer ---
$loadBalancer = New-AzLoadBalancer -Name $lbName `
    -ResourceGroupName $resourceGroupName `
    -Location $location `
    -Sku Standard `
    -FrontendIpConfiguration $frontendIP `
    -BackendAddressPool $backendPool `
    -LoadBalancingRule $lbRule `
    -Probe $healthProbe

Write-Host "Load Balancer '$lbName' created successfully."

# --- 9. Add VMs to the Backend Pool ---
# Get the NICs of your web server VMs
# Replace 'vm-web-01' and 'vm-web-02' with your actual VM names and NICs
$vm1Nic = Get-AzNetworkInterface -ResourceGroupName $resourceGroupName -Name "vm-web-01-nic" # Assumes NIC name
$vm2Nic = Get-AzNetworkInterface -ResourceGroupName $resourceGroupName -Name "vm-web-02-nic" # Assumes NIC name

# Add NICs to the Load Balancer's backend pool
# Note: For Standard LB, we link the NIC's IP configuration to the backend pool.
# Each VM's primary IP config should be added.
$vm1Nic.IpConfigurations[0].LoadBalancerBackendAddressPools = @($loadBalancer.BackendAddressPools[0])
$vm2Nic.IpConfigurations[0].LoadBalancerBackendAddressPools = @($loadBalancer.BackendAddressPools[0])

Set-AzNetworkInterface -NetworkInterface $vm1Nic
Set-AzNetworkInterface -NetworkInterface $vm2Nic

Write-Host "VMs added to the Load Balancer backend pool."
```

**Explanation:**

  * You first define configurations for each component (Frontend IP, Backend Pool, Health Probe, Rule) using `New-AzLoadBalancer...Config` cmdlets. These are in-memory objects.
  * Then, `New-AzLoadBalancer` brings all these configurations together to create the Load Balancer resource in Azure.
  * Finally, you retrieve the Network Interface Cards (NICs) of your VMs and update their IP configurations to be part of the Load Balancer's backend pool. This is how the VMs are "hooked up" to the LB.

-----

## Method 3: Azure CLI üñ•Ô∏è

The Azure CLI is a command-line tool that allows you to execute commands against Azure resources. You can run these commands in Azure Cloud Shell (Bash environment) or a local Azure CLI installation.

```bash
# --- 1. Define Variables ---
resourceGroupName="rg-lb-prod"
location="eastus"
vnetName="vnet-web-prod"
subnetName="snet-webservers"
lbName="lb-web-prod"
publicIpName="pip-web-lb"
feIpConfigName="feip-web-public"
backendPoolName="bepool-webservers"
healthProbeName="hp-http-80"
lbRuleName="lbrule-http-80"

# --- 2. Create Resource Group (if it doesn't exist) ---
az group create --name $resourceGroupName --location $location

# --- 3. Create Public IP Address for Load Balancer Frontend ---
az network public-ip create \
    --resource-group $resourceGroupName \
    --name $publicIpName \
    --sku Standard \
    --zone 1 \
    --allocation-method Static \
    --query "ipAddress" -o tsv # Use --zone 1 for zonal, remove for NoZone

# --- 4. Create the Standard Load Balancer ---
# This command creates the LB and its frontend IP configuration and backend pool.
az network lb create \
    --resource-group $resourceGroupName \
    --name $lbName \
    --sku Standard \
    --location $location \
    --frontend-ip-name $feIpConfigName \
    --public-ip-address $publicIpName \
    --backend-pool-name $backendPoolName

echo "Load Balancer '$lbName' created successfully with frontend and backend pool."

# --- 5. Create Health Probe ---
az network lb probe create \
    --resource-group $resourceGroupName \
    --lb-name $lbName \
    --name $healthProbeName \
    --protocol Http \
    --port 80 \
    --path / \
    --interval 5 \
    --threshold 2

echo "Health probe '$healthProbeName' created."

# --- 6. Create Load Balancing Rule ---
az network lb rule create \
    --resource-group $resourceGroupName \
    --lb-name $lbName \
    --name $lbRuleName \
    --protocol Tcp \
    --frontend-port 80 \
    --backend-port 80 \
    --frontend-ip-name $feIpConfigName \
    --backend-pool-name $backendPoolName \
    --probe-name $healthProbeName \
    --disable-outbound-snat false # Enable outbound SNAT implicitly for the LB. Standard LBs are secure by default.
                                 # Alternatively, setup an Outbound Rule or NAT Gateway.

echo "Load balancing rule '$lbRuleName' created."

# --- 7. Add VMs to the Backend Pool ---
# You need the IDs of your VMs' Network Interfaces.
# Replace 'vm-web-01' and 'vm-web-02' with your actual VM names.
# This adds the VM's primary IP configuration to the backend pool.

vm1NicId=$(az vm nic list --resource-group $resourceGroupName --vm-name vm-web-01 --query "[0].id" -o tsv)
vm2NicId=$(az vm nic list --resource-group $resourceGroupName --vm-name vm-web-02 --query "[0].id" -o tsv)

az network nic ip-config update \
    --resource-group $resourceGroupName \
    --nic-name $(basename $vm1NicId) \
    --name ipconfig1 \
    --lb-address-pools $backendPoolName

az network nic ip-config update \
    --resource-group $resourceGroupName \
    --nic-name $(basename $vm2NicId) \
    --name ipconfig1 \
    --lb-address-pools $backendPoolName

echo "VMs added to the Load Balancer backend pool."
```

**Explanation:**

  * The `az network lb create` command is powerful; it can create the Load Balancer, its public IP, frontend IP configuration, and a backend pool all at once.
  * Subsequent commands (`az network lb probe create`, `az network lb rule create`) are used to add the health probe and load balancing rule to the *existing* Load Balancer.
  * Finally, you update the IP configuration of each VM's NIC to associate it with the backend pool using `az network nic ip-config update`.

-----

## Post-Configuration / Verification ‚úÖ

Regardless of the method you used:

1.  **NSG Configuration**: **Crucially**, ensure you have an **NSG rule** on the *subnet* of your web servers (or directly on their NICs) that allows **Inbound** traffic:

      * **Source**: `Any` or a specific IP/range if you want to restrict public access.
      * **Source port ranges**: `*`
      * **Destination**: `Any` or `VirtualNetwork`
      * **Destination port ranges**: `80`
      * **Protocol**: `TCP`
      * **Action**: `Allow`
      * **Priority**: A lower number (higher priority) than `DenyAllInbound` (e.g., 1000).

    Without this NSG rule, the Standard Load Balancer will not be able to send traffic to your VMs, as it's **secure by default** and requires explicit NSG allowance.

2.  **Test Connectivity**:

      * Open a web browser and navigate to the **Public IP address** of your Load Balancer (from the Frontend IP configuration).
      * You should see your web application responding. If you refresh, depending on the load balancing algorithm, you might see responses from different backend VMs if you've configured them to display unique identifiers.

3.  **Monitor Health**: In the Load Balancer's blade in the portal, check **Backend pools** or **Health probes** to ensure your VMs are reported as healthy.

-----

You have now successfully configured a simple Standard Azure Load Balancer to distribute web traffic to your backend virtual machines, providing high availability and scalability for your application.