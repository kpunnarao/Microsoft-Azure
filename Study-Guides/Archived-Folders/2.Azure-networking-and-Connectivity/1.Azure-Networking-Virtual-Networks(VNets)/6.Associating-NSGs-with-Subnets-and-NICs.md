# Associating NSGs with Subnets and NICs ðŸ”—

Network Security Groups (NSGs) are only effective once they are **associated** with the Azure resources they are intended to protect. 

In Azure, you can associate an NSG with either a **subnet** or an individual **Network Interface Card (NIC)**, or both. Understanding these association points is crucial for designing and implementing your network security strategy.

---

## Association Points: Subnet vs. NIC

An NSG can be applied at two levels within a Virtual Network (VNet):

1.  **Subnet Association**:
    * When an NSG is associated with a **subnet**, its rules are applied to **all** resources (e.g., Virtual Machines, Application Gateways, Azure Kubernetes Service nodes) deployed within that subnet.
    * This provides a **broad layer of security** for a group of resources that share similar security requirements.
    * It's a common and recommended practice to associate NSGs at the subnet level to establish a baseline security posture for all resources in that segment.
    * **Traffic Flow**:
        * **Inbound**: Rules are evaluated when traffic *enters* the subnet.
        * **Outbound**: Rules are evaluated when traffic *leaves* the subnet.

2.  **Network Interface Card (NIC) Association**:
    * When an NSG is associated with a **NIC** (which is attached to a Virtual Machine), its rules are applied specifically to that individual NIC, regardless of the subnet it's in.
    * This provides a **finer-grained level of security**, allowing you to apply unique rules to a specific VM or application, even if other VMs in the same subnet have different requirements.
    * **Traffic Flow**:
        * **Inbound**: Rules are evaluated when traffic *enters* the NIC.
        * **Outbound**: Rules are evaluated when traffic *leaves* the NIC.

### Why have two association points? ðŸ¤”

Having both subnet and NIC associations provides flexibility and layered security:

* **Layered Security**: You can have a general NSG on the subnet for common security policies (e.g., "allow internal VNet communication") and then a more specific NSG on a particular VM's NIC for unique requirements of that VM (e.g., "allow RDP only from my workstation IP").
* **Granular Control**: If a subnet hosts multiple types of VMs with differing security needs, applying NSGs at the NIC level allows for precise control without affecting other VMs in the same subnet.

---

## How NSG Rules Are Applied When Both Are Present ðŸš¦

When an NSG is associated with **both** the subnet and the NIC:

* **Inbound Traffic**:
    * Rules are evaluated first by the **subnet NSG**. If the subnet NSG denies the traffic, it's dropped, and the NIC NSG is never evaluated.
    * If the subnet NSG allows the traffic, then the **NIC NSG** rules are evaluated. If the NIC NSG denies the traffic, it's dropped.
    * For traffic to reach the VM, **both** the subnet NSG and the NIC NSG must explicitly allow it. It's an "AND" condition.

* **Outbound Traffic**:
    * Rules are evaluated first by the **NIC NSG**. If the NIC NSG denies the traffic, it's dropped, and the subnet NSG is never evaluated.
    * If the NIC NSG allows the traffic, then the **subnet NSG** rules are evaluated. If the subnet NSG denies the traffic, it's dropped.
    * For traffic to leave the VM, **both** the NIC NSG and the subnet NSG must explicitly allow it. It's also an "AND" condition.

**Analogy**: Think of it like a bouncer at the club door (Subnet NSG) and another bouncer at the VIP section entrance (NIC NSG).
* **Inbound**: You first need to get past the main door bouncer. If they say no, you're out. If they say yes, you then face the VIP bouncer.
* **Outbound**: When leaving the VIP section, you first face the VIP bouncer. If they say no, you're stuck. If they say yes, you then face the main door bouncer to exit the club.

---

## Practical Steps to Associate NSGs (Azure Portal) ðŸ’»

### 1. Associate an NSG with a Subnet:

1.  In the Azure portal, search for and select **Virtual networks**.
2.  Select the VNet that contains the subnet you want to protect.
3.  In the VNet's menu, under **Settings**, select **Subnets**.
4.  Select the subnet you want to associate the NSG with.
5.  In the subnet's blade, for the **Network security group** field, click on the dropdown.
6.  Select an existing NSG from the list. If you don't have one, you'll need to create it first.
7.  Click **Save**.

### 2. Associate an NSG with a NIC:

1.  In the Azure portal, search for and select **Virtual machines**.
2.  Select the VM you want to protect.
3.  In the VM's menu, under **Settings**, select **Networking**.
4.  Click on the **Network Interface** name (e.g., `myvm_nic_0`).
5.  In the NIC's blade, under **Settings**, select **Network security group**.
6.  Click **Edit** (or **Configure network security group**).
7.  Click on the dropdown for **Network security group**.
8.  Select an existing NSG from the list.
9.  Click **Save**.

---

## Important Considerations and Best Practices âœ¨

* **Plan Your Security Layers**: Decide whether you need broad subnet-level security, fine-grained NIC-level security, or a combination of both. Most commonly, a **subnet-level NSG is a good starting point** for most deployments, providing a baseline of protection for all resources in that segment.
* **Least Privilege**: Always follow the principle of least privilege â€“ only allow traffic that is absolutely necessary. Explicitly deny traffic that is not needed.
* **Default Rules**: Be aware of the **default NSG rules** (which we'll cover next). They are automatically present in every NSG and define baseline allow/deny behavior. Your custom rules will override these if they have a higher priority.
* **Management Complexity**: While NIC-level NSGs offer granular control, they can increase management complexity, especially in environments with many VMs. Use them judiciously for specific, isolated security needs.
* **Testing**: Always test your NSG rules after implementation to ensure they are working as expected and not inadvertently blocking legitimate traffic or allowing unauthorized access.
* **Service Endpoints / Private Link**: For secure connectivity to Azure platform services (like Azure Storage, SQL Database), consider using **Service Endpoints** or **Private Link** instead of NSGs to control access over public IPs. These offer a more secure and performant way to access services privately within your VNet.

Understanding how to associate NSGs is key to effectively implementing your network security policies in Azure.