
# Lab: Enhancing Security with Application Security Groups (ASGs) 🚀

This lab builds upon the concept of Network Security Groups (NSGs) by introducing **Application Security Groups (ASGs)**. 

You'll learn how ASGs simplify NSG rule management by allowing you to define security policies based on logical groups of virtual machines (VMs), rather than individual IP addresses.

## Lab Scenario 🏰

We will create a multi-tier application environment with two types of VMs: "Web Servers" and "Database Servers". We'll then use ASGs with NSG rules to enforce the following security policy:

  * **Web Servers to Database Servers**: Only allow specific database traffic (e.g., SQL Server Port 1433) from Web Servers to Database Servers.

  * **Default Deny**: All other traffic is implicitly denied by the NSG.

  * **Resource Group**: `rg-asg-lab`

  * **Location**: `East US` (or a region close to you)

  * **Virtual Network**: `vnet-asg-app` (`10.0.0.0/16`)

  * **Subnet Web**: `subnet-web` (`10.0.0.0/24`)

  * **Subnet DB**: `subnet-db` (`10.0.1.0/24`)

  * **VMs**:

      * `vm-asg-web-01` (in `subnet-web`)
      * `vm-asg-db-01` (in `subnet-db`)

  * **Application Security Groups**:

      * `asg-web`
      * `asg-db`

  * **Network Security Group**: `nsg-asg-policy` (associated with subnets)

-----

## Part 1: Prerequisites & Initial Setup

Before you begin, ensure you have:

  * An active Azure Subscription.
  * The Azure CLI or Azure PowerShell installed and configured, or use Azure Cloud Shell.

### Create the Resource Group and Virtual Network 🌐

### Method 1: Azure Portal 🌐

1.  **Create Resource Group**:
      * Search for "Resource groups" and click **"+ Create"**.
      * Subscription: Your subscription.
      * Resource Group name: `rg-asg-lab`.
      * Region: `East US`.
      * Review + create, then Create.
2.  **Create Virtual Network**:
      * Search for "Virtual networks" and click **"+ Create"**.
      * Basics Tab:
          * Subscription: Your subscription.
          * Resource Group: `rg-asg-lab`.
          * Name: `vnet-asg-app`.
          * Region: `East US`.
      * IP Addresses Tab:
          * IPv4 address space: `10.0.0.0/16`.
          * Subnets:
              * Delete the default subnet if it exists.
              * Click **"+ Add subnet"**:
                  * Name: `subnet-web`, Address range: `10.0.0.0/24`. Add.
              * Click **"+ Add subnet"**:
                  * Name: `subnet-db`, Address range: `10.0.1.0/24`. Add.
      * Review + Create, then Create.

-----

### Method 2: Azure PowerShell 💻

```powershell
# --- Define Variables ---
$resourceGroupName = "rg-asg-lab"
$location = "eastus"
$vnetName = "vnet-asg-app"
$webSubnetName = "subnet-web"
$dbSubnetName = "subnet-db"

# --- Create Resource Group ---
Write-Host "Creating Resource Group: $resourceGroupName..."
New-AzResourceGroup -Name $resourceGroupName -Location $location

# --- Create Virtual Network with Subnets ---
Write-Host "Creating Virtual Network: $vnetName with subnets..."
$webSubnet = New-AzVirtualNetworkSubnetConfig -Name $webSubnetName -AddressPrefix "10.0.0.0/24"
$dbSubnet = New-AzVirtualNetworkSubnetConfig -Name $dbSubnetName -AddressPrefix "10.0.1.0/24"

New-AzVirtualNetwork -Name $vnetName -ResourceGroupName $resourceGroupName `
    -Location $location -AddressPrefix "10.0.0.0/16" `
    -Subnet $webSubnet, $dbSubnet

Write-Host "Virtual Network and subnets created."
```

-----

### Method 3: Azure CLI 🖥️

```bash
# --- Define Variables ---
resourceGroupName="rg-asg-lab"
location="eastus"
vnetName="vnet-asg-app"
webSubnetName="subnet-web"
dbSubnetName="subnet-db"

# --- Create Resource Group ---
echo "Creating Resource Group: $resourceGroupName..."
az group create --name $resourceGroupName --location $location

# --- Create Virtual Network with Subnets ---
echo "Creating Virtual Network: $vnetName with subnets..."
az network vnet create \
    --resource-group $resourceGroupName \
    --name $vnetName \
    --address-prefix 10.0.0.0/16 \
    --subnet-name $webSubnetName \
    --subnet-prefix 10.0.0.0/24

az network vnet subnet create \
    --resource-group $resourceGroupName \
    --vnet-name $vnetName \
    --name $dbSubnetName \
    --address-prefix 10.0.1.0/24

echo "Virtual Network and subnets created."
```

-----

## Part 2: Create Application Security Groups (ASGs)

ASGs are collections of network interfaces (NICs) that you can target in NSG rules. This allows you to group VMs by application role instead of by explicit IP addresses, making rules more reusable and easier to manage.

### Method 1: Azure Portal 🌐

1.  Search for "Application security groups" and click **"+ Create"**.
2.  **ASG 1 (`asg-web`)**:
      * Basics Tab:
          * Subscription: Your subscription.
          * Resource Group: `rg-asg-lab`.
          * Name: `asg-web`.
          * Region: `East US`.
      * Review + create, then Create.
3.  **ASG 2 (`asg-db`)**: Repeat steps for ASG 1, but change the Name to `asg-db`.

-----

### Method 2: Azure PowerShell 💻

```powershell
# --- Define ASG Variables ---
$asgWebName = "asg-web"
$asgDbName = "asg-db"

# --- Create ASG Web ---
Write-Host "Creating Application Security Group: $asgWebName..."
New-AzApplicationSecurityGroup -Name $asgWebName `
    -ResourceGroupName $resourceGroupName `
    -Location $location

# --- Create ASG DB ---
Write-Host "Creating Application Security Group: $asgDbName..."
New-AzApplicationSecurityGroup -Name $asgDbName `
    -ResourceGroupName $resourceGroupName `
    -Location $location

Write-Host "Application Security Groups created."
```

-----

### Method 3: Azure CLI 🖥️

```bash
# --- Define ASG Variables ---
asgWebName="asg-web"
asgDbName="asg-db"

# --- Create ASG Web ---
echo "Creating Application Security Group: $asgWebName..."
az network asg create \
    --name $asgWebName \
    --resource-group $resourceGroupName \
    --location $location

# --- Create ASG DB ---
echo "Creating Application Security Group: $asgDbName..."
az network asg create \
    --name $asgDbName \
    --resource-group $resourceGroupName \
    --location $location

echo "Application Security Groups created."
```

-----

## Part 3: Create Backend Virtual Machines and Assign to ASGs

We'll create two Windows Server VMs. One will be a "Web Server" and assigned to `asg-web`, and the other will be a "Database Server" and assigned to `asg-db`.

### Method 1: Azure Portal 🌐

1.  **Create VM 1 (`vm-asg-web-01`)**:

      * Search for "Virtual machines" and click **"+ Create"** -\> "Azure virtual machine".
      * Basics Tab:
          * Subscription: Your subscription.
          * Resource Group: `rg-asg-lab`.
          * Virtual machine name: `vm-asg-web-01`.
          * Region: `East US`.
          * Image: `Windows Server 2019 Datacenter`.
          * Size: `Standard_B2s`.
          * Administrator account: Create username/password.
          * Public inbound ports: `None`.
      * Disks Tab: Accept defaults.
      * Networking Tab:
          * Virtual network: `vnet-asg-app`.
          * Subnet: `subnet-web`.
          * Public IP: `None` (We're focusing on internal traffic rules for this lab).
          * NIC network security group: `None` (NSG will be associated with the subnet).
          * **Application security groups**: Select `asg-web`.
      * Management, Monitoring, Advanced, Tags: Accept defaults.
      * Review + Create, then Create.

2.  **Create VM 2 (`vm-asg-db-01`)**: Repeat steps for VM 1, but with:

      * Virtual machine name: `vm-asg-db-01`.
      * Subnet: `subnet-db`.
      * Public IP: `None`.
      * **Application security groups**: Select `asg-db`.
      * Review + Create, then Create.

3.  **Prepare VMs for Testing**:

      * **Allow RDP from your client IP to *any* VM (temporarily)**: For initial setup, you'll need a way to connect. The easiest is to temporarily add an **inbound NSG rule to the *NIC* of each VM** to allow RDP from your public IP address. **Remember to remove these NIC-level rules later** as our goal is subnet-level NSG control.
      * Connect to `vm-asg-web-01` via RDP. Create a simple text file on the desktop named `web_status.txt` with content like: `This is the Web Server.`
      * Connect to `vm-asg-db-01` via RDP. Create a simple text file on the desktop named `db_status.txt` with content like: `This is the Database Server. DB connectivity test successful!` (This will simulate a database response).

-----

### Method 2: Azure PowerShell 💻

```powershell
# --- Define VM Variables ---
$vmAdminUsername = "localadmin"
$vmAdminPassword = "YourSecurePassword123!" | ConvertTo-SecureString -AsPlainText -Force

# Get ASG IDs
$asgWebId = (Get-AzApplicationSecurityGroup -Name $asgWebName -ResourceGroupName $resourceGroupName).Id
$asgDbId = (Get-AzApplicationSecurityGroup -Name $asgDbName -ResourceGroupName $resourceGroupName).Id

# Get Subnets
$webSubnet = Get-AzVirtualNetworkSubnetConfig -Name $webSubnetName -VirtualNetworkName $vnetName -ResourceGroupName $resourceGroupName
$dbSubnet = Get-AzVirtualNetworkSubnetConfig -Name $dbSubnetName -VirtualNetworkName $vnetName -ResourceGroupName $resourceGroupName

# --- Create VM 1 (Web Server) ---
Write-Host "Creating VM: vm-asg-web-01..."
$nicWeb = New-AzNetworkInterface -Name "nic-asg-web-01" `
    -ResourceGroupName $resourceGroupName `
    -Location $location `
    -SubnetId $webSubnet.Id `
    -ApplicationSecurityGroupId $asgWebId # Assign to ASG

New-AzVM -ResourceGroupName $resourceGroupName `
    -Name "vm-asg-web-01" `
    -Location $location `
    -Image "Win2019Datacenter" `
    -Size "Standard_B1s" `
    -Credential (New-Object System.Management.Automation.PSCredential($vmAdminUsername, $vmAdminPassword)) `
    -NetworkInterface $nicWeb `
    -DisableBootDiagnostics

# --- Create VM 2 (DB Server) ---
Write-Host "Creating VM: vm-asg-db-01..."
$nicDb = New-AzNetworkInterface -Name "nic-asg-db-01" `
    -ResourceGroupName $resourceGroupName `
    -Location $location `
    -SubnetId $dbSubnet.Id `
    -ApplicationSecurityGroupId $asgDbId # Assign to ASG

New-AzVM -ResourceGroupName $resourceGroupName `
    -Name "vm-asg-db-01" `
    -Location $location `
    -Image "Win2019Datacenter" `
    -Size "Standard_B1s" `
    -Credential (New-Object System.Management.Automation.PSCredential($vmAdminUsername, $vmAdminPassword)) `
    -NetworkInterface $nicDb `
    -DisableBootDiagnostics

Write-Host "VMs creation initiated. This will take a few minutes."
Write-Host "Remember to temporarily allow RDP via NIC NSGs to connect and prepare VMs."
```

-----

### Method 3: Azure CLI 🖥️

```bash
# --- Define VM Variables ---
vmAdminUsername="localadmin"
vmAdminPassword="YourSecurePassword123!"

# Get ASG IDs
asgWebId=$(az network asg show --name $asgWebName --resource-group $resourceGroupName --query id -o tsv)
asgDbId=$(az network asg show --name $asgDbName --resource-group $resourceGroupName --query id -o tsv)

# --- Create VM 1 (Web Server) ---
echo "Creating VM: vm-asg-web-01..."
az vm create \
    --resource-group $resourceGroupName \
    --name "vm-asg-web-01" \
    --image Win2019Datacenter \
    --size Standard_B1s \
    --admin-username $vmAdminUsername \
    --admin-password $vmAdminPassword \
    --vnet-name $vnetName \
    --subnet $webSubnetName \
    --public-ip-address "" \
    --asgs $asgWebId \
    --no-wait

# --- Create VM 2 (DB Server) ---
echo "Creating VM: vm-asg-db-01..."
az vm create \
    --resource-group $resourceGroupName \
    --name "vm-asg-db-01" \
    --image Win2019Datacenter \
    --size Standard_B1s \
    --admin-username $vmAdminUsername \
    --admin-password $vmAdminPassword \
    --vnet-name $vnetName \
    --subnet $dbSubnetName \
    --public-ip-address "" \
    --asgs $asgDbId \
    --no-wait

echo "VMs creation initiated. This will take a few minutes."
echo "Remember to temporarily allow RDP via NIC NSGs to connect and prepare VMs."
```

-----

## Part 4: Create and Configure Network Security Group (NSG) with ASGs

Now, we'll create the NSG, define the security rules using our ASGs as sources and destinations, and then associate this NSG with both `subnet-web` and `subnet-db`.

### Method 1: Azure Portal 🌐

1.  Search for "Network security groups" and click **"+ Create"**.

2.  Basics Tab:

      * Subscription: Your subscription.
      * Resource Group: `rg-asg-lab`.
      * Name: `nsg-asg-policy`.
      * Region: `East US`.
      * Review + create, then Create.

3.  **Associate NSG to Subnets**:

      * Once `nsg-asg-policy` is created, navigate to its overview.
      * In the left-hand menu, under **Settings**, click **"Subnets"**.
      * Click **"+ Associate"**.
          * Virtual network: `vnet-asg-app`.
          * Subnet: Select `subnet-web`. Click OK.
      * Click **"+ Associate"** again.
          * Virtual network: `vnet-asg-app`.
          * Subnet: Select `subnet-db`. Click OK.

4.  **Configure Inbound Security Rules**:

      * In the `nsg-asg-policy` overview, in the left-hand menu, click **"Inbound security rules"**.

      * Click **"+ Add"** for each rule below:

      * **Rule 1: Allow SQL Traffic from Web ASG to DB ASG**

          * Source: `Application security group`.
          * Source application security group: `asg-web`.
          * Source port ranges: `*`.
          * Destination: `Application security group`.
          * Destination application security group: `asg-db`.
          * Service: `Custom`.
          * Destination port ranges: `1433`.
          * Protocol: `TCP`.
          * Action: `Allow`.
          * Priority: `100`. (Lower number = higher priority)
          * Name: `Allow-SQL-ASGWeb-to-ASGDb`.
          * Add.

      * *Default Deny rules (like `DenyAllInbound` and `DenyAllOutbound`) are already present with higher priority numbers (e.g., 65500), so our custom rules with lower priority numbers will take precedence. For this lab, we're explicitly allowing internal traffic based on ASGs.*

-----

### Method 2: Azure PowerShell 💻

```powershell
# --- Define NSG Variables ---
$nsgName = "nsg-asg-policy"

# --- Create NSG ---
Write-Host "Creating Network Security Group: $nsgName..."
New-AzNetworkSecurityGroup -Name $nsgName `
    -ResourceGroupName $resourceGroupName `
    -Location $location

# --- Associate NSG to Subnets ---
Write-Host "Associating NSG to subnets..."
$vnet = Get-AzVirtualNetwork -Name $vnetName -ResourceGroupName $resourceGroupName
Set-AzVirtualNetworkSubnetConfig -Name $webSubnetName `
    -VirtualNetwork $vnet `
    -AddressPrefix "10.0.0.0/24" `
    -NetworkSecurityGroup $nsgName # Reference by name as it's in the same RG

Set-AzVirtualNetworkSubnetConfig -Name $dbSubnetName `
    -VirtualNetwork $vnet `
    -AddressPrefix "10.0.1.0/24" `
    -NetworkSecurityGroup $nsgName # Reference by name

$vnet | Set-AzVirtualNetwork # Apply the subnet changes

# --- Add Inbound Security Rule ---
Write-Host "Adding Inbound Security Rule to NSG (Web ASG to DB ASG)..."
# Rule 1: Allow SQL Traffic from Web ASG to DB ASG
$asgWeb = Get-AzApplicationSecurityGroup -Name $asgWebName -ResourceGroupName $resourceGroupName
$asgDb = Get-AzApplicationSecurityGroup -Name $asgDbName -ResourceGroupName $resourceGroupName
Add-AzNetworkSecurityGroupRuleConfig -Name "Allow-SQL-ASGWeb-to-ASGDb" `
    -NetworkSecurityGroup $nsgName `
    -Description "Allow SQL traffic from Web ASG to DB ASG" `
    -Access Allow `
    -Protocol Tcp `
    -Direction Inbound `
    -Priority 100 `
    -SourceApplicationSecurityGroup $asgWeb `
    -SourcePortRange "*" `
    -DestinationApplicationSecurityGroup $asgDb `
    -DestinationPortRange "1433"

# Apply NSG rules (get the NSG and set it back to trigger the update)
Get-AzNetworkSecurityGroup -Name $nsgName -ResourceGroupName $resourceGroupName | Set-AzNetworkSecurityGroup

Write-Host "Network Security Group and rules configured."
```

-----

### Method 3: Azure CLI 🖥️

```bash
# --- Define NSG Variables ---
nsgName="nsg-asg-policy"

# --- Create NSG ---
echo "Creating Network Security Group: $nsgName..."
az network nsg create \
    --name $nsgName \
    --resource-group $resourceGroupName \
    --location $location

# --- Associate NSG to Subnets ---
echo "Associating NSG to subnets..."
az network vnet subnet update \
    --resource-group $resourceGroupName \
    --vnet-name $vnetName \
    --name $webSubnetName \
    --network-security-group $nsgName

az network vnet subnet update \
    --resource-group $resourceGroupName \
    --vnet-name $vnetName \
    --name $dbSubnetName \
    --network-security-group $nsgName

# --- Add Inbound Security Rule ---
echo "Adding Inbound Security Rule to NSG (Web ASG to DB ASG)..."
# Rule 1: Allow SQL Traffic from Web ASG to DB ASG
az network nsg rule create \
    --resource-group $resourceGroupName \
    --nsg-name $nsgName \
    --name "Allow-SQL-ASGWeb-to-ASGDb" \
    --priority 100 \
    --direction Inbound \
    --source-asgs $asgWebName \
    --destination-asgs $asgDbName \
    --destination-port-ranges 1433 \
    --protocol Tcp \
    --access Allow \
    --description "Allow SQL traffic from Web ASG to DB ASG"

echo "Network Security Group and rules configured."
```

-----

## Part 5: Test Connectivity and Security Policy

It might take a few minutes for the NSG rules to propagate after creation/update.

### 1\. Initial Access to VMs (via RDP)

  * **Before testing ASG rules, ensure you can RDP into both VMs.** You would have temporarily added RDP access rules during VM setup. If not, temporarily add an NSG rule to `nsg-asg-policy` to allow RDP from your public IP (similar to the previous NSG lab) with a low priority (e.g., 50). **Remember to remove it after testing to enforce our ASG policy\!**
  * Connect to `vm-asg-web-01` via RDP.
  * Connect to `vm-asg-db-01` via RDP.

### 2\. Test Internal Database Connectivity (from Web Server to DB Server)

This is the core test for ASGs. We'll simulate a web server trying to connect to a database.

1.  Connect to `vm-asg-web-01` via RDP.
2.  Open PowerShell as Administrator.
3.  Test TCP connectivity to the database server on port 1433:
    ```powershell
    Test-NetConnection -ComputerName 10.0.1.4 -Port 1433
    ```
    (Replace `10.0.1.4` with the actual private IP of `vm-asg-db-01` if it's different. You can find this by running `ipconfig` on `vm-asg-db-01`).
4.  **Expected Outcome**: The `TcpTestSucceeded` field should be `True`. This confirms that the `Allow-SQL-ASGWeb-to-ASGDb` rule is working, allowing traffic from any VM belonging to `asg-web` (which is `vm-asg-web-01`) to any VM belonging to `asg-db` (which is `vm-asg-db-01`) on port 1433.

### 3\. Test Blocked Internal Traffic (e.g., Web Server to DB Server on a different port)

1.  While still connected to `vm-asg-web-01` via RDP.
2.  Open PowerShell as Administrator.
3.  Try to connect to `vm-asg-db-01` on a port other than 1433 (e.g., 80 or 3389):
    ```powershell
    Test-NetConnection -ComputerName 10.0.1.4 -Port 80
    ```
4.  **Expected Outcome**: The `TcpTestSucceeded` field should be `False` or the command should time out. This demonstrates that only the explicitly allowed traffic (SQL on 1433) is permitted between the ASGs, and the implicit `DenyAllInbound` rule blocks other internal traffic.

This lab clearly demonstrates how ASGs simplify NSG rule management by allowing you to define security policies based on application roles (e.g., "Web Servers" and "Database Servers") rather than individual IP addresses, making your security rules much more scalable and readable.

-----

## Part 6: Clean Up Resources

To avoid incurring unnecessary costs, delete the resource group created in this lab. This will remove all VMs, NSGs, ASGs, and the Virtual Network.

### Method 1: Azure Portal 🌐

1.  Search for "Resource groups" and select `rg-asg-lab`.
2.  Click **"Delete resource group"**.
3.  Type `rg-asg-lab` to confirm, then click **"Delete"**.

-----

### Method 2: Azure PowerShell 💻

```powershell
Remove-AzResourceGroup -Name "rg-asg-lab" -Force -AsJob
Write-Host "Resource group 'rg-asg-lab' deletion initiated."
```

-----

### Method 3: Azure CLI 🖥️

```bash
az group delete --name "rg-asg-lab" --yes --no-wait
echo "Resource group 'rg-asg-lab' deletion initiated."
```