# Diagnosing common network problems:

Diagnosing common network problems in Azure requires a systematic approach, often leveraging the diagnostic tools within Azure Network Watcher. 

Here's how to diagnose some of the most frequent issues:

---

## 1. Virtual Machine (VM) Connectivity Issues ðŸ–¥ï¸

### Symptoms
* Cannot RDP/SSH into a VM.
* VM cannot access the internet or other Azure resources.
* Applications running on VMs are unreachable.

### Diagnosis Steps
1.  **Verify VM Status**:
    * **Check in Portal**: Ensure the VM is in a `Running` state. If it's stopped, deallocated, or stuck, try restarting it.
    * **OS Level**: Connect to the VM (e.g., via Serial Console if RDP/SSH fails) and check the guest OS firewall (Windows Firewall, `firewalld`/`iptables` on Linux) to ensure it's not blocking traffic. Use `netstat -ano` (Windows) or `netstat -l` (Linux) to see if the application is listening on the expected port.

2.  **Network Security Group (NSG) Rules**: This is the most common culprit.
    * **IP Flow Verify**: Use **Network Watcher > IP Flow Verify** to simulate traffic from a source to the VM's private IP on the problematic port and protocol (e.g., Inbound, TCP, Port 3389 for RDP). It will tell you if traffic is *allowed* or *denied* and, crucially, **which specific NSG rule** is responsible.
    * **Effective Security Rules**: In the VM's networking settings, check **Effective security rules**. This shows the combined NSG rules applied at both the NIC and subnet levels, in their effective processing order. Ensure there's an `Allow` rule with higher priority (lower number) than any `Deny` rules for your traffic.

3.  **Routing Issues (User Defined Routes - UDRs)**:
    * **Next Hop**: Use **Network Watcher > Next hop**. Specify the VM's NIC and a destination IP (e.g., an internet IP or another VM's IP). This tool tells you the next hop that traffic will take. If it's unexpected (e.g., pointing to a Network Virtual Appliance (NVA) that isn't configured, or `None`), you have a routing issue. Check custom UDRs associated with the VM's subnet.

4.  **DNS Resolution**:
    * If you can connect by IP but not by hostname, it's likely a DNS issue.
    * **Check VNet DNS Servers**: Verify that your Virtual Network is configured with correct DNS servers (Azure's default, custom DNS servers, or an on-premises DNS server via VPN/ExpressRoute).
    * **Test from VM**: Use `nslookup` or `dig` from within the VM to test name resolution.

5.  **SNAT Port Exhaustion (for VMs behind Load Balancers)**:
    * If you experience intermittent outbound connection failures, especially when making many simultaneous connections, SNAT port exhaustion might be the cause. This occurs when a public load balancer or public IP address runs out of available ephemeral ports for outbound connections.
    * **Diagnosis**: This is harder to pinpoint directly. Look for high connection counts, especially short-lived ones. Consider adding more public IPs to the load balancer or using a NAT Gateway for outbound connectivity.

---

## 2. Network Security Group (NSG) Misconfigurations ðŸ›¡ï¸

### Symptoms
* Traffic unexpectedly blocked or allowed.
* "403 Forbidden" errors on web applications.
* Inability to connect to services even after opening ports.

### Diagnosis Steps
1.  **IP Flow Verify**: As mentioned above, this is the primary tool. It directly simulates traffic against NSG rules and tells you the allowing/denying rule.
2.  **Effective Security Rules**: Always review the **Effective security rules** on the VM's NIC. Remember:
    * NSGs can be applied at both the **subnet** and **NIC** level.
    * **Inbound**: Rules are processed first at the subnet NSG, then the NIC NSG. For traffic to be allowed, it must be allowed by *both*.
    * **Outbound**: Rules are processed first at the NIC NSG, then the subnet NSG. For traffic to be allowed, it must be allowed by *both*.
    * Rules are evaluated by **priority (lowest number = highest priority)**. If a `Deny` rule has a lower priority than your intended `Allow` rule, it will block the traffic.
3.  **NSG Flow Logs**: Enable and analyze **NSG Flow Logs** (often with Traffic Analytics in Log Analytics). This provides historical data on what traffic hit the NSG and whether it was allowed or denied, along with the rule name. This is crucial for intermittent issues or understanding traffic patterns over time.

---

## 3. VPN Gateway Connectivity Issues ðŸ”—

### Symptoms
* Site-to-Site VPN tunnel is disconnected or unstable.
* On-premises network cannot reach Azure resources, or vice-versa.
* Slow performance over the VPN.

### Diagnosis Steps
1.  **Network Watcher VPN Troubleshoot**:
    * **Network Watcher > VPN troubleshoot** is specifically designed for this. You select the VPN gateway and connection, and it performs diagnostic checks, providing a status (Healthy/Unhealthy) and generating diagnostic logs (stored in a specified storage account).
    * These logs can pinpoint issues like `Authentication failed` (shared key mismatch) or `On-premises device rejected Quick Mode settings` (IPsec/IKE parameter mismatch).

2.  **Verify Configuration Parameters**:
    * **Shared Key**: Ensure the pre-shared key on the Azure VPN Gateway connection exactly matches the one configured on your on-premises VPN device.
    * **IPsec/IKE Parameters**: Confirm that all IPsec/IKE parameters (encryption, hashing algorithms, DH groups, lifetime) are compatible and match on both sides. Use validated VPN devices and their recommended configurations.
    * **Local Network Gateway**: The IP address specified in your Azure Local Network Gateway object must match the external (public) IP address of your on-premises VPN device.
    * **BGP (if applicable)**: If using BGP, ensure peer IPs, ASNs, and prefixes are correctly configured on both sides.

3.  **Routing**:
    * **Address Spaces**: Ensure that the address spaces (VNet prefixes in Azure, on-premises network prefixes) are correctly defined on both the Azure VPN Gateway connection and your on-premises device. No overlapping address spaces.
    * **UDRs/NSGs on Gateway Subnet**: Crucially, **do not** associate NSGs or UDRs directly to the Gateway Subnet. This can disrupt the VPN gateway's operation. If you suspect this, remove them and re-test.

4.  **On-premises Firewall/NAT**:
    * Verify that any on-premises firewalls or NAT devices are not blocking UDP ports 500 (IKE) and 4500 (IPsec NAT-T) or ESP protocol (IP Protocol 50) to and from the Azure VPN Gateway's public IP.

By systematically following these diagnosis steps and utilizing the powerful tools within Azure Network Watcher, you can efficiently identify and resolve most common networking issues in your Azure environment.