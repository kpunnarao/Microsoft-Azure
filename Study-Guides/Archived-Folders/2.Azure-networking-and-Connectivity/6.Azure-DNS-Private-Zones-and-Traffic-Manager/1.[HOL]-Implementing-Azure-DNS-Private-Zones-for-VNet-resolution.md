# Lab: Implementing Azure DNS Private Zones for VNet Resolution üå≥

This lab guides you through the process of setting up an Azure DNS Private Zone to provide name resolution for resources within your Azure Virtual Networks. This enables virtual machines (VMs) and other resources in your VNet to resolve hostnames using your custom domain, even if they are in different subnets or if auto-registration is enabled.

## Lab Scenario üåê

We will create a new Azure DNS Private Zone, link it to an existing Virtual Network, deploy two VMs, and then test the name resolution.

  * **Resource Group**: `rg-private-dns-lab`
  * **Region**: `East US`
  * **Virtual Network**: `vnet-apps` (Address space: `10.0.0.0/16`)
      * **Subnet 1**: `subnet-web` (Address range: `10.0.1.0/24`)
      * **Subnet 2**: `subnet-db` (Address range: `10.0.2.0/24`)
  * **Private DNS Zone Name**: `contoso.com`
  * **VM 1**: `vm-web` (in `subnet-web`)
  * **VM 2**: `vm-db` (in `subnet-db`)

-----

## Part 1: Prerequisites & Initial Setup

Before proceeding, ensure you have:

  * An active Azure Subscription.
  * The Azure CLI and Azure PowerShell installed and configured on your local machine, or use Azure Cloud Shell.
  * **Create the Resource Group and Virtual Network**:

### Method 1: Azure Portal üåê

1.  **Create Resource Group**:
      * Search for "Resource groups" and click "+ Create".
      * Subscription: Your subscription.
      * Resource Group name: `rg-private-dns-lab`.
      * Region: `East US`.
      * Review + create, then Create.
2.  **Create Virtual Network**:
      * Search for "Virtual networks" and click "+ Create".
      * Basics Tab:
          * Subscription: Your subscription.
          * Resource Group: `rg-private-dns-lab`.
          * Name: `vnet-apps`.
          * Region: `East US`.
      * IP Addresses Tab:
          * IPv4 address space: `10.0.0.0/16`.
          * Add subnet:
              * Name: `subnet-web`, Address range: `10.0.1.0/24`. Add.
          * Add subnet:
              * Name: `subnet-db`, Address range: `10.0.2.0/24`. Add.
      * Security, Tags, Review + create, then Create.

### Method 2: Azure PowerShell üíª

```powershell
# --- Define Variables ---
$resourceGroupName = "rg-private-dns-lab"
$location = "eastus"
$vnetName = "vnet-apps"
$vnetAddressPrefix = "10.0.0.0/16"
$subnetWebName = "subnet-web"
$subnetWebPrefix = "10.0.1.0/24"
$subnetDbName = "subnet-db"
$subnetDbPrefix = "10.0.2.0/24"

# --- Create Resource Group ---
Write-Host "Creating Resource Group: $resourceGroupName..."
New-AzResourceGroup -Name $resourceGroupName -Location $location

# --- Create Virtual Network with subnets ---
Write-Host "Creating Virtual Network: $vnetName..."
$subnetWeb = New-AzVirtualNetworkSubnetConfig -Name $subnetWebName -AddressPrefix $subnetWebPrefix
$subnetDb = New-AzVirtualNetworkSubnetConfig -Name $subnetDbName -AddressPrefix $subnetDbPrefix

New-AzVirtualNetwork -Name $vnetName `
    -ResourceGroupName $resourceGroupName `
    -Location $location `
    -AddressPrefix $vnetAddressPrefix `
    -Subnet $subnetWeb, $subnetDb

Write-Host "Virtual Network and subnets created."
```

### Method 3: Azure CLI üñ•Ô∏è

```bash
# --- Define Variables ---
resourceGroupName="rg-private-dns-lab"
location="eastus"
vnetName="vnet-apps"
vnetAddressPrefix="10.0.0.0/16"
subnetWebName="subnet-web"
subnetWebPrefix="10.0.1.0/24"
subnetDbName="subnet-db"
subnetDbPrefix="10.0.2.0/24"

# --- Create Resource Group ---
echo "Creating Resource Group: $resourceGroupName..."
az group create --name $resourceGroupName --location $location

# --- Create Virtual Network ---
echo "Creating Virtual Network: $vnetName..."
az network vnet create \
    --resource-group $resourceGroupName \
    --name $vnetName \
    --address-prefix $vnetAddressPrefix \
    --location $location

# --- Add Subnets ---
echo "Adding subnets to $vnetName..."
az network vnet subnet create \
    --resource-group $resourceGroupName \
    --vnet-name $vnetName \
    --name $subnetWebName \
    --address-prefixes $subnetWebPrefix

az network vnet subnet create \
    --resource-group $resourceGroupName \
    --vnet-name $vnetName \
    --name $subnetDbName \
    --address-prefixes $subnetDbPrefix

echo "Virtual Network and subnets created."
```

-----

## Part 2: Create Azure DNS Private Zone

Now, let's create the private DNS zone and link it to your virtual network. Enabling auto-registration will automatically create A records for VMs deployed in the linked VNet.

### Method 1: Azure Portal üåê

1.  Search for "Private DNS zones" and click **"+ Create"**.
2.  **Basics Tab**:
      * Subscription: Your subscription.
      * Resource Group: `rg-private-dns-lab`.
      * Name: `contoso.com`.
      * Region: (This is a global resource, so region is for metadata only; select `East US`).
3.  Click **"Review + create"** and then **"Create"**.
4.  Once the zone is deployed, navigate to `contoso.com` (your new private DNS zone).
5.  In the left-hand menu, under **Settings**, select **Virtual network links**.
6.  Click **"+ Add"**.
      * **Link name**: `vnet-apps-link`.
      * **Virtual network**: Select `vnet-apps`.
      * **Enable auto registration**: Check this box. (Crucial for automatic VM record creation).
7.  Click **"OK"**.

-----

### Method 2: Azure PowerShell üíª

```powershell
# --- Define Variables ---
$privateDnsZoneName = "contoso.com"
$vnetLinkName = "vnet-apps-link"

# --- Create Private DNS Zone ---
Write-Host "Creating Private DNS Zone: $privateDnsZoneName..."
New-AzPrivateDnsZone -ResourceGroupName $resourceGroupName -Name $privateDnsZoneName

Write-Host "Private DNS Zone created. Now linking to VNet..."

# --- Link Private DNS Zone to Virtual Network with auto-registration ---
$vnet = Get-AzVirtualNetwork -Name $vnetName -ResourceGroupName $resourceGroupName
New-AzPrivateDnsVirtualNetworkLink -ResourceGroupName $resourceGroupName `
    -ZoneName $privateDnsZoneName `
    -Name $vnetLinkName `
    -VirtualNetworkId $vnet.Id `
    -EnableRegistration

Write-Host "Private DNS Zone linked to VNet '$vnetName' with auto-registration enabled."
```

-----

### Method 3: Azure CLI üñ•Ô∏è

```bash
# --- Define Variables ---
privateDnsZoneName="contoso.com"
vnetLinkName="vnet-apps-link"

# --- Create Private DNS Zone ---
echo "Creating Private DNS Zone: $privateDnsZoneName..."
az network private-dns zone create \
    --resource-group $resourceGroupName \
    --name $privateDnsZoneName

echo "Private DNS Zone created. Now linking to VNet..."

# --- Link Private DNS Zone to Virtual Network with auto-registration ---
vnetId=$(az network vnet show -g $resourceGroupName -n $vnetName --query id -o tsv)
az network private-dns link vnet create \
    --resource-group $resourceGroupName \
    --zone-name $privateDnsZoneName \
    --name $vnetLinkName \
    --virtual-network $vnetId \
    --registration-enabled true

echo "Private DNS Zone linked to VNet '$vnetName' with auto-registration enabled."
```

-----

## Part 3: Deploy Virtual Machines for Testing

We'll deploy two simple Windows Server VMs into different subnets within `vnet-apps` to test private name resolution.

### Method 1: Azure Portal üåê

1.  Search for "Virtual machines" and click "+ Create" -\> "Azure virtual machine".
2.  **VM 1 (`vm-web`)**:
      * Basics Tab:
          * Subscription: Your subscription.
          * Resource Group: `rg-private-dns-lab`.
          * Virtual machine name: `vm-web`.
          * Region: `East US`.
          * Image: `Windows Server 2019 Datacenter - Gen2`.
          * Size: `Standard_B2s` (or similar, cheap size).
          * Administrator account: Enter username and password.
          * Inbound port rules: `None`.
      * Disks, Networking, Management, Monitoring, Advanced, Tags: Use defaults.
      * **Networking Tab**:
          * Virtual network: `vnet-apps`.
          * Subnet: `subnet-web`.
          * Public IP: Select "None". (We'll rely on private resolution).
      * Review + create, then Create.
3.  **VM 2 (`vm-db`)**: Repeat steps for `vm-web` but with:
      * Virtual machine name: `vm-db`.
      * Subnet: `subnet-db`.
      * Public IP: Select "None".
      * Review + create, then Create.

-----

### Method 2: Azure PowerShell üíª

```powershell
# --- Define Variables for VMs ---
$vmImage = "MicrosoftWindowsServer:WindowsServer:2019-Datacenter:latest"
$vmSize = "Standard_B2s"
$adminUsername = "azureuser"
$adminPassword = "YourSecurePassword123!" # ***CHANGE THIS TO A STRONG PASSWORD***

# --- Create VM 1 (vm-web) ---
Write-Host "Creating VM: vm-web in subnet-web..."
New-AzVm `
    -ResourceGroupName $resourceGroupName `
    -Name "vm-web" `
    -Location $location `
    -VirtualNetworkName $vnetName `
    -SubnetName $subnetWebName `
    -Image $vmImage `
    -Size $vmSize `
    -AdminUsername $adminUsername `
    -AdminPassword $adminPassword `
    -NoPublicIP # Ensures no public IP is assigned

# --- Create VM 2 (vm-db) ---
Write-Host "Creating VM: vm-db in subnet-db..."
New-AzVm `
    -ResourceGroupName $resourceGroupName `
    -Name "vm-db" `
    -Location $location `
    -VirtualNetworkName $vnetName `
    -SubnetName $subnetDbName `
    -Image $vmImage `
    -Size $vmSize `
    -AdminUsername $adminUsername `
    -AdminPassword $adminPassword `
    -NoPublicIP

Write-Host "VMs creation initiated. This will take several minutes."
```

-----

### Method 3: Azure CLI üñ•Ô∏è

```bash
# --- Define Variables for VMs ---
vmImage="Win2019Datacenter" # Alias for Windows Server 2019 Datacenter
vmSize="Standard_B2s"
adminUsername="azureuser"
adminPassword="YourSecurePassword123!" # ***CHANGE THIS TO A STRONG PASSWORD***

# --- Create VM 1 (vm-web) ---
echo "Creating VM: vm-web in subnet-web..."
az vm create \
    --resource-group $resourceGroupName \
    --name "vm-web" \
    --location $location \
    --image $vmImage \
    --size $vmSize \
    --admin-username $adminUsername \
    --admin-password $adminPassword \
    --vnet-name $vnetName \
    --subnet $subnetWebName \
    --private-ip-address-only \
    --no-wait # Run in background

# --- Create VM 2 (vm-db) ---
echo "Creating VM: vm-db in subnet-db..."
az vm create \
    --resource-group $resourceGroupName \
    --name "vm-db" \
    --location $location \
    --image $vmImage \
    --size $vmSize \
    --admin-username $adminUsername \
    --admin-password $adminPassword \
    --vnet-name $vnetName \
    --subnet $subnetDbName \
    --private-ip-address-only \
    --no-wait # Run in background

echo "VMs creation initiated. This will take several minutes."
echo "Check their status with: az vm list -g $resourceGroupName --query '[].{Name:name,ProvisioningState:provisioningState}' -o table"
```

-----

## Part 4: Verify Auto-Registration and Test Name Resolution

Once both VMs are deployed and running, we can check the private DNS zone and test name resolution.

### Method 1: Azure Portal üåê

1.  Navigate to your **Private DNS zone** (`contoso.com`).
2.  In the left-hand menu, select **Record sets**.
3.  You should now see **A records** for `vm-web` and `vm-db` automatically created, pointing to their respective private IP addresses within `vnet-apps`. The `Auto registered` column should show `true`.
4.  **Test Resolution**:
      * Connect to `vm-web` (via Bastion, JIT VM Access, or a jumpbox within the VNet, since it has no public IP).
      * Open **Command Prompt** or **PowerShell**.
      * Ping `vm-db.contoso.com`. You should see successful replies from the private IP address of `vm-db`.
      * Ping `vm-web.contoso.com` (to confirm self-resolution).
      * You can also use `nslookup vm-db.contoso.com` to confirm the resolved IP address.
      * *Troubleshooting*: If `ping` fails but `nslookup` resolves, ensure Windows Firewall on the VMs allows inbound ICMP. Run `New-NetFirewallRule ‚ÄìDisplayName "Allow ICMPv4-In" ‚ÄìProtocol ICMPv4` on both VMs.

-----

### Method 2: Azure PowerShell üíª

1.  **Verify Records**:
    ```powershell
    # --- Define Variables ---
    $privateDnsZoneName = "contoso.com"
    $resourceGroupName = "rg-private-dns-lab"

    # --- Get all A records in the private DNS zone ---
    Get-AzPrivateDnsRecordSet -ResourceGroupName $resourceGroupName -ZoneName $privateDnsZoneName -RecordType A
    ```
    You should see output similar to this, confirming `vm-web` and `vm-db` records are present and auto-registered:
    ```
    Name       : vm-db
    ZoneName   : contoso.com
    ResourceGroupName : rg-private-dns-lab
    Ttl        : 300
    Etag       : "..."
    RecordType : A
    Records    : {10.0.2.x} # Private IP of vm-db
    AutoRegistered : True

    Name       : vm-web
    ZoneName   : contoso.com
    ResourceGroupName : rg-private-dns-lab
    Ttl        : 300
    Etag       : "..."
    RecordType : A
    Records    : {10.0.1.x} # Private IP of vm-web
    AutoRegistered : True
    ```
2.  **Test Resolution**:
      * Connect to `vm-web` (e.g., via `az vm run-command invoke` if no public IP for RDP, or use Azure Bastion).
      * Execute a ping command from within the VM:
        ```powershell
        # From vm-web's PowerShell
        ping vm-db.contoso.com
        nslookup vm-db.contoso.com
        ```
      * Expected output: `vm-db.contoso.com` resolves to its private IP address (`10.0.2.x`).

-----

### Method 3: Azure CLI üñ•Ô∏è

1.  **Verify Records**:
    ```bash
    # --- Define Variables ---
    privateDnsZoneName="contoso.com"
    resourceGroupName="rg-private-dns-lab"

    # --- Get all A records in the private DNS zone ---
    az network private-dns record-set a list \
        --resource-group $resourceGroupName \
        --zone-name $privateDnsZoneName \
        --output table
    ```
    You should see a table similar to this, confirming `vm-web` and `vm-db` records:
    ```
    Name    Ttl    IpAddress    IsAutoRegistered
    ------  -----  -----------  ------------------
    vm-db   300    10.0.2.x     True
    vm-web  300    10.0.1.x     True
    ```
2.  **Test Resolution**:
      * Connect to `vm-web` (e.g., using `az vm run-command invoke` if no public IP for RDP).
      * Execute a ping command from within the VM:
        ```bash
        # From vm-web's command prompt/PowerShell
        ping vm-db.contoso.com
        nslookup vm-db.contoso.com
        ```
      * Expected output: `vm-db.contoso.com` resolves to its private IP address (`10.0.2.x`).

-----

## Part 5: Clean Up Resources

To avoid incurring unnecessary costs, delete the resources created in this lab.

### Method 1: Azure Portal üåê

1.  Search for "Resource groups" and select `rg-private-dns-lab`.
2.  Click "Delete resource group".
3.  Type `rg-private-dns-lab` to confirm, then click "Delete".

### Method 2: Azure PowerShell üíª

```powershell
Remove-AzResourceGroup -Name "rg-private-dns-lab" -Force -AsJob
Write-Host "Resource group 'rg-private-dns-lab' deletion initiated."
```

### Method 3: Azure CLI üñ•Ô∏è

```bash
az group delete --name "rg-private-dns-lab" --yes --no-wait
echo "Resource group 'rg-private-dns-lab' deletion initiated."
```

-----

This lab demonstrates the fundamental steps of implementing Azure DNS Private Zones for name resolution within a VNet, showcasing how VMs automatically register and can resolve each other using custom private domain names.