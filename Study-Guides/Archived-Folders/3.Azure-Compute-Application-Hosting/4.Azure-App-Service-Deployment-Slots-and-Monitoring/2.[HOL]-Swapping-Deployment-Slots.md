# Lab: Azure App Service - Deployment Slots & Monitoring: Swapping Deployment Slots üîÑ

This lab will guide you through the process of creating a deployment slot for your Azure Web App, deploying a new version of your application to it, and then performing a slot swap to update your production environment with zero downtime.

## Lab Scenario üè∞

You have an existing web application in Azure App Service (`webapp-yourname-d16`).

A new version of your application is ready, and you want to deploy it without any downtime for your users. 

You will create a "staging" slot, deploy the new code there, test it, and then swap it to production.

**Resources you'll be working with:**

  * **Existing Web App**: `webapp-yourname-d16` (from Day 16 Lab)
  * **Existing App Service Plan**: `plan-webapp-lab` (Standard S1 tier, required for slots)
  * **New Deployment Slot**: `webapp-yourname-d16-staging`
  * **Source Code**:
      * **Original (Production)**: `index.html` (e.g., "Hello from Azure App Service\! This is **VERSION 1**")
      * **New (Staging)**: `index.html` (e.g., "Hello from Azure App Service\! This is **VERSION 2**")

-----

## Part 1: Prerequisites

Before you begin, ensure you have:

  * An active Azure Subscription.
  * Access to the Azure Portal ([portal.azure.com](https://portal.azure.com)).
  * **For Azure CLI/PowerShell methods**: Azure CLI and/or Azure PowerShell installed and configured locally, or access to Azure Cloud Shell.
  * **Existing Web App and App Service Plan**: You should have completed "Day 16 Lab: Deploying Web Apps & Custom Domains & SSL", so you have:
      * A Resource Group named `rg-webapp-lab`.
      * An App Service Plan named `plan-webapp-lab` (Standard S1 tier or higher).
      * A Web App named `webapp-yourname-d16`.
      * A GitHub repository or local Git repository connected for deployment from Day 16, or you'll need to manually deploy.
  * **Updated Sample Code**: Prepare your sample `index.html` (or equivalent for your runtime) with "VERSION 2" content.
      * **Example `index.html` (VERSION 2):**
        ```html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Azure App Service Lab - Version 2</title>
            <style>
                body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; background-color: #e0f2f7; }
                h1 { color: #d9534f; } /* Changed color for visual distinction */
                p { font-size: 1.3em; }
            </style>
        </head>
        <body>
            <h1>Hello from Azure App Service!</h1>
            <p>This is my first deployment to Azure App Service from GitHub/Local Git.</p>
            <p><strong>This is VERSION 2 of the application!</strong></p>
            <p>It's running on: <span id="hostname"></span></p>
            <script>
                document.getElementById('hostname').innerText = window.location.hostname;
            </script>
        </body>
        </html>
        ```
      * Ensure your `VERSION 1` code is currently deployed to your `webapp-yourname-d16` (production slot).

-----

## Part 2: Create a Deployment Slot

Let's create the staging slot where we'll deploy our new code.

### Method 1: Azure Portal üåê

1.  **Navigate to your Web App**:
      * In the Azure Portal, search for "App Services" and select your `webapp-yourname-d16`.
2.  **Access Deployment Slots**:
      * In the left-hand menu, under **"Deployment"**, select **"Deployment slots"**.
3.  **Add New Slot**:
      * Click **"+ Add Slot"**.
      * **Name**: Enter `staging`.
      * **Clone settings from**: Select `webapp-yourname-d16` (the production slot). This copies most configuration settings, including App Settings and Connection Strings that are *not* marked as slot-specific.
      * Click **"Add"**.
      * Wait for the slot to be created. Once complete, you'll see `staging` listed alongside `production`.
      * Click on the `staging` slot name in the list. This will take you to the overview blade for the `staging` slot. Note its URL (e.g., `webapp-yourname-d16-staging.azurewebsites.net`).

### Method 2: Azure CLI üñ•Ô∏è

1.  **Set Variables**:
    ```bash
    resourceGroup="rg-webapp-lab"
    webappName="webapp-yourname-d16" # Your unique web app name
    stagingSlotName="staging"
    ```
2.  **Create the Deployment Slot**:
    ```bash
    az webapp deployment slot create \
      --name $webappName \
      --resource-group $resourceGroup \
      --slot $stagingSlotName \
      --configuration-source $webappName # Clones settings from the production slot
    ```
      * `az webapp deployment slot show --name $webappName --resource-group $resourceGroup --slot $stagingSlotName --query defaultHostName -o tsv` to get its URL.

### Method 3: Azure PowerShell üíª

1.  **Set Variables**:
    ```powershell
    $resourceGroupName = "rg-webapp-lab"
    $webappName = "webapp-yourname-d16" # Your unique web app name
    $stagingSlotName = "staging"
    ```
2.  **Create the Deployment Slot**:
    ```powershell
    New-AzWebAppSlot -ResourceGroupName $resourceGroupName -Name $webappName -Slot $stagingSlotName -AppServicePlan $webappName # AppServicePlan should be the name of the main webapp/slot to copy from
    # Note: PowerShell's AppServicePlan parameter for New-AzWebAppSlot refers to the parent app's name to link it, not the actual plan object.
    ```
      * `$slot = Get-AzWebAppSlot -ResourceGroupName $resourceGroupName -Name $webappName -Slot $stagingSlotName`
      * `$slot.DefaultHostName` to get its URL.

-----

## Part 3: Deploy New Code to the Staging Slot

Now, let's deploy our "VERSION 2" code to the newly created `staging` slot.

### Method A: Deploy from GitHub (Continuous Deployment) üöÄ

If you configured GitHub Actions in Day 16:

1.  **Update your GitHub Repository**:
      * Modify your `index.html` file in your GitHub repository to contain the "VERSION 2" content (e.g., "This is VERSION 2 of the application\!").
      * Commit and push these changes to the `main` (or `master`) branch of your GitHub repository.
2.  **Trigger Deployment**:
      * If you set up GitHub Actions, the push should automatically trigger a workflow.
      * In your GitHub repository, go to the **"Actions"** tab to monitor the workflow run. It will likely deploy to the production slot by default if that's how your GitHub Action was configured initially.
      * **Crucial step for slots**: To deploy to the `staging` slot specifically via GitHub Actions, you often need to **edit the `.github/workflows/main_yourwebapp.yml` file** in your repository.
          * Change the `slot-name` parameter in the `azure/webapps-deploy` action from `production` to `staging`.
          * Commit and push this change. This will trigger a deployment specifically to the `staging` slot.
3.  **Verify Deployment**:
      * Once the GitHub Actions workflow completes successfully for the `staging` slot, open a web browser and navigate to the `staging` slot's URL (e.g., `webapp-yourname-d16-staging.azurewebsites.net`).
      * You should see the "VERSION 2" content.
      * Verify that the production URL (`webapp-yourname-d16.azurewebsites.net`) still shows "VERSION 1".

### Method B: Deploy from Local Git (Manual Push) üì§

1.  **Update Local Git Repository**:
      * Go to your local Git repository folder (`my-local-webapp`).
      * Modify your `index.html` file to contain the "VERSION 2" content.
      * Commit the changes:
        ```bash
        git add .
        git commit -m "Deploying Version 2 to staging"
        ```
2.  **Get Staging Slot Deployment URI and Credentials**:
      * **Azure Portal üåê**: Navigate to your `webapp-yourname-d16` -\> **Deployment slots** -\> Click on the `staging` slot. Now, go to **"Deployment Center"** for the `staging` slot. Select "Local Git" and "App Service build service". Copy the Git Clone URI and deployment credentials specifically for the *staging slot*.
      * **Azure CLI üñ•Ô∏è**:
        ```bash
        az webapp deployment source config-local-git --name $webappName --resource-group $resourceGroup --slot $stagingSlotName
        # The output will provide the Git clone URI for the staging slot.
        # Get credentials: az webapp deployment list-publishing-profiles --name $webappName --resource-group $resourceGroup --slot $stagingSlotName --query "[?contains(publishMethod, 'Git')].{UserName:userName, UserPwd:userPwd}" -o jsonc
        ```
      * **Azure PowerShell üíª**:
        ```powershell
        Set-AzResource -Properties @{ scmType = "LocalGit" } -ResourceGroupName $resourceGroupName `
            -ResourceType Microsoft.Web/sites/slots/config -ResourceName "$webappName/$stagingSlotName/web" -ApiVersion 2015-08-01 -Force
        # Get publishing profile (look for .git ServiceUrl for the staging slot)
        (Get-AzWebAppPublishingProfile -ResourceGroupName $resourceGroupName -Name $webappName -Slot $stagingSlotName -FormatXml).PublishProfile.item | Select-Object -ExpandProperty "$_".ServiceUrl, UserName, UserPWD
        ```
3.  **Push to Staging Slot**:
      * In your local terminal (from your `my-local-webapp` folder):
        ```bash
        git remote set-url azure <Git_clone_URI_for_staging_slot> # Update existing remote
        # OR: git remote add azure-staging <Git_clone_URI_for_staging_slot>
        git push azure main # or master
        ```
      * Enter the deployment username and password when prompted.
      * **Verify Deployment**:
          * Once the push completes, open a web browser and navigate to the `staging` slot's URL (`webapp-yourname-d16-staging.azurewebsites.net`). You should see the "VERSION 2" content.
          * Verify that the production URL (`webapp-yourname-d16.azurewebsites.net`) still shows "VERSION 1".

-----

## Part 4: Swapping Deployment Slots (Zero-Downtime Deployment)

Now that "VERSION 2" is tested and verified in `staging`, let's swap it to production.

### Method 1: Azure Portal üåê

1.  **Navigate to your Web App**:

      * In the Azure Portal, go to `webapp-yourname-d16`.

2.  **Access Deployment Slots**:

      * In the left-hand menu, under **"Deployment"**, select **"Deployment slots"**.

3.  **Initiate Swap**:

      * Click the **"Swap"** button at the top.
      * **Swap source**:
          * **Source**: `staging`
          * **Target**: `production`
      * **Preview changes (Optional but Recommended)**: Click **"Swap with preview"** first. This allows you to see the configuration changes that will occur. Click **"Perform Swap"** when ready.
      * Alternatively, just click **"Swap"** directly.
      * Confirm the swap by clicking **"Swap"** in the confirmation dialog.
      * The swap operation will begin. This usually takes less than a minute. You'll see notifications in the portal.

4.  **Verify Swap**:

      * Once the swap is complete:
          * Browse to your production URL (`webapp-yourname-d16.azurewebsites.net`). You should now see the **"VERSION 2"** content.
          * Browse to the `staging` slot URL (`webapp-yourname-d16-staging.azurewebsites.net`). You should now see the **"VERSION 1"** content (the previous production version).
          * This demonstrates the zero-downtime nature and the immediate rollback capability.

### Method 2: Azure CLI üñ•Ô∏è

1.  **Set Variables**:

    ```bash
    resourceGroup="rg-webapp-lab"
    webappName="webapp-yourname-d16"
    sourceSlot="staging"
    targetSlot="production" # The default production slot is named "production"
    ```

2.  **Perform the Swap**:

    ```bash
    az webapp deployment slot swap \
      --name $webappName \
      --resource-group $resourceGroup \
      --slot $sourceSlot \
      --target-slot $targetSlot
    ```

      * The command will execute and provide output when complete.

3.  **Verify Swap**:

      * Open your web browser and check both the production URL and the `staging` slot URL to confirm the content has swapped.

### Method 3: Azure PowerShell üíª

1.  **Set Variables**:

    ```powershell
    $resourceGroupName = "rg-webapp-lab"
    $webappName = "webapp-yourname-d16"
    $sourceSlotName = "staging"
    $targetSlotName = "production"
    ```

2.  **Perform the Swap**:

    ```powershell
    Invoke-AzWebAppSlotSwap -ResourceGroupName $resourceGroupName -Name $webappName -SourceSlotName $sourceSlotName -DestinationSlotName $targetSlotName
    ```

      * The command will execute and provide output when complete.

3.  **Verify Swap**:

      * Open your web browser and check both the production URL and the `staging` slot URL to confirm the content has swapped.

-----

## Part 5: Cleaning Up Resources (Highly Recommended)

To avoid incurring ongoing costs, always delete resources you no longer need. Deleting the resource group will remove the Web App, the App Service Plan, all deployment slots, and any associated components.

### Method 1: Azure Portal üåê

1.  **Navigate to Resource Groups**: In the Azure Portal, go to **"Resource groups"**.
2.  Find and click on your resource group: **`rg-webapp-lab`**.
3.  On the resource group's Overview blade, click **"Delete resource group"**.
4.  Type `rg-webapp-lab` to confirm, then click **"Delete"**.

### Method 2: Azure CLI üñ•Ô∏è

```bash
az group delete --name rg-webapp-lab --no-wait --yes
echo "Resource group 'rg-webapp-lab' deletion initiated."
```

### Method 3: Azure PowerShell üíª

```powershell
Remove-AzResourceGroup -Name "rg-webapp-lab" -Force -AsJob
Write-Host "Resource group 'rg-webapp-lab' deletion initiated."
```

-----

This lab has provided you with hands-on experience in using Azure App Service Deployment Slots for zero-downtime deployments, a crucial practice for maintaining continuous availability of your web applications.