# Azure App Service - Deployment Slots & Monitoring 📊

## Monitoring App Service Performance (Metrics & Logs)

Effective monitoring is the backbone of a resilient and performant application. For Azure App Service, Microsoft provides a rich suite of tools within **Azure Monitor** to collect, analyze, and act upon telemetry data. 

This data primarily falls into two categories: **Metrics** and **Logs**.

### 1. Understanding Metrics 📈

**Metrics** are numerical values that describe some aspect of your system at a particular time. They are collected at regular intervals and stored in a time-series database. Metrics are ideal for:

* **Near real-time alerting**: Because they are numerical and collected frequently, they are perfect for triggering alerts when thresholds are breached (e.g., CPU usage above 80%).
* **Dashboards and trending**: Visualizing trends over time to understand performance, capacity, and usage patterns.
* **Autoscaling**: Driving automatic scaling decisions based on real-time load.

#### Key App Service Metrics to Monitor:

Azure App Service provides a comprehensive set of platform metrics out-of-the-box, requiring no configuration. Here are some of the most common and important ones:

* **CPU Percentage**: The percentage of allocated CPU being used by your app. High CPU is often a sign of inefficient code, high traffic, or insufficient compute resources.
* **Memory Percentage**: The percentage of allocated memory being consumed. High memory usage can lead to app restarts or performance degradation.
* **HTTP Queue Length**: The number of requests waiting to be processed by your application. A consistently high queue indicates your app can't keep up with incoming requests.
* **Requests**: The total number of HTTP requests received by your app over a period. Helps track overall traffic.
* **HTTP Server Errors (5xx)**: The number of HTTP responses with a 5xx status code (e.g., 500 Internal Server Error). Indicates application failures.
* **Data In/Out**: Network traffic in and out of your app. Useful for understanding bandwidth consumption.
* **Average Response Time**: The average time it takes for your application to respond to HTTP requests. A critical indicator of user experience.
* **Connections**: The number of active connections to your web app.
* **Disk Queue Length**: The number of pending disk I/O requests. High values can indicate storage bottlenecks.

#### How to View and Analyze Metrics:

* **Azure Portal (Metrics Explorer)**:
    * Navigate to your App Service.
    * In the left menu, under **"Monitoring"**, select **"Metrics"**.
    * You can then select a **Metric Namespace** (e.g., "App Service Plan Standard Metrics" or "App Service Http 4xx" for specific HTTP errors), choose a **Metric** (e.g., "CPU Percentage"), an **Aggregation** (e.g., Average, Max), and a **Time Range**.
    * You can also **Split** by dimensions (e.g., by instance if your app is scaled out) or apply **Filters**.
    * This interface allows you to create custom charts and save them to dashboards.
* **Azure Dashboards**: Pin metric charts directly from the Metrics Explorer to custom Azure Dashboards for a consolidated view of your application's health.
* **Azure Monitor Workbooks**: For more interactive and customizable reporting and troubleshooting, Workbooks provide a flexible canvas to combine metric charts, log queries, text, and parameters.
* **Programmatic Access**: Use Azure CLI, Azure PowerShell, or Azure Monitor REST APIs/SDKs to programmatically retrieve metric data for custom automation or integration with external monitoring tools.

### 2. Understanding Logs 📝

**Logs** provide detailed, contextual information about events occurring within your application and the App Service platform. Unlike metrics (which are numerical aggregates), logs are typically text-based records. They are invaluable for:

* **Detailed troubleshooting**: Diagnosing specific errors, tracing user requests, and understanding application behavior at a granular level.
* **Auditing and security**: Tracking actions performed on your App Service and identifying potential security incidents.
* **Deep analysis**: When combined with a powerful query language (like Kusto Query Language in Log Analytics), logs allow for complex data correlation and root cause analysis.

#### Types of App Service Logs:

Azure App Service offers several categories of logs that you can enable:

1.  **Application Logs**:
    * Logs generated by your application code itself (e.g., `console.log` in Node.js, `Debug.WriteLine` in .NET, `print()` in Python/PHP).
    * Can be streamed to the **file system** (for temporary debugging, retention limited to 12 hours) or to **Azure Blob Storage** (for long-term storage).
    * For Windows apps, you can also send them to a Log Analytics Workspace via diagnostic settings for advanced querying.
    * **Level**: You can set the logging level (Error, Warning, Info, Verbose/Debug) to control the verbosity.

2.  **Web Server (HTTP) Logs**:
    * Raw HTTP request logs generated by the App Service's web server (IIS on Windows, Nginx/Apache on Linux).
    * Contain details about every request, including IP address, request method, URL, status code, response time, user agent, etc.
    * Can be stored in the **file system** or **Azure Blob Storage**.
    * Crucial for understanding traffic patterns, identifying popular pages, and debugging HTTP-related issues (e.g., 404s, 500s).

3.  **Detailed Error Messages**:
    * Full HTML error pages generated by the server when a specific HTTP error occurs (e.g., 401, 403, 404, 500).
    * Stored in the App Service **file system** and can be downloaded. Useful during development/testing but usually disabled in production to avoid exposing sensitive information.

4.  **Failed Request Tracing (FREB Logs)**:
    * Detailed XML-based logs that trace the execution flow of a request through the IIS pipeline (Windows apps only).
    * Extremely verbose and powerful for diagnosing complex request failures, performance bottlenecks within IIS, or module issues.
    * Stored in the App Service **file system**.

5.  **Deployment Logs**:
    * Logs related to deployment operations (e.g., Git pushes, FTP deployments, Azure DevOps deployments).
    * Accessible via the Kudu console or Deployment Center. Useful for troubleshooting deployment failures.

6.  **Container Logs (for Docker/Linux App Services)**:
    * Console output (stdout/stderr) from your Docker container.
    * Essential for debugging containerized applications.
    * Can be viewed live via **Log Stream** or stored in the file system/blob storage.

7.  **Platform Logs (Resource Logs / Diagnostic Logs)**:
    * These are logs emitted by the Azure App Service platform itself, describing operations performed on your service (e.g., App Service plan scaling, restarts, configuration changes).
    * These are configured via **Diagnostic Settings** in Azure Monitor and are typically sent to a **Log Analytics Workspace**, **Azure Storage Account**, or an **Event Hub**.

8.  **Activity Log (Subscription-level)**:
    * Provides insight into *control plane* operations on your App Service resource (e.g., who created/deleted the app, scaled the plan, restarted the app).
    * Accessible from the App Service's "Activity log" blade or the global Azure Monitor Activity Log.

#### How to View and Analyze Logs:

* **Azure Portal (Log Stream)**: For real-time viewing of application and container console logs. Navigate to your App Service -> **"Log stream"**. Requires enabling "Application logging (File System)" or "Container logs".
* **Azure Portal (Kudu Console / Advanced Tools)**: Access `https://<your-webapp-name>.scm.azurewebsites.net`. Under **"Debug console" -> "CMD"** or **"PowerShell"**, you can browse the `LogFiles` directory to download various log files. Also, **"Tools" -> "Diagnostic dump"** can download a comprehensive set of logs.
* **Azure Storage Account**: If you configure application or web server logs to go to Blob Storage, you can browse and download them directly from the storage account.
* **Log Analytics Workspace (via Azure Monitor Logs)**:
    * This is the **recommended solution for comprehensive logging and analysis**.
    * You configure **Diagnostic Settings** on your App Service to send various log categories (e.g., AppServiceHTTPLogs, AppServiceAppLogs) to a Log Analytics Workspace.
    * Once logs are in Log Analytics, you can use **Kusto Query Language (KQL)** to perform powerful queries, create visualizations, and build sophisticated alerts.
    * **Example KQL**: `AppServiceHTTPLogs | where HttpStatusCode == 500 | summarize count() by ClientIp`
* **Application Insights**: A powerful Application Performance Management (APM) service that integrates deeply with App Service. It automatically collects application logs, request telemetry, dependencies, exceptions, and performance metrics, providing an end-to-end view of your application. While it leverages metrics and logs, it's a higher-level solution that combines and enriches this data for deeper insights and distributed tracing.

### Best Practices for Monitoring 💡

* **Enable appropriate logging**: Don't enable *all* logs at "Verbose" in production, as this can generate massive amounts of data and incur costs. Start with "Information" or "Warning" and increase verbosity for debugging.
* **Send logs to Log Analytics**: For production applications, always route your logs to a Log Analytics Workspace for centralized storage, advanced querying, and correlation.
* **Use Application Insights**: For detailed application-level monitoring, distributed tracing, and user experience insights, integrate Application Insights.
* **Set up Alerts**: Define alert rules based on critical metrics (e.g., CPU, Memory, HTTP 5xx errors, HTTP queue length) and log patterns (e.g., high rate of exceptions) to be proactively notified of issues.
* **Regularly Review Dashboards**: Monitor your custom dashboards in Azure Portal or custom tools to stay on top of application health.
* **Health Checks**: Implement health checks within your application and configure App Service's health check feature to automatically restart unhealthy instances.

By diligently collecting and analyzing metrics and logs, you gain the visibility needed to proactively identify performance bottlenecks, troubleshoot issues efficiently, and ensure the continuous health and availability of your Azure App Service applications.