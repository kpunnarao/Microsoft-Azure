# Azure App Service - Deployment Slots & Monitoring 📊

This section will be primarily theoretical, as comprehensive troubleshooting often involves a deep dive into logs and metrics that we've just covered in the previous lab. 

However, we'll outline common issues and the structured approach to tackle them.

## Troubleshooting Common App Service Issues

Even with robust monitoring in place, issues can arise in any application. Understanding common problems in Azure App Service and knowing a systematic approach to troubleshooting them is crucial for minimizing downtime and ensuring application reliability.

### General Troubleshooting Principles 🧠

Before diving into specific issues, adopt a structured approach:

1.  **Don't Panic\!**: Stay calm and systematic.
2.  **Verify Service Health**: Check the Azure Status page ([status.azure.com](https://status.azure.com)) and your Azure Portal's Service Health blade. Sometimes, the problem isn't your app, but an underlying Azure service issue.
3.  **Recent Changes**: Did anything change recently? New code deployment, configuration change, scale operation, network alteration? Recent changes are often the root cause.
4.  **Start Broad, Then Narrow Down**: Look at high-level metrics first (CPU, memory, requests), then dive into specific logs (HTTP errors, application logs) for details.
5.  **Replicate the Issue**: If possible, try to reproduce the problem to gather real-time data.
6.  **Utilize Built-in Tools**: Azure App Service provides powerful diagnostic tools.
7.  **Document Findings**: Keep notes on what you've tried and what you've found.

### Common App Service Issues and Troubleshooting Steps 🛠️

Let's explore common problems and the diagnostic tools/methods to resolve them.

#### Issue 1: "My App is Down" or "HTTP Error 500" (Application Crashing/Not Starting) ❌

**Symptoms**: Users see a generic "HTTP Error 500", "Service Unavailable", or "Application Error" page. The site doesn't load.

**Likely Causes**:

  * Application code errors (e.g., unhandled exceptions during startup, invalid configuration).
  * Missing dependencies (DLLs, packages, modules).
  * Incorrect runtime version or platform bitness (32-bit vs. 64-bit).
  * Connection string issues (cannot connect to database).
  * High resource consumption leading to app pool crashes/restarts.

**Troubleshooting Steps**:

1.  **Check Azure Portal "Overview"**: Is the App Service running? Has it stopped? Is the App Service Plan healthy?
2.  **Restart the Web App**: Often, a simple restart can resolve transient issues or clear memory.
      * **Azure Portal**: Navigate to your Web App -\> **Overview** -\> **Restart**.
      * **Azure CLI**: `az webapp restart --name <webapp-name> --resource-group <resource-group-name>`
3.  **Review Application Logs (Most Important)**: This is your primary source of truth for application-level errors.
      * **Log Stream**: View real-time `console.log` or equivalent output from your application. Look for exceptions, startup errors, or binding failures.
      * **Log Analytics (AppServiceAppLogs)**: Query your `AppServiceAppLogs` table for `Error` or `Critical` level messages during the time of the outage.
      * **Kudu Console (LogFiles)**: Download `applicationHost.log` or other app-specific logs for deeper analysis.
4.  **Check Diagnostic Settings (if not already configured)**: Ensure `AppServiceAppLogs` are enabled and flowing to Log Analytics.
5.  **App Service Diagnostics and Solve Problems**:
      * Navigate to your Web App -\> **Diagnose and solve problems**.
      * Select **"Availability and Performance"** -\> **"Web App Down"** or **"Application Crashes"**. This interactive tool often provides immediate insights, common causes, and recommended actions based on collected data. It can even show specific exception messages if Application Insights is enabled.
6.  **Application Insights**: If integrated, check **Failures** blade for exceptions, failed requests, and dependency issues. Use the **Live Metrics Stream** for real-time telemetry.
7.  **Review Deployment Logs**: If the issue started after a new deployment, check the Deployment Center logs for failures during the deployment process.
8.  **Check App Settings/Connection Strings**: Verify that all required environment variables, secrets, and database connection strings are correctly configured and accessible by the app. Pay attention to "slot settings" if using deployment slots.

#### Issue 2: Slow Application Performance 🐌

**Symptoms**: Pages load slowly, requests time out, high latency.

**Likely Causes**:

  * Insufficient compute resources (CPU/memory bottleneck).
  * Inefficient application code (e.g., long-running database queries, unoptimized loops).
  * External dependency issues (slow database, slow external API).
  * Network latency.
  * Cold starts (if the app idles and needs to restart frequently).

**Troubleshooting Steps**:

1.  **Monitor Metrics (CPU, Memory, Requests, Response Time, HTTP Queue Length)**:
      * **CPU Percentage**: Consistently high CPU (\>80-90%) indicates a bottleneck.
      * **Memory Percentage**: High memory usage can lead to swapping or restarts.
      * **HTTP Queue Length**: A growing queue means your app can't process requests fast enough.
      * **Average Response Time**: Directly shows the latency experienced by users.
      * If resources are maxed out, consider **scaling up** (larger VM size in App Service Plan) or **scaling out** (more instances).
2.  **App Service Diagnostics and Solve Problems**:
      * Select **"Availability and Performance"** -\> **"Web App Slow"** or **"High CPU Usage"** / **"Memory Usage"**. These diagnostics provide insights into potential root causes.
3.  **Application Insights (Crucial for Performance)**:
      * **Performance blade**: Identify slow requests, slowest dependencies (database calls, external APIs), and longest-running operations.
      * **Profiler**: Automatically collects performance traces for live production applications, highlighting hot paths in your code that are consuming the most CPU.
      * **Live Metrics Stream**: Observe real-time performance indicators.
4.  **Web Server (HTTP) Logs**: Analyze `time-taken` fields for slow requests.
      * **Log Analytics (AppServiceHTTPLogs)**: Query to find requests with unusually high response times.
        ```kusto
        AppServiceHTTPLogs
        | where TimeTaken > 5000 // requests taking longer than 5 seconds
        | project TimeGenerated, CsUriStem, TimeTaken, ClientIp
        | order by TimeTaken desc
        ```
5.  **Failed Request Tracing (Windows only)**: For very deep analysis of request processing within IIS.
6.  **Check "Always On" Setting**: For non-Free/Shared plans, ensure "Always On" is enabled. This prevents your app from being unloaded due to inactivity, reducing cold start times. (Under Web App -\> Configuration -\> General settings).
7.  **Connection Pool Exhaustion**: If your app makes many external calls (e.g., to databases), ensure connection pooling is configured correctly in your application code to avoid exhausting available connections.

#### Issue 3: Deployment Failures 📦

**Symptoms**: New code doesn't appear, deployment pipeline fails, error messages during CI/CD.

**Likely Causes**:

  * Incorrect build configuration (e.g., missing `web.config` for .NET, `start.sh` for Linux containers).
  * Dependency installation failures (e.g., `npm install` fails, `pip install` fails).
  * Permissions issues.
  * Resource limits (e.g., disk space on the App Service Plan).
  * Incorrect deployment method or target.

**Troubleshooting Steps**:

1.  **Deployment Center Logs**: In the Azure Portal, go to your Web App -\> **Deployment Center**. Review the logs of the failed deployment. This often provides the exact error message from the build process.
2.  **Kudu Console (SCM Site)**: Access `https://<your-webapp-name>.scm.azurewebsites.net`.
      * **LogFiles/Git** or **LogFiles/Kudu/trace** for Git deployment details.
      * **LogFiles/deployments**: For general deployment logs.
      * **`_diag` endpoint**: `https://<your-webapp-name>.scm.azurewebsites.net/_diag` for live deployment logs.
3.  **Build Output**: If using Azure DevOps or GitHub Actions, review the detailed build output logs in your pipeline for specific errors during compilation or dependency installation.
4.  **Disk Space**: Check the "Disk Quota" in the App Service Overview. If full, deployments can fail. Clear old files via Kudu or scale up the App Service Plan.
5.  **Runtime and Platform Mismatch**: Ensure your App Service's configured runtime stack (e.g., Node.js 18) matches what your application expects, and the OS (Linux/Windows) is correct.
6.  **Local Test**: Can the application build and run successfully on your local machine? This helps isolate if the problem is environmental or code-related.

#### Issue 4: Custom Domain / SSL Issues 🔐

**Symptoms**: Custom domain doesn't resolve, "Not Secure" warning, SSL certificate errors.

**Likely Causes**:

  * Incorrect DNS records at the domain registrar.
  * SSL certificate not correctly bound to the custom domain in App Service.
  * Certificate expiration.
  * Domain verification pending.

**Troubleshooting Steps**:

1.  **Custom Domains Blade in Azure Portal**:
      * Navigate to your Web App -\> **Custom domains**.
      * Check the status indicators next to your custom domain. Are there any warnings or "X" marks?
      * The portal will often provide explicit instructions for missing DNS records (CNAME, A, TXT for verification).
2.  **DNS Propagation**: Use online DNS lookup tools (e.g., `digwebinterface.com`, `dnschecker.org`) to verify that your CNAME/A/TXT records have propagated correctly globally. DNS changes can take time.
3.  **SSL Binding**: Ensure the correct SSL certificate is bound to your custom domain and the TLS/SSL type is set correctly (e.g., SNI SSL for shared IPs, IP SSL for dedicated IPs if needed).
4.  **Certificate Expiration**: Check the expiry date of your SSL certificate. For App Service Managed Certificates, Azure handles renewal, but custom uploaded certificates need manual renewal.
5.  **"HTTPS Only" Setting**: Ensure "HTTPS Only" is enabled if you want all HTTP traffic redirected (recommended). (Under Web App -\> Custom domains -\> HTTPS Only).

### Azure App Service Diagnostics 🌟 (Revisit this key tool\!)

This portal-based interactive experience is your first stop for most issues. It uses machine learning to diagnose common problems without requiring any configuration.

  * **How to access**: Navigate to your App App -\> **Diagnose and solve problems**.
  * **Key Features**:
      * **Search Bar**: Quickly find diagnostics for specific issues.
      * **Risk Alerts**: Proactive checks and recommendations.
      * **Troubleshooting Categories**: Organized diagnostics for Availability & Performance, Configuration & Management, SSL & Domains, Deployment, Networking, etc.
      * **Diagnostic Tools**: Advanced tools like Application Event Logs, Memory Dumps, CPU monitoring.

By understanding these common issues and systematically applying the diagnostic tools available in Azure App Service, you can effectively troubleshoot and maintain the health of your cloud applications.