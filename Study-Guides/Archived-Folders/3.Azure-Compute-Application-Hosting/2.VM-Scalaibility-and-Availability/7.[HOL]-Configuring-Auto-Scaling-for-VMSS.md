# Lab: Configuring Auto-Scaling for VMSS ⚙️

Now that you have an understanding of what Virtual Machine Scale Sets (VMSS) are and why they're beneficial, let's get into the practical aspect: **Configuring Auto-Scaling for VMSS**. 

This is where the magic happens, allowing your application to dynamically adjust its capacity to meet demand.

This lab will guide you through setting up auto-scaling rules for an Azure Virtual Machine Scale Set using the Azure Portal, Azure CLI, and Azure PowerShell.

## Lab Scenario 🏰

You have a web application hosted on a VMSS, and you want to ensure it can handle fluctuating user traffic efficiently. 

You'll configure rules to automatically scale out (add VMs) when CPU usage is high and scale in (remove VMs) when CPU usage is low, thereby optimizing performance and costs.

**Assumptions:**

  * You have an **Azure Virtual Machine Scale Set (VMSS)** already deployed in your Azure subscription. If not, you can quickly create a basic one via the Azure Portal. For the purposes of this lab, a simple Linux VMSS will suffice.
  * You have access to the Azure Portal, Azure CLI, and Azure PowerShell.

-----

## Part 1: Prerequisites

  * An active Azure Subscription.
  * Access to the Azure Portal ([portal.azure.com](https://portal.azure.com)).
  * An existing **Virtual Machine Scale Set**. If you need to create one for this lab:
      * **Azure Portal**: Search for "Virtual machine scale sets" -\> "Create" -\> fill in basics (Resource Group, Name, Region, Orchestration Mode (Flexible is recommended for new deployments), Image, Size, Admin account, etc.). On the "Scaling" tab, choose "Manual scale" for now, and set an initial instance count (e.g., 2). You'll change this to autoscale later.
      * **Azure CLI (example for a basic Linux VMSS)**:
        ```bash
        # Set variables
        resourceGroup="myvmssrg"
        vmssName="myvmss"
        location="eastus" # Or your preferred location

        # Create a resource group
        az group create --name $resourceGroup --location $location

        # Create a VMSS with a basic configuration (Ubuntu Server, Standard_B2s VM size)
        az vmss create \
          --resource-group $resourceGroup \
          --name $vmssName \
          --image UbuntuLTS \
          --instance-count 2 \
          --admin-username azureuser \
          --generate-ssh-keys \
          --upgrade-policy-mode automatic \
          --load-balancer Standard \
          --orchestration-mode Flexible # Flexible orchestration is recommended
        ```

-----

## Part 2: Configuring Auto-Scaling Rules

### Method 1: Azure Portal 🌐

1.  **Sign in to the Azure Portal**:

      * Go to [**portal.azure.com**](https://portal.azure.com).

2.  **Navigate to your Virtual Machine Scale Set**:

      * In the global search bar, type your VMSS name (e.g., `myvmss`) and select it.
      * Alternatively, go to **"Virtual machine scale sets"** from the left-hand menu and select your VMSS.

3.  **Access Scaling Settings**:

      * On the VMSS blade, under **"Settings"**, select **"Scaling"**.

4.  **Configure Custom Autoscale**:

      * By default, it might be set to "Manual scale" or have no autoscale settings.
      * Select **"Custom autoscale"**.
      * Provide a **"Autoscale setting name"** (e.g., `CpuBasedScaling`).
      * Ensure the **Resource Group** is correct.

5.  **Define Instance Limits**:

      * Under **"Instance limits"**, set:
          * **Minimum instances**: `2` (e.g., you always want at least 2 VMs for redundancy).
          * **Maximum instances**: `10` (e.g., to cap costs and prevent uncontrolled growth).
          * **Default instances**: `2` (the number of instances when no rules are met, or at startup).

6.  **Add Scale-Out Rule (Increase VMs)**:

      * Under **"Scale conditions"**, click **"Add a rule"**.
      * **Metric source**: "Current resource (myvmss)"
      * **Metric name**: "Percentage CPU" (or choose another relevant metric like Memory, Network In/Out, etc.).
      * **Time aggregation**: "Average"
      * **Operator**: "Greater than"
      * **Metric threshold to trigger scale action**: `70` (meaning if average CPU is \> 70%).
      * **Duration (minutes)**: `5` (The CPU must be \> 70% for at least 5 minutes before scaling out).
      * **Time grain statistic**: "Average"
      * **Operation**: "Increase count by"
      * **Instance count**: `1` (Add 1 VM).
      * **Cool down (minutes)**: `5` (Wait 5 minutes after a scale action before evaluating rules again to prevent "flapping").
      * Click **"Add"**.

7.  **Add Scale-In Rule (Decrease VMs)**:

      * Click **"Add a rule"** again.
      * **Metric source**: "Current resource (myvmss)"
      * **Metric name**: "Percentage CPU"
      * **Time aggregation**: "Average"
      * **Operator**: "Less than"
      * **Metric threshold to trigger scale action**: `30` (meaning if average CPU is \< 30%).
      * **Duration (minutes)**: `5` (The CPU must be \< 30% for at least 5 minutes before scaling in).
      * **Time grain statistic**: "Average"
      * **Operation**: "Decrease count by"
      * **Instance count**: `1` (Remove 1 VM).
      * **Cool down (minutes)**: `5`
      * Click **"Add"**.

8.  **Save Autoscale Settings**:

      * Click **"Save"** at the top of the "Scaling" blade.

9.  **Monitor Scaling (Optional)**:

      * On the "Scaling" blade, select **"Run history"** to see past and current scaling actions.
      * You can also go to **Azure Monitor** -\> **Autoscale** to view all autoscale settings and their history.

-----

### Method 2: Azure CLI 🖥️

1.  **Open Azure Cloud Shell (Bash) or your local Terminal with Azure CLI installed**.

      * Ensure you are logged in to Azure CLI (`az login`).

2.  **Set Variables**:

    ```bash
    resourceGroup="myvmssrg"
    vmssName="myvmss"
    autoscaleSettingName="CpuBasedScaling"
    ```

3.  **Define Autoscale Profile (Min/Max/Default Instances)**:

    ```bash
    az monitor autoscale create \
      --resource-group $resourceGroup \
      --resource $vmssName \
      --resource-type Microsoft.Compute/virtualMachineScaleSets \
      --name $autoscaleSettingName \
      --min-count 2 \
      --max-count 10 \
      --count 2 # Default instance count
    ```

4.  **Add Scale-Out Rule**:

    ```bash
    az monitor autoscale rule create \
      --resource-group $resourceGroup \
      --autoscale-name $autoscaleSettingName \
      --condition "Percentage CPU > 70 avg 5m" \
      --scale out 1 \
      --cool-down 5
    ```

5.  **Add Scale-In Rule**:

    ```bash
    az monitor autoscale rule create \
      --resource-group $resourceGroup \
      --autoscale-name $autoscaleSettingName \
      --condition "Percentage CPU < 30 avg 5m" \
      --scale in 1 \
      --cool-down 5
    ```

6.  **Verify Autoscale Settings**:

    ```bash
    az monitor autoscale show --resource-group $resourceGroup --name $autoscaleSettingName --output json
    ```

    *This will show the full JSON definition of your autoscale settings and rules.*

-----

### Method 3: Azure PowerShell 💻

1.  **Open Azure Cloud Shell (PowerShell) or your local PowerShell 7 terminal with Azure PowerShell installed**.

      * Ensure you are logged in to Azure PowerShell (`Connect-AzAccount`).

2.  **Set Variables**:

    ```powershell
    $resourceGroupName = "myvmssrg"
    $vmssName = "myvmss"
    $autoscaleSettingName = "CpuBasedScaling"
    ```

3.  **Create Scale-Out Rule Object**:

    ```powershell
    $scaleOutRule = New-AzAutoscaleScaleRuleObject `
        -MetricTriggerMetricName "Percentage CPU" `
        -MetricTriggerMetricResourceUri "/subscriptions/$((Get-AzContext).Subscription.Id)/resourceGroups/$resourceGroupName/providers/Microsoft.Compute/virtualMachineScaleSets/$vmssName" `
        -MetricTriggerTimeGrain "PT1M" ` # 1 minute
        -MetricTriggerStatistic "Average" `
        -MetricTriggerTimeWindow "PT5M" ` # 5 minutes
        -MetricTriggerOperator "GreaterThan" `
        -MetricTriggerThreshold 70 `
        -MetricTriggerScaleActionDirection "Increase" `
        -MetricTriggerScaleActionType "ChangeCount" `
        -MetricTriggerScaleActionValue 1 `
        -MetricTriggerScaleActionCooldown "PT5M" # 5 minutes
    ```

4.  **Create Scale-In Rule Object**:

    ```powershell
    $scaleInRule = New-AzAutoscaleScaleRuleObject `
        -MetricTriggerMetricName "Percentage CPU" `
        -MetricTriggerMetricResourceUri "/subscriptions/$((Get-AzContext).Subscription.Id)/resourceGroups/$resourceGroupName/providers/Microsoft.Compute/virtualMachineScaleSets/$vmssName" `
        -MetricTriggerTimeGrain "PT1M" `
        -MetricTriggerStatistic "Average" `
        -MetricTriggerTimeWindow "PT5M" `
        -MetricTriggerOperator "LessThan" `
        -MetricTriggerThreshold 30 `
        -MetricTriggerScaleActionDirection "Decrease" `
        -MetricTriggerScaleActionType "ChangeCount" `
        -MetricTriggerScaleActionValue 1 `
        -MetricTriggerScaleActionCooldown "PT5M"
    ```

5.  **Create Autoscale Profile**:

    ```powershell
    $autoscaleProfile = New-AzAutoscaleProfileObject `
        -Name "Default" `
        -CapacityDefault 2 `
        -CapacityMinimum 2 `
        -CapacityMaximum 10 `
        -Rule $scaleOutRule,$scaleInRule
    ```

    *Note: You can define multiple profiles for scheduled scaling (e.g., different rules for weekdays vs. weekends).*

6.  **Apply Autoscale Settings**:

    ```powershell
    New-AzAutoscaleSetting `
        -ResourceGroupName $resourceGroupName `
        -Name $autoscaleSettingName `
        -Location (Get-AzResourceGroup -Name $resourceGroupName).Location `
        -TargetResourceId (Get-AzVmss -ResourceGroupName $resourceGroupName -Name $vmssName).Id `
        -Profile $autoscaleProfile
    ```

7.  **Verify Autoscale Settings**:

    ```powershell
    Get-AzAutoscaleSetting -ResourceGroupName $resourceGroupName -Name $autoscaleSettingName | Format-List
    ```

    *This will show the details of your autoscale configuration.*

-----

## Part 3: Simulating Load (Optional, but highly recommended for testing)

To observe your auto-scaling rules in action, you need to generate load on your VMSS instances.

1.  **SSH into one of your VMSS instances**. (Refer to Day 14 lab if needed).

      * Get the public IP of your load balancer associated with the VMSS (or one of the VM instances if you didn't set up a load balancer for initial testing).
      * `ssh azureuser@<VMSS_Public_IP_or_Instance_IP>`

2.  **Install a CPU stress tool**:

      * **For Linux VMs**:
        ```bash
        sudo apt update
        sudo apt install stress -y
        ```
      * **For Windows VMs**: You might use a tool like `Prime95` or a simple PowerShell script to generate CPU load.

3.  **Generate CPU Load**:

      * **Linux (using `stress`)**:

        ```bash
        stress --cpu 4 --timeout 300s # Stresses 4 CPU cores for 5 minutes
        ```

        *(Adjust `--cpu` based on your VM size's core count. You might need to run this on multiple instances to get the average CPU up across the scale set).*

      * **Windows (PowerShell - rudimentary example)**:

        ```powershell
        # Open multiple PowerShell windows and run this in each to increase load
        while ($true) {
            # This creates an infinite loop, consuming CPU
            # To stop, press Ctrl+C in the PowerShell window
        }
        ```

4.  **Monitor Scaling**:

      * Go back to the Azure Portal -\> your VMSS -\> **"Scaling"** blade -\> **"Run history"**.
      * You should start to see scale-out events triggered after a few minutes (depending on your `Duration` and `Cool down` settings).
      * Once the load is removed, after some time, you should observe scale-in events.

-----

## Part 4: Clean Up Resources (Optional but Recommended)

To avoid incurring ongoing costs, always delete resources you no longer need. Deleting the resource group will remove the VMSS, load balancer, public IPs, disks, and associated networking.

### Method 1: Azure Portal 🌐

1.  **Navigate to Resource Groups**: In the Azure Portal, go to **"Resource groups"**.
2.  Find and click on your resource group: **`myvmssrg`** (or the one containing your VMSS).
3.  On the resource group's Overview blade, click **"Delete resource group"**.
4.  Type `myvmssrg` to confirm, then click **"Delete"**.

### Method 2: Azure CLI 🖥️

```bash
az group delete --name myvmssrg --no-wait --yes
echo "Resource group 'myvmssrg' deletion initiated."
```

### Method 3: Azure PowerShell 💻

```powershell
Remove-AzResourceGroup -Name "myvmssrg" -Force -AsJob
Write-Host "Resource group 'myvmssrg' deletion initiated."
```

-----

By completing this lab, you've successfully configured and observed the automatic scaling behavior of an Azure Virtual Machine Scale Set, a critical skill for managing dynamic, high-traffic applications in Azure.