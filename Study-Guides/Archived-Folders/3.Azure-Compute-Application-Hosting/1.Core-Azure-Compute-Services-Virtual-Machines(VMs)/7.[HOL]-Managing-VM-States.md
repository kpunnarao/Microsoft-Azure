# Lab: Managing VM States (Start, Stop, Restart, Deallocate) üîÑ

This lab will guide you through the different operational states of an Azure Virtual Machine and how to manage them using the Azure Portal, Azure CLI, and Azure PowerShell. 

Understanding these states is critical for controlling costs and ensuring your VMs are available when needed.

## Lab Scenario üè∞

You have a Linux VM (or Windows VM) running in Azure, and you need to understand how to control its power state to manage its lifecycle and optimize costs.

**Assumptions:**

  * You have an **Azure Virtual Machine** already deployed and running in your subscription (e.g., `vm-linux-01` in `rg-linuxvm-lab` from the previous lab, or any other existing VM).
  * You have access to the Azure Portal, Azure CLI, and Azure PowerShell.

-----

## Part 1: Understanding VM States

Azure VMs can exist in several states, each with different implications for billing and availability:

  * **Running**: üü¢ The VM is fully operational, actively consuming compute resources (CPU, memory, storage, network). **You are being billed for compute and storage.**
  * **Stopped (Deallocated)**: üõë The VM is shut down, and the underlying hardware resources (CPU, memory, temporary storage) have been released. **You are only billed for persistent storage (OS and data disks) and public IPs, not for compute.** This is the key state for cost savings when a VM is not in use.
  * **Stopped (Allocated)**: ‚è∏Ô∏è This state usually occurs when you initiate a "shutdown" from within the guest OS (e.g., `shutdown -h now` on Linux, "Shut down" from Windows Start menu) without explicitly "stopping" or "deallocating" it through the Azure Portal/CLI/PowerShell. The VM is off, but its allocated compute resources are reserved. **You are still being billed for compute and storage.** Avoid this state for cost optimization.
  * **Starting**: ‚û°Ô∏è The VM is in the process of spinning up.
  * **Stopping**: ‚¨áÔ∏è The VM is in the process of shutting down and deallocating.
  * **Updating**: üõ†Ô∏è The VM is undergoing maintenance or an update operation.
  * **Failed**: ‚ùå The VM encountered an error during a state transition or operation.

**Key Takeaway for Cost Saving**: To stop billing for compute resources, you *must* ensure the VM is in the **Stopped (Deallocated)** state.

-----

## Part 2: Managing VM States

Let's practice managing these states using the different Azure management tools.

### Method 1: Azure Portal üåê

1.  **Sign in to the Azure Portal**:

      * Open your web browser and navigate to [**portal.azure.com**](https://portal.azure.com).
      * Sign in with your Azure account.

2.  **Navigate to your Virtual Machine**:

      * In the global search bar, search for your VM (e.g., `vm-linux-01`) and select it.
      * Alternatively, go to **"Virtual machines"** from the left-hand menu and select your VM.

3.  **View Current State**:

      * On the VM's **Overview** blade, locate the **"Status"** field. It should say **"Running"**.

4.  **Stop (Deallocate) the VM**:

      * In the top menu bar of the VM's Overview blade, click the **"Stop"** button.
      * A confirmation dialog will appear. Click **"OK"**.
      * The portal will show a notification that the VM is stopping. Wait a moment and refresh the Overview blade. The **"Status"** will change to **"Updating"**, then eventually to **"Stopped (deallocated)"**.
      * **Observe Cost Impact**: When in `Stopped (deallocated)` state, the compute billing stops.

5.  **Start the VM**:

      * Once the VM is in **"Stopped (deallocated)"** state, the **"Start"** button will become active. Click it.
      * The portal will show a notification that the VM is starting. Refresh the Overview blade. The **"Status"** will change to **"Starting"**, then eventually to **"Running"**.
      * **Observe Cost Impact**: Compute billing resumes when the VM is `Running`. Note that restarting a deallocated VM might result in a new public IP address if the previous one was dynamic.

6.  **Restart the VM**:

      * While the VM is **"Running"**, click the **"Restart"** button in the top menu bar.
      * A confirmation dialog will appear. Click **"OK"**.
      * The VM will gracefully shut down and then start up again. Its public IP address will typically remain the same during a `Restart` operation, unlike a `Stop` then `Start`.

-----

### Method 2: Azure CLI üñ•Ô∏è

This method uses command-line commands for precise control over VM states.

1.  **Open Azure Cloud Shell (Bash) or your local Terminal with Azure CLI installed**.

      * Ensure you are logged in to Azure CLI (`az login`).

2.  **Set Variables (Recommended)**:

    ```bash
    resourceGroupName="rg-linuxvm-lab" # Or your VM's resource group
    vmName="vm-linux-01" # Or your VM's name
    ```

3.  **Get Current VM Status**:

    ```bash
    az vm show --resource-group $resourceGroupName --name $vmName --query "powerState" -o tsv
    ```

    *This will output the current power state, e.g., `VM running`.*

4.  **Stop (Deallocate) the VM**:

    ```bash
    az vm deallocate --resource-group $resourceGroupName --name $vmName --no-wait
    ```

      * `deallocate`: This is the crucial command for stopping compute billing.
      * `--no-wait`: Returns control to the terminal immediately.
      * To check status after `deallocate`:
        ```bash
        az vm show --resource-group $resourceGroupName --name $vmName --query "powerState" -o tsv
        ```
        *Wait for it to show `VM deallocated`.*

5.  **Start the VM**:

    ```bash
    az vm start --resource-group $resourceGroupName --name $vmName --no-wait
    ```

      * To check status after `start`:
        ```bash
        az vm show --resource-group $resourceGroupName --name $vmName --query "powerState" -o tsv
        ```
        *Wait for it to show `VM running`.*

6.  **Restart the VM**:

    ```bash
    az vm restart --resource-group $resourceGroupName --name $vmName --no-wait
    ```

      * To check status after `restart`:
        ```bash
        az vm show --resource-group $resourceGroupName --name $vmName --query "powerState" -o tsv
        ```
        *Wait for it to show `VM running`.*

7.  **Stop (without Deallocate - NOT recommended for cost savings)**:

      * This simulates an OS-level shutdown, but compute resources remain allocated. **Avoid this for cost savings.**

    <!-- end list -->

    ```bash
    az vm stop --resource-group $resourceGroupName --name $vmName --no-wait
    ```

      * Check power state: It will show `VM stopped`. You are still being billed for compute in this state.
      * To deallocate from this state, you'd need to run `az vm deallocate` again.

-----

### Method 3: Azure PowerShell üíª

This method uses PowerShell cmdlets for managing VM states, great for scripting.

1.  **Open Azure Cloud Shell (PowerShell) or your local PowerShell 7 terminal with Azure PowerShell installed**.

      * Ensure you are logged in to Azure PowerShell (`Connect-AzAccount`).

2.  **Set Variables (Recommended)**:

    ```powershell
    $resourceGroupName = "rg-linuxvm-lab" # Or your VM's resource group
    $vmName = "vm-linux-01" # Or your VM's name
    ```

3.  **Get Current VM Status**:

    ```powershell
    (Get-AzVM -ResourceGroupName $resourceGroupName -Name $vmName -Status).Statuses.Code
    ```

    *This will output the current power state, e.g., `PowerState/running`.*

4.  **Stop (Deallocate) the VM**:

    ```powershell
    Stop-AzVM -ResourceGroupName $resourceGroupName -Name $vmName -Force -AsJob
    ```

      * `Stop-AzVM`: This cmdlet by default performs a deallocation.
      * `-Force`: Suppresses the confirmation prompt.
      * `-AsJob`: Runs the command as a background job, returning control immediately.
      * To check status after `Stop-AzVM`:
        ```powershell
        (Get-AzVM -ResourceGroupName $resourceGroupName -Name $vmName -Status).Statuses.Code
        ```
        *Wait for it to show `PowerState/deallocated`.*

5.  **Start the VM**:

    ```powershell
    Start-AzVM -ResourceGroupName $resourceGroupName -Name $vmName -AsJob
    ```

      * To check status after `Start-AzVM`:
        ```powershell
        (Get-AzVM -ResourceGroupName $resourceGroupName -Name $vmName -Status).Statuses.Code
        ```
        *Wait for it to show `PowerState/running`.*

6.  **Restart the VM**:

    ```powerspowershell
    Restart-AzVM -ResourceGroupName $resourceGroupName -Name $vmName -Force -AsJob
    ```

      * To check status after `Restart-AzVM`:
        ```powershell
        (Get-AzVM -ResourceGroupName $resourceGroupName -Name $vmName -Status).Statuses.Code
        ```
        *Wait for it to show `PowerState/running`.*

-----

## Part 3: Clean Up Resources (Optional but Recommended)

To avoid incurring ongoing costs for the persistent storage and public IP, it's recommended to delete the entire resource group.

### Method 1: Azure Portal üåê

1.  **Navigate to Resource Groups**: In the Azure Portal, go to **"Resource groups"**.
2.  Find and click on your resource group: **`rg-linuxvm-lab`** (or the one containing your test VM).
3.  On the resource group's Overview blade, click **"Delete resource group"**.
4.  Type `rg-linuxvm-lab` to confirm, then click **"Delete"**.

### Method 2: Azure CLI üñ•Ô∏è

```bash
az group delete --name rg-linuxvm-lab --no-wait --yes
echo "Resource group 'rg-linuxvm-lab' deletion initiated."
```

  * **Caution**: Deleting a resource group will delete ALL resources contained within it.

### Method 3: Azure PowerShell üíª

```powershell
Remove-AzResourceGroup -Name "rg-linuxvm-lab" -Force -AsJob
Write-Host "Resource group 'rg-linuxvm-lab' deletion initiated."
```

  * **Caution**: Deleting a resource group will delete ALL resources contained within it.

-----

By completing this lab, you now have a firm grasp of VM states and how to manage them effectively, which is essential for both operational efficiency and cost control in your Azure environment.