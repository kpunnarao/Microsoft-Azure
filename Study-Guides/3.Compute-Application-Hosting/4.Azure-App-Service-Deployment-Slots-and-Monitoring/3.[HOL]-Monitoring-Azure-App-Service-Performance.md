# Lab: Monitoring Azure App Service Performance (Metrics & Logs) üìä

This lab will guide you through the process of enabling various logging options for your Azure App Service, generating sample traffic, and then exploring how to view and analyze performance metrics and different types of logs within the Azure Portal and Log Analytics.

## Lab Scenario üè∞

You've deployed a web application to Azure App Service. 

Now, you need to set up comprehensive monitoring to understand its performance, diagnose potential issues, and ensure its health. 

You will enable web server and application logging, route logs to Log Analytics, explore key metrics, and perform basic log queries.

**Resources you'll be working with:**

  * **Existing Web App**: `webapp-yourname-d16` (from previous labs)
  * **Existing App Service Plan**: `plan-webapp-lab`
  * **New Resource**: **Log Analytics Workspace** (`loganalytics-webapp-lab`)
  * **Source Code for Application Logging**: A simple update to `index.html` to include a server-side log message (requires a minimal dynamic app, not just static HTML).
      * **Option 1 (Recommended for deeper logging): Node.js `app.js`**:
        ```javascript
        const express = require('express');
        const app = express();
        const port = process.env.PORT || 80;

        app.get('/', (req, res) => {
          console.log(`Request received at: ${new Date().toISOString()} for path: ${req.path}`);
          res.send(`
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Azure App Service Monitoring Lab</title>
                <style>
                    body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; background-color: #e6f7ff; }
                    h1 { color: #0056b3; }
                    p { font-size: 1.2em; }
                    .version { font-weight: bold; color: #28a745; }
                </style>
            </head>
            <body>
                <h1>Welcome to the Monitoring Lab!</h1>
                <p>This is my web app. Exploring Azure App Service monitoring.</p>
                <p class="version">Current time on server: ${new Date().toLocaleTimeString()}</p>
                <p>Accessed from: <span id="hostname">${req.hostname}</span></p>
            </body>
            </html>
          `);
        });

        app.listen(port, () => {
          console.log(`App listening on port ${port}`);
        });
        ```
        And a `package.json`:
        ```json
        {
          "name": "monitoring-lab-app",
          "version": "1.0.0",
          "description": "Simple Node.js app for Azure App Service Monitoring Lab",
          "main": "app.js",
          "scripts": {
            "start": "node app.js"
          },
          "dependencies": {
            "express": "^4.17.1"
          },
          "author": "",
          "license": "MIT"
        }
        ```
      * **Option 2 (Simpler static site for Web Server logs):** Just use the `index.html` from previous labs.

-----

## Part 1: Prerequisites

Before you begin, ensure you have:

  * An active Azure Subscription.
  * Access to the Azure Portal ([portal.azure.com](https://portal.azure.com)).
  * **For Azure CLI/PowerShell methods**: Azure CLI and/or Azure PowerShell installed and configured locally, or access to Azure Cloud Shell.
  * **Existing Web App**: The `webapp-yourname-d16` deployed to `rg-webapp-lab` from the Day 16 lab. Ensure it's running.
  * **Optional (for Application Logs)**: A GitHub repository or local Git repository updated with the simple Node.js application (`app.js` and `package.json`). If you use static HTML, you'll mainly focus on Web Server logs.

-----

## Part 2: Deploy a Simple Dynamic App (Optional but Recommended for App Logs)

If your `webapp-yourname-d16` is currently static HTML, it's beneficial to deploy a simple dynamic app (like the Node.js example) to generate application logs. If you're only focusing on Web Server logs and Metrics, you can skip this.

**Instructions**:

1.  Update your GitHub repository or local Git repository with the `app.js` and `package.json` files mentioned in the Scenario.
2.  Redeploy your web app using the method you prefer (GitHub Actions/Local Git push from Day 16).
      * **Important**: For Node.js, ensure your Web App's **Runtime Stack** is set to `Node 18 LTS` (or compatible version) in the Azure Portal under **Configuration -\> General settings**. If you change this, your app will restart.
3.  Browse to your web app's URL (`webapp-yourname-d16.azurewebsites.net`) a few times to ensure it's running and generating traffic.

-----

## Part 3: Create a Log Analytics Workspace

This is essential for centralizing and querying your logs effectively.

### Method 1: Azure Portal üåê

1.  **Search for "Log Analytics workspaces"** in the Azure Portal and click **"+ Create"**.
2.  **Basics tab**:
      * **Subscription**: Your subscription.
      * **Resource group**: Select `rg-webapp-lab`.
      * **Name**: `loganalytics-webapp-lab` (must be globally unique).
      * **Region**: `East US` (or the same region as your web app for best performance and reduced egress costs).
3.  Click **"Review + create"** then **"Create"**.

### Method 2: Azure CLI üñ•Ô∏è

```bash
resourceGroup="rg-webapp-lab"
location="eastus"
logAnalyticsWorkspaceName="loganalytics-webapp-lab" # Choose a unique name

az monitor log-analytics workspace create \
  --resource-group $resourceGroup \
  --location $location \
  --workspace-name $logAnalyticsWorkspaceName
```

### Method 3: Azure PowerShell üíª

```powershell
$resourceGroupName = "rg-webapp-lab"
$location = "EastUS"
$logAnalyticsWorkspaceName = "loganalytics-webapp-lab" # Choose a unique name

New-AzOperationalInsightsWorkspace -ResourceGroupName $resourceGroupName -Name $logAnalyticsWorkspaceName -Location $location
```

-----

## Part 4: Enable Diagnostic Logging and Send to Log Analytics

Now, let's configure your App Service to send its logs to the newly created Log Analytics Workspace.

### Method 1: Azure Portal üåê

1.  **Navigate to your Web App**: `webapp-yourname-d16`.
2.  **Access Diagnostic Settings**:
      * In the left-hand menu, under **"Monitoring"**, select **"Diagnostic settings"**.
3.  **Add Diagnostic Setting**:
      * Click **"+ Add diagnostic setting"**.
      * **Diagnostic setting name**: `send-logs-to-la` (or similar).
      * Under **"Logs"**, select the following categories:
          * `AppServiceHTTPLogs`
          * `AppServiceAppLogs` (if you deployed the Node.js app)
          * `AppServicePlatformLogs`
          * `AppServiceAuditLogs` (optional, for management plane operations)
          * `AppServiceFileAuditLogs` (optional)
      * Under **"Destination details"**, check **"Send to Log Analytics workspace"**.
          * **Subscription**: Your subscription.
          * **Log Analytics workspace**: Select `loganalytics-webapp-lab`.
      * Click **"Save"**.
      * **Wait a few minutes** for the configuration to take effect and for the first logs to start flowing.

### Method 2: Azure CLI üñ•Ô∏è

1.  **Set Variables**:
    ```bash
    resourceGroup="rg-webapp-lab"
    webappName="webapp-yourname-d16"
    logAnalyticsWorkspaceName="loganalytics-webapp-lab" # Your unique workspace name
    diagnosticSettingName="send-logs-to-la-cli"
    ```
2.  **Get Web App Resource ID and Log Analytics Workspace ID**:
    ```bash
    webappId=$(az webapp show --name $webappName --resource-group $resourceGroup --query id -o tsv)
    workspaceId=$(az monitor log-analytics workspace show --name $logAnalyticsWorkspaceName --resource-group $resourceGroup --query id -o tsv)
    ```
3.  **Create Diagnostic Setting**:
    ```bash
    az monitor diagnostic-settings create \
      --name $diagnosticSettingName \
      --resource $webappId \
      --workspace $workspaceId \
      --logs '[{category: "AppServiceHTTPLogs", enabled: true}, {category: "AppServiceAppLogs", enabled: true}, {category: "AppServicePlatformLogs", enabled: true}]' # Add/remove categories as needed
    ```
      * **Note**: For `AppServiceAppLogs` to actually capture your application's `console.log` or similar, you also need to enable "Application logging (File System)" with a level of "Information" or "Verbose" in the App Service's "App Service logs" settings. This is a separate setting from Diagnostic Settings but crucial for App Logs content.
        ```bash
        az webapp log config --name $webappName --resource-group $resourceGroup --application-logging filesystem --level information
        ```

### Method 3: Azure PowerShell üíª

1.  **Set Variables**:

    ```powershell
    $resourceGroupName = "rg-webapp-lab"
    $webappName = "webapp-yourname-d16"
    $logAnalyticsWorkspaceName = "loganalytics-webapp-lab"
    $diagnosticSettingName = "send-logs-to-la-ps"
    ```

2.  **Get Web App Resource ID and Log Analytics Workspace ID**:

    ```powershell
    $webapp = Get-AzWebApp -ResourceGroupName $resourceGroupName -Name $webappName
    $workspace = Get-AzOperationalInsightsWorkspace -ResourceGroupName $resourceGroupName -Name $logAnalyticsWorkspaceName
    ```

3.  **Define Log Categories (as an array of objects)**:

    ```powershell
    $logCategories = @(
        @{ Category = "AppServiceHTTPLogs"; Enabled = $true },
        @{ Category = "AppServiceAppLogs"; Enabled = $true },
        @{ Category = "AppServicePlatformLogs"; Enabled = $true }
    )
    ```

      * **Note**: Similar to CLI, for `AppServiceAppLogs`, ensure you enable Application Logging (File System) in the App Service itself.
        ```powershell
        Set-AzWebApp -ResourceGroupName $resourceGroupName -Name $webappName -ApplicationLogging @{ FileSystem = @{ Level = "Information" } }
        ```

4.  **Create Diagnostic Setting**:

    ```powershell
    New-AzDiagnosticSetting -Name $diagnosticSettingName -ResourceId $webapp.Id -WorkspaceId $workspace.ResourceId -Log $logCategories
    ```

      * **Wait a few minutes** for the configuration to take effect and for the first logs to start flowing.

-----

## Part 5: Generate Traffic and Observe Metrics

Let's generate some activity to see metrics populate.

1.  **Open your web app**: Browse to `http://webapp-yourname-d16.azurewebsites.net` repeatedly for a few minutes. Refresh the page, maybe 10-20 times. This will generate HTTP requests and some CPU/memory usage.
2.  **View Metrics in Azure Portal**:
      * Navigate to your Web App (`webapp-yourname-d16`).
      * In the left menu, under **"Monitoring"**, select **"Metrics"**.
      * **Metric Namespace**: Select `App Service Standard Metrics`.
      * **Metric**: Select `CPU Percentage`.
      * **Aggregation**: Select `Avg`.
      * **Time Range**: Select `Last 30 minutes`.
      * You should see a graph showing your CPU usage. Repeat for `Memory Percentage`, `Requests`, `HTTP Queue Length`.
      * **Experiment**:
          * Add multiple metrics to the same chart.
          * Use the "Add filter" option (e.g., filter by `Instance`) if you have a scaled-out app.
          * Use the "Apply splitting" option to see metrics broken down by dimension (e.g., `Instance`).
      * **Pin to Dashboard**: Click the "Pin to dashboard" icon at the top right of the metrics chart to add it to a custom Azure Dashboard for quick access.

-----

## Part 6: Query Logs in Log Analytics

This is where you gain deep insights from your collected data.

1.  **Navigate to Log Analytics Workspace**:

      * In the Azure Portal, search for "Log Analytics workspaces" and select `loganalytics-webapp-lab`.

2.  **Access Logs Query Interface**:

      * In the left menu, under **"General"**, select **"Logs"**.
      * Close any initial pop-ups. You'll see the Kusto Query Language (KQL) editor.

3.  **Basic Log Queries**:

      * **Check HTTP Logs**:
        ```kusto
        AppServiceHTTPLogs
        | project TimeGenerated, CsUriStem, HttpStatusCode, ClientIp
        | order by TimeGenerated desc
        | take 100
        ```
          * Run this query. You should see entries for the HTTP requests you made to your web app. Look for your IP address.
      * **Check Application Logs (if using Node.js app)**:
        ```kusto
        AppServiceAppLogs
        | project TimeGenerated, Message, LogLevel
        | order by TimeGenerated desc
        | take 100
        ```
          * Run this query. You should see the `Request received at:` messages generated by your Node.js application.
      * **Count HTTP 5xx Errors**:
        ```kusto
        AppServiceHTTPLogs
        | where HttpStatusCode >= 500 and HttpStatusCode < 600
        | summarize ErrorCount = count() by bin(TimeGenerated, 5m), HttpStatusCode
        | render timechart
        ```
          * (You might not have 5xx errors unless your app is actually failing).
      * **Requests from specific IP**:
        ```kusto
        AppServiceHTTPLogs
        | where ClientIp == "<YOUR_PUBLIC_IP_ADDRESS>" // Replace with your actual public IP
        | project TimeGenerated, CsUriStem, HttpStatusCode
        | order by TimeGenerated desc
        ```
      * **Explore other tables**: In the left pane, under "Tables", expand "LogManagement" and "Azure Logs" to see other tables like `AppServicePlatformLogs`, `ActivityLog`, etc. Experiment with querying them.

4.  **Live Log Stream (Alternative for quick app logs)**:

      * Navigate back to your Web App (`webapp-yourname-d16`).
      * In the left menu, under **"Monitoring"**, select **"Log stream"**.
      * If you enabled application logging (File System) and your Node.js app is running, you'll see your `console.log` messages streaming in real-time as you browse your web app.

-----

## Part 7: Cleaning Up Resources (Highly Recommended)

To avoid incurring ongoing costs, always delete resources you no longer need. Deleting the resource group will remove the Web App, App Service Plan, Log Analytics Workspace, and all associated components.

### Method 1: Azure Portal üåê

1.  **Navigate to Resource Groups**: In the Azure Portal, go to **"Resource groups"**.
2.  Find and click on your resource group: **`rg-webapp-lab`**.
3.  On the resource group's Overview blade, click **"Delete resource group"**.
4.  Type `rg-webapp-lab` to confirm, then click **"Delete"**.

### Method 2: Azure CLI üñ•Ô∏è

```bash
az group delete --name rg-webapp-lab --no-wait --yes
echo "Resource group 'rg-webapp-lab' deletion initiated."
```

### Method 3: Azure PowerShell üíª

```powershell
Remove-AzResourceGroup -Name "rg-webapp-lab" -Force -AsJob
Write-Host "Resource group 'rg-webapp-lab' deletion initiated."
```

-----

This lab has provided hands-on experience with the fundamental aspects of monitoring Azure App Service applications using Metrics and Logs, specifically leveraging Log Analytics for powerful querying. 

This knowledge is critical for maintaining healthy and performant applications in the cloud.