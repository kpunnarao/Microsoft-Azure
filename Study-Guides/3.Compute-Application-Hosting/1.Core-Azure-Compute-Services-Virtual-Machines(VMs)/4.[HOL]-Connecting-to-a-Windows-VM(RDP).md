# Lab: Connecting to a Windows VM (RDP) üñ•Ô∏è

This lab provides step-by-step instructions on how to connect to a provisioned Windows Virtual Machine (VM) in Azure using Remote Desktop Protocol (RDP). 

We'll cover connecting via the Azure Portal's built-in RDP functionality, using the Azure CLI to download the RDP file, and connecting via Azure PowerShell.

## Lab Scenario üè∞

You have successfully deployed a Windows Server VM in Azure (as per the previous lab or an existing VM) and now need to establish a Remote Desktop connection to manage and configure it.

**Assumptions:**

  * You have a **Windows Virtual Machine** already deployed in your Azure subscription (e.g., `vm-windows-01` in `rg-winvm-lab`) with a **Public IP address** and **RDP (port 3389)** allowed via its Network Security Group.
  * You have the **Administrator Username** and **Password** for the VM.
  * You have **Azure CLI** and/or **Azure PowerShell** installed and configured on your local machine (if using those methods).

-----

## Part 1: Prerequisites

  * An active Azure Subscription.
  * Access to the Azure Portal ([portal.azure.com](https://portal.azure.com)).
  * A Windows VM with a public IP address and RDP port 3389 open in its NSG.
  * The local machine you are connecting *from* must have an RDP client. (Windows has one built-in, macOS users can download "Microsoft Remote Desktop" from the App Store, Linux users can use clients like Remmina or FreeRDP).

-----

## Part 2: Connecting to the Windows VM

### Method 1: Azure Portal üåê

This is the most common and straightforward method, especially for first-time connections.

1.  **Sign in to the Azure Portal**:

      * Open your web browser and navigate to [**portal.azure.com**](https://portal.azure.com).
      * Sign in with your Azure account credentials.

2.  **Navigate to your Virtual Machine**:

      * In the Azure Portal's global search bar, type `vm-windows-01` (or your VM's name) and select it from the search results.
      * Alternatively, go to **"Virtual machines"** from the left-hand menu and select `vm-windows-01`.

3.  **Initiate RDP Connection**:

      * On the VM's **Overview** blade, locate the **"Connect"** button in the top menu bar. Click it.
      * From the dropdown, select **"RDP"**.

4.  **Download RDP File**:

      * On the RDP blade, ensure the Public IP address and Port (3389) are correct.
      * Click the **"Download RDP File"** button. Your browser will download an `.rdp` file.

5.  **Launch RDP Connection**:

      * Locate the downloaded `.rdp` file (usually in your browser's download folder) and **double-click it**.
      * A "Remote Desktop Connection" dialog box will appear. Click **"Connect"**.
      * You might receive a security warning about the publisher of the remote connection. Check the box "Don't ask me again for connections to this computer" if you trust it, then click **"Connect"** or **"Yes"**.

6.  **Enter Credentials**:

      * You will be prompted for credentials. Enter the **Username** and **Password** you defined when creating the VM (e.g., `azureuser` and your chosen password).
      * Click **"OK"**.
      * You might get a certificate warning. You can click **"Yes"** or **"Continue"** to proceed.

7.  **Successful Connection**:

      * The RDP client will connect, and you should see the Windows Server desktop of your Azure VM.

-----

### Method 2: Azure CLI üñ•Ô∏è

The Azure CLI can be used to get the public IP and even automatically download the RDP file.

1.  **Open your Terminal/Command Prompt**:

      * Ensure you are logged in to Azure CLI (`az login`).

2.  **Get the VM's Public IP Address**:

      * You can retrieve the public IP address of your VM using the following command:
        ```bash
        az vm show --resource-group rg-winvm-lab --name vm-windows-01 --query "publicIps" --output tsv
        ```
        *Replace `rg-winvm-lab` and `vm-windows-01` with your actual resource group and VM names if different.*
      * This command will output only the public IP address, which you can copy.

3.  **Download the RDP File (Optional but Recommended)**:

      * The CLI can directly generate and download an RDP file for you. This is convenient as it pre-populates the IP and port.

      * Navigate to a directory where you want to save the RDP file (e.g., `cd C:\Users\YourUser\Downloads` or `cd ~/Downloads`).

      * Run the following command:

        ```bash
        az vm show --resource-group rg-winvm-lab --name vm-windows-01 --query "{PublicIP:publicIps, OS:osProfile.windowsConfiguration}" -otsv --output tsv > vm-windows-01.rdp
        ```

        *This command attempts to extract the public IP and indicates a Windows OS, then redirects the output to a file. **Note:** Direct RDP file generation isn't a single `az vm` command output. A more robust method to get the correct RDP content would involve using `az vm get-rdp-file` but that's currently a feature request. For now, the most common CLI approach is to get the IP and connect manually.*

      * **Alternative (Manual Connection)**: If the above command doesn't generate a full `.rdp` file, simply copy the Public IP address from step 2. Then, manually open your RDP client (as in Method 1, step 2) and paste the IP address.

4.  **Connect using RDP Client**:

      * If you successfully downloaded the `.rdp` file, double-click it.
      * If you copied the IP, open your RDP client and paste the IP.
      * Proceed with entering the Username and Password as in Method 1, step 6.

-----

### Method 3: Azure PowerShell üíª

Azure PowerShell cmdlets can also fetch VM details, including the public IP, to facilitate the RDP connection.

1.  **Open your PowerShell terminal**:

      * Ensure you are logged in to Azure PowerShell (`Connect-AzAccount`).

2.  **Get the VM Object and Public IP Address**:

      * First, get the VM object:
        ```powershell
        $vm = Get-AzVM -ResourceGroupName "rg-winvm-lab" -Name "vm-windows-01"
        ```
        *Replace `"rg-winvm-lab"` and `"vm-windows-01"` with your actual resource group and VM names if different.*
      * Then, get the public IP address associated with the VM:
        ```powershell
        $publicIP = (Get-AzPublicIpAddress -ResourceGroupName $vm.ResourceGroupName -Name $vm.NetworkProfile.NetworkInterfaces.Id.Split('/')[-1].Replace("Microsoft.Network/networkInterfaces/", "") | Select-Object -ExpandProperty IpAddress)
        Write-Host "VM Public IP: $publicIP"
        ```
        *This is a common way to extract the public IP from the VM object's network interface details.*

3.  **Generate and Save RDP File (Recommended)**:

      * PowerShell can construct the content for an `.rdp` file. You can then save it and open it.

    <!-- end list -->

    ```powershell
    $rdpFileContent = @"
    full address:s:$publicIP
    audiocapturemode:i:1
    videoplaybackmode:i:1
    connection type:i:7
    use redirection server name:i:0
    disable wallpaper:i:1
    disable full window drag:i:1
    disable menu anims:i:1
    disable themes:i:0
    disable cursor blinking:i:1
    bitmapcachepersistenable:i:1
    redirectdrives:i:1
    redirectprinters:i:1
    redirectcomports:i:1
    redirectsmartcards:i:1
    redirectclipboard:i:1
    keyboardhook:i:2
    displayconnectionbar:i:1
    devicestoredirect:s:*
    drivestoredirect:s:*
    alternate shell:s:
    shell working directory:s:
    gatewayhostname:s:
    gatewayusagemethod:i:2
    gatewaycredentialssource:i:4
    gatewayprofileusagemethod:i:0
    @
    Set-Content -Path "C:\Users\$env:USERNAME\Downloads\vm-windows-01.rdp" -Value $rdpFileContent
    Write-Host "RDP file saved to C:\Users\$env:USERNAME\Downloads\vm-windows-01.rdp"
    ```

    *Adjust the path `C:\Users\$env:USERNAME\Downloads\` if you want to save it elsewhere.*

4.  **Connect using RDP Client**:

      * Double-click the generated `.rdp` file from your Downloads folder.
      * Alternatively, manually open your RDP client and paste the `$publicIP` address you obtained in step 2.
      * Proceed with entering the Username and Password as in Method 1, step 6.

-----

## Part 4: Clean Up Resources (Optional but Recommended)

To avoid incurring ongoing costs, it's a good practice to delete resources you no longer need. This will remove the VM, public IP, network interface, and associated disks.

### Method 1: Azure Portal üåê

1.  **Navigate to Resource Groups**:
      * In the Azure Portal, go to **"Resource groups"**.
      * Find and click on your resource group: **`rg-winvm-lab`**.
      * On the resource group's Overview blade, click **"Delete resource group"**.
      * Type `rg-winvm-lab` to confirm, then click **"Delete"**.

### Method 2: Azure CLI üñ•Ô∏è

```bash
az group delete --name rg-winvm-lab --no-wait --yes
echo "Resource group 'rg-winvm-lab' deletion initiated."
```

  * **Caution**: Deleting a resource group will delete ALL resources contained within it.

### Method 3: Azure PowerShell üíª

```powershell
Remove-AzResourceGroup -Name "rg-winvm-lab" -Force -AsJob
Write-Host "Resource group 'rg-winvm-lab' deletion initiated."
```

  * **Caution**: Deleting a resource group will delete ALL resources contained within it.

-----

You have now successfully connected to your Windows VM using various methods provided by Azure. This fundamental skill is essential for managing your cloud-based servers.