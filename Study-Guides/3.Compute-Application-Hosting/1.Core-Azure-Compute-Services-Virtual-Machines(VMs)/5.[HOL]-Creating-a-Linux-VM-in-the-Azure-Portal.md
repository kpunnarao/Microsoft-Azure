# Lab: Core Azure Compute Services - Virtual Machines (VMs) Part 2 üêß

## Creating a Linux VM in the Azure Portal, Azure CLI, and Azure PowerShell

This lab provides step-by-step instructions on how to create a new Linux Virtual Machine (VM) in Microsoft Azure using the Azure Portal, Azure CLI, and Azure PowerShell.

You'll learn the essential configuration steps to deploy a standard Linux VM and prepare it for initial access.

## Lab Scenario üè∞

You need to provision a new Linux Server VM in Azure to host an application, run scripts, or serve as a development environment. 

This lab will focus on the core steps to deploy a standard Linux VM and prepare it for initial SSH access.

**Resources to be created:**

  * **Resource Group**: `rg-linuxvm-lab`
  * **Location**: `East US` (or a region close to you)
  * **Virtual Machine**: `vm-linux-01`
  * **Image**: `Ubuntu Server 20.04 LTS` (or a recent LTS version)
  * **Size**: `Standard_B2s` (or a similar small, economical size)
  * **Authentication Type**: `SSH public key` (recommended for Linux)
  * **Administrator Username**: `azureuser` (or choose your own)
  * **Public Inbound Ports**: Allow SSH (Port 22)

-----

## Part 1: Prerequisites

Before you begin, ensure you have:

  * An active Azure Subscription.
  * Access to the Azure Portal ([portal.azure.com](https://portal.azure.com)).
  * **For Azure CLI/PowerShell methods**: Azure CLI and/or Azure PowerShell installed and configured locally, or access to Azure Cloud Shell.
  * **For SSH Public Key authentication**: A generated SSH key pair (public and private key). If you don't have one, the lab will guide you on how to generate it.

### Generating an SSH Key Pair (if you don't have one) üîë

If you don't have an SSH key pair, you can generate one on your local machine.

1.  **Open your Terminal (macOS/Linux) or PowerShell/Git Bash (Windows)**.

2.  Run the following command:

    ```bash
    ssh-keygen -t rsa -b 2048 -f ~/.ssh/id_rsa_azure -C "azureuser@yourmachine"
    ```

      * `-t rsa`: Specifies the key type as RSA.
      * `-b 2048`: Specifies the number of bits in the key (2048 is common).
      * `-f ~/.ssh/id_rsa_azure`: Specifies the file path to save the key. This will create two files: `id_rsa_azure` (private key) and `id_rsa_azure.pub` (public key).
      * `-C "azureuser@yourmachine"`: Adds a comment to the public key (optional, but good practice).
      * You'll be prompted to enter a passphrase. You can leave it empty for no passphrase (less secure, but easier for labs) or enter one for added security.

3.  **Locate your Public Key**:

      * The public key will be in the file with the `.pub` extension (e.g., `~/.ssh/id_rsa_azure.pub`).
      * You will need the **content** of this file in the following steps. You can view it using `cat ~/.ssh/id_rsa_azure.pub` (Linux/macOS) or `Get-Content ~/.ssh/id_rsa_azure.pub` (PowerShell). Copy the entire string.

-----

## Part 2: Creating the Linux Virtual Machine

Choose your preferred method to deploy the Linux VM.

### Method 1: Azure Portal üåê

This is the most common and straightforward method.

1.  **Sign in to the Azure Portal**:

      * Open your web browser and navigate to [**portal.azure.com**](https://portal.azure.com).
      * Sign in with your Azure account credentials.

2.  **Navigate to Virtual Machines**:

      * In the Azure Portal's global search bar, type "Virtual machines" and select **"Virtual machines"** from the search results.
      * Alternatively, click on **"Virtual machines"** from your Dashboard or the left-hand menu.

3.  **Start the VM Creation Process**:

      * On the Virtual machines blade, click **"+ Create"** then select **"Azure virtual machine"**.

4.  **Configure Basics Tab**:

      * **Project details**:
          * **Subscription**: Select your Azure subscription.
          * **Resource group**: Click **"Create new"** and enter `rg-linuxvm-lab`. Click **"OK"**.
      * **Instance details**:
          * **Virtual machine name**: Enter `vm-linux-01`.
          * **Region**: Select **"East US"** (or a region closest to you).
          * **Availability options**: Leave as default (`No infrastructure redundancy required`).
          * **Security type**: Leave as default (`Standard`).
          * **Image**: Select **"Ubuntu Server 20.04 LTS"** (or a more recent LTS version if available and preferred).
          * **Azure Spot instance**: Leave unchecked.
          * **Size**: Click **"Change size"**. Select **`Standard_B2s`** (2 vCPUs, 4 GiB memory). Click **"Select"**.
      * **Administrator account**:
          * **Authentication type**: Select **"SSH public key"** (recommended).
          * **Username**: Enter a username, for example, `azureuser`.
          * **SSH public key source**: Select **"Use existing public key"**.
          * **SSH public key**: Paste the **entire content** of your `id_rsa_azure.pub` file (from Part 1: Prerequisites). It starts with `ssh-rsa` or `ssh-ed25519` and ends with your comment.
      * **Inbound port rules**:
          * **Public inbound ports**: Select **"Allow selected ports"**.
          * **Select inbound ports**: Check the box next to **"SSH (22)"**.

5.  **Configure Disks Tab**:

      * **OS disk type**: Keep **"Standard SSD"**.
      * No other changes needed for this lab.

6.  **Configure Networking Tab**:

      * Accept the automatically created **Virtual network**, **Subnet**, and **Public IP**.
      * The **NIC network security group** and **Public inbound ports** should reflect your SSH allowance.

7.  **Review + Create Tab**:

      * Review all the settings. Azure will perform a final validation.
      * Check the **estimated monthly cost**.
      * If validation passes, click **"Create"** at the bottom.

8.  **Deployment**:

      * Azure will start deploying your VM. This process usually takes a few minutes.
      * You'll see a notification indicating the deployment status. You can click **"Go to resource"** from the notification once it's complete.

-----

### Method 2: Azure CLI üñ•Ô∏è

This method uses command-line commands, which are efficient for automation and repeatable deployments.

1.  **Open Azure Cloud Shell (Bash) or your local Terminal with Azure CLI installed**.

      * Ensure you are logged in to Azure CLI (`az login`).

2.  **Set Variables (Recommended)**:

    ```bash
    resourceGroupName="rg-linuxvm-lab"
    vmName="vm-linux-01"
    location="eastus"
    adminUsername="azureuser"
    image="UbuntuLTS" # Or "Canonical:0001-com-ubuntu-server-focal:20_04-lts-gen2:latest"
    vmSize="Standard_B2s"
    sshPublicKeyPath="~/.ssh/id_rsa_azure.pub" # Adjust if your public key is in a different path
    ```

3.  **Create Resource Group**:

      * If you don't already have the resource group:
        ```bash
        az group create --name $resourceGroupName --location $location
        ```

4.  **Create the Virtual Machine**:

    ```bash
    az vm create \
      --resource-group $resourceGroupName \
      --name $vmName \
      --image $image \
      --admin-username $adminUsername \
      --ssh-key-values $sshPublicKeyPath \
      --size $vmSize \
      --location $location \
      --public-ip-sku Standard \
      --nsg-rule SSH \
      --no-wait
    ```

      * `--ssh-key-values`: Specifies the path to your **public** SSH key file. The CLI will automatically read its content.
      * `--nsg-rule SSH`: Automatically creates an inbound NSG rule to allow SSH (port 22) traffic.
      * `--no-wait`: Tells the command to return immediately.

5.  **Monitor Deployment (Optional)**:

    ```bash
    az vm show --resource-group $resourceGroupName --name $vmName --show-details --query "powerState" -o tsv
    ```

    Keep running this command until the output is "VM running".

-----

### Method 3: Azure PowerShell üíª

This method uses PowerShell cmdlets, offering a powerful scripting option.

1.  **Open Azure Cloud Shell (PowerShell) or your local PowerShell 7 terminal with Azure PowerShell installed**.

      * Ensure you are logged in to Azure PowerShell (`Connect-AzAccount`).

2.  **Set Variables (Recommended)**:

    ```powershell
    $resourceGroupName = "rg-linuxvm-lab"
    $vmName = "vm-linux-01"
    $location = "EastUS"
    $adminUsername = "azureuser"
    $image = "Canonical:UbuntuServer:20.04-LTS:latest"
    $vmSize = "Standard_B2s"
    $sshPublicKeyPath = "$env:USERPROFILE\.ssh\id_rsa_azure.pub" # Adjust for Windows path or Linux/macOS
    ```

      * **Note for Linux/macOS PowerShell users**: If running locally on Linux/macOS, `$env:USERPROFILE` might be `$HOME`. You can also use `Get-Content ~/.ssh/id_rsa_azure.pub`.

3.  **Get Public SSH Key Content**:

    ```powershell
    $sshPublicKey = Get-Content -Path $sshPublicKeyPath -Raw
    ```

4.  **Create Resource Group**:

      * If you don't already have the resource group:
        ```powershell
        New-AzResourceGroup -Name $resourceGroupName -Location $location
        ```

5.  **Configure VM Object**:

    ```powershell
    # Create SSH config object
    $sshConfig = New-AzVMConfigSshKey -KeyData $sshPublicKey -Path "/home/$adminUsername/.ssh/authorized_keys"

    # Create credential object (required even for key-based auth)
    # The password is not used for authentication but required for New-AzVM to proceed
    $securePassword = ConvertTo-SecureString (Get-Random -Maximum 999999999999) -AsPlainText -Force

    # Create VM configuration
    $vmConfig = New-AzVMConfig -VMName $vmName -VMSize $vmSize `
        | Set-AzVMOperatingSystem -Linux -ComputerName $vmName -Credential (New-Object System.Management.Automation.PSCredential($adminUsername, $securePassword)) -SshHostPublicKeyAlias "$vmName" -SshKey $sshConfig `
        | Set-AzVMSourceImage -Publisher (Split-Path -Path $image -Leaf).Split(':')[0] -Offer (Split-Path -Path $image -Leaf).Split(':')[1] -Sku (Split-Path -Path $image -Leaf).Split(':')[2] -Version (Split-Path -Path $image -Leaf).Split(':')[3] `
        | Add-AzVMNetworkInterface -Id (New-AzNetworkInterface -Name ($vmName + "-nic") -ResourceGroupName $resourceGroupName -Location $location -Subnet (New-AzVirtualNetwork -Name ($resourceGroupName + "-vnet") -ResourceGroupName $resourceGroupName -Location $location -AddressPrefix "10.0.0.0/16" | Add-AzVirtualNetworkSubnetConfig -Name "default" -AddressPrefix "10.0.0.0/24" -VirtualNetwork $virtualNetwork).Subnets[0].Id | Set-AzNetworkInterfaceIpConfig -Name "ipconfig1" -PublicIpAddress (New-AzPublicIpAddress -Name ($vmName + "-ip") -ResourceGroupName $resourceGroupName -Location $location -AllocationMethod Dynamic -Sku Standard) -NetworkInterface ).Id
    ```

      * **Note**: The PowerShell VM creation command can be quite verbose due to the object-oriented nature and the need to chain network and OS configurations.

6.  **Create the Virtual Machine**:

    ```powershell
    New-AzVM -ResourceGroupName $resourceGroupName -Location $location -VM $vmConfig -Verbose
    ```

      * `-Verbose`: Provides detailed output during deployment.

7.  **Monitor Deployment (Optional)**:

    ```powershell
    Get-AzVM -ResourceGroupName $resourceGroupName -Name $vmName -Status
    ```

    Look for `PowerState` being `VM running`.

-----

## Part 3: Cleaning Up Resources (Optional but Recommended)

To avoid incurring ongoing costs, always delete resources you no longer need. Deleting the resource group will remove the VM, public IP, network interface, and associated disks.

### Method 1: Azure Portal üåê

1.  **Navigate to Resource Groups**: In the Azure Portal, go to **"Resource groups"**.
2.  Find and click on your resource group: **`rg-linuxvm-lab`**.
3.  On the resource group's Overview blade, click **"Delete resource group"**.
4.  Type `rg-linuxvm-lab` to confirm, then click **"Delete"**.

### Method 2: Azure CLI üñ•Ô∏è

```bash
az group delete --name rg-linuxvm-lab --no-wait --yes
echo "Resource group 'rg-linuxvm-lab' deletion initiated."
```

  * **Caution**: Deleting a resource group will delete ALL resources contained within it.

### Method 3: Azure PowerShell üíª

```powershell
Remove-AzResourceGroup -Name "rg-linuxvm-lab" -Force -AsJob
Write-Host "Resource group 'rg-linuxvm-lab' deletion initiated."
```

  * **Caution**: Deleting a resource group will delete ALL resources contained within it.

-----