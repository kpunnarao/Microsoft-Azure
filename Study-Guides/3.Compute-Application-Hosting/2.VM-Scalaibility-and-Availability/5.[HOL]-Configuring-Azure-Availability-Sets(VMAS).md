# Lab: Configuring Azure Availability Sets üõ°Ô∏è

This lab provides step-by-step instructions on how to create an Azure Availability Set and then deploy Virtual Machines (VMs) into it. This configuration is fundamental for ensuring high availability of your applications within a single Azure datacenter, protecting them from planned maintenance events and unplanned hardware failures.

  * **Lab Scenario**: You need to ensure your critical application, running on multiple VMs, is protected from planned maintenance and unplanned hardware failures within an Azure datacenter.
  * **Part 1: Prerequisites** (Azure subscription, access to portal/CLI/PS, understanding of Fault/Update Domains).
  * **Part 2: Creating the Availability Set**
      * Method 1: Azure Portal
      * Method 2: Azure CLI
      * Method 3: Azure PowerShell
  * **Part 3: Deploying VMs into the Availability Set**
      * Method 1: Azure Portal (creating new VMs and selecting the AS)
      * Method 2: Azure CLI (creating new VMs and specifying the AS)
      * Method 3: Azure PowerShell (creating new VMs and specifying the AS)
  * **Part 4: Verifying VM Placement** (How to check which VMs are in the AS and their domain distribution).
  * **Part 5: Clean Up Resources** (Deleting the resource group to remove the AS and VMs).

  This comprehensive approach will ensure the user not only creates the Availability Set but also correctly utilizes it by deploying VMs within it and verifying the configuration.

## Lab Scenario üè∞

You are tasked with deploying a critical, multi-tier application. To ensure its high availability, you need to configure your web servers and application servers in separate Availability Sets. This lab will focus on setting up one Availability Set and deploying a couple of VMs into it.

**Resources to be created:**

  * **Resource Group**: `rg-avset-lab`
  * **Location**: `East US` (or a region close to you that supports Availability Sets)
  * **Availability Set**: `avset-web` (with default Fault Domains and Update Domains)
  * **Virtual Machines**: `vm-web-01`, `vm-web-02` (Linux VMs for simplicity)
  * **Image**: `Ubuntu Server 20.04 LTS` (or a recent LTS version)
  * **Size**: `Standard_B2s` (or a similar small, economical size)
  * **Authentication Type**: `SSH public key`
  * **Administrator Username**: `azureuser`
  * **Public Inbound Ports**: Allow SSH (Port 22)

-----

## Part 1: Prerequisites

Before you begin, ensure you have:

  * An active Azure Subscription.
  * Access to the Azure Portal ([portal.azure.com](https://portal.azure.com)).
  * **For Azure CLI/PowerShell methods**: Azure CLI and/or Azure PowerShell installed and configured locally, or access to Azure Cloud Shell.
  * **For SSH Public Key authentication**: A generated SSH key pair (public and private key). You will need the content of your public key. If you don't have one, refer to Day 14's "Creating a Linux VM" lab for instructions on `ssh-keygen`.

-----

## Part 2: Creating the Availability Set

You must create the Availability Set *before* creating the VMs that will reside in it.

### Method 1: Azure Portal üåê

1.  **Sign in to the Azure Portal**:

      * Open your web browser and navigate to [**portal.azure.com**](https://portal.azure.com).
      * Sign in with your Azure account credentials.

2.  **Navigate to Availability Sets**:

      * In the Azure Portal's global search bar, type "Availability sets" and select **"Availability sets"** from the search results.

3.  **Start Creation Process**:

      * On the Availability sets blade, click **"+ Create"**.

4.  **Configure Basics**:

      * **Project details**:
          * **Subscription**: Select your Azure subscription.
          * **Resource group**: Click **"Create new"** and enter `rg-avset-lab`. Click **"OK"**.
      * **Instance details**:
          * **Availability set name**: Enter `avset-web`.
          * **Region**: Select **"East US"** (or the region you plan to deploy your VMs in).
          * **Fault domains**: Keep the default (`3`).
          * **Update domains**: Keep the default (`5`).
          * **Proximity placement group**: Leave as default (`None`).
      * **Managed disks**: Select **"Use managed disks"** (this is the recommended and modern approach).
      * Leave Tags as default.

5.  **Review + Create**:

      * Review the settings.
      * Click **"Review + create"** then **"Create"**.
      * The deployment should complete quickly.

-----

### Method 2: Azure CLI üñ•Ô∏è

1.  **Open Azure Cloud Shell (Bash) or your local Terminal with Azure CLI installed**.

      * Ensure you are logged in to Azure CLI (`az login`).

2.  **Set Variables**:

    ```bash
    resourceGroup="rg-avset-lab"
    location="eastus"
    availabilitySetName="avset-web"
    ```

3.  **Create Resource Group (if it doesn't exist)**:

    ```bash
    az group create --name $resourceGroup --location $location
    ```

4.  **Create the Availability Set**:

    ```bash
    az vm availability-set create \
      --resource-group $resourceGroup \
      --name $availabilitySetName \
      --location $location \
      --platform-fault-domain-count 3 \
      --platform-update-domain-count 5 \
      --managed-disk true # Use managed disks
    ```

      * `platform-fault-domain-count` and `platform-update-domain-count` define the number of domains.

-----

### Method 3: Azure PowerShell üíª

1.  **Open Azure Cloud Shell (PowerShell) or your local PowerShell 7 terminal with Azure PowerShell installed**.

      * Ensure you are logged in to Azure PowerShell (`Connect-AzAccount`).

2.  **Set Variables**:

    ```powershell
    $resourceGroupName = "rg-avset-lab"
    $location = "EastUS"
    $availabilitySetName = "avset-web"
    ```

3.  **Create Resource Group (if it doesn't exist)**:

    ```powershell
    New-AzResourceGroup -Name $resourceGroupName -Location $location
    ```

4.  **Create the Availability Set**:

    ```powershell
    New-AzAvailabilitySet `
        -ResourceGroupName $resourceGroupName `
        -Name $availabilitySetName `
        -Location $location `
        -PlatformFaultDomainCount 3 `
        -PlatformUpdateDomainCount 5 `
        -Sku "Aligned" # "Aligned" specifies managed disks; "Classic" for unmanaged.
    ```

      * `-PlatformFaultDomainCount` and `-PlatformUpdateDomainCount` define the number of domains.

-----

## Part 3: Deploying VMs into the Availability Set

Now that the Availability Set is created, you can deploy your VMs and assign them to it.

### Method 1: Azure Portal üåê

1.  **Start VM Creation**:

      * In the Azure Portal's global search, type "Virtual machines" and select **"Virtual machines"**.
      * Click **"+ Create"** then **"Azure virtual machine"**.

2.  **Configure Basics for `vm-web-01`**:

      * **Project details**:
          * **Subscription**: Your subscription.
          * **Resource group**: Select `rg-avset-lab` (the one you just created/used).
      * **Instance details**:
          * **Virtual machine name**: `vm-web-01`
          * **Region**: Select **"East US"** (must match the Availability Set's region).
          * **Availability options**: Select **"Availability set"**.
          * **Availability set**: Choose `avset-web` from the dropdown.
          * **Security type**: `Standard`
          * **Image**: `Ubuntu Server 20.04 LTS`
          * **Size**: `Standard_B2s`
      * **Administrator account**:
          * **Authentication type**: `SSH public key`
          * **Username**: `azureuser`
          * **SSH public key source**: `Use existing public key`
          * **SSH public key**: Paste the content of your `id_rsa_azure.pub` file.
      * **Inbound port rules**:
          * **Public inbound ports**: `Allow selected ports`
          * **Select inbound ports**: Check `SSH (22)`
      * Click **"Review + create"** and then **"Create"**.

3.  **Configure Basics for `vm-web-02`**:

      * Repeat steps 1 and 2 for a second VM.
      * **Virtual machine name**: `vm-web-02`
      * **Crucially**: Ensure you select the **SAME Availability set (`avset-web`)**.
      * Keep all other settings consistent.
      * Click **"Review + create"** and then **"Create"**.

-----

### Method 2: Azure CLI üñ•Ô∏è

1.  **Set Variables**:

    ```bash
    resourceGroup="rg-avset-lab"
    location="eastus"
    availabilitySetName="avset-web"
    adminUsername="azureuser"
    sshPublicKeyPath="~/.ssh/id_rsa_azure.pub" # Adjust path if needed
    ```

2.  **Create `vm-web-01` and assign to Availability Set**:

    ```bash
    az vm create \
      --resource-group $resourceGroup \
      --name vm-web-01 \
      --image UbuntuLTS \
      --admin-username $adminUsername \
      --ssh-key-values $sshPublicKeyPath \
      --size Standard_B2s \
      --location $location \
      --availability-set $availabilitySetName \
      --public-ip-sku Standard \
      --nsg-rule SSH \
      --no-wait
    ```

3.  **Create `vm-web-02` and assign to Availability Set**:

    ```bash
    az vm create \
      --resource-group $resourceGroup \
      --name vm-web-02 \
      --image UbuntuLTS \
      --admin-username $adminUsername \
      --ssh-key-values $sshPublicKeyPath \
      --size Standard_B2s \
      --location $location \
      --availability-set $availabilitySetName \
      --public-ip-sku Standard \
      --nsg-rule SSH \
      --no-wait
    ```

-----

### Method 3: Azure PowerShell üíª

1.  **Set Variables**:

    ```powershell
    $resourceGroupName = "rg-avset-lab"
    $location = "EastUS"
    $availabilitySetName = "avset-web"
    $adminUsername = "azureuser"
    $sshPublicKeyPath = "$env:USERPROFILE\.ssh\id_rsa_azure.pub" # Adjust for Windows path or Linux/macOS
    $sshPublicKey = Get-Content -Path $sshPublicKeyPath -Raw
    $securePassword = ConvertTo-SecureString (Get-Random -Maximum 999999999999) -AsPlainText -Force # Required for credential object, not used for auth
    ```

2.  **Get Availability Set Object**:

    ```powershell
    $avSet = Get-AzAvailabilitySet -ResourceGroupName $resourceGroupName -Name $availabilitySetName
    ```

3.  **Create `vm-web-01` and assign to Availability Set**:

    ```powershell
    $vm1Config = New-AzVMConfig -VMName "vm-web-01" -VMSize "Standard_B2s" `
        | Set-AzVMOperatingSystem -Linux -ComputerName "vm-web-01" -Credential (New-Object System.Management.Automation.PSCredential($adminUsername, $securePassword)) -SshHostPublicKeyAlias "vm-web-01" -SshKey (New-AzVMConfigSshKey -KeyData $sshPublicKey -Path "/home/$adminUsername/.ssh/authorized_keys") `
        | Set-AzVMSourceImage -Publisher "Canonical" -Offer "UbuntuServer" -Sku "20.04-LTS" -Version "latest" `
        | Add-AzVMNetworkInterface -Id (New-AzNetworkInterface -Name "vm-web-01-nic" -ResourceGroupName $resourceGroupName -Location $location -Subnet (Get-AzVirtualNetwork -ResourceGroupName $resourceGroupName -Name ($resourceGroupName + "-vnet")).Subnets[0].Id | Set-AzNetworkInterfaceIpConfig -Name "ipconfig1" -PublicIpAddress (New-AzPublicIpAddress -Name "vm-web-01-ip" -ResourceGroupName $resourceGroupName -Location $location -AllocationMethod Dynamic -Sku Standard) -NetworkInterface | Add-AzNetworkSecurityRuleConfig -Name "SSH" -Description "Allow SSH" -Access "Allow" -Protocol "Tcp" -Direction "Inbound" -Priority 1000 -SourceAddressPrefix "*" -SourcePortRange "*" -DestinationAddressPrefix "*" -DestinationPortRange 22).Id `
        | Set-AzVMAvailabilitySet -AvailabilitySetId $avSet.Id

    New-AzVM -ResourceGroupName $resourceGroupName -Location $location -VM $vm1Config -Verbose
    ```

4.  **Create `vm-web-02` and assign to Availability Set**:

    ```powershell
    $vm2Config = New-AzVMConfig -VMName "vm-web-02" -VMSize "Standard_B2s" `
        | Set-AzVMOperatingSystem -Linux -ComputerName "vm-web-02" -Credential (New-Object System.Management.Automation.PSCredential($adminUsername, $securePassword)) -SshHostPublicKeyAlias "vm-web-02" -SshKey (New-AzVMConfigSshKey -KeyData $sshPublicKey -Path "/home/$adminUsername/.ssh/authorized_keys") `
        | Set-AzVMSourceImage -Publisher "Canonical" -Offer "UbuntuServer" -Sku "20.04-LTS" -Version "latest" `
        | Add-AzVMNetworkInterface -Id (New-AzNetworkInterface -Name "vm-web-02-nic" -ResourceGroupName $resourceGroupName -Location $location -Subnet (Get-AzVirtualNetwork -ResourceGroupName $resourceGroupName -Name ($resourceGroupName + "-vnet")).Subnets[0].Id | Set-AzNetworkInterfaceIpConfig -Name "ipconfig1" -PublicIpAddress (New-AzPublicIpAddress -Name "vm-web-02-ip" -ResourceGroupName $resourceGroupName -Location $location -AllocationMethod Dynamic -Sku Standard) -NetworkInterface | Add-AzNetworkSecurityRuleConfig -Name "SSH" -Description "Allow SSH" -Access "Allow" -Protocol "Tcp" -Direction "Inbound" -Priority 1000 -SourceAddressPrefix "*" -SourcePortRange "*" -DestinationAddressPrefix "*" -DestinationPortRange 22).Id `
        | Set-AzVMAvailabilitySet -AvailabilitySetId $avSet.Id

    New-AzVM -ResourceGroupName $resourceGroupName -Location $location -VM $vm2Config -Verbose
    ```

    *(Note: The PowerShell commands for VM creation are more verbose as they require explicit setup of network interfaces and public IPs if not already existing).*

-----

## Part 4: Verifying VM Placement

After the VMs are deployed, you can verify their placement across Fault and Update Domains.

### Method 1: Azure Portal üåê

1.  **Navigate to your Availability Set**:
      * In the Azure Portal, go to **"Availability sets"** and select `avset-web`.
2.  **View Instances**:
      * On the `avset-web` Overview blade, scroll down to the **"Virtual Machines"** section.
      * You will see `vm-web-01` and `vm-web-02` listed.
      * Critically, observe the **"Fault Domain"** and **"Update Domain"** columns. Azure will automatically distribute your VMs. For 2 VMs, you will likely see them in FD 0 and FD 1, and UD 0 and UD 1 respectively.

### Method 2: Azure CLI üñ•Ô∏è

```bash
az vm list --resource-group rg-avset-lab --query "[?availabilitySet.id=='/subscriptions/$((az account show --query id -o tsv))/resourceGroups/rg-avset-lab/providers/Microsoft.Compute/availabilitySets/avset-web'].{Name:name, FaultDomain:extendedLocation.type, UpdateDomain:virtualMachineScaleSet.id}" -o table
```

  * **Correction**: The Azure CLI `az vm list` output doesn't directly show `FaultDomain` and `UpdateDomain` for VMs *in an Availability Set* in a simple field like that. It's usually within the `instanceView.platformFaultDomain` and `instanceView.platformUpdateDomain` when you query the VM directly or the Availability Set.

Let's refine the CLI command for better verification:

```bash
# Get the Availability Set ID first
avsetId=$(az vm availability-set show -g $resourceGroup -n $availabilitySetName --query id -o tsv)

# Loop through VMs in the resource group and check their domains if they are in the AS
echo "VMs in Availability Set '$availabilitySetName' in '$resourceGroup':"
az vm list -g $resourceGroup --query "[?availabilitySet.id=='$avsetId'].{Name:name, FaultDomain:instanceView.platformFaultDomain, UpdateDomain:instanceView.platformUpdateDomain}" -o table
```

*Expected Output (example, exact numbers may vary):*

```
Name      FaultDomain    UpdateDomain
--------  -------------  ------------
vm-web-01 0              0
vm-web-02 1              1
```

### Method 3: Azure PowerShell üíª

```powershell
$resourceGroupName = "rg-avset-lab"
$availabilitySetName = "avset-web"

Get-AzVM -ResourceGroupName $resourceGroupName -Status | Where-Object {$_.AvailabilitySetReference -ne $null -and $_.AvailabilitySetReference.Id -like "*$availabilitySetName*"} | Select-Object Name, @{Name="FaultDomain";Expression={$_.InstanceView.PlatformFaultDomain}}, @{Name="UpdateDomain";Expression={$_.InstanceView.PlatformUpdateDomain}} | Format-Table
```

*Expected Output (example, exact numbers may vary):*

```
Name      FaultDomain UpdateDomain
----      ----------- ------------
vm-web-01           0            0
vm-web-02           1            1
```

-----

## Part 5: Cleaning Up Resources (Recommended)

To avoid incurring ongoing costs, always delete resources you no longer need. Deleting the resource group will remove the Availability Set, VMs, public IPs, network interfaces, and associated disks.

### Method 1: Azure Portal üåê

1.  **Navigate to Resource Groups**: In the Azure Portal, go to **"Resource groups"**.
2.  Find and click on your resource group: **`rg-avset-lab`**.
3.  On the resource group's Overview blade, click **"Delete resource group"**.
4.  Type `rg-avset-lab` to confirm, then click **"Delete"**.

### Method 2: Azure CLI üñ•Ô∏è

```bash
az group delete --name rg-avset-lab --no-wait --yes
echo "Resource group 'rg-avset-lab' deletion initiated."
```

  * **Caution**: Deleting a resource group will delete ALL resources contained within it.

### Method 3: Azure PowerShell üíª

```powershell
Remove-AzResourceGroup -Name "rg-avset-lab" -Force -AsJob
Write-Host "Resource group 'rg-avset-lab' deletion initiated."
```

  * **Caution**: Deleting a resource group will delete ALL resources contained within it.

-----