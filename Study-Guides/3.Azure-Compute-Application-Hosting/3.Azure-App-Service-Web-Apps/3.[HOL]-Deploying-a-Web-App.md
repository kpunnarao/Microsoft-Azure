# Lab: Azure App Service - Web Apps: Deployment, Custom Domains & SSL üöÄüîí

This lab will guide you through the process of deploying a simple web application to Azure App Service using various Git deployment methods. 

Afterwards, you'll learn how to map a custom domain to your web app and secure it with an SSL certificate.

## Lab Scenario üåê

You have a basic static HTML website (or a simple Node.js/Python "Hello World" app) stored in a GitHub repository. 

You need to deploy this application to Azure App Service, make it accessible via your own custom domain (e.g., `www.yourdomain.com`), and ensure all traffic is secured with HTTPS.

**Resources to be created/configured:**

  * **Resource Group**: `rg-webapp-lab`
  * **Location**: `East US` (or a region close to you)
  * **App Service Plan**: `plan-webapp-lab` (Standard S1 tier, required for Custom Domains/SSL)
  * **Web App**: `webapp-yourname-d16` (replace `yourname` with a unique identifier)
  * **Source Code**: A simple HTML file or a basic web app in a GitHub repository (or local Git).
      * **GitHub Repo**: You'll need to create a *public* GitHub repository with a simple `index.html` file (e.g., "Hello from Azure App Service\!").
      * **Local Git**: A local Git repository with the same simple `index.html`.
  * **Custom Domain**: Access to a domain registrar (e.g., GoDaddy, Namecheap) to manage DNS records for a domain you own (e.g., `yourdomain.com`).
  * **SSL Certificate**: We'll use the free App Service Managed Certificate.

-----

## Part 1: Prerequisites

Before you begin, ensure you have:

  * An active Azure Subscription.
  * Access to the Azure Portal ([portal.azure.com](https://portal.azure.com)).
  * **For Azure CLI/PowerShell methods**: Azure CLI and/or Azure PowerShell installed and configured locally, or access to Azure Cloud Shell.
  * **GitHub Account**: A GitHub account and a *public* repository with some basic web content (e.g., an `index.html` file).
      * **Example `index.html` content**:
        ```html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Azure App Service Lab</title>
            <style>
                body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
                h1 { color: #0078d4; }
                p { font-size: 1.2em; }
            </style>
        </head>
        <body>
            <h1>Hello from Azure App Service!</h1>
            <p>This is my first deployment to Azure App Service from GitHub/Local Git.</p>
            <p>It's running on: <span id="hostname"></span></p>
            <script>
                document.getElementById('hostname').innerText = window.location.hostname;
            </script>
        </body>
        </html>
        ```
  * **Custom Domain**: Ownership of a domain name where you can modify DNS records (e.g., `yourdomain.com`). If you don't own one, you can skip the custom domain/SSL part or simulate it conceptually. For this lab, assume you have a domain like `example.com` and will create `www.example.com`.

-----

## Part 2: Create Azure App Service Web App and App Service Plan

First, let's create the foundational resources. We'll ensure the App Service Plan is in a tier that supports custom domains and SSL (Standard S1 minimum).

### Method 1: Azure Portal üåê

1.  **Create Resource Group**:

      * In the Azure Portal, search for "Resource groups" and click **"+ Create"**.
      * **Subscription**: Select your subscription.
      * **Resource group name**: `rg-webapp-lab`
      * **Region**: `East US`
      * Click **"Review + create"** then **"Create"**.

2.  **Create Web App**:

      * In the Azure Portal search bar, type "App Services" and select **"App Services"**.
      * Click **"+ Create"** then **"Web App"**.
      * **Basics tab**:
          * **Project Details**:
              * **Subscription**: Your subscription.
              * **Resource Group**: Select `rg-webapp-lab`.
          * **Instance Details**:
              * **Name**: `webapp-yourname-d16` (Choose a globally unique name, e.g., `webapp-johndoe-d16`)
              * **Publish**: `Code`
              * **Runtime stack**: `Node 18 LTS` (or `Python 3.9`, `.NET 6 (LTS)` - choose what aligns with your sample code. For simple HTML, any will work as App Service serves static files by default)
              * **Operating System**: `Linux` (recommended, generally cheaper for web apps)
              * **Region**: `East US`
              * **App Service Plan**: Click **"Create new"**.
                  * **App Service Plan name**: `plan-webapp-lab`
                  * **Sku and size**: Click **"Change size"**. Select **"Standard (S1)"** under the "Production" tab. Click **"Apply"**.
      * Click **"Review + create"** then **"Create"**.
      * Wait for the deployment to complete.

-----

### Method 2: Azure CLI üñ•Ô∏è

1.  **Open Azure Cloud Shell (Bash) or your local Terminal with Azure CLI installed**.

      * Ensure you are logged in to Azure CLI (`az login`).

2.  **Set Variables**:

    ```bash
    resourceGroup="rg-webapp-lab"
    location="eastus"
    appServicePlanName="plan-webapp-lab"
    webappName="webapp-yourname-d16" # Replace with your unique name
    runtimeStack="NODE|18-lts" # Example: NODE|18-lts, PYTHON|3.9, DOTNET|6.0
    ```

3.  **Create Resource Group (if it doesn't exist)**:

    ```bash
    az group create --name $resourceGroup --location $location
    ```

4.  **Create App Service Plan (Standard S1)**:

    ```bash
    az appservice plan create \
      --name $appServicePlanName \
      --resource-group $resourceGroup \
      --location $location \
      --is-linux \
      --sku S1
    ```

5.  **Create Web App**:

    ```bash
    az webapp create \
      --name $webappName \
      --resource-group $resourceGroup \
      --plan $appServicePlanName \
      --runtime "$runtimeStack"
    ```

-----

### Method 3: Azure PowerShell üíª

1.  **Open Azure Cloud Shell (PowerShell) or your local PowerShell 7 terminal with Azure PowerShell installed**.

      * Ensure you are logged in to Azure PowerShell (`Connect-AzAccount`).

2.  **Set Variables**:

    ```powershell
    $resourceGroupName = "rg-webapp-lab"
    $location = "EastUS"
    $appServicePlanName = "plan-webapp-lab"
    $webappName = "webapp-yourname-d16" # Replace with your unique name
    $runtimeStack = "NODE|18-lts" # Example: NODE|18-lts, PYTHON|3.9, DOTNET|6.0
    ```

3.  **Create Resource Group (if it doesn't exist)**:

    ```powershell
    New-AzResourceGroup -Name $resourceGroupName -Location $location
    ```

4.  **Create App Service Plan (Standard S1)**:

    ```powershell
    New-AzAppServicePlan -Name $appServicePlanName -ResourceGroupName $resourceGroupName -Location $location -Tier Standard -Sku S1 -OS Linux
    ```

5.  **Create Web App**:

    ```powersavo
    New-AzWebApp -Name $webappName -ResourceGroupName $resourceGroupName -Location $location -AppServicePlan $appServicePlanName -Runtime $runtimeStack
    ```

-----

## Part 3: Deploying a Web App from GitHub/Local Git

Now that your web app is created, let's deploy some code\!

### Method A: Deploy from GitHub (Continuous Deployment) üöÄ

This method sets up a CI/CD pipeline so that changes pushed to your GitHub repo automatically trigger a redeployment to your App Service.

1.  **Ensure your GitHub repo is ready**: Make sure your `index.html` (or your app's main file) is at the root of your repo.

2.  **Azure Portal üåê**:

      * Navigate to your Web App (`webapp-yourname-d16`).
      * In the left-hand menu, under **"Deployment"**, select **"Deployment Center"**.
      * **Source**: Select **"GitHub"**.
      * **Build Provider**: Select **"GitHub Actions"** (recommended for modern CI/CD).
      * **Authorize**: Click **"Authorize"** and follow the prompts to authorize Azure to access your GitHub account.
      * **Organization**: Select your GitHub organization/account.
      * **Repository**: Select the public repository containing your web app code.
      * **Branch**: Select the branch you want to deploy from (e.g., `main` or `master`).
      * **Runtime Stack**: Confirm the runtime stack (e.g., Node.js, Python, .NET). This should match what you selected during app creation.
      * Click **"Save"**.
      * Azure will now create a GitHub Actions workflow file in your repository (`.github/workflows/main_webapp-yourname-d16.yml`). The first deployment will automatically trigger.
      * Go to your GitHub repo -\> Actions tab to monitor the workflow.
      * Once the workflow completes successfully, browse to your web app's default URL (found on the Web App's Overview blade, e.g., `webapp-yourname-d16.azurewebsites.net`). You should see your "Hello from Azure App Service\!" page.

3.  **Azure CLI üñ•Ô∏è**:

      * First, you need to create a Personal Access Token (PAT) in GitHub with `repo` scope.
          * Go to GitHub -\> Settings -\> Developer settings -\> Personal access tokens -\> Tokens (classic) -\> Generate new token. Give it a descriptive name and ensure it has `repo` permissions. Copy the token.
      * **Set Variables**:
        ```bash
        githubRepoURL="https://github.com/<your-github-username>/<your-repo-name>" # e.g., https://github.com/myusername/mywebapp
        branchName="main"
        githubPAT="<your-github-personal-access-token>" # Paste the token you copied
        ```
      * **Configure deployment from GitHub Actions (OIDC - recommended for security)**:
          * This method is more secure but involves setting up an Azure AD service principal and federated credentials. It's too complex for a quick lab step in all three methods, but it's the *recommended production approach*.
          * **For simplicity in this lab, we'll use a Publish Profile or Git local push (next methods).** GitHub Actions setup is generally more involved for CLI/PS than the portal's integrated flow.
      * **Alternatively, to set up basic GitHub deployment (older method, not GitHub Actions):**
        ```bash
        # Set up a deployment user (if not already set for your subscription)
        # This user is for Git/FTP deployments. Keep username and password secure!
        az webapp deployment user set --user-name <your-deployment-username> --password <your-deployment-password>

        # Configure deployment source
        az webapp deployment source config --name $webappName --resource-group $resourceGroup \
          --repo-url $githubRepoURL --branch $branchName --git-token $githubPAT --repository-type GitHub
        ```
        *This method is less preferred than GitHub Actions for CI/CD but works for direct GitHub integration.*

4.  **Azure PowerShell üíª**:

      * Similar to Azure CLI, setting up GitHub Actions via PowerShell is intricate due to service principal and federated credential setup.
      * **For simplicity, we'll stick to a Publish Profile or Local Git push.**
      * **Alternatively, to set up basic GitHub deployment (older method, not GitHub Actions):**
        ```powershell
        # Set up a deployment user (if not already set for your subscription)
        Set-AzWebAppDeploymentUser -UserName "<your-deployment-username>" -Password "<your-deployment-password>"

        # Configure deployment source
        Set-AzWebAppSourceControl -ResourceGroupName $resourceGroupName -WebAppName $webappName `
            -RepositoryUrl $githubRepoURL -Branch $branchName -RepositoryType GitHub -GitHubToken $githubPAT
        ```

### Method B: Deploy from Local Git (Manual Push) üì§

This method allows you to push directly from your local Git repository to Azure App Service. This is a one-way push, not a continuous integration setup.

1.  **Prepare Local Git Repository**:

      * Ensure you have Git installed.
      * Create a local folder, `cd` into it, and initialize a Git repository:
        ```bash
        mkdir my-local-webapp
        cd my-local-webapp
        git init
        ```
      * Create an `index.html` file inside this folder with the content provided in **Part 1 Prerequisites**.
      * Commit the file:
        ```bash
        git add .
        git commit -m "Initial commit for Azure App Service lab"
        ```

2.  **Azure Portal üåê**:

      * Navigate to your Web App (`webapp-yourname-d16`).
      * In the left-hand menu, under **"Deployment"**, select **"Deployment Center"**.
      * **Source**: Select **"Local Git"**.
      * **Build Provider**: Select **"App Service build service"**.
      * Click **"Save"**.
      * The portal will display a **Git clone URI** (e.g., `https://webapp-yourname-d16.scm.azurewebsites.net/webapp-yourname-d16.git`) and a **deployment username and password** (either app-scoped or user-scoped). **Copy these values.**
      * Back in your local terminal (from step 1), add the Azure remote and push:
        ```bash
        git remote add azure <Git_clone_URI_from_portal>
        git push azure main # or master, depending on your branch name
        ```
      * When prompted, enter the deployment username and password you copied from the portal.
      * Wait for the deployment to complete. Browse to your web app's default URL to verify.

3.  **Azure CLI üñ•Ô∏è**:

      * **Set Variables**:
        ```bash
        webappName="webapp-yourname-d16" # Your web app name
        resourceGroup="rg-webapp-lab"
        localRepoPath="./my-local-webapp" # Path to your local Git repo
        ```
      * **Configure Local Git deployment for the web app**:
        ```bash
        az webapp deployment source config-local-git --name $webappName --resource-group $resourceGroup
        ```
      * The output will provide the **Git clone URI** (e.g., `https://$webappName@$webappName.scm.azurewebsites.net/$webappName.git`). Copy this URI.
      * **Get deployment credentials**: (Optional, if you haven't set them globally)
        ```bash
        az webapp deployment list-publishing-profiles --name $webappName --resource-group $resourceGroup --query "[?contains(publishMethod, 'Git')].{UserName:userName, UserPwd:userPwd}" -o jsonc
        # Or if you set a global deployment user:
        # az webapp deployment user show --query "{UserName:name, Password:scmUserPwd}"
        ```
      * In your local terminal (after `cd` into `$localRepoPath` and `git init` and commit), add the Azure remote and push:
        ```bash
        git remote add azure <Git_clone_URI_from_CLI_output>
        git push azure main # or master
        ```
      * Enter the deployment username and password when prompted.

4.  **Azure PowerShell üíª**:

      * **Set Variables**:
        ```powershell
        $webappName = "webapp-yourname-d16" # Your web app name
        $resourceGroupName = "rg-webapp-lab"
        $localRepoPath = "./my-local-webapp" # Path to your local Git repo
        ```
      * **Configure Local Git deployment for the web app**:
        ```powershell
        Set-AzResource -Properties @{ scmType = "LocalGit" } -ResourceGroupName $resourceGroupName `
            -ResourceType Microsoft.Web/sites/config -ResourceName "$webappName/web" -ApiVersion 2015-08-01 -Force
        ```
      * **Get the Git clone URI and publishing profile details**:
        ```powershell
        (Get-AzWebAppPublishingProfile -ResourceGroupName $resourceGroupName -Name $webappName -FormatXml).PublishProfile.item | Select-Object -ExpandProperty "$_".ServiceUrl, UserName, UserPWD
        # Look for a ServiceUrl ending in .git
        ```
      * In your local terminal (after `cd` into `$localRepoPath` and `git init` and commit), add the Azure remote and push:
        ```bash
        git remote add azure <Git_clone_URI_from_PowerShell_output>
        git push azure main # or master
        ```
      * Enter the deployment username and password when prompted.

-----

## Part 4: Configuring Custom Domains and SSL Certificates

Now, let's make your web app accessible via a custom domain and secure it with HTTPS using an App Service Managed Certificate.

**Prerequisites for this Part**:

  * Your App Service Plan must be **Standard (S1)** tier or higher. (We set this up in Part 2).
  * You must own a domain name and have access to its DNS management portal.

### Step 1: Get Your Web App's Default Domain and IP Address

You'll need these to create DNS records.

  * **Azure Portal**: Navigate to your Web App (`webapp-yourname-d16`). On the **Overview** blade, note the **Default domain** (e.g., `webapp-yourname-d16.azurewebsites.net`). Also, copy the **Outbound IP addresses** (you'll typically use the first one for the A record if mapping a root domain, or the CNAME for subdomains). For a CNAME, you only need the default domain.
  * **Azure CLI**:
    ```bash
    az webapp show --name $webappName --resource-group $resourceGroup --query "{DefaultHostName:defaultHostName, OutboundIpAddresses:outboundIpAddresses}" -o jsonc
    ```
  * **Azure PowerShell**:
    ```powershell
    (Get-AzWebApp -ResourceGroupName $resourceGroupName -Name $webappName).DefaultHostName
    (Get-AzWebApp -ResourceGroupName $resourceGroupName -Name $webappName).OutboundIpAddresses
    ```

### Step 2: Configure DNS Records at Your Domain Registrar

You'll map a subdomain (e.g., `www.yourdomain.com`) using a CNAME record. If you want to map the root domain (`yourdomain.com`), you'd typically use an A record pointing to the App Service's inbound IP, and a TXT record for verification. For simplicity, let's focus on the `www` subdomain using CNAME.

1.  **Login to your domain registrar's website** (e.g., GoDaddy, Namecheap, Cloudflare).
2.  Navigate to the **DNS management** section for your domain (`yourdomain.com`).
3.  **Add a CNAME record**:
      * **Type**: `CNAME`
      * **Host/Name**: `www` (or any other subdomain you wish to use, e.g., `app`)
      * **Value/Points to**: `<your-webapp-name>.azurewebsites.net` (e.g., `webapp-yourname-d16.azurewebsites.net`).
      * **TTL**: Leave as default (e.g., 600 seconds, 1 hour).
4.  **Add a TXT record for domain ownership verification**:
      * Azure requires a TXT record to verify you own the domain. This record typically maps `asuid.<subdomain>` or `asuid` for root domains to a specific ID.
      * **Azure Portal**: Go to your Web App -\> **Custom domains**. Click **"+ Add custom domain"**. Enter `www.yourdomain.com`. The portal will then show you the required CNAME and TXT records. Copy the **TXT record** details.
      * **Azure CLI/PowerShell**: The TXT record value for verification is the Web App's `CustomDomainVerificationId`.
          * **CLI**: `az webapp show --name $webappName --resource-group $resourceGroup --query "customDomainVerificationId" -o tsv`
          * **PowerShell**: `(Get-AzWebApp -ResourceGroupName $resourceGroupName -Name $webappName).CustomDomainVerificationId`
      * **At your registrar**:
          * **Type**: `TXT`
          * **Host/Name**: `asuid.www` (if `www` is your CNAME host) or `asuid` (for root domain). Azure Portal will explicitly tell you.
          * **Value**: `<CustomDomainVerificationId_from_Azure>`
      * **Save your DNS changes.** DNS changes can take a few minutes to several hours to propagate.

### Step 3: Add the Custom Domain to Azure App Service

1.  **Azure Portal üåê**:

      * Navigate to your Web App (`webapp-yourname-d16`).
      * In the left-hand menu, under **"Settings"**, select **"Custom domains"**.
      * Click **"+ Add custom domain"**.
      * **Domain provider**: Select **"All other domain services"**.
      * **Domain**: Enter your fully qualified custom domain name (e.g., `www.yourdomain.com`).
      * **TLS/SSL certificate**: Select **"App Service Managed Certificate"**.
      * Click **"Validate"**. If your DNS records have propagated correctly, you'll see green checkmarks.
      * Click **"Add"**.
      * The custom domain will be added, and an "App Service Managed Certificate" will start provisioning. This can take a few minutes.

2.  **Azure CLI üñ•Ô∏è**:

      * **Set Variables**:
        ```bash
        customDomainName="www.yourdomain.com" # Replace with your actual domain
        ```
      * **Add the custom domain to the web app**:
        ```bash
        az webapp hostname add \
          --webapp-name $webappName \
          --resource-group $resourceGroup \
          --hostname $customDomainName
        ```
      * **Wait for DNS propagation and App Service internal verification.**
      * **Enable App Service Managed Certificate**:
        ```bash
        az webapp create-remote-connection --name $webappName --resource-group $resourceGroup
        az webapp config ssl create --hostname $customDomainName --name $webappName --resource-group $resourceGroup
        ```
        *Note: The CLI might require a brief delay for DNS propagation before the SSL certificate creation succeeds.*

3.  **Azure PowerShell üíª**:

      * **Set Variables**:
        ```powershell
        $customDomainName = "www.yourdomain.com" # Replace with your actual domain
        ```
      * **Add the custom domain to the web app**:
        ```powershell
        Set-AzWebApp -ResourceGroupName $resourceGroupName -Name $webappName -HostNames @($customDomainName, "$webappName.azurewebsites.net")
        ```
      * **Wait for DNS propagation and App Service internal verification.**
      * **Create and bind App Service Managed Certificate**:
        ```powershell
        # Get App Service Managed Certificate details (this is a bit more manual with PS)
        # In practice, you'd usually do this via portal or use a pre-existing cert.
        # Azure CLI's 'az webapp config ssl create' is more streamlined for Managed Certs.
        # For PowerShell, you'd typically manage certificates from Key Vault or upload PFX.
        # If you truly want to use the *free managed cert* with PowerShell, it's not a single direct command like CLI.
        # The common approach is to create via Portal/CLI first, then list/bind in PS.

        # To demonstrate binding with a placeholder for a pre-existing certificate object (if you had one)
        # First, ensure your App Service Plan is at least Basic (B1) for custom domains, Standard (S1) for SSL.
        # We already set it to S1.

        # This command creates an App Service Managed Certificate (simplified, might require additional steps for full automation)
        # Note: This command might not directly trigger the managed cert creation, which is often tied to the Portal UI.
        # Best practice is to initiate the managed cert from the portal for simplicity in a lab.
        # Then you can proceed to bind it.

        # Let's assume the managed cert is already created (e.g., from portal or if the CLI command above worked)
        # You'd typically find it like this:
        $managedCert = Get-AzWebAppCertificate -ResourceGroupName $resourceGroupName -WebAppName $webappName | Where-Object {$_.IsCsm} | Select-Object *

        if ($managedCert) {
            # Bind the certificate to the custom domain
            Set-AzWebAppSslBinding -ResourceGroupName $resourceGroupName -WebAppName $webappName `
                -CertificateId $managedCert.Id -SslState SniEnabled -HostName $customDomainName
            Write-Host "SSL Binding for $customDomainName created with Managed Certificate."
        } else {
            Write-Warning "App Service Managed Certificate not found or created. Please ensure it's provisioned via Portal/CLI."
            # Fallback for lab: Instruct to use Portal to create the managed cert first.
        }
        ```
        *The App Service Managed Certificate feature in PowerShell is less direct than in the Portal/CLI. For a lab, it's often easiest to trigger the managed cert creation from the Portal first, then use PowerShell for binding if needed.*

### Step 4: Test Your Custom Domain and HTTPS

1.  Open your web browser.
2.  Navigate to `http://www.yourdomain.com`. It should load your web app.
3.  Navigate to `https://www.yourdomain.com`. It should load your web app securely (look for the padlock icon in the browser).
4.  Azure App Service automatically redirects HTTP traffic to HTTPS by default.

-----

## Part 5: Cleaning Up Resources (Highly Recommended)

To avoid incurring ongoing costs, always delete resources you no longer need. Deleting the resource group will remove the Web App, App Service Plan, and all associated components.

### Method 1: Azure Portal üåê

1.  **Navigate to Resource Groups**: In the Azure Portal, go to **"Resource groups"**.
2.  Find and click on your resource group: **`rg-webapp-lab`**.
3.  On the resource group's Overview blade, click **"Delete resource group"**.
4.  Type `rg-webapp-lab` to confirm, then click **"Delete"**.

### Method 2: Azure CLI üñ•Ô∏è

```bash
az group delete --name rg-webapp-lab --no-wait --yes
echo "Resource group 'rg-webapp-lab' deletion initiated."
```

### Method 3: Azure PowerShell üíª

```powershell
Remove-AzResourceGroup -Name "rg-webapp-lab" -Force -AsJob
Write-Host "Resource group 'rg-webapp-lab' deletion initiated."
```

-----

This lab covers the essential steps for deploying a web app to Azure App Service and configuring it for custom domains with SSL, using multiple management tools. This hands-on experience will solidify your understanding of these core App Service capabilities.