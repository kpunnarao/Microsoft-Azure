# Lab: Core Azure Compute Services - Virtual Machines (VMs) Part 1 üñ•Ô∏è

## Creating a Windows VM in the Azure Portal, Azure CLI, and Azure PowerShell

This lab provides comprehensive instructions on how to create a new Windows Virtual Machine (VM) in Microsoft Azure using the Azure Portal, Azure CLI, and Azure PowerShell. 

You'll learn the essential configuration steps to get a basic VM up and running with each method.

## Lab Scenario üè∞

You need to provision a new Windows Server VM in Azure to host an application or serve as a development environment. 

This lab will focus on the core steps to deploy a standard Windows VM and prepare it for initial access by allowing RDP.

**Resources to be created:**

  * **Resource Group**: `rg-winvm-lab`
  * **Location**: `East US` (or a region close to you)
  * **Virtual Machine**: `vm-windows-01`
  * **Image**: `Windows Server 2019 Datacenter`
  * **Size**: `Standard_B2s` (or a similar small, economical size)
  * **Administrator Username**: `azureuser` (or choose your own)
  * **Public Inbound Ports**: Allow RDP (Port 3389)

-----

## Part 1: Prerequisites

Before you begin, ensure you have:

  * An active Azure Subscription.
  * Access to the Azure Portal ([portal.azure.com](https://portal.azure.com)).
  * **For Azure CLI method**: Azure CLI installed and configured locally, or access to Azure Cloud Shell (Bash).
  * **For Azure PowerShell method**: Azure PowerShell installed and configured locally, or access to Azure Cloud Shell (PowerShell).

-----

## Part 2: Creating the Windows Virtual Machine

Choose your preferred method to deploy the Windows VM.

### Method 1: Azure Portal üåê

This is the most common and straightforward method, especially for those new to Azure.

1.  **Sign in to the Azure Portal**:

      * Open your web browser and navigate to [**portal.azure.com**](https://portal.azure.com).
      * Sign in with your Azure account credentials.

2.  **Navigate to Virtual Machines**:

      * In the Azure Portal's global search bar (at the top), type "Virtual machines" and select **"Virtual machines"** from the search results.
      * Alternatively, click on **"Virtual machines"** from your Dashboard or the left-hand menu.

3.  **Start the VM Creation Process**:

      * On the Virtual machines blade, click **"+ Create"** then select **"Azure virtual machine"**.

4.  **Configure Basics Tab**:

      * **Project details**:
          * **Subscription**: Select your Azure subscription from the dropdown.
          * **Resource group**: Click **"Create new"** and enter `rg-winvm-lab`. Click **"OK"**.
      * **Instance details**:
          * **Virtual machine name**: Enter `vm-windows-01`.
          * **Region**: Select **"East US"** (or a region closest to your physical location).
          * **Availability options**: Leave as default (`No infrastructure redundancy required`).
          * **Security type**: Leave as default (`Standard`).
          * **Image**: Select **"Windows Server 2019 Datacenter"** from the dropdown.
          * **Azure Spot instance**: Leave unchecked (default is "No").
          * **Size**: Click **"Change size"**. Select a cost-effective size like **`Standard_B2s`** (2 vCPUs, 4 GiB memory). Click **"Select"**.
      * **Administrator account**:
          * **Username**: Enter a username, for example, `azureuser`.
          * **Password**: Enter a strong password and confirm it. Remember these credentials\!
      * **Inbound port rules**:
          * **Public inbound ports**: Select **"Allow selected ports"**.
          * **Select inbound ports**: Check the box next to **"RDP (3389)"**.
      * **Licensing**: Leave unchecked unless you have an existing Windows Server license.

5.  **Configure Disks Tab**:

      * **OS disk type**: Keep **"Standard SSD"**.
      * No other changes needed for this lab.

6.  **Configure Networking Tab**:

      * Accept the automatically created **Virtual network**, **Subnet**, and **Public IP**.
      * The **NIC network security group** and **Public inbound ports** should reflect your RDP allowance.

7.  **Review + Create Tab**:

      * Review all settings. Azure will perform a final validation.
      * Check the **estimated monthly cost**.
      * If validation passes, click **"Create"** at the bottom.

8.  **Deployment**:

      * Azure will start deploying your VM. This usually takes a few minutes.
      * You'll see a notification indicating the deployment status. You can click on **"Go to resource"** from the deployment notification once it's complete.

-----

### Method 2: Azure CLI üñ•Ô∏è

This method uses command-line commands to create the VM, which is efficient for automation.

1.  **Open Azure Cloud Shell (Bash) or your local Terminal with Azure CLI installed**.

      * Ensure you are logged in to Azure CLI (`az login`).

2.  **Set Variables (Optional but Recommended)**:

    ```bash
    resourceGroupName="rg-winvm-lab"
    vmName="vm-windows-01"
    location="eastus"
    adminUsername="azureuser"
    adminPassword="YourComplexPassword123!" # CHANGE THIS TO A STRONG PASSWORD
    image="Win2019Datacenter" # Or use "MicrosoftWindowsServer:WindowsServer:2019-Datacenter:latest"
    vmSize="Standard_B2s"
    ```

3.  **Create Resource Group**:

      * If you don't already have the resource group from the portal method:
        ```bash
        az group create --name $resourceGroupName --location $location
        ```

4.  **Create the Virtual Machine**:

    ```bash
    az vm create \
      --resource-group $resourceGroupName \
      --name $vmName \
      --image $image \
      --admin-username $adminUsername \
      --admin-password $adminPassword \
      --size $vmSize \
      --location $location \
      --public-ip-sku Standard \
      --nsg-rule RDP \
      --no-wait
    ```

      * `--image`: Specifies the OS image.
      * `--public-ip-sku Standard`: Creates a Standard Public IP (recommended for production).
      * `--nsg-rule RDP`: Automatically creates an inbound NSG rule to allow RDP (port 3389) traffic.
      * `--no-wait`: Tells the command to return immediately without waiting for the VM deployment to complete. You can check the status later using `az vm show -g $resourceGroupName -n $vmName --query "provisioningState"`.

5.  **Monitor Deployment (Optional)**:

    ```bash
    az vm show --resource-group $resourceGroupName --name $vmName --show-details --query "powerState" -o tsv
    ```

    Keep running this command until the output is "VM running".

-----

### Method 3: Azure PowerShell üíª

This method uses PowerShell cmdlets to create the VM, offering a powerful scripting option.

1.  **Open Azure Cloud Shell (PowerShell) or your local PowerShell 7 terminal with Azure PowerShell installed**.

      * Ensure you are logged in to Azure PowerShell (`Connect-AzAccount`).

2.  **Set Variables (Optional but Recommended)**:

    ```powershell
    $resourceGroupName = "rg-winvm-lab"
    $vmName = "vm-windows-01"
    $location = "EastUS"
    $adminUsername = "azureuser"
    $adminPassword = (ConvertTo-SecureString "YourComplexPassword123!" -AsPlainText -Force) # CHANGE THIS TO A STRONG PASSWORD
    $image = "MicrosoftWindowsServer:WindowsServer:2019-Datacenter:latest"
    $vmSize = "Standard_B2s"
    ```

3.  **Create Resource Group**:

      * If you don't already have the resource group:
        ```powershell
        New-AzResourceGroup -Name $resourceGroupName -Location $location
        ```

4.  **Create the Virtual Machine**:

    ```powershell
    New-AzVM -ResourceGroupName $resourceGroupName `
      -Name $vmName `
      -Location $location `
      -Image $image `
      -Size $vmSize `
      -Credential (New-Object System.Management.Automation.PSCredential($adminUsername, $adminPassword)) `
      -PublicIPAddressName ($vmName + "-ip") `
      -OpenPorts 3389 `
      -Verbose
    ```

      * `-Credential`: Takes a PSCredential object for username/password.
      * `-PublicIPAddressName`: Assigns a name to the automatically created public IP.
      * `-OpenPorts 3389`: Automatically creates an inbound NSG rule to allow port 3389 (RDP).
      * `-Verbose`: Provides detailed output during deployment.

5.  **Monitor Deployment (Optional)**:

    ```powershell
    Get-AzVM -ResourceGroupName $resourceGroupName -Name $vmName -Status
    ```

    Look for `PowerState` being `VM running`.

-----

## Part 3: Connecting to the Windows VM (RDP)

Regardless of the method used to create the VM, the connection process is the same. Refer to the previous lab for detailed steps on connecting via RDP.

**Quick Steps for RDP:**

1.  **Get the Public IP Address** of your VM:
      * **Portal**: Navigate to the VM's **Overview** blade and copy the "Public IP address".
      * **CLI**: `az vm show --resource-group rg-winvm-lab --name vm-windows-01 --query "publicIps" -o tsv`
      * **PowerShell**: `(Get-AzPublicIpAddress -ResourceGroupName rg-winvm-lab -Name (Get-AzVM -ResourceGroupName rg-winvm-lab -Name vm-windows-01).NetworkProfile.NetworkInterfaces.Id.Split('/')[-1].Replace("Microsoft.Network/networkInterfaces/", "")).IpAddress`
2.  **Open your RDP client** (Remote Desktop Connection on Windows, Microsoft Remote Desktop on macOS, Remmina/FreeRDP on Linux).
3.  **Enter the Public IP address** and click **"Connect"**.
4.  **Enter the Administrator Username** (`azureuser`) and **Password** you set during VM creation.
5.  Accept any certificate warnings to complete the connection.

-----

## Part 4: Clean Up Resources (Optional but Recommended)

To avoid incurring ongoing costs, always delete resources you no longer need. Deleting the resource group will remove the VM, public IP, network interface, and associated disks.

### Method 1: Azure Portal üåê

1.  **Navigate to Resource Groups**: In the Azure Portal, go to **"Resource groups"**.
2.  Find and click on your resource group: **`rg-winvm-lab`**.
3.  On the resource group's Overview blade, click **"Delete resource group"**.
4.  Type `rg-winvm-lab` to confirm, then click **"Delete"**.

### Method 2: Azure CLI üñ•Ô∏è

```bash
az group delete --name rg-winvm-lab --no-wait --yes
echo "Resource group 'rg-winvm-lab' deletion initiated."
```

  * **Caution**: Deleting a resource group will delete ALL resources contained within it.

### Method 3: Azure PowerShell üíª

```powershell
Remove-AzResourceGroup -Name "rg-winvm-lab" -Force -AsJob
Write-Host "Resource group 'rg-winvm-lab' deletion initiated."
```

  * **Caution**: Deleting a resource group will delete ALL resources contained within it.

-----