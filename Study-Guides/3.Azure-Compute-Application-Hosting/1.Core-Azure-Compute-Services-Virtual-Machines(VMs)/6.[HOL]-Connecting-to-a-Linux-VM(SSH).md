# Lab: Connecting to a Linux VM (SSH) üêß

This lab provides step-by-step instructions on how to establish a Secure Shell (SSH) connection to your Linux Virtual Machine (VM) in Azure. 

We'll cover connecting via the Azure Portal's built-in SSH functionality (Azure Bastion), using your local SSH client (the most common method), and leveraging Azure Cloud Shell.

## Lab Scenario üè∞

You have successfully deployed a Linux Server VM in Azure (e.g., `vm-linux-01` in `rg-linuxvm-lab`), configured with SSH public key authentication, and now you need to securely connect to it to perform administrative tasks.

**Assumptions:**

  * You have a **Linux Virtual Machine** already deployed in your Azure subscription (e.g., `vm-linux-01` in `rg-linuxvm-lab`) with a **Public IP address** and **SSH (port 22)** allowed via its Network Security Group.
  * You used **SSH public key authentication** when creating the VM.
  * You have the **private key** corresponding to the public key that was uploaded to the VM. This private key file should be stored securely on your local machine and have restricted permissions (e.g., `chmod 400 ~/.ssh/id_rsa_azure`).
  * You know the **Administrator Username** for the VM (e.g., `azureuser`).
  * Your local machine has an SSH client installed (most Linux/macOS systems have OpenSSH built-in; Windows 10/11 also include OpenSSH).

-----

## Part 1: Prerequisites

  * An active Azure Subscription.
  * Access to the Azure Portal ([portal.azure.com](https://portal.azure.com)).
  * The **private SSH key file** (`id_rsa_azure` or similar) on your local machine, corresponding to the public key you provided when creating the VM.
  * **Permissions for private key**: Ensure your private key file has the correct permissions (read-only for the owner).
      * **Linux/macOS/Git Bash (Windows)**:
        ```bash
        chmod 400 ~/.ssh/id_rsa_azure # Replace with your private key path
        ```
      * **Windows (PowerShell/CMD)**: The permissions are often handled automatically, but you can set them manually if needed (right-click file -\> Properties -\> Security -\> Advanced -\> Disable inheritance -\> Remove all permissions except for your user).

-----

## Part 2: Connecting to the Linux VM

### Method 1: Azure Portal (using Azure Bastion) üåê

The Azure Portal offers a browser-based SSH client via **Azure Bastion**. This is a highly secure method as it requires no public IP on your VM and uses an encrypted connection through your browser, without exposing your VM to the internet.

**Note:** Azure Bastion is a paid service and needs to be deployed in your VNet. If you haven't set up Bastion, this option won't be available by default. If it's not set up, you'll be prompted to configure it. For this lab, we'll assume a basic scenario where you just use the Portal's SSH option which *might* use a temporary public IP if Bastion is not provisioned.

1.  **Sign in to the Azure Portal**:

      * Open your web browser and navigate to [**portal.azure.com**](https://portal.azure.com).
      * Sign in with your Azure account credentials.

2.  **Navigate to your Virtual Machine**:

      * In the Azure Portal's global search bar, type `vm-linux-01` (or your VM's name) and select it from the search results.
      * Alternatively, go to **"Virtual machines"** from the left-hand menu and select `vm-linux-01`.

3.  **Initiate SSH Connection via Portal**:

      * On the VM's **Overview** blade, locate the **"Connect"** button in the top menu bar. Click it.
      * From the dropdown, select **"SSH"**.

4.  **Configure SSH Connection**:

      * The SSH blade will appear.
      * **Authentication type**: Choose **"SSH private key from local file"**.
      * **Username**: Enter `azureuser` (or your VM's admin username).
      * **Private Key File**: Click **"Browse"** and select your **private SSH key file** (e.g., `id_rsa_azure`).
      * Click **"Connect"**.

5.  **Successful Connection**:

      * A new browser window/tab will open, displaying a terminal window connected to your Linux VM.
      * You can now execute commands on your VM.

-----

### Method 2: Local SSH Client üíª

This is the most common and flexible way to connect to a Linux VM.

1.  **Open your Terminal/Command Prompt (with OpenSSH installed)**.

      * **Windows 10/11**: Open PowerShell or Command Prompt. OpenSSH client is usually built-in.
      * **macOS/Linux**: Open your default terminal application. OpenSSH client is built-in.

2.  **Get the VM's Public IP Address**:

      * You can find this in the Azure Portal on your VM's **Overview** blade. Copy the **"Public IP address"**.
      * Alternatively, use Azure CLI:
        ```bash
        az vm show --resource-group rg-linuxvm-lab --name vm-linux-01 --query "publicIps" --output tsv
        ```
      * Or Azure PowerShell:
        ```powershell
        (Get-AzPublicIpAddress -ResourceGroupName "rg-linuxvm-lab" -Name (Get-AzVM -ResourceGroupName "rg-linuxvm-lab" -Name "vm-linux-01").NetworkProfile.NetworkInterfaces.Id.Split('/')[-1].Replace("Microsoft.Network/networkInterfaces/", "")).IpAddress
        ```
      * Store this IP address for the next step (e.g., `20.123.45.67`).

3.  **Connect using SSH Command**:

      * In your terminal, use the `ssh` command with the following syntax:

        ```bash
        ssh -i /path/to/your/private_key_file azureuser@<Public_IP_Address>
        ```

      * **Replace**:

          * `/path/to/your/private_key_file`: With the actual path to your private SSH key (e.g., `~/.ssh/id_rsa_azure` on Linux/macOS, or `C:\Users\YourUser\.ssh\id_rsa_azure` on Windows).
          * `azureuser`: With the administrator username you configured for the VM.
          * `<Public_IP_Address>`: With the public IP address you obtained in the previous step.

      * **Example (Linux/macOS/Git Bash)**:

        ```bash
        ssh -i ~/.ssh/id_rsa_azure azureuser@20.123.45.67
        ```

      * **Example (Windows PowerShell/CMD)**:

        ```powershell
        ssh -i "C:\Users\YourUser\.ssh\id_rsa_azure" azureuser@20.123.45.67
        ```

        *(Note the quotes around the path if it contains spaces.)*

4.  **First Connection Fingerprint Verification**:

      * The first time you connect to a new VM, SSH will ask you to verify the host's authenticity by displaying its fingerprint.
      * It will look something like:
        ```
        The authenticity of host '20.123.45.67 (20.123.45.67)' can't be established.
        ECDSA key fingerprint is SHA256:abcd123...
        Are you sure you want to continue connecting (yes/no)?
        ```
      * Type **`yes`** and press Enter. This will add the VM's host key to your `~/.ssh/known_hosts` file, so you won't be prompted again for this specific VM from this client.
      * **Security Best Practice**: For production environments, it's recommended to verify this fingerprint against the actual fingerprint from the VM (e.g., by running `ssh-keygen -lf /etc/ssh/ssh_host_ecdsa_key.pub` on the VM itself via Azure's Run Command, or by checking the VM's boot diagnostics).

5.  **Enter Passphrase (if set)**:

      * If you protected your private key with a passphrase, you will be prompted to enter it.
      * Enter your passphrase and press Enter.

6.  **Successful Connection**:

      * You should now be connected to your Linux VM's command-line interface. You'll see the VM's prompt (e.g., `azureuser@vm-linux-01:~$` ).

-----

### Method 3: Azure Cloud Shell ‚òÅÔ∏è

Azure Cloud Shell provides a browser-based shell (Bash or PowerShell) with Azure CLI and Azure PowerShell pre-installed and authenticated. This is a great option if you don't want to install tools locally or are using a machine without your private key.

**Important Note for SSH Keys in Cloud Shell**:

  * If you generated your SSH key pair *outside* Cloud Shell and want to use it here, you'll need to upload your **private key** to your Cloud Shell storage.
  * Alternatively, if you create the VM *from* Cloud Shell, it can automatically generate and use a key pair stored within your Cloud Shell, or you can paste your public key directly.

<!-- end list -->

1.  **Open Azure Cloud Shell**:

      * In the Azure Portal, click the **Cloud Shell icon** ( `>_` ) in the top right corner of the header.
      * Choose **Bash** or **PowerShell**.

2.  **Get the VM's Public IP Address**:

      * If you just created the VM using Cloud Shell, you might already have the IP from the output.
      * Otherwise, use the same CLI or PowerShell commands as in Method 2 to get the public IP address.
          * **Bash**:
            ```bash
            az vm show --resource-group rg-linuxvm-lab --name vm-linux-01 --query "publicIps" --output tsv
            ```
          * **PowerShell**:
            ```powershell
            (Get-AzPublicIpAddress -ResourceGroupName "rg-linuxvm-lab" -Name (Get-AzVM -ResourceGroupName "rg-linuxvm-lab" -Name "vm-linux-01").NetworkProfile.NetworkInterfaces.Id.Split('/')[-1].Replace("Microsoft.Network/networkInterfaces/", "")).IpAddress
            ```

3.  **Connect using SSH Command (Bash or PowerShell in Cloud Shell)**:

      * **If you uploaded your private key to Cloud Shell's `clouddrive`**:
        ```bash
        ssh -i ~/clouddrive/id_rsa_azure azureuser@<Public_IP_Address>
        ```
      * **If your VM was created with an SSH key pair generated by Cloud Shell (e.g., `az vm create` without `--ssh-key-values` but with `--generate-ssh-keys`)**:
        ```bash
        ssh azureuser@<Public_IP_Address>
        ```
        (Cloud Shell will automatically use the default key it generated for the user).

4.  **Follow On-Screen Prompts**:

      * Similar to the local SSH client, you'll be prompted to confirm the host's fingerprint and enter your passphrase if applicable.

5.  **Successful Connection**:

      * You are now connected to your Linux VM directly from your browser.

-----

## Part 3: Cleaning Up Resources (Optional but Recommended)

To avoid incurring ongoing costs, always delete resources you no longer need. Deleting the resource group will remove the VM, public IP, network interface, and associated disks.

### Method 1: Azure Portal üåê

1.  **Navigate to Resource Groups**: In the Azure Portal, go to **"Resource groups"**.
2.  Find and click on your resource group: **`rg-linuxvm-lab`**.
3.  On the resource group's Overview blade, click **"Delete resource group"**.
4.  Type `rg-linuxvm-lab` to confirm, then click **"Delete"**.

### Method 2: Azure CLI üñ•Ô∏è

```bash
az group delete --name rg-linuxvm-lab --no-wait --yes
echo "Resource group 'rg-linuxvm-lab' deletion initiated."
```

  * **Caution**: Deleting a resource group will delete ALL resources contained within it.

### Method 3: Azure PowerShell üíª

```powershell
Remove-AzResourceGroup -Name "rg-linuxvm-lab" -Force -AsJob
Write-Host "Resource group 'rg-linuxvm-lab' deletion initiated."
```

  * **Caution**: Deleting a resource group will delete ALL resources contained within it.

-----