# Lab: Implementing Azure Traffic Manager (Priority Routing) üö¶

This lab guides you through setting up an Azure Traffic Manager profile to direct user traffic to web applications in different Azure regions based on a priority routing method. This simulates a common disaster recovery pattern where a primary region serves all traffic, and a secondary region acts as a failover.

## Lab Scenario üåê

We will create two simple web applications in two different Azure regions and use Traffic Manager to route traffic to the primary region, failing over to the secondary if the primary becomes unhealthy.

  * **Resource Group**: `rg-traffic-manager-lab`
  * **Regions**: `East US` (Primary) and `West US` (Secondary)
  * **Web App 1 (Primary)**: `webapp-primary-eus` (in `East US`)
  * **Web App 2 (Secondary)**: `webapp-secondary-wus` (in `West US`)
  * **Traffic Manager Profile Name**: `mywebapp-global-tm`
  * **Routing Method**: `Priority`

-----

## Part 1: Prerequisites & Initial Setup

Before proceeding, ensure you have:

  * An active Azure Subscription.
  * The Azure CLI and Azure PowerShell installed and configured on your local machine, or use Azure Cloud Shell.
  * **Create the Resource Group**:

### Method 1: Azure Portal üåê

1.  Search for "Resource groups" and click **"+ Create"**.
2.  Subscription: Your subscription.
3.  Resource Group name: `rg-traffic-manager-lab`.
4.  Region: `East US` (This is just for the RG metadata).
5.  Review + create, then Create.

### Method 2: Azure PowerShell üíª

```powershell
# --- Define Variables ---
$resourceGroupName = "rg-traffic-manager-lab"
$locationEastUS = "eastus"
$locationWestUS = "westus"

# --- Create Resource Group ---
Write-Host "Creating Resource Group: $resourceGroupName..."
New-AzResourceGroup -Name $resourceGroupName -Location $locationEastUS

Write-Host "Resource Group created."
```

### Method 3: Azure CLI üñ•Ô∏è

```bash
# --- Define Variables ---
resourceGroupName="rg-traffic-manager-lab"
locationEastUS="eastus"
locationWestUS="westus"

# --- Create Resource Group ---
echo "Creating Resource Group: $resourceGroupName..."
az group create --name $resourceGroupName --location $locationEastUS

echo "Resource Group created."
```

-----

## Part 2: Create Web Applications

We'll create two basic Azure Web Apps (App Services) to serve as our endpoints. These don't need to host any specific content for this lab, as we're just demonstrating routing.

### Method 1: Azure Portal üåê

1.  Search for "App Services" and click **"+ Create"** -\> "Web App".
2.  **Web App 1 (`webapp-primary-eus`)**:
      * Basics Tab:
          * Subscription: Your subscription.
          * Resource Group: `rg-traffic-manager-lab`.
          * Name: `webapp-primary-eus` (Must be globally unique).
          * Publish: `Code`.
          * Runtime stack: `.NET 8 (LTS)` (or any other, doesn't matter for this lab).
          * Operating System: `Windows`.
          * Region: `East US`.
          * App Service Plan: "Create new", Name: `plan-eus-tm`, SKU and size: `Basic B1`.
      * Review + create, then Create.
3.  **Web App 2 (`webapp-secondary-wus`)**: Repeat steps for Web App 1 but with:
      * Name: `webapp-secondary-wus` (Must be globally unique).
      * Region: `West US`.
      * App Service Plan: "Create new", Name: `plan-wus-tm`, SKU and size: `Basic B1`.
      * Review + create, then Create.

### Method 2: Azure PowerShell üíª

```powershell
# --- Define Web App Variables ---
$webappPrimaryName = "webapp-primary-eus-$(Get-Random)" # Ensures global uniqueness
$webappSecondaryName = "webapp-secondary-wus-$(Get-Random)" # Ensures global uniqueness
$appServicePlanNameEUS = "plan-eus-tm"
$appServicePlanNameWUS = "plan-wus-tm"

# --- Create App Service Plan (East US) ---
Write-Host "Creating App Service Plan for Primary Web App in East US..."
New-AzAppServicePlan -Name $appServicePlanNameEUS `
    -ResourceGroupName $resourceGroupName `
    -Location $locationEastUS `
    -Tier Basic `
    -IsLinux $false # Use $true for Linux plan

# --- Create Primary Web App (East US) ---
Write-Host "Creating Primary Web App: $webappPrimaryName in East US..."
New-AzWebApp -Name $webappPrimaryName `
    -ResourceGroupName $resourceGroupName `
    -Location $locationEastUS `
    -AppServicePlan $appServicePlanNameEUS

# --- Create App Service Plan (West US) ---
Write-Host "Creating App Service Plan for Secondary Web App in West US..."
New-AzAppServicePlan -Name $appServicePlanNameWUS `
    -ResourceGroupName $resourceGroupName `
    -Location $locationWestUS `
    -Tier Basic `
    -IsLinux $false

# --- Create Secondary Web App (West US) ---
Write-Host "Creating Secondary Web App: $webappSecondaryName in West US..."
New-AzWebApp -Name $webappSecondaryName `
    -ResourceGroupName $resourceGroupName `
    -Location $locationWestUS `
    -AppServicePlan $appServicePlanNameWUS

Write-Host "Web Apps creation initiated. This will take a few minutes."
```

### Method 3: Azure CLI üñ•Ô∏è

```bash
# --- Define Web App Variables ---
webappPrimaryName="webapp-primary-eus-$RANDOM" # Ensures global uniqueness
webappSecondaryName="webapp-secondary-wus-$RANDOM" # Ensures global uniqueness
appServicePlanNameEUS="plan-eus-tm"
appServicePlanNameWUS="plan-wus-tm"

# --- Create App Service Plan (East US) ---
echo "Creating App Service Plan for Primary Web App in East US..."
az appservice plan create \
    --name $appServicePlanNameEUS \
    --resource-group $resourceGroupName \
    --location $locationEastUS \
    --sku B1 # Basic B1

# --- Create Primary Web App (East US) ---
echo "Creating Primary Web App: $webappPrimaryName in East US..."
az webapp create \
    --resource-group $resourceGroupName \
    --plan $appServicePlanNameEUS \
    --name $webappPrimaryName \
    --deployment-container-image-names mcr.microsoft.com/azure-app-service/samples/aspnethelloworld # Basic demo image

# --- Create App Service Plan (West US) ---
echo "Creating App Service Plan for Secondary Web App in West US..."
az appservice plan create \
    --name $appServicePlanNameWUS \
    --resource-group $resourceGroupName \
    --location $locationWestUS \
    --sku B1

# --- Create Secondary Web App (West US) ---
echo "Creating Secondary Web App: $webappSecondaryName in West US..."
az webapp create \
    --resource-group $resourceGroupName \
    --plan $appServicePlanNameWUS \
    --name $webappSecondaryName \
    --deployment-container-image-names mcr.microsoft.com/azure-app-service/samples/aspnethelloworld

echo "Web Apps creation initiated. This will take a few minutes."
echo "You can check their status with: az webapp list -g $resourceGroupName --query '[].{Name:name,State:state}' -o table"
```

-----

## Part 3: Create Azure Traffic Manager Profile

Now we'll create the Traffic Manager profile and add our two web apps as endpoints, configuring them for Priority routing.

### Method 1: Azure Portal üåê

1.  Search for "Traffic Manager profiles" and click **"+ Create"**.
2.  **Basics Tab**:
      * Name: `mywebapp-global-tm` (Must be globally unique).
      * Routing method: Select `Priority`.
      * Subscription: Your subscription.
      * Resource Group: `rg-traffic-manager-lab`.
3.  Click **"Create"**.
4.  Once the profile is deployed, navigate to `mywebapp-global-tm`.
5.  In the left-hand menu, under **Settings**, select **Endpoints**.
6.  Click **"+ Add"**.
      * Type: `Azure endpoint`.
      * Name: `primary-endpoint-eus`.
      * Target resource type: `App Service`.
      * Target resource: Select `webapp-primary-eus`.
      * Priority: `1` (This makes it the primary).
      * Add.
7.  Click **"+ Add"** again.
      * Type: `Azure endpoint`.
      * Name: `secondary-endpoint-wus`.
      * Target resource type: `App Service`.
      * Target resource: Select `webapp-secondary-wus`.
      * Priority: `2` (This makes it the secondary/failover).
      * Add.
8.  In the left-hand menu, under **Settings**, select **Configuration**.
      * Under **Endpoint monitoring settings**:
          * Protocol: `HTTP`.
          * Port: `80`.
          * Path: `/`.
      * **TTL (Time to Live)**: Leave as default (300 seconds). This determines how long DNS resolvers cache the DNS response.
      * Click **"Save"** at the top.

-----

### Method 2: Azure PowerShell üíª

```powershell
# --- Define Traffic Manager Variables ---
$tmProfileName = "mywebapp-global-tm-$(Get-Random -Minimum 1000 -Maximum 9999)" # Ensures global uniqueness
$trafficRoutingMethod = "Priority"
$monitorProtocol = "HTTP"
$monitorPort = 80
$monitorPath = "/"

# --- Create Traffic Manager Profile ---
Write-Host "Creating Traffic Manager Profile: $tmProfileName..."
$tmProfile = New-AzTrafficManagerProfile -Name $tmProfileName `
    -ResourceGroupName $resourceGroupName `
    -TrafficRoutingMethod $trafficRoutingMethod `
    -RelativeDnsName $tmProfileName ` # Use the profile name as relative DNS name
    -MonitorProtocol $monitorProtocol `
    -MonitorPort $monitorPort `
    -MonitorPath $monitorPath `
    -Ttl 300 # TTL in seconds

Write-Host "Traffic Manager Profile created."

# --- Add Primary Endpoint (Priority 1) ---
Write-Host "Adding Primary Web App endpoint to Traffic Manager..."
$webappPrimary = Get-AzWebApp -Name $webappPrimaryName -ResourceGroupName $resourceGroupName
Add-AzTrafficManagerEndpoint -Name "primary-endpoint-eus" `
    -Type AzureEndpoints `
    -TargetResourceId $webappPrimary.Id `
    -EndpointStatus Enabled `
    -Priority 1 `
    -TrafficManagerProfile $tmProfile

# --- Add Secondary Endpoint (Priority 2) ---
Write-Host "Adding Secondary Web App endpoint to Traffic Manager..."
$webappSecondary = Get-AzWebApp -Name $webappSecondaryName -ResourceGroupName $resourceGroupName
Add-AzTrafficManagerEndpoint -Name "secondary-endpoint-wus" `
    -Type AzureEndpoints `
    -TargetResourceId $webappSecondary.Id `
    -EndpointStatus Enabled `
    -Priority 2 `
    -TrafficManagerProfile $tmProfile

Write-Host "Endpoints added to Traffic Manager Profile."
```

### Method 3: Azure CLI üñ•Ô∏è

```bash
# --- Define Traffic Manager Variables ---
tmProfileName="mywebapp-global-tm-$RANDOM" # Ensures global uniqueness
trafficRoutingMethod="Priority"
monitorProtocol="HTTP"
monitorPort="80"
monitorPath="/"

# --- Create Traffic Manager Profile ---
echo "Creating Traffic Manager Profile: $tmProfileName..."
az network traffic-manager profile create \
    --resource-group $resourceGroupName \
    --name $tmProfileName \
    --routing-method $trafficRoutingMethod \
    --unique-dns-name $tmProfileName \
    --monitor-protocol $monitorProtocol \
    --monitor-port $monitorPort \
    --monitor-path $monitorPath \
    --ttl 300

echo "Traffic Manager Profile created."

# --- Add Primary Endpoint (Priority 1) ---
echo "Adding Primary Web App endpoint to Traffic Manager..."
az network traffic-manager endpoint create \
    --resource-group $resourceGroupName \
    --profile-name $tmProfileName \
    --name "primary-endpoint-eus" \
    --type azureEndpoints \
    --target-resource-id $(az webapp show -g $resourceGroupName -n $webappPrimaryName --query id -o tsv) \
    --endpoint-status Enabled \
    --priority 1

# --- Add Secondary Endpoint (Priority 2) ---
echo "Adding Secondary Web App endpoint to Traffic Manager..."
az network traffic-manager endpoint create \
    --resource-group $resourceGroupName \
    --profile-name $tmProfileName \
    --name "secondary-endpoint-wus" \
    --type azureEndpoints \
    --target-resource-id $(az webapp show -g $resourceGroupName -n $webappSecondaryName --query id -o tsv) \
    --endpoint-status Enabled \
    --priority 2

echo "Endpoints added to Traffic Manager Profile."
```

-----

## Part 4: Test Traffic Manager Routing and Failover

After deployment, wait a few minutes for the health probes to mark the endpoints as healthy.

### 1\. Initial Test (Primary Active)

1.  **Get Traffic Manager DNS Name**:
      * **Portal**: Navigate to your `mywebapp-global-tm` profile. The DNS name will be displayed prominently (e.g., `mywebapp-global-tm.trafficmanager.net`).
      * **PowerShell**: `$tmProfile.DnsSettings.RelativeDnsName + ".trafficmanager.net"`
      * **CLI**: `az network traffic-manager profile show -g $resourceGroupName -n $tmProfileName --query dnsConfig.fqdn -o tsv`
2.  **Access the URL**: Open a web browser and navigate to the Traffic Manager's DNS name (e.g., `http://mywebapp-global-tm.trafficmanager.net`).
3.  **Verify Primary**: You should see the default "Your App Service app has been successfully deployed" page from the **primary (East US)** web app (`webapp-primary-eus`). You can usually infer this from the URL shown in the browser once it redirects, or if you had custom content on the apps.

### 2\. Simulate Failover (Disable Primary)

1.  **Disable Primary Web App (Portal)**:
      * Navigate to your `webapp-primary-eus` App Service.
      * In the **Overview** pane, click **"Stop"** (or in Traffic Manager -\> Endpoints, click the primary endpoint, then `Disable`).
2.  **Wait for Health Probes**: Wait about 2-5 minutes. Traffic Manager's health probes will detect that `webapp-primary-eus` is no longer responding.
3.  **Test Failover**: Open a **new browser tab/window** (or clear your browser's DNS cache if you're not getting a different result immediately) and navigate to the Traffic Manager's DNS name again (`http://mywebapp-global-tm.trafficmanager.net`).
4.  **Verify Secondary**: You should now be routed to the **secondary (West US)** web app (`webapp-secondary-wus`). Traffic Manager has automatically failed over.
5.  **Re-enable Primary (Optional)**: If you re-enable `webapp-primary-eus`, after a few minutes, Traffic Manager will detect it's healthy again and automatically route traffic back to it (since it has higher priority).

This lab demonstrates how Azure Traffic Manager, using Priority routing, provides a robust and automated failover mechanism for your global applications.

-----

## Part 5: Clean Up Resources

To avoid incurring unnecessary costs, delete the resource group created in this lab.

### Method 1: Azure Portal üåê

1.  Search for "Resource groups" and select `rg-traffic-manager-lab`.
2.  Click **"Delete resource group"**.
3.  Type `rg-traffic-manager-lab` to confirm, then click **"Delete"**.

### Method 2: Azure PowerShell üíª

```powershell
Remove-AzResourceGroup -Name "rg-traffic-manager-lab" -Force -AsJob
Write-Host "Resource group 'rg-traffic-manager-lab' deletion initiated."
```

### Method 3: Azure CLI üñ•Ô∏è

```bash
az group delete --name "rg-traffic-manager-lab" --yes --no-wait
echo "Resource group 'rg-traffic-manager-lab' deletion initiated."
```