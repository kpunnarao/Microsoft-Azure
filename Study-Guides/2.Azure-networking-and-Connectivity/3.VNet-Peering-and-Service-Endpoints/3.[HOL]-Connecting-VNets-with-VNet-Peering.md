# Connecting VNets with VNet Peering ü§ù

**VNet peering** is a mechanism in Azure that allows you to seamlessly connect two or more Azure Virtual Networks (VNets), making them appear as a single, larger network for connectivity purposes. 

Once peered, resources in one VNet can communicate with resources in the other VNet using **private IP addresses**, without the need for public IPs, VPN gateways, or ExpressRoute.

Think of it like knocking down the walls between two separate houses in a neighborhood to create one much larger house. Everyone inside can now talk to each other directly.

-----

## How VNet Peering Works üß†

VNet peering establishes a **low-latency, high-bandwidth connection** between two VNets. Here are the core characteristics of how it functions:

1.  **Private IP Connectivity**: Once peered, virtual machines (VMs) and other resources in one VNet can communicate directly with VMs and resources in the peered VNet using their **private IP addresses**. This traffic remains entirely within the Azure backbone network.
2.  **Non-Transitive Relationship**: VNet peering is **non-transitive**. This is a crucial point. If VNet A is peered with VNet B, and VNet B is peered with VNet C, it *does not* automatically mean that VNet A can communicate with VNet C. To allow A to communicate with C, you would need to explicitly peer VNet A with VNet C.
      * **A ‚Üî B**
      * **B ‚Üî C**
      * **A ‚Üî C (required for direct A to C communication)**
3.  **Cross-Subscription and Cross-Region Support**:
      * **VNet Peering**: Connects VNets within the **same Azure region**.
      * **Global VNet Peering**: Connects VNets across **different Azure regions**. This operates over the Microsoft backbone network, ensuring reliable and high-performance connectivity.
4.  **No Gateways Required for Direct Peering**: When you peer VNets, traffic flows directly between them within the Azure network. You **do not need a VPN Gateway** or ExpressRoute connection *between the peered VNets themselves* for this direct private communication. This significantly simplifies network design and reduces latency.
5.  **Traffic Isolation**: Peered VNets remain distinct. While resources can communicate, they are still logically separate networks. For instance, Network Security Groups (NSGs) applied within each VNet continue to function independently, allowing for granular security control within each VNet.

-----

## Steps to Configure VNet Peering (Azure Portal) üåê

Let's assume you have two existing VNets you want to peer:

  * **VNet A**: `vnet-prod-eastus` (e.g., `10.0.0.0/16`) in `East US`
  * **VNet B**: `vnet-dev-eastus` (e.g., `10.1.0.0/16`) in `East US`

*(For Global VNet Peering, the process is identical; you just select VNets in different regions.)*

1.  **Navigate to a VNet**: In the Azure portal, search for and select **Virtual networks**. Choose one of your VNets (e.g., `vnet-prod-eastus`).
2.  **Select Peerings**: In the VNet's left-hand menu, under **Settings**, select **Peerings**.
3.  **Add Peering**: Click the **"+ Add"** button.
4.  **Add Peering Configuration**: This blade configures the peering connection from *both sides*.
      * **From `vnet-prod-eastus` to `vnet-dev-eastus` (This VNet)**:
          * **Peering link name**: `vnetA-to-vnetB` (A descriptive name for *this side* of the peering).
          * **Allow `vnet-prod-eastus` to access `vnet-dev-eastus`**: Checked (default).
          * **Allow forwarded traffic from `vnet-dev-eastus` to `vnet-prod-eastus`**: Checked (default, allows traffic from resources not in the VNet itself to traverse the peering).
          * **Allow gateway transit**: Leave unchecked for now unless `vnet-dev-eastus` has a gateway you want to share (covered in advanced scenarios).
          * **Use remote gateways**: Leave unchecked for now unless `vnet-prod-eastus` needs to use a gateway in `vnet-dev-eastus`.
      * **From `vnet-dev-eastus` to `vnet-prod-eastus` (Remote virtual network)**:
          * **Peering link name**: `vnetB-to-vnetA` (A descriptive name for the *other side* of the peering).
          * **Subscription**: Select the subscription where `vnet-dev-eastus` resides.
          * **Virtual network**: Select `vnet-dev-eastus`.
          * **Allow `vnet-dev-eastus` to access `vnet-prod-eastus`**: Checked (default).
          * **Allow forwarded traffic from `vnet-prod-eastus` to `vnet-dev-eastus`**: Checked (default).
          * **Allow gateway transit**: Leave unchecked.
          * **Use remote gateways**: Leave unchecked.
5.  Click **"Add"**.

Once both sides of the peering are successfully created, their "Peering status" will change from "Updating" to **"Connected"**. This indicates that resources in both VNets can now communicate directly.

-----

## Step-by-Step Configuration (Azure PowerShell) üíª

```powershell
# --- 1. Define Variables ---
$resourceGroupName1 = "rg-vnet-prod"
$vnetName1 = "vnet-prod-eastus"
$resourceGroupName2 = "rg-vnet-dev"
$vnetName2 = "vnet-dev-eastus"
$location1 = "eastus"
$location2 = "eastus" # For Global Peering, this would be a different region

# --- 2. Retrieve VNets (or create if they don't exist) ---
# Assuming VNets already exist, retrieve them
$vnet1 = Get-AzVirtualNetwork -Name $vnetName1 -ResourceGroupName $resourceGroupName1
$vnet2 = Get-AzVirtualNetwork -Name $vnetName2 -ResourceGroupName $resourceGroupName2

# --- 3. Add Peering from VNet1 to VNet2 ---
Add-AzVirtualNetworkPeering `
    -Name "vnet1-to-vnet2" `
    -VirtualNetwork $vnet1 `
    -RemoteVirtualNetworkId $vnet2.Id `
    -AllowVirtualNetworkAccess # Equivalent to "Allow `vnet-prod-eastus` to access `vnet-dev-eastus`"
    # -AllowForwardedTraffic # Add if forwarded traffic is needed
    # -AllowGatewayTransit # Add if gateway transit from VNet1 to VNet2 is needed
    # -UseRemoteGateways # Add if VNet1 needs to use VNet2's gateway

# --- 4. Add Peering from VNet2 to VNet1 ---
# Note: You must run peering from both sides for it to be "Connected"
Add-AzVirtualNetworkPeering `
    -Name "vnet2-to-vnet1" `
    -VirtualNetwork $vnet2 `
    -RemoteVirtualNetworkId $vnet1.Id `
    -AllowVirtualNetworkAccess
    # -AllowForwardedTraffic
    # -AllowGatewayTransit
    # -UseRemoteGateways

Write-Host "VNet peering initiated between '$vnetName1' and '$vnetName2'. Status should become 'Connected'."

# --- 5. Verify Peering Status (Optional) ---
# Get-AzVirtualNetworkPeering -VirtualNetworkName $vnetName1 -ResourceGroupName $resourceGroupName1 | Select-Object Name, PeeringState
# Get-AzVirtualNetworkPeering -VirtualNetworkName $vnetName2 -ResourceGroupName $resourceGroupName2 | Select-Object Name, PeeringState
```

-----

## Step-by-Step Configuration (Azure CLI) üñ•Ô∏è

```bash
# --- 1. Define Variables ---
resourceGroupName1="rg-vnet-prod"
vnetName1="vnet-prod-eastus"
resourceGroupName2="rg-vnet-dev"
vnetName2="vnet-dev-eastus"
location1="eastus"
location2="eastus" # For Global Peering, this would be a different region

# --- 2. Get VNet IDs ---
vnet1Id=$(az network vnet show -g $resourceGroupName1 -n $vnetName1 --query id -o tsv)
vnet2Id=$(az network vnet show -g $resourceGroupName2 -n $vnetName2 --query id -o tsv)

# --- 3. Add Peering from VNet1 to VNet2 ---
az network vnet peering create \
    --name "vnet1-to-vnet2" \
    --resource-group $resourceGroupName1 \
    --vnet-name $vnetName1 \
    --remote-vnet $vnet2Id \
    --allow-vnet-access \
    --query "peeringState" # Displays "Initiated" initially

# --- 4. Add Peering from VNet2 to VNet1 ---
# This command completes the peering, setting both sides to "Connected"
az network vnet peering create \
    --name "vnet2-to-vnet1" \
    --resource-group $resourceGroupName2 \
    --vnet-name $vnetName2 \
    --remote-vnet $vnet1Id \
    --allow-vnet-access \
    --query "peeringState" # Displays "Connected"

echo "VNet peering initiated between '$vnetName1' and '$vnetName2'. Status should become 'Connected'."

# --- 5. Verify Peering Status (Optional) ---
# az network vnet peering show --resource-group $resourceGroupName1 --vnet-name $vnetName1 --name "vnet1-to-vnet2" --query peeringState
# az network vnet peering show --resource-group $resourceGroupName2 --vnet-name $vnetName2 --name "vnet2-to-vnet1" --query peeringState
```

-----

## Important Considerations for Peering ‚ö†Ô∏è

  * **Non-Overlapping IP Address Spaces**: This is the most critical requirement. The IP address spaces of the peered VNets **must not overlap**. If they do, the peering cannot be established. Plan your VNet address spaces carefully from the start.
  * **Routing**: Azure automatically handles the routing between peered VNets. You don't need to configure User Defined Routes (UDRs) for direct communication within the peering.
  * **Security**: While peering enables connectivity, NSGs still apply and function within each VNet. You must configure NSG rules to allow traffic between resources in peered VNets if not already allowed by default (e.g., `AllowVnetInBound` and `AllowVnetOutBound` NSG rules).
  * **Gateway Transit**: This is an advanced feature where one VNet (the "hub") can have a VPN or ExpressRoute Gateway, and other peered VNets (the "spokes") can use that gateway to connect to on-premises networks. This feature requires specific configuration (`AllowGatewayTransit` and `UseRemoteGateways`).
  * **Latency/Bandwidth**: Peering connections offer excellent performance. Global VNet peering uses Microsoft's global backbone network, providing reliable and low-latency connectivity across regions.

VNet peering is a powerful and efficient way to connect your Azure virtual networks, forming complex and scalable network topologies while maintaining logical separation.