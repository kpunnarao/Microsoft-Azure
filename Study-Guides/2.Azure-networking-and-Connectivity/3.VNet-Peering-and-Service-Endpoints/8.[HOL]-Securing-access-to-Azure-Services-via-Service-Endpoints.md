
# Securing access to Azure Services via Service Endpoints:
Securing access to Azure services via Service Endpoints involves two primary steps: **enabling the Service Endpoint on the subnet** where your consuming resources reside, and then **configuring network rules on the Azure PaaS service itself** to only allow traffic from that specific subnet. 

This effectively "locks down" access to your PaaS resources.

-----

## How to Secure Access with Service Endpoints üîí

Let's use an example of securing an Azure Storage Account so that it's only accessible from a specific subnet within your VNet.

### Step 1: Enable Service Endpoint on the Virtual Network Subnet

This step "extends" your VNet's identity to the Azure service and modifies routing.

#### Azure Portal üåê

1.  Navigate to your **Virtual Network** in the Azure portal.
2.  In the left-hand menu, under **Settings**, select **Subnets**.
3.  Select the specific **subnet** where your VMs or other compute resources (that need to access the PaaS service) are located.
4.  In the subnet's settings blade, locate the **Service endpoints** section.
5.  From the dropdown, select the **service(s)** you want to enable. For Azure Storage, you'd select `Microsoft.Storage`. For Azure SQL Database, you'd select `Microsoft.Sql`.
      * **Note**: For Azure Storage, you might see `Microsoft.Storage` (for regional access) and `Microsoft.Storage.Global` (for cross-region access). If you need to access storage accounts in different regions, enable `Microsoft.Storage.Global`.
6.  Click **Save**.
      * **Important**: Enabling a service endpoint can cause a brief network interruption for resources in that subnet as the routing tables are updated. Plan for this during a maintenance window.

#### Azure PowerShell üíª

```powershell
# Define variables
$resourceGroupName = "your-vnet-rg"
$vnetName = "your-vnet"
$subnetName = "your-subnet"
$serviceEndpoint = "Microsoft.Storage" # Or Microsoft.Sql, Microsoft.KeyVault, etc.

# Get the VNet and Subnet
$vnet = Get-AzVirtualNetwork -Name $vnetName -ResourceGroupName $resourceGroupName
$subnet = Get-AzVirtualNetworkSubnetConfig -Name $subnetName -VirtualNetwork $vnet

# Add the service endpoint to the subnet configuration
Set-AzVirtualNetworkSubnetConfig -Name $subnet.Name `
    -VirtualNetwork $vnet `
    -AddressPrefix $subnet.AddressPrefix `
    -ServiceEndpoint $serviceEndpoint

# Update the VNet to apply the subnet configuration change
Set-AzVirtualNetwork -VirtualNetwork $vnet

Write-Host "Service Endpoint '$serviceEndpoint' enabled on subnet '$subnetName'."
```

#### Azure CLI üñ•Ô∏è

```bash
# Define variables
resourceGroupName="your-vnet-rg"
vnetName="your-vnet"
subnetName="your-subnet"
serviceEndpoint="Microsoft.Storage" # Or Microsoft.Sql, Microsoft.KeyVault, etc.

# Enable the service endpoint on the subnet
az network vnet subnet update \
    --resource-group $resourceGroupName \
    --vnet-name $vnetName \
    --name $subnetName \
    --service-endpoints $serviceEndpoint

echo "Service Endpoint '$serviceEndpoint' enabled on subnet '$subnetName'."
```

-----

### Step 2: Configure Network Rules (Firewall) on the Azure PaaS Service

This step restricts access to the PaaS service, ensuring it only accepts connections originating from your VNet's specific subnet(s) that have the service endpoint enabled.

#### Azure Portal üåê

1.  Navigate to your **Azure PaaS resource** (e.g., your Storage Account, SQL Database server) in the Azure portal.
2.  Look for the **Networking** or **Firewalls and virtual networks** blade in the left-hand menu.
3.  For **Public network access** (or similar setting):
      * **Storage Account**: Select "Selected networks" under "Allow access from".
      * **SQL Database Server**: Under "Networking", ensure "Public network access" is set to "Selected networks".
4.  In the **Virtual networks** section:
      * Click **+ Add existing virtual network**.
      * Select your **Subscription**, **Virtual network** (e.g., `vnet-prod`), and the specific **Subnet** (e.g., `snet-webservers`) on which you enabled the service endpoint.
      * Click **Add**.
5.  Optionally, review and configure the "Allow trusted Microsoft services to access this storage account/server" setting. For maximum security, it's often recommended to disable this if you're not using specific Azure services that require this bypass (e.g., Azure Backup, Azure Monitor).
6.  Click **Save** or **Apply** to commit the changes.

#### Azure PowerShell üíª

##### For Azure Storage Account:

```powershell
# Define variables
$storageAccountName = "yourstorageaccountname"
$resourceGroupName = "your-storage-rg"
$vnetName = "your-vnet"
$subnetName = "your-subnet"

# Get the VNet and Subnet ID
$vnet = Get-AzVirtualNetwork -Name $vnetName -ResourceGroupName $resourceGroupName
$subnetId = (Get-AzVirtualNetworkSubnetConfig -Name $subnetName -VirtualNetwork $vnet).Id

# Get the current network rule set for the storage account
$storageAccount = Get-AzStorageAccount -ResourceGroupName $resourceGroupName -Name $storageAccountName
$networkAcl = $storageAccount.NetworkAcl

# Add the VNet rule
$networkAcl.VirtualNetworkRules.Add((New-AzStorageNetworkRule -VirtualNetworkResourceId $subnetId))

# Set the default action to Deny (important for security)
$networkAcl.DefaultAction = "Deny"

# Update the storage account's network rules
Set-AzStorageAccount -ResourceGroupName $resourceGroupName `
    -Name $storageAccountName `
    -NetworkAcl $networkAcl

Write-Host "Storage account '$storageAccountName' network access restricted to subnet '$subnetName'."
```

##### For Azure SQL Database Server:

```powershell
# Define variables
$sqlServerName = "your-sqlserver"
$resourceGroupName = "your-sql-rg"
$vnetName = "your-vnet"
$subnetName = "your-subnet"

# Get the Subnet ID
$subnetId = (Get-AzVirtualNetwork -Name $vnetName -ResourceGroupName $resourceGroupName).Subnets | Where-Object {$_.Name -eq $subnetName} | Select-Object -ExpandProperty Id

# Create a VNet rule for the SQL Server
New-AzSqlServerVirtualNetworkRule -ResourceGroupName $resourceGroupName `
    -ServerName $sqlServerName `
    -VirtualNetworkRuleName "vnet-rule-for-$subnetName" `
    -VirtualNetworkResourceId $subnetId `
    -SubnetName $subnetName

# Recommended: Disable "Allow Azure services and resources to access this server"
Set-AzSqlServer -ResourceGroupName $resourceGroupName -ServerName $sqlServerName -PublicNetworkAccess "Selected"
# Note: In the portal, this usually shows as a checkbox "Allow Azure services and resources to access this server".
# Setting PublicNetworkAccess to "Selected" ensures only VNet rules and IP rules apply.
# You might need to additionally configure firewall rules to deny all other public IPs if "Selected networks" is chosen.

Write-Host "SQL Server '$sqlServerName' network access restricted to subnet '$subnetName'."
```

#### Azure CLI üñ•Ô∏è

##### For Azure Storage Account:

```bash
# Define variables
storageAccountName="yourstorageaccountname"
resourceGroupName="your-storage-rg"
vnetName="your-vnet"
subnetName="your-subnet"

# Add the VNet rule to the storage account
az storage account network-rule add \
    --resource-group $resourceGroupName \
    --account-name $storageAccountName \
    --vnet-name $vnetName \
    --subnet $subnetName

# Set the default action to Deny (important for security)
az storage account update \
    --resource-group $resourceGroupName \
    --name $storageAccountName \
    --default-action Deny

echo "Storage account '$storageAccountName' network access restricted to subnet '$subnetName'."
```

##### For Azure SQL Database Server:

```bash
# Define variables
sqlServerName="your-sqlserver"
resourceGroupName="your-sql-rg"
vnetName="your-vnet"
subnetName="your-subnet"

# Add the VNet rule to the SQL Server
az sql server vnet-rule create \
    --resource-group $resourceGroupName \
    --server $sqlServerName \
    --name "vnet-rule-for-$subnetName" \
    --vnet-name $vnetName \
    --subnet $subnetName

# Recommended: Disable "Allow Azure services and resources to access this server"
az sql server update \
    --resource-group $resourceGroupName \
    --name $sqlServerName \
    --public-network-access "Selected"
# Note: Setting public-network-access to "Selected" ensures only VNet rules and IP rules apply.

echo "SQL Server '$sqlServerName' network access restricted to subnet '$subnetName'."
```

-----

### Step 3: Optional - Enhance Security with Network Security Groups (NSGs) and Service Endpoint Policies

While the above steps lock down the PaaS service, you can further control outbound traffic from your VNet.

  * **Network Security Groups (NSGs)**: You can apply NSG rules to the subnet where the service endpoint is enabled. Use **Service Tags** to allow outbound traffic only to specific Azure services.

      * Example: Allow outbound traffic to `Storage` (or `Storage.RegionName` for granular region control) and `Deny` all other outbound `Internet` traffic. This prevents data exfiltration to other public storage accounts.

    <!-- end list -->

    ```powershell
    # Example NSG rule for outbound traffic to Storage
    $nsg = Get-AzNetworkSecurityGroup -Name "your-nsg" -ResourceGroupName "your-nsg-rg"
    Add-AzNetworkSecurityRuleConfig -NetworkSecurityGroup $nsg `
        -Name "AllowStorageOutbound" `
        -Description "Allow outbound to Azure Storage via Service Endpoint" `
        -Access Allow `
        -Protocol "*" `
        -Direction Outbound `
        -Priority 100 `
        -SourceAddressPrefix "VirtualNetwork" `
        -SourcePortRange "*" `
        -DestinationAddressPrefix "Storage" ` # Use service tag
        -DestinationPortRange "*"

    Add-AzNetworkSecurityRuleConfig -NetworkSecurityGroup $nsg `
        -Name "DenyAllOtherInternetOutbound" `
        -Description "Deny all other outbound internet traffic" `
        -Access Deny `
        -Protocol "*" `
        -Direction Outbound `
        -Priority 200 `
        -SourceAddressPrefix "VirtualNetwork" `
        -SourcePortRange "*" `
        -DestinationAddressPrefix "Internet" ` # Use service tag
        -DestinationPortRange "*"

    Set-AzNetworkSecurityGroup -NetworkSecurityGroup $nsg
    ```

  * **Service Endpoint Policies (for Azure Storage only)**: For Azure Storage, Service Endpoint Policies provide even more granular control. Instead of allowing access to *any* Storage Account in a region (which is the default behavior with a basic Service Endpoint), you can create a policy to permit access to **only specific Storage Accounts** (by their Resource ID). This is crucial for preventing data exfiltration to unauthorized storage accounts.

    1.  **Create Service Endpoint Policy**:
          * Define the allowed Storage Accounts by their Resource ID.
    2.  **Associate Policy with Subnet**:
          * Apply this policy to the subnet where the Service Endpoint for `Microsoft.Storage` is enabled.

    <!-- end list -->

    ```powershell
    # Example Service Endpoint Policy for Storage (PowerShell)
    $policyName = "myStorageEndpointPolicy"
    $policyRg = "rg-vnet-prod"
    $storageAccountId = "/subscriptions/your-sub-id/resourceGroups/your-storage-rg/providers/Microsoft.Storage/storageAccounts/allowedstorageaccount"

    # Create the policy definition
    $policy = New-AzServiceEndpointPolicy -ResourceGroupName $policyRg `
        -Name $policyName `
        -Location "eastus"

    # Add the allowed storage account to the policy
    Add-AzServiceEndpointPolicyDefinition -Name "AllowedStorage" `
        -ServiceEndpointPolicy $policy `
        -Service "Microsoft.Storage" `
        -ServiceResource $storageAccountId

    # Update the policy
    Set-AzServiceEndpointPolicy -ServiceEndpointPolicy $policy

    # Associate the policy to the subnet (assuming vnet and subnet are defined as before)
    $subnet = Get-AzVirtualNetworkSubnetConfig -Name $subnetName -VirtualNetwork $vnet
    $subnet.ServiceEndpointPolicies = @($policy) # Assign the policy object
    Set-AzVirtualNetwork -VirtualNetwork $vnet

    Write-Host "Service Endpoint Policy '$policyName' created and associated with subnet '$subnetName'."
    ```

By following these steps, you can effectively leverage Azure Service Endpoints to secure access to your PaaS resources, ensuring that communication occurs over the private Azure backbone network and is restricted only to your authorized virtual network subnets.