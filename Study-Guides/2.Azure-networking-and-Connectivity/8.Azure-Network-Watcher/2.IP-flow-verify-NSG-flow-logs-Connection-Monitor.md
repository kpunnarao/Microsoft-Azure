# **IP flow verify**, **NSG flow logs**, and **Connection Monitor**:

---

## IP Flow Verify üîç

**IP flow verify** is a Network Watcher capability that allows you to check if a packet is permitted or denied to or from a virtual machine (VM). It's a quick and powerful tool to diagnose Network Security Group (NSG) rule conflicts or misconfigurations.

### How it Works
You specify a source IP, destination IP, destination port, protocol (TCP/UDP), and direction (Inbound/Outbound). Network Watcher then evaluates all applicable NSG rules for the specified VM's network interface (NIC) and/or its subnet. It tells you:

* **Allowed or Denied**: Whether the traffic is allowed or denied.
* **Rule Name**: If denied, it indicates *which specific NSG rule* blocked the traffic. This is incredibly helpful for pinpointing problems.
* **NSG Name**: The name of the NSG where the rule resides.

### Use Case
Imagine your web server VM isn't reachable on port 80. You can use IP flow verify to check `Inbound` traffic to its private IP on port `80` with protocol `TCP`. If it shows "Denied" and points to an NSG rule, you know exactly where to fix it. This is your first stop for "why can't my VM talk to X?" questions.

---

## NSG Flow Logs üìù

**NSG flow logs** record information about IP traffic flowing through an NSG. Unlike IP flow verify, which is a snapshot check, flow logs provide a **historical record** of all network traffic that passed through the NSG, including both allowed and denied traffic.

### How it Works
When enabled on an NSG, flow logs capture metadata about network flows, such as:

* **Source IP and Port**
* **Destination IP and Port**
* **Protocol (TCP/UDP)**
* **Traffic Direction (Inbound/Outbound)**
* **Traffic Status (Allowed or Denied)**
* **Bytes and Packets Transferred**
* **Rule Name**: The NSG rule that was applied to the traffic.

These logs are stored in an Azure Storage account. To make them easily digestible, they are often processed and visualized using tools like **Log Analytics Workspaces** (which can parse the JSON output into queryable tables) or **Traffic Analytics** (a Network Watcher feature built on Log Analytics that provides rich visualizations of network activity).

### Use Cases
* **Security Auditing**: Understanding what traffic is entering/leaving your network.
* **Compliance**: Meeting regulatory requirements for network logging.
* **Troubleshooting Intermittent Issues**: When IP flow verify shows traffic should be allowed, but problems persist. Flow logs help you see if traffic is actually reaching the NSG and what happens to it.
* **Identifying Unauthorized Access Attempts**: Spotting denied connections from suspicious IPs or ports.
* **Network Usage Analysis**: Understanding traffic patterns, top talkers, and application dependencies.

---

## Connection Monitor üì°

**Connection Monitor** (the evolution of the older Connection Troubleshoot) provides **end-to-end connection monitoring** between a source and a destination, proactively identifying network performance and reachability issues. It's a continuous, long-running test rather than a one-time check.

### How it Works
You define a connection test by specifying:

* **Source(s)**: Azure VMs, Azure Virtual Networks, or on-premises machines (with Network Watcher agent).
* **Destination(s)**: Azure public endpoints (web apps, public IPs), Azure private endpoints (VMs, private IPs), or external URLs/IPs.
* **Protocol**: TCP, ICMP, or HTTP.
* **Ports**: For TCP/HTTP.
* **Test Frequency**: How often to run the checks.

Connection Monitor then continuously sends synthetic traffic between the specified source and destination. It gathers metrics like:

* **Packet Loss Percentage**
* **Latency (Round-Trip Time)**
* **Topology**: Shows the network path taken by the packets, including hops through NSGs, load balancers, and gateways.
* **Connectivity Status**: Healthy, Unhealthy, or Unknown, along with the reason for unhealthiness (e.g., NSG block, DNS issue, firewall).
* **Historical Trends**: Visualizes performance over time.

### Use Cases
* **Proactive Monitoring**: Get alerts *before* users report an issue.
* **Hybrid Connectivity**: Monitoring connectivity between your on-premises data centers and Azure.
* **Application Performance Baseline**: Establish a baseline for network performance and detect deviations.
* **Multi-Tier Application Connectivity**: Ensuring seamless communication between different tiers of a distributed application (e.g., web server to database).
* **VPN/ExpressRoute Monitoring**: Verifying the health and performance of your private network connections.

---

In essence:

* **IP Flow Verify** answers: "Is this specific packet allowed or denied RIGHT NOW, and why?"
* **NSG Flow Logs** answer: "What traffic has gone through this NSG, and what happened to it historically?"
* **Connection Monitor** answers: "Is the connection between these two points consistently healthy, what's its performance, and what path does it take?"

Together, these Network Watcher tools provide a comprehensive toolkit for diagnosing, monitoring, and resolving network connectivity challenges in your Azure environment.