# Lab: Implementing Azure Application Gateway (WAF V2) üõ°Ô∏è

This lab guides you through setting up an Azure Application Gateway with the WAF V2 SKU.

This lab will demonstrate how to set up a basic Application Gateway to load balance traffic to two virtual machines running a simple web server (IIS on Windows, or Nginx/Apache on Linux). We'll also briefly touch on the WAF capability by selecting a WAF SKU.

You'll create a virtual network, deploy two backend virtual machines, and configure the Application Gateway to distribute web traffic to these VMs.

## Lab Scenario üåê

We will create two simple web servers (VMs) within a single Azure region and use Application Gateway to load balance incoming HTTP traffic across them. We'll use a public IP for the Application Gateway's frontend.

  * **Resource Group**: `rg-appgateway-lab`
  * **Location**: `East US` (or a region close to you)
  * **Virtual Network**: `vnet-appgw` (Address space: `10.0.0.0/16`)
  * **Application Gateway Subnet**: `subnet-appgw` (`10.0.0.0/24`)
  * **Backend Subnet**: `subnet-backends` (`10.0.1.0/24`)
  * **Backend VMs**: `vm-backend-01`, `vm-backend-02` (Windows Server with IIS or Linux with Nginx)
  * **Application Gateway Name**: `my-app-gateway`
  * **Application Gateway SKU**: `WAF_v2` (for WAF capabilities)
  * **Public IP**: `pip-appgw`

-----

## Part 1: Prerequisites & Initial Setup

Before proceeding, ensure you have:

  * An active Azure Subscription.
  * The Azure CLI or Azure PowerShell installed and configured, or use Azure Cloud Shell.
  * Familiarity with creating Azure Virtual Machines.

### Create the Resource Group and Virtual Network üåê

We need a dedicated resource group and a virtual network with two subnets: one for the Application Gateway and one for the backend VMs.

### Method 1: Azure Portal üåê

1.  **Create Resource Group**:
      * Search for "Resource groups" and click **"+ Create"**.
      * Subscription: Your subscription.
      * Resource Group name: `rg-appgateway-lab`.
      * Region: `East US`.
      * Review + create, then Create.
2.  **Create Virtual Network**:
      * Search for "Virtual networks" and click **"+ Create"**.
      * Basics Tab:
          * Subscription: Your subscription.
          * Resource Group: `rg-appgateway-lab`.
          * Name: `vnet-appgw`.
          * Region: `East US`.
      * IP Addresses Tab:
          * IPv4 address space: `10.0.0.0/16`.
          * Subnets:
              * Delete the default subnet if it exists.
              * Click **"+ Add subnet"**:
                  * Name: `subnet-appgw`, Address range: `10.0.0.0/24`. Add.
              * Click **"+ Add subnet"**:
                  * Name: `subnet-backends`, Address range: `10.0.1.0/24`. Add.
      * Security, Tags, Review + Create: Accept defaults, then Create.

### Method 2: Azure PowerShell üíª

```powershell
# --- Define Variables ---
$resourceGroupName = "rg-appgateway-lab"
$location = "eastus"
$vnetName = "vnet-appgw"
$appGwSubnetName = "subnet-appgw"
$backendSubnetName = "subnet-backends"

# --- Create Resource Group ---
Write-Host "Creating Resource Group: $resourceGroupName..."
New-AzResourceGroup -Name $resourceGroupName -Location $location

# --- Create Virtual Network with Subnets ---
Write-Host "Creating Virtual Network: $vnetName with subnets..."
$appGwSubnet = New-AzVirtualNetworkSubnetConfig -Name $appGwSubnetName -AddressPrefix "10.0.0.0/24"
$backendSubnet = New-AzVirtualNetworkSubnetConfig -Name $backendSubnetName -AddressPrefix "10.0.1.0/24"

New-AzVirtualNetwork -Name $vnetName -ResourceGroupName $resourceGroupName `
    -Location $location -AddressPrefix "10.0.0.0/16" `
    -Subnet $appGwSubnet, $backendSubnet

Write-Host "Virtual Network and subnets created."
```

### Method 3: Azure CLI üñ•Ô∏è

```bash
# --- Define Variables ---
resourceGroupName="rg-appgateway-lab"
location="eastus"
vnetName="vnet-appgw"
appGwSubnetName="subnet-appgw"
backendSubnetName="subnet-backends"

# --- Create Resource Group ---
echo "Creating Resource Group: $resourceGroupName..."
az group create --name $resourceGroupName --location $location

# --- Create Virtual Network with Subnets ---
echo "Creating Virtual Network: $vnetName with subnets..."
az network vnet create \
    --resource-group $resourceGroupName \
    --name $vnetName \
    --address-prefix 10.0.0.0/16 \
    --subnet-name $appGwSubnetName \
    --subnet-prefix 10.0.0.0/24

az network vnet subnet create \
    --resource-group $resourceGroupName \
    --vnet-name $vnetName \
    --name $backendSubnetName \
    --address-prefix 10.0.1.0/24

echo "Virtual Network and subnets created."
```

-----

## Part 2: Create Backend Virtual Machines

We'll create two Windows Server VMs and install IIS (Internet Information Services) on them to act as our simple web servers. For Linux, you could install Nginx or Apache.

### Method 1: Azure Portal üåê

1.  **Create VM 1 (`vm-backend-01`)**:
      * Search for "Virtual machines" and click **"+ Create"** -\> "Azure virtual machine".
      * Basics Tab:
          * Subscription: Your subscription.
          * Resource Group: `rg-appgateway-lab`.
          * Virtual machine name: `vm-backend-01`.
          * Region: `East US`.
          * Image: `Windows Server 2019 Datacenter` (or your preferred Linux distribution).
          * Size: `Standard_B2s` (or a similar small size).
          * Administrator account: Create username/password.
          * Inbound port rules: `None` (Application Gateway will handle inbound).
      * Disks Tab: Accept defaults.
      * Networking Tab:
          * Virtual network: `vnet-appgw`.
          * Subnet: `subnet-backends`.
          * Public IP: `None`.
          * NIC network security group: `Basic`.
          * Delete public IP and inbound ports.
      * Management, Monitoring, Advanced, Tags: Accept defaults.
      * Review + Create, then Create.
2.  **Create VM 2 (`vm-backend-02`)**: Repeat steps for VM 1, but change the Virtual machine name to `vm-backend-02`.
3.  **Install IIS on VMs (for Windows)**:
      * Once both VMs are running, connect to each VM via RDP (you'll need to temporarily allow RDP inbound in their Network Security Group or use Azure Bastion).
      * Open PowerShell as Administrator on each VM.
      * Run: `Install-WindowsFeature -Name Web-Server -IncludeManagementTools`
      * To make it easier to identify, you can modify the default IIS page on each:
          * Navigate to `C:\inetpub\wwwroot`.
          * Edit `iisstart.htm` or create a new `index.html`.
          * For `vm-backend-01`, add `<h1>Hello from VM Backend 01!</h1>`.
          * For `vm-backend-02`, add `<h1>Hello from VM Backend 02!</h1>`.
      * Ensure Firewall on VMs allows inbound for HTTP (Port 80) if you're not seeing traffic. IIS typically configures this.

### Method 2: Azure PowerShell üíª

```powershell
# --- Define VM Variables ---
$vmAdminUsername = "agadmin"
$vmAdminPassword = "YourSecurePassword123!" | ConvertTo-SecureString -AsPlainText -Force

# Get network resources
$vnet = Get-AzVirtualNetwork -Name $vnetName -ResourceGroupName $resourceGroupName
$backendSubnet = Get-AzVirtualNetworkSubnetConfig -Name $backendSubnetName -VirtualNetwork $vnet

# --- Create VM 1 ---
Write-Host "Creating VM: vm-backend-01..."
New-AzVM -ResourceGroupName $resourceGroupName `
    -Name "vm-backend-01" `
    -Location $location `
    -VirtualNetworkName $vnetName `
    -SubnetName $backendSubnetName `
    -Image "Win2019Datacenter" `
    -Size "Standard_B1s" `
    -AuthenticationType Password `
    -Credential (New-Object System.Management.Automation.PSCredential($vmAdminUsername, $vmAdminPassword)) `
    -DisableBootDiagnostics

# --- Create VM 2 ---
Write-Host "Creating VM: vm-backend-02..."
New-AzVM -ResourceGroupName $resourceGroupName `
    -Name "vm-backend-02" `
    -Location $location `
    -VirtualNetworkName $vnetName `
    -SubnetName $backendSubnetName `
    -Image "Win2019Datacenter" `
    -Size "Standard_B1s" `
    -AuthenticationType Password `
    -Credential (New-Object System.Management.Automation.PSCredential($vmAdminUsername, $vmAdminPassword)) `
    -DisableBootDiagnostics

Write-Host "VMs creation initiated. This will take a few minutes."
Write-Host "Remember to connect to VMs and install IIS/Web Server manually."
```

### Method 3: Azure CLI üñ•Ô∏è

```bash
# --- Define VM Variables ---
vmAdminUsername="agadmin"
vmAdminPassword="YourSecurePassword123!"

# --- Create VM 1 ---
echo "Creating VM: vm-backend-01..."
az vm create \
    --resource-group $resourceGroupName \
    --name "vm-backend-01" \
    --location $location \
    --image Win2019Datacenter \
    --vnet-name $vnetName \
    --subnet $backendSubnetName \
    --public-ip-address "" \
    --admin-username $vmAdminUsername \
    --admin-password $vmAdminPassword \
    --size Standard_B1s \
    --no-wait

# --- Create VM 2 ---
echo "Creating VM: vm-backend-02..."
az vm create \
    --resource-group $resourceGroupName \
    --name "vm-backend-02" \
    --location $location \
    --image Win2019Datacenter \
    --vnet-name $vnetName \
    --subnet $backendSubnetName \
    --public-ip-address "" \
    --admin-username $vmAdminUsername \
    --admin-password $vmAdminPassword \
    --size Standard_B1s \
    --no-wait

echo "VMs creation initiated. This will take a few minutes."
echo "You will need to manually install IIS/Web Server and customize index.html on these VMs."
echo "To connect: az vm list-ip-addresses -g $resourceGroupName -n vm-backend-01 --query '[].virtualMachine.network.privateIpAddresses[0]' -o tsv"
```

-----

## Part 3: Create Azure Application Gateway

Now we'll create the Application Gateway with a WAF V2 SKU, a public IP, and configure it to route traffic to our backend VMs.

### Method 1: Azure Portal üåê

1.  Search for "Application Gateways" and click **"+ Create"**.
2.  **Basics Tab**:
      * Subscription: Your subscription.
      * Resource group: `rg-appgateway-lab`.
      * Application gateway name: `my-app-gateway`.
      * Region: `East US`.
      * Tier: Select `WAF V2`.
      * Enable autoscaling: `No` (for this lab).
      * Instance count (Manual): `1` (for this lab).
      * Availability zone: `None` (for this lab, in production, choose zones).
      * HTTP2: `Disabled`.
      * Virtual network: `vnet-appgw`.
      * Subnet: `subnet-appgw` (`10.0.0.0/24`).
3.  **Frontends Tab**:
      * Frontend IP address type: `Public`.
      * Public IP address: Click **"Add new"**.
          * Name: `pip-appgw`.
          * SKU: `Standard`.
          * Availability zone: `No zone`.
          * OK.
4.  **Backends Tab**:
      * Click **"Add a backend pool"**.
          * Name: `my-backend-pool`.
          * Add backend pool without targets: `No`.
          * Target type: `Virtual machine`.
          * Target: Select `vm-backend-01`.
          * Click **"Add"**.
          * Click **"+ Add"** again to add `vm-backend-02`.
          * Target: Select `vm-backend-02`.
          * Click **"Add"**.
          * Click **"Add"** on the "Add a backend pool" pane.
5.  **Configuration Tab**:
      * **Routing rules**: Click **"Add a routing rule"**.
          * Rule name: `rule-http`.
          * **Listener Tab**:
              * Listener name: `listener-http`.
              * Frontend IP: `Public` (This is `pip-appgw`).
              * Protocol: `HTTP`.
              * Port: `80`.
          * **Backend targets Tab**:
              * Target type: `Backend pool`.
              * Backend target: `my-backend-pool`.
              * Backend settings: Click **"Add new"**.
                  * Backend settings name: `settings-http`.
                  * Backend port: `80`.
                  * Backend protocol: `HTTP`.
                  * Use for App Service: `No`.
                  * Cookie-based affinity: `Disabled` (or `Enabled` for sticky sessions).
                  * Health probe: `Yes, create new`.
                      * Health probe name: `probe-http`.
                      * Protocol: `HTTP`.
                      * Host: (Leave default - `127.0.0.1` or the AG's public IP).
                      * Path: `/` (or your specific health check path).
                      * Interval: `30`.
                      * Timeout: `30`.
                      * Unhealthy threshold: `3`.
                      * OK.
                  * Add.
          * Click **"Add"** on the "Add a routing rule" pane.
6.  **Tags Tab**: (Optional) Add any tags.
7.  **Review + create Tab**: Review settings, then **Create**. This deployment can take **15-20 minutes**.

-----

### Method 2: Azure PowerShell üíª

```powershell
# --- Define AG Variables ---
$agName = "my-app-gateway"
$publicIpName = "pip-appgw"
$wafPolicyName = "my-waf-policy"

# --- Get Network Resources ---
$vnet = Get-AzVirtualNetwork -Name $vnetName -ResourceGroupName $resourceGroupName
$appGwSubnet = Get-AzVirtualNetworkSubnetConfig -Name $appGwSubnetName -VirtualNetwork $vnet
$backendSubnet = Get-AzVirtualNetworkSubnetConfig -Name $backendSubnetName -VirtualNetwork $vnet # Used for VMs, but not directly for AG setup here

# --- Create Public IP Address for Application Gateway ---
Write-Host "Creating Public IP for Application Gateway..."
$publicIP = New-AzPublicIpAddress -ResourceGroupName $resourceGroupName `
    -Name $publicIpName `
    -Location $location `
    -AllocationMethod Static `
    -Sku Standard

# --- Create Backend Address Pool ---
Write-Host "Creating Backend Address Pool..."
# Get VMs' private IPs - ensure VMs are running for this to work
$vm1IP = (Get-AzVM -Name "vm-backend-01" -ResourceGroupName $resourceGroupName).NetworkProfile.NetworkInterfaces.IpConfigurations.PrivateIpAddress
$vm2IP = (Get-AzVM -Name "vm-backend-02" -ResourceGroupName $resourceGroupName).NetworkProfile.NetworkInterfaces.IpConfigurations.PrivateIpAddress

$backendPool = New-AzApplicationGatewayBackendAddressPool -Name "my-backend-pool" `
    -BackendIPAddresses $vm1IP, $vm2IP

# --- Create Health Probe ---
Write-Host "Creating Health Probe..."
$healthProbe = New-AzApplicationGatewayProbeConfig -Name "probe-http" `
    -Protocol Http `
    -Host "127.0.0.1" ` # Or use your AG's public IP if using external for probes, but 127.0.0.1 is common for internal
    -Path "/" `
    -Interval 30 `
    -Timeout 30 `
    -UnhealthyThreshold 3

# --- Create Backend HTTP Settings ---
Write-Host "Creating Backend HTTP Settings..."
$backendSetting = New-AzApplicationGatewayBackendHttpSettings -Name "settings-http" `
    -Port 80 `
    -Protocol Http `
    -CookieBasedAffinity Disabled `
    -RequestTimeout 20 `
    -Probe $healthProbe # Link the health probe

# --- Create Frontend IP Configuration ---
Write-Host "Creating Frontend IP Configuration..."
$frontendIPConfig = New-AzApplicationGatewayFrontendIPConfig -Name "frontend-ip-config" `
    -PublicIPAddress $publicIP

# --- Create Frontend Port ---
Write-Host "Creating Frontend Port..."
$frontendPort = New-AzApplicationGatewayFrontendPort -Name "listener-port-80" `
    -Port 80

# --- Create Listener ---
Write-Host "Creating Listener..."
$listener = New-AzApplicationGatewayHttpListener -Name "listener-http" `
    -Protocol Http `
    -FrontendIPConfiguration $frontendIPConfig `
    -FrontendPort $frontendPort

# --- Create WAF Policy (Required for WAF_v2 SKU) ---
Write-Host "Creating WAF Policy..."
$wafPolicy = New-AzApplicationGatewayFirewallPolicy -Name $wafPolicyName `
    -ResourceGroupName $resourceGroupName `
    -Location $location `
    -Mode Prevention # Can be Detection or Prevention

# --- Create Routing Rule ---
Write-Host "Creating Routing Rule..."
$routingRule = New-AzApplicationGatewayRequestRoutingRule -Name "rule-http" `
    -RuleType Basic `
    -HttpListener $listener `
    -BackendAddressPool $backendPool `
    -BackendHttpSettings $backendSetting

# --- Create Application Gateway ---
Write-Host "Creating Application Gateway: $agName (This will take a while)..."
New-AzApplicationGateway -Name $agName `
    -ResourceGroupName $resourceGroupName `
    -Location $location `
    -SkuName WAF_v2 `
    -SkuTier WAF `
    -GatewayIPConfiguration $appGwSubnet `
    -FrontendIPConfiguration $frontendIPConfig `
    -FrontendPort $frontendPort `
    -BackendAddressPool $backendPool `
    -BackendHttpSettingsCollection $backendSetting `
    -HttpListener $listener `
    -RequestRoutingRule $routingRule `
    -ForceFirewallPolicy $wafPolicy.Id # Link the WAF policy

Write-Host "Application Gateway deployment initiated. This can take 15-20 minutes."
```

### Method 3: Azure CLI üñ•Ô∏è

```bash
# --- Define AG Variables ---
agName="my-app-gateway"
publicIpName="pip-appgw"
wafPolicyName="my-waf-policy"

# --- Create Public IP for Application Gateway ---
echo "Creating Public IP for Application Gateway..."
az network public-ip create \
    --resource-group $resourceGroupName \
    --name $publicIpName \
    --allocation-method Static \
    --sku Standard \
    --zone 1 2 3 # Optional: specify zones for resilience

# --- Get VM Private IPs for Backend Pool ---
# Ensure VMs are running before running this
vm1PrivateIp=$(az vm show -d -g $resourceGroupName -n vm-backend-01 --query privateIps -o tsv)
vm2PrivateIp=$(az vm show -d -g $resourceGroupName -n vm-backend-02 --query privateIps -o tsv)

# --- Create WAF Policy (Required for WAF_v2 SKU) ---
echo "Creating WAF Policy..."
az network application-gateway waf-policy create \
    --name $wafPolicyName \
    --resource-group $resourceGroupName \
    --location $location \
    --mode Prevention # Can be Detection or Prevention

# --- Create Application Gateway ---
echo "Creating Application Gateway: $agName (This will take a while)..."
az network application-gateway create \
    --name $agName \
    --location $location \
    --resource-group $resourceGroupName \
    --vnet-name $vnetName \
    --subnet $appGwSubnetName \
    --sku WAF_v2 \
    --public-ip-address $publicIpName \
    --priority 100 \
    --http-settings-port 80 \
    --http-settings-protocol Http \
    --http-settings-cookie-based-affinity Disabled \
    --frontend-port 80 \
    --waf-policy $wafPolicyName \
    --capacity 1 \
    --no-wait # Continue without waiting for deployment to finish

# --- Add Backend Pool Targets (using VM Private IPs) ---
# Note: In CLI, you typically add these after creation or during if using a single-command deploy
echo "Adding Backend Pool targets..."
az network application-gateway backend-pool create \
    --gateway-name $agName \
    --name "my-backend-pool" \
    --resource-group $resourceGroupName

az network application-gateway backend-address-pool add \
    --gateway-name $agName \
    --name "my-backend-pool" \
    --resource-group $resourceGroupName \
    --ip-address $vm1PrivateIp

az network application-gateway backend-address-pool add \
    --gateway-name $agName \
    --name "my-backend-pool" \
    --resource-group $resourceGroupName \
    --ip-address $vm2PrivateIp

# --- Add Health Probe (if not created by default or customized) ---
# For HTTP/HTTPS, a default probe is often created, but custom is better
echo "Creating/Updating Health Probe..."
az network application-gateway probe create \
    --gateway-name $agName \
    --name "probe-http" \
    --protocol Http \
    --host "127.0.0.1" \
    --path "/" \
    --interval 30 \
    --timeout 30 \
    --threshold 3 \
    --resource-group $resourceGroupName

# --- Update Backend HTTP Settings to use the custom probe ---
echo "Updating Backend HTTP Settings to use the probe..."
az network application-gateway http-settings update \
    --gateway-name $agName \
    --name "appGatewayBackendHttpSettings" \
    --resource-group $resourceGroupName \
    --probe "probe-http" # Link the custom probe

echo "Application Gateway creation and configuration initiated. Please wait for deployment to complete."
echo "You can check status with: az network application-gateway show -g $resourceGroupName -n $agName --query provisioningState"
echo "Once deployed, get public IP with: az network public-ip show -g $resourceGroupName -n $publicIpName --query ipAddress -o tsv"
```

-----

## Part 4: Test Application Gateway and WAF

After the Application Gateway deployment completes and the backend VMs are healthy, you can test it.

### 1\. Get Application Gateway Public IP

1.  **Portal**: Navigate to your `my-app-gateway` Application Gateway. On the **Overview** pane, copy the **Frontend public IP address**.
2.  **PowerShell (after deployment)**: `(Get-AzPublicIpAddress -ResourceGroupName $resourceGroupName -Name $publicIpName).IpAddress`
3.  **CLI (after deployment)**: `az network public-ip show -g $resourceGroupName -n $publicIpName --query ipAddress -o tsv`

### 2\. Access the Web Application

1.  Open a web browser and navigate to the **Public IP address** of your Application Gateway.
2.  **Verify Load Balancing**: Refresh the page multiple times. You should see responses alternating between "Hello from VM Backend 01\!" and "Hello from VM Backend 02\!", demonstrating that Application Gateway is load balancing traffic.

### 3\. Test WAF (Optional)

If your WAF policy is in **Prevention mode**, you can try to trigger a common attack to see it blocked.

1.  In your browser, append a simple SQL Injection string to the URL: `http://<your-app-gateway-ip-address>/index.html?id=1'OR'1'='1`
2.  **Expected Outcome**: You should receive a "403 Forbidden" error or an Application Gateway block page, indicating that the WAF detected and blocked the suspicious request.
3.  **Check WAF Logs**: (Advanced) You can configure diagnostic settings for your Application Gateway to send WAF logs to a Log Analytics Workspace. Inspecting these logs would show the blocked request and the WAF rule that triggered it.

-----

## Part 5: Clean Up Resources

To avoid incurring unnecessary costs, delete the resource group created in this lab. This will remove the Application Gateway, VMs, Virtual Network, and Public IP.

### Method 1: Azure Portal üåê

1.  Search for "Resource groups" and select `rg-appgateway-lab`.
2.  Click **"Delete resource group"**.
3.  Type `rg-appgateway-lab` to confirm, then click **"Delete"**.

### Method 2: Azure PowerShell üíª

```powershell
Remove-AzResourceGroup -Name "rg-appgateway-lab" -Force -AsJob
Write-Host "Resource group 'rg-appgateway-lab' deletion initiated."
```

### Method 3: Azure CLI üñ•Ô∏è

```bash
az group delete --name "rg-appgateway-lab" --yes --no-wait
echo "Resource group 'rg-appgateway-lab' deletion initiated."
```