# Lab: Implementing Network Security Groups (NSGs) üõ°Ô∏è

This lab will guide you through creating and configuring a **Network Security Group (NSG)** to control network traffic to a Virtual Machine (VM) within a Virtual Network. 

You'll observe how NSGs act as a firewall at the network interface or subnet level.

## Lab Scenario üè∞

We will create a single web server VM within a Virtual Network and configure an NSG to enforce the following security policy:

  * **Internet to Web Server**: Only allow HTTP (Port 80) and HTTPS (Port 443) from the internet to the Web Server.

  * **Management Access**: Allow RDP (Port 3389) from a specific management IP range (your client public IP) to the VM.

  * **Default Deny**: All other inbound traffic is implicitly denied.

  * **Resource Group**: `rg-nsg-lab`

  * **Location**: `East US` (or a region close to you)

  * **Virtual Network**: `vnet-nsg-test` (`10.0.0.0/16`)

  * **Subnet**: `subnet-web` (`10.0.0.0/24`)

  * **VM**: `vm-web-01` (in `subnet-web`)

  * **Network Security Group**: `nsg-web-policy` (associated with the subnet)

-----

## Part 1: Prerequisites & Initial Setup

Before you begin, ensure you have:

  * An active Azure Subscription.
  * The Azure CLI or Azure PowerShell installed and configured, or use Azure Cloud Shell.
  * **Your Public IP Address**: You'll need this to allow RDP traffic from your machine. You can find it by searching "what is my ip" on Google.

### Create the Resource Group and Virtual Network üåê

### Method 1: Azure Portal üåê

1.  **Create Resource Group**:
      * Search for "Resource groups" and click **"+ Create"**.
      * Subscription: Your subscription.
      * Resource Group name: `rg-nsg-lab`.
      * Region: `East US`.
      * Review + create, then Create.
2.  **Create Virtual Network**:
      * Search for "Virtual networks" and click **"+ Create"**
      * Basics Tab:
          * Subscription: Your subscription.
          * Resource Group: `rg-nsg-lab`.
          * Name: `vnet-nsg-test`.
          * Region: `East US`.
      * IP Addresses Tab:
          * IPv4 address space: `10.0.0.0/16`.
          * Subnets:
              * Delete the default subnet if it exists.
              * Click **"+ Add subnet"**:
                  * Name: `subnet-web`, Address range: `10.0.0.0/24`. Add.
      * Review + Create, then Create.

-----

### Method 2: Azure PowerShell üíª

```powershell
# --- Define Variables ---
$resourceGroupName = "rg-nsg-lab"
$location = "eastus"
$vnetName = "vnet-nsg-test"
$webSubnetName = "subnet-web"

# --- Create Resource Group ---
Write-Host "Creating Resource Group: $resourceGroupName..."
New-AzResourceGroup -Name $resourceGroupName -Location $location

# --- Create Virtual Network with Subnet ---
Write-Host "Creating Virtual Network: $vnetName with subnet..."
$webSubnet = New-AzVirtualNetworkSubnetConfig -Name $webSubnetName -AddressPrefix "10.0.0.0/24"

New-AzVirtualNetwork -Name $vnetName -ResourceGroupName $resourceGroupName `
    -Location $location -AddressPrefix "10.0.0.0/16" `
    -Subnet $webSubnet

Write-Host "Virtual Network and subnet created."
```

-----

### Method 3: Azure CLI üñ•Ô∏è

```bash
# --- Define Variables ---
resourceGroupName="rg-nsg-lab"
location="eastus"
vnetName="vnet-nsg-test"
webSubnetName="subnet-web"

# --- Create Resource Group ---
echo "Creating Resource Group: $resourceGroupName..."
az group create --name $resourceGroupName --location $location

# --- Create Virtual Network with Subnet ---
echo "Creating Virtual Network: $vnetName with subnet..."
az network vnet create \
    --resource-group $resourceGroupName \
    --name $vnetName \
    --address-prefix 10.0.0.0/16 \
    --subnet-name $webSubnetName \
    --subnet-prefix 10.0.0.0/24

echo "Virtual Network and subnet created."
```

-----

## Part 2: Create a Web Server Virtual Machine

We'll create a Windows Server VM and install IIS (Internet Information Services) on it to act as our simple web server.

### Method 1: Azure Portal üåê

1.  Search for "Virtual machines" and click **"+ Create"** -\> "Azure virtual machine".

2.  Basics Tab:

      * Subscription: Your subscription.
      * Resource Group: `rg-nsg-lab`.
      * Virtual machine name: `vm-web-01`.
      * Region: `East US`.
      * Image: `Windows Server 2019 Datacenter`.
      * Size: `Standard_B2s` (or a similar small size).
      * Administrator account: Create username/password.
      * Public inbound ports: `None` (NSG will control this).

3.  Disks Tab: Accept defaults.

4.  Networking Tab:

      * Virtual network: `vnet-nsg-test`.
      * Subnet: `subnet-web`.
      * Public IP: **Create a new one** (e.g., `pip-web-01`).
      * NIC network security group: `None` (we'll associate the NSG to the subnet later).

5.  Management, Monitoring, Advanced, Tags: Accept defaults.

6.  Review + Create, then Create.

7.  **Install IIS on `vm-web-01`**:

      * Once `vm-web-01` is running, connect via RDP (you'll need to temporarily allow RDP inbound via its NIC's NSG or use Azure Bastion for setup, then ensure the RDP rule is removed if publicly exposed only via the NSG configured later).
      * Open PowerShell as Administrator.
      * Run: `Install-WindowsFeature -Name Web-Server -IncludeManagementTools`
      * Navigate to `C:\inetpub\wwwroot`. Edit `iisstart.htm` or create `index.html` with: `<h1>Welcome to the NSG Lab Web Server!</h1>`

-----

### Method 2: Azure PowerShell üíª

```powershell
# --- Define VM Variables ---
$vmAdminUsername = "localadmin"
$vmAdminPassword = "YourSecurePassword123!" | ConvertTo-SecureString -AsPlainText -Force

# Get Subnet
$webSubnet = Get-AzVirtualNetworkSubnetConfig -Name $webSubnetName -VirtualNetworkName $vnetName -ResourceGroupName $resourceGroupName

# --- Create Public IP for Web VM ---
Write-Host "Creating Public IP for Web VM..."
$pipWeb = New-AzPublicIpAddress -ResourceGroupName $resourceGroupName `
    -Name "pip-web-01" `
    -Location $location `
    -AllocationMethod Dynamic # Or Static for production

# --- Create VM 1 (Web Server) ---
Write-Host "Creating VM: vm-web-01..."
$nicWeb = New-AzNetworkInterface -Name "nic-web-01" `
    -ResourceGroupName $resourceGroupName `
    -Location $location `
    -SubnetId $webSubnet.Id `
    -PublicIpAddressId $pipWeb.Id # Public IP for web server access

New-AzVM -ResourceGroupName $resourceGroupName `
    -Name "vm-web-01" `
    -Location $location `
    -Image "Win2019Datacenter" `
    -Size "Standard_B1s" `
    -Credential (New-Object System.Management.Automation.PSCredential($vmAdminUsername, $vmAdminPassword)) `
    -NetworkInterface $nicWeb `
    -DisableBootDiagnostics

Write-Host "VM creation initiated. This will take a few minutes."
Write-Host "Remember to connect to vm-web-01 and install IIS."
```

-----

### Method 3: Azure CLI üñ•Ô∏è

```bash
# --- Define VM Variables ---
vmAdminUsername="localadmin"
vmAdminPassword="YourSecurePassword123!"

# --- Create Public IP for Web VM ---
echo "Creating Public IP for Web VM..."
az network public-ip create \
    --resource-group $resourceGroupName \
    --name "pip-web-01" \
    --location $location \
    --allocation-method Dynamic

# --- Create VM 1 (Web Server) ---
echo "Creating VM: vm-web-01..."
az vm create \
    --resource-group $resourceGroupName \
    --name "vm-web-01" \
    --image Win2019Datacenter \
    --size Standard_B1s \
    --admin-username $vmAdminUsername \
    --admin-password $vmAdminPassword \
    --vnet-name $vnetName \
    --subnet $webSubnetName \
    --public-ip-address "pip-web-01" \
    --no-wait

echo "VM creation initiated. This will take a few minutes."
echo "Remember to install IIS on vm-web-01."
echo "To get public IP for RDP setup on vm-web-01 (temporarily): az network public-ip show -g $resourceGroupName -n pip-web-01 --query ipAddress -o tsv"
```

-----

## Part 3: Create and Configure Network Security Group (NSG)

Now, we'll create the NSG, define the security rules, and then associate this NSG with the `subnet-web`.

### Method 1: Azure Portal üåê

1.  Search for "Network security groups" and click **"+ Create"**.

2.  Basics Tab:

      * Subscription: Your subscription.
      * Resource Group: `rg-nsg-lab`.
      * Name: `nsg-web-policy`.
      * Region: `East US`.
      * Review + create, then Create.

3.  **Associate NSG to Subnet**:

      * Once `nsg-web-policy` is created, navigate to its overview.
      * In the left-hand menu, under **Settings**, click **"Subnets"**.
      * Click **"+ Associate"**.
          * Virtual network: `vnet-nsg-test`.
          * Subnet: Select `subnet-web`. Click OK.

4.  **Configure Inbound Security Rules**:

      * In the `nsg-web-policy` overview, in the left-hand menu, click **"Inbound security rules"**.

      * Click **"+ Add"** for each rule below:

      * **Rule 1: Allow RDP from your Public IP (for management)**

          * Source: `IP Addresses`.
          * Source IP addresses/CIDR ranges: **Your public IP address** (e.g., `X.Y.Z.W/32`).
          * Source port ranges: `*`.
          * Destination: `Any`.
          * Service: `RDP`.
          * Action: `Allow`.
          * Priority: `100`. (Lower number = higher priority)
          * Name: `Allow-RDP-from-MyIP`.
          * Add.

      * **Rule 2: Allow HTTP/HTTPS from Internet**

          * Source: `Service Tag`.
          * Source service tag: `Internet`.
          * Source port ranges: `*`.
          * Destination: `Any`.
          * Service: `Custom`.
          * Destination port ranges: `80,443`.
          * Protocol: `TCP`.
          * Action: `Allow`.
          * Priority: `200`.
          * Name: `Allow-Web-from-Internet`.
          * Add.

      * *Default Deny rules (like `DenyAllInbound`) are already present with higher priority numbers (e.g., 65500), so our custom rules with lower priority numbers will take precedence.*

-----

### Method 2: Azure PowerShell üíª

```powershell
# --- Define NSG Variables ---
$nsgName = "nsg-web-policy"
$myPublicIp = "X.Y.Z.W/32" # REPLACE WITH YOUR PUBLIC IP ADDRESS!

# --- Create NSG ---
Write-Host "Creating Network Security Group: $nsgName..."
New-AzNetworkSecurityGroup -Name $nsgName `
    -ResourceGroupName $resourceGroupName `
    -Location $location

# --- Associate NSG to Subnet ---
Write-Host "Associating NSG to subnet: $webSubnetName..."
$vnet = Get-AzVirtualNetwork -Name $vnetName -ResourceGroupName $resourceGroupName
Set-AzVirtualNetworkSubnetConfig -Name $webSubnetName `
    -VirtualNetwork $vnet `
    -AddressPrefix "10.0.0.0/24" `
    -NetworkSecurityGroup $nsgName # Reference by name as it's in the same RG

$vnet | Set-AzVirtualNetwork # Apply the subnet changes

# --- Add Inbound Security Rules ---
Write-Host "Adding Inbound Security Rules to NSG..."
# Rule 1: Allow RDP from your Public IP
Add-AzNetworkSecurityGroupRuleConfig -Name "Allow-RDP-from-MyIP" `
    -NetworkSecurityGroup $nsgName `
    -Description "Allow RDP from specific management IP" `
    -Access Allow `
    -Protocol Tcp `
    -Direction Inbound `
    -Priority 100 `
    -SourceAddressPrefix $myPublicIp `
    -SourcePortRange "*" `
    -DestinationAddressPrefix "*" `
    -DestinationPortRange "3389"

# Rule 2: Allow HTTP/HTTPS from Internet
Add-AzNetworkSecurityGroupRuleConfig -Name "Allow-Web-from-Internet" `
    -NetworkSecurityGroup $nsgName `
    -Description "Allow HTTP/HTTPS from Internet" `
    -Access Allow `
    -Protocol Tcp `
    -Direction Inbound `
    -Priority 200 `
    -SourceAddressPrefix "Internet" `
    -SourcePortRange "*" `
    -DestinationAddressPrefix "*" `
    -DestinationPortRange "80,443"

# Apply NSG rules (get the NSG and set it back to trigger the update)
Get-AzNetworkSecurityGroup -Name $nsgName -ResourceGroupName $resourceGroupName | Set-AzNetworkSecurityGroup

Write-Host "Network Security Group and rules configured."
```

-----

### Method 3: Azure CLI üñ•Ô∏è

```bash
# --- Define NSG Variables ---
nsgName="nsg-web-policy"
myPublicIp="X.Y.Z.W/32" # REPLACE WITH YOUR PUBLIC IP ADDRESS!

# --- Create NSG ---
echo "Creating Network Security Group: $nsgName..."
az network nsg create \
    --name $nsgName \
    --resource-group $resourceGroupName \
    --location $location

# --- Associate NSG to Subnet ---
echo "Associating NSG to subnet: $webSubnetName..."
az network vnet subnet update \
    --resource-group $resourceGroupName \
    --vnet-name $vnetName \
    --name $webSubnetName \
    --network-security-group $nsgName

# --- Add Inbound Security Rules ---
echo "Adding Inbound Security Rules to NSG..."

# Rule 1: Allow RDP from your Public IP
az network nsg rule create \
    --resource-group $resourceGroupName \
    --nsg-name $nsgName \
    --name "Allow-RDP-from-MyIP" \
    --priority 100 \
    --direction Inbound \
    --source-address-prefixes $myPublicIp \
    --destination-address-prefixes "*" \
    --destination-port-ranges 3389 \
    --protocol Tcp \
    --access Allow \
    --description "Allow RDP from specific management IP"

# Rule 2: Allow HTTP/HTTPS from Internet
az network nsg rule create \
    --resource-group $resourceGroupName \
    --nsg-name $nsgName \
    --name "Allow-Web-from-Internet" \
    --priority 200 \
    --direction Inbound \
    --source-address-prefixes Internet \
    --destination-address-prefixes "*" \
    --destination-port-ranges 80 443 \
    --protocol Tcp \
    --access Allow \
    --description "Allow HTTP/HTTPS from Internet"

echo "Network Security Group and rules configured."
```

-----

## Part 4: Test Connectivity and Security Policy

It might take a few minutes for the NSG rules to propagate after creation/update.

### 1\. Test RDP to `vm-web-01` (from your public IP)

1.  **Get Public IP of `vm-web-01`**:
      * **Portal**: Navigate to `vm-web-01` and copy its Public IP.
      * **PowerShell**: `(Get-AzPublicIpAddress -ResourceGroupName $resourceGroupName -Name "pip-web-01").IpAddress`
      * **CLI**: `az network public-ip show -g $resourceGroupName -n pip-web-01 --query ipAddress -o tsv`
2.  **RDP to `vm-web-01`**: Use an RDP client to connect to the public IP of `vm-web-01`. You should be able to connect successfully due to the `Allow-RDP-from-MyIP` rule.

### 2\. Test Web Server Access (from Internet)

1.  Open a web browser on your local machine.
2.  Navigate to the **Public IP address** of `vm-web-01`.
3.  You should see the "Welcome to the NSG Lab Web Server\!" message. This confirms the `Allow-Web-from-Internet` rule is working.

### 3\. Test Blocked Traffic (from a different IP or port)

1.  If you have access to a device with a **different public IP address** (e.g., a mobile hotspot, a friend's connection), try to RDP to `vm-web-01`'s public IP.
2.  **Expected Outcome**: The connection attempt should fail. This is because your "other" IP is not in the `Allow-RDP-from-MyIP` rule, and the default `DenyAllInbound` rule will block it.
3.  Similarly, try to connect to an arbitrary high port on `vm-web-01`'s public IP (e.g., using `telnet <PublicIP> 8080`). It should fail.

This lab demonstrates how NSGs provide granular control over network traffic to and from your Azure resources, acting as a crucial first line of defense.

-----

## Part 5: Clean Up Resources

To avoid incurring unnecessary costs, delete the resource group created in this lab. This will remove all VMs, NSGs, and the Virtual Network.

### Method 1: Azure Portal üåê

1.  Search for "Resource groups" and select `rg-nsg-lab`.
2.  Click **"Delete resource group"**.
3.  Type `rg-nsg-lab` to confirm, then click **"Delete"**.

-----

### Method 2: Azure PowerShell üíª

```powershell
Remove-AzResourceGroup -Name "rg-nsg-lab" -Force -AsJob
Write-Host "Resource group 'rg-nsg-lab' deletion initiated."
```

-----

### Method 3: Azure CLI üñ•Ô∏è

```bash
az group delete --name "rg-nsg-lab" --yes --no-wait
echo "Resource group 'rg-nsg-lab' deletion initiated."
```

-----

Now, I'll prepare the second document for **Application Security Groups (ASGs)**\!