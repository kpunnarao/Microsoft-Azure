# Troubleshooting Network Connectivity with NSGs üîé

Network Security Groups (NSGs) are powerful, but misconfigured rules are a frequent cause of connectivity problems in Azure. When a resource can't communicate as expected, NSGs should be one of the first places you look. Troubleshooting involves systematically checking the NSG rules applied to both the source and destination of the traffic.

---

## Common Symptoms of NSG-Related Connectivity Issues üõë

You might suspect an NSG issue if you experience any of the following:

* **Cannot RDP/SSH to a VM**: You can't connect to your virtual machine from outside its VNet.
* **Web server inaccessible**: Your website or API hosted on an Azure VM is not reachable from the internet or other parts of your network.
* **Database connectivity fails**: Your application server cannot connect to its database, even if they're in the same VNet.
* **Outbound calls fail**: A VM cannot reach external services (e.g., public APIs, update servers).
* **Load Balancer health probes fail**: The load balancer reports backend instances as unhealthy.
* **Inter-subnet communication blocked**: VMs in one subnet cannot talk to VMs in another subnet, despite being in the same VNet.

---

## The Troubleshooting Methodology: A Systematic Approach üî¨

Effective NSG troubleshooting follows a logical path:

### 1. Identify the Traffic Flow ‚û°Ô∏è‚¨ÖÔ∏è

* **Source IP Address**: Where is the traffic originating from? (e.g., your home public IP, another VM's private IP, an on-premises server's IP).
* **Destination IP Address**: Where is the traffic trying to go? (e.g., your VM's private IP, a public IP assigned to your VM/Load Balancer).
* **Destination Port**: What port is the traffic targeting? (e.g., 3389 for RDP, 22 for SSH, 80 for HTTP, 443 for HTTPS, 1433 for SQL).
* **Protocol**: What protocol is being used? (TCP, UDP, ICMP, Any).
* **Direction**: Is it **inbound** to the target resource or **outbound** from the source resource?

### 2. Locate Applicable NSGs üìç

Remember NSGs can be applied at two levels:

* **Source Side**:
    * The **NIC NSG** attached to the source VM (outbound rules).
    * The **Subnet NSG** of the source VM's subnet (outbound rules).
* **Destination Side**:
    * The **Subnet NSG** of the destination VM's subnet (inbound rules).
    * The **NIC NSG** attached to the destination VM (inbound rules).

You need to consider **all** NSGs that the traffic will traverse and the direction of the traffic relative to each NSG.

### 3. Use NSG Flow Logs and IP Flow Verify (Recommended Tools) üõ†Ô∏è

Azure provides powerful tools specifically for NSG troubleshooting:

#### a. IP Flow Verify (Part of Azure Network Watcher) ‚úÖ

This is your go-to tool for quick checks. IP Flow Verify allows you to simulate a traffic flow and see if it's allowed or denied by NSGs.

1.  In the Azure portal, search for **Network Watcher**.
2.  Under **Network diagnostic tools**, select **IP flow verify**.
3.  **Configure Parameters**:
    * **Subscription**: Select your subscription.
    * **Resource Group**: Select the resource group containing the VM.
    * **Virtual machine**: Select the VM you're troubleshooting (or select a Network interface).
    * **Protocol**: TCP or UDP.
    * **Direction**: Inbound or Outbound (relative to the VM/NIC).
    * **Local IP address**: The VM's private IP.
    * **Local port**: The port the VM is listening on (e.g., 3389, 80).
    * **Remote IP address**: The source IP trying to connect (e.g., your public IP, another VM's IP).
    * **Remote port**: The source port (often ephemeral, so you can use `*` or a common range like 1024-65535, but often specific if it's a known service).
4.  Click **Check**.

**Output**: IP Flow Verify will tell you if the traffic is **Allowed** or **Denied** and, crucially, **which NSG rule** (and whether it's on a NIC or subnet NSG) was responsible for the decision. This pinpoints the exact rule you need to investigate.

#### b. NSG Flow Logs (Part of Azure Network Watcher) üìú

For more in-depth, historical analysis of network traffic that actually hit your NSGs, NSG Flow Logs are invaluable. They record information about IP traffic through an NSG.

1.  **Enable Flow Logs**: You need to enable NSG flow logs for the specific NSG(s) you want to monitor. This sends log data to an Azure Storage account.
    * In Network Watcher, select **NSG flow logs**.
    * Click "+ Create" or configure an existing NSG.
    * Select the NSG, choose a Storage account, set the retention, and enable "Traffic Analytics" if you want advanced visualization.
2.  **Analyze Flow Logs**:
    * You can directly view the raw JSON logs in the Storage account, but this is cumbersome.
    * The best way to analyze is using **Traffic Analytics** (if enabled) in Network Watcher. It provides visualizations of traffic patterns, top talkers, and blocked flows.
    * Alternatively, stream logs to **Azure Log Analytics Workspace** and query them using Kusto Query Language (KQL) for powerful filtering and analysis.

### 4. Review and Adjust NSG Rules ‚úèÔ∏è

Based on the insights from IP Flow Verify or Flow Logs:

* **Locate the blocking rule**: Identify the specific NSG (subnet or NIC) and the rule that denied the traffic (or the lack of an allowing rule).
* **Check priority**: Is your intended "allow" rule at a higher priority (lower number) than a conflicting "deny" rule? Remember the default `DenyAllInbound` and `DenyAllOutbound` rules at priority 65500.
* **Verify parameters**: Double-check the source/destination IPs/ports, protocol, and direction. Even a small typo can block traffic.
* **Service Tags**: Ensure you're using appropriate Service Tags (e.g., `Internet`, `VirtualNetwork`, `AzureLoadBalancer`) where applicable, as they automatically handle IP range updates.
* **Create/Modify rules**: Add a new `Allow` rule with a higher priority, or modify an existing rule, to permit the desired traffic. Remember to only allow what's necessary.
* **Test again**: After making changes, re-test the connectivity.

### 5. Consider Other Network Components üß©

While NSGs are a primary suspect, remember that other Azure networking components can also affect connectivity:

* **Public IP Addresses**: Does the target resource have a public IP if it needs internet access?
* **Load Balancers/Application Gateways**: Are their health probes configured correctly? Are their own rules allowing traffic to backend pools?
* **Firewalls (Azure Firewall, NVA)**: If you have a centralized firewall, its rules will also govern traffic. NSGs are processed *before* a Network Virtual Appliance (NVA) firewall.
* **User Defined Routes (UDRs)**: Are packets being routed away from their intended destination?
* **DNS Resolution**: Can the resource resolve the destination hostname? (Less about NSGs, but critical for overall connectivity).
* **Guest OS Firewall**: Don't forget the operating system's built-in firewall (Windows Firewall, iptables on Linux). Even if Azure NSGs allow traffic, the OS firewall might block it.

---

By systematically following these steps and utilizing Azure's built-in diagnostic tools, you can efficiently identify and resolve network connectivity issues related to Network Security Groups. 

Always start with IP Flow Verify for quick diagnosis, and use Flow Logs for deeper analysis of past traffic patterns.