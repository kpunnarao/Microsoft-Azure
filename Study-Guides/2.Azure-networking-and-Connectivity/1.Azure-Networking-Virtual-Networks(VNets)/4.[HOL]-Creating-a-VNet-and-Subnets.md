# Creating an Azure VNet and Subnets 🛠️

Now that you understand the theoretical concepts of Azure Virtual Networks, IP addressing, subnets, and CIDR notation, let's look at the practical steps to create them in Azure using various methods: the **Azure portal**, **Azure PowerShell**, and **Azure CLI**.

-----

## Prerequisites 🏁

Before you start, you'll need:

  * An **Azure subscription**.
  * Familiarity with the **Azure portal**, **Azure PowerShell**, or **Azure CLI**.
      * For PowerShell: Ensure you have the `Az.Network` module installed and are logged in (`Connect-AzAccount`).
      * For Azure CLI: Ensure you have the Azure CLI installed and are logged in (`az login`).
  * A clear understanding of your **network design**:
      * What **private IP address space** (e.g., `10.0.0.0/16`, `192.168.1.0/24`) do you want for your VNet? Ensure it doesn't overlap with any on-premises networks you might connect to.
      * How many **subnets** do you need?
      * What **IP address range** (CIDR block) will each subnet have? Make sure these subnet ranges are within the VNet's address space and do not overlap with each other.

-----

## Example Scenario: Simple Web Application 🌐➡️🖥️➡️💾

For consistency across all methods, we'll use the following example:

  * **Resource Group Name**: `rg-mywebapp-prod`
  * **VNet Name**: `vnet-mywebapp-prod`
  * **Region**: `eastus`
  * **VNet Address Space**: `10.1.0.0/16`
  * **Subnet 1 (Web Tier)**:
      * **Name**: `snet-web`
      * **Address Range**: `10.1.0.0/24`
  * **Subnet 2 (Application Tier)**:
      * **Name**: `snet-app`
      * **Address Range**: `10.1.1.0/24`
  * **Subnet 3 (Database Tier)**:
      * **Name**: `snet-db`
      * **Address Range**: `10.1.2.0/24`

-----

## Method 1: Azure Portal 🌐

The Azure portal provides a user-friendly graphical interface for creating and managing resources.

### 1\. Create the Virtual Network (VNet)

1.  **Search for "Virtual networks"**: In the Azure portal search bar, type "Virtual networks" and select it.
2.  **Click "Create virtual network"**: On the Virtual networks page, click the "+ Create" button.
3.  **Basics Tab**:
      * **Subscription**: Select your Azure subscription.
      * **Resource group**: Click "Create new" and enter `rg-mywebapp-prod`.
      * **Name**: Enter `vnet-mywebapp-prod`.
      * **Region**: Select `East US`.
4.  **IP Addresses Tab**:
      * By default, Azure suggests an address space. **Review and modify this** to `10.1.0.0/16`.
      * **Delete any default subnet** if it doesn't match your plan by clicking the "..." (ellipsis) next to it and selecting "Delete".

### 2\. Create Subnets within the VNet

Still on the "IP Addresses" tab during VNet creation:

1.  **Click "Add subnet"** for the first subnet:
      * **Subnet name**: Enter `snet-web`.
      * **Subnet address range**: Enter `10.1.0.0/24`.
      * Click "**Add**".
2.  **Repeat "Add subnet"** for the second subnet:
      * **Subnet name**: Enter `snet-app`.
      * **Subnet address range**: Enter `10.1.1.0/24`.
      * Click "**Add**".
3.  **Repeat "Add subnet"** for the third subnet:
      * **Subnet name**: Enter `snet-db`.
      * **Subnet address range**: `10.1.2.0/24`.
      * Click "**Add**".
4.  **Security Tab**: You can leave defaults for now.
5.  **Tags Tab**: (Optional but Recommended) Add tags like `Environment: Production`, `Application: WebApp`.
6.  **Review + create Tab**: Review all your settings.
7.  **Click "Create"**: Azure will deploy your VNet and its defined subnets.

-----

## Method 2: Azure PowerShell 💻

Azure PowerShell allows you to manage Azure resources using cmdlets. You can run these commands in Azure Cloud Shell (PowerShell environment) or a local PowerShell installation with the Azure Az module.

```powershell
# --- 1. Define Variables ---
$resourceGroupName = "rg-mywebapp-prod"
$location = "eastus"
$vnetName = "vnet-mywebapp-prod"
$vnetAddressPrefix = "10.1.0.0/16"

# Define subnet configurations
$subnetWeb = New-AzVirtualNetworkSubnetConfig -Name "snet-web" -AddressPrefix "10.1.0.0/24"
$subnetApp = New-AzVirtualNetworkSubnetConfig -Name "snet-app" -AddressPrefix "10.1.1.0/24"
$subnetDb = New-AzVirtualNetworkSubnetConfig -Name "snet-db" -AddressPrefix "10.1.2.0/24"

# --- 2. Create Resource Group (if it doesn't exist) ---
# This command will create the resource group if it's not already present.
New-AzResourceGroup -Name $resourceGroupName -Location $location

# --- 3. Create Virtual Network with Subnets ---
# The New-AzVirtualNetwork cmdlet creates the VNet and associates the defined subnets.
New-AzVirtualNetwork `
    -Name $vnetName `
    -ResourceGroupName $resourceGroupName `
    -Location $location `
    -AddressPrefix $vnetAddressPrefix `
    -Subnet $subnetWeb, $subnetApp, $subnetDb

Write-Host "VNet '$vnetName' and subnets created successfully in '$resourceGroupName'."

# --- 4. Verification (Optional) ---
# Retrieve the VNet to confirm its creation and subnets
Get-AzVirtualNetwork -Name $vnetName -ResourceGroupName $resourceGroupName | Select-Object -ExpandProperty Subnets
```

**Explanation:**

  * `New-AzVirtualNetworkSubnetConfig`: This cmdlet creates an in-memory representation of a subnet configuration. It doesn't deploy the subnet to Azure immediately.
  * `New-AzVirtualNetwork`: This cmdlet is then used to create the actual Virtual Network and, crucially, accepts an array of the `New-AzVirtualNetworkSubnetConfig` objects via the `-Subnet` parameter to create the subnets simultaneously with the VNet.
  * `New-AzResourceGroup`: Creates a resource group if it doesn't already exist, which is a prerequisite for deploying VNets.

-----

## Method 3: Azure CLI 🖥️

The Azure CLI is a command-line tool that allows you to execute commands against Azure resources. You can run these commands in Azure Cloud Shell (Bash environment) or a local Azure CLI installation.

```bash
# --- 1. Define Variables ---
resourceGroupName="rg-mywebapp-prod"
location="eastus"
vnetName="vnet-mywebapp-prod"
vnetAddressPrefix="10.1.0.0/16"
subnetWebName="snet-web"
subnetWebAppPrefix="10.1.0.0/24"
subnetAppName="snet-app"
subnetAppPrefix="10.1.1.0/24"
subnetDbName="snet-db"
subnetDbPrefix="10.1.2.0/24"

# --- 2. Create Resource Group (if it doesn't exist) ---
# This command will create the resource group if it's not already present.
az group create --name $resourceGroupName --location $location

# --- 3. Create Virtual Network with the first Subnet ---
# The 'az network vnet create' command can create the VNet and one subnet initially.
az network vnet create \
    --resource-group $resourceGroupName \
    --name $vnetName \
    --address-prefix $vnetAddressPrefix \
    --subnet-name $subnetWebName \
    --subnet-prefix $subnetWebAppPrefix \
    --location $location

# --- 4. Add Additional Subnets to the VNet ---
# Use 'az network vnet subnet create' to add more subnets to the existing VNet.
az network vnet subnet create \
    --resource-group $resourceGroupName \
    --vnet-name $vnetName \
    --name $subnetAppName \
    --address-prefix $subnetAppPrefix

az network vnet subnet create \
    --resource-group $resourceGroupName \
    --vnet-name $vnetName \
    --name $subnetDbName \
    --address-prefix $subnetDbPrefix

echo "VNet '$vnetName' and subnets created successfully in '$resourceGroupName'."

# --- 5. Verification (Optional) ---
# List subnets within the VNet to confirm their creation
az network vnet subnet list --resource-group $resourceGroupName --vnet-name $vnetName --output table
```

**Explanation:**

  * `az group create`: Creates a resource group.
  * `az network vnet create`: This command creates the Virtual Network. It can also create one initial subnet directly using `--subnet-name` and `--subnet-prefix`.
  * `az network vnet subnet create`: This command is used to add additional subnets to an *existing* Virtual Network. You reference the VNet by its name and resource group.

-----

## Verification ✅

Regardless of the method you used, you can verify your deployment in the Azure portal:

1.  Navigate to the **Virtual networks** service.
2.  Click on the name of your VNet (`vnet-mywebapp-prod`).
3.  In the VNet's blade, go to **Settings \> Subnets**.
4.  You should see `snet-web`, `snet-app`, and `snet-db` listed with their corresponding address ranges.

-----

## Important Considerations and Best Practices ✨

  * **Idempotency**: When using scripts (PowerShell/CLI), note that running the same creation command multiple times will usually result in an error if the resource already exists. For more robust scripting, consider using logic to check for existence before creating, or use Azure Resource Manager (ARM) templates, which are inherently idempotent.
  * **Permissions**: Ensure the Azure identity (user or service principal) you are using has the necessary permissions (e.g., `Network Contributor` role) to create and manage VNets and subnets.
  * **Connectivity**: After creating your VNet and subnets, remember that simply having them doesn't mean your resources can communicate with the internet or other networks. You'll need to configure Network Security Groups (NSGs), public IP addresses, VPN Gateways, or ExpressRoute as needed for specific connectivity requirements.
  * **Future Growth**: Always over-allocate slightly when defining address spaces. Resizing a VNet's address space or a subnet's address range is a complex operation that often requires downtime or redeployment of resources.

By mastering these different deployment methods, you'll gain flexibility and efficiency in managing your Azure networking infrastructure.