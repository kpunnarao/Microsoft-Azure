# Hybrid Active Directory Migration to Microsoft Entra ID (Azure AD) - Technical Deep Dive

**Version:** 1.1
**Date:** July 28, 2025

---

## 1. Executive Summary

This document provides a detailed, step-by-step technical guide for establishing a hybrid identity solution by synchronizing our on-premises Active Directory Domain Services (AD DS) with Microsoft Entra ID (formerly Azure Active Directory). 

It covers critical planning, installation, configuration, verification, and ongoing management tasks, including specific commands and best practices. 

The goal is to ensure a robust, secure, and seamless identity experience for users accessing both on-premises and cloud resources, maintaining on-premises AD DS as the primary authoritative identity source.

---

## 2. Theoretical Concepts & Technical Deep Dive (Recap & Expansion)

### 2.1. Authentication Methods - Technical Nuances

**Password Hash Synchronization (PHS):**

    * **How it works:** Azure AD Connect takes a hash of the user's password from on-premises AD DS and synchronizes it to Microsoft Entra ID. This is a one-way sync. The actual password plaintext is never sent.

    * **Technical Detail:** Uses an export function in AD Connect to send batches of SHA256 hashes of the user's NTLM hash (not the plaintext password). There are multiple "salt" values used to make rainbow table attacks extremely difficult.

    * **Pros:** Simplest to deploy, highly resilient (Microsoft Entra ID handles authentication directly), supports password writeback, compatible with all Microsoft Entra ID features (MFA, Conditional Access).

    * **Cons:** Hashes of passwords are in the cloud (though highly secured).

    * **Recommendation:** Default and highly recommended for most scenarios.

**Pass-through Authentication (PTA):**

* **How it works:** When a user attempts to log in to Microsoft Entra ID, the request is routed to a Pass-through Authentication Agent running on an on-premises server. This agent then validates the username and password directly against your on-premises AD DS.

* **Technical Detail:** Requires 2-3 agents for high availability. Agents initiate outbound connections over standard ports (443) to Microsoft Entra ID. No inbound ports required. Uses a challenge-response mechanism.

* **Pros:** No password information (even hashes) leaves the on-premises environment.

* **Cons:** Requires additional on-premises servers/agents to maintain. Depends on on-premises connectivity for cloud authentication.

* **Recommendation:** Consider if strict compliance requires no password hashes in the cloud.

**Federation with AD FS (Active Directory Federation Services):**

* **How it works:** Microsoft Entra ID redirects authentication requests to an on-premises AD FS farm. AD FS validates the user against on-premises AD DS and issues a security token to Microsoft Entra ID.

* **Technical Detail:** Complex deployment involving Web Application Proxies (WAP) for external access, load balancing, and dedicated AD FS servers. Requires specific firewall rules.

* **Pros:** Allows for highly customized authentication policies, integration with third-party MFA solutions that AD FS supports.

* **Cons:** Most complex to deploy and maintain, high availability requires multiple servers, additional patching and management overhead.

* **Recommendation:** Only if you have existing AD FS requirements, complex legacy app integrations, or very specific authentication needs not met by PHS/PTA.

### 2.2. Communication & Synchronization Flow (Deeper Dive)

**Azure AD Connect Service Account (ADSync):** This account is created during Azure AD Connect installation and is used to connect to Microsoft Entra ID and the on-premises AD DS. It's critical for its permissions.

* **On-Premises Permissions:** During installation, if you select "Express settings" or specify an "Enterprise Admin" credential, Azure AD Connect configures the necessary permissions. These include `Replicating Directory Changes` and `Replicating Directory Changes All` on the Domain Naming Contexts, and read access on specific attributes. It also gets `Write` permissions for password writeback and device writeback, if enabled.

* **Microsoft Entra ID Permissions:** A Microsoft Entra ID account (often `Sync_[ServerName]_[GUID]@yourtenant.onmicrosoft.com`) is created with specific permissions (e.g., Directory Writers) to provision and update objects in Microsoft Entra ID.

**Synchronization Cycle:**

* **Import:** Azure AD Connect imports changes from on-premises AD DS (delta) and Microsoft Entra ID (delta) into its Connector Spaces.

* **Synchronization:** Rules are applied to combine data from Connector Spaces into the Metaverse (a consolidated view of objects).

* **Export:** Changes from the Metaverse are exported to the respective connected directories (on-premises AD DS for writeback, Microsoft Entra ID for most objects).

* **Schedule:** By default, every 30 minutes. Can be adjusted via PowerShell: `Set-ADSyncScheduler -SyncCycleInterval [TimeSpan]` (e.g., `00:15:00` for 15 minutes).

**Attribute Flow:**

* Azure AD Connect uses a sophisticated rule engine to determine which attributes flow from on-premises AD to Microsoft Entra ID and vice-versa (for writeback features).

* **`ms-DS-ConsistencyGuid` (Source Anchor):** A crucial attribute for linking on-premises objects to Microsoft Entra ID objects. By default, Azure AD Connect uses `mS-DS-ConsistencyGuid` if populated, otherwise `objectGUID`. It's best practice to use `mS-DS-ConsistencyGuid` as the source anchor, as `objectGUID` can change in certain scenarios (e.g., forest migrations). This attribute remains immutable after the initial synchronization.

* **`userPrincipalName` (UPN):** Critical for cloud sign-in. Ensure on-premises UPNs are routable and match verified custom domains in Microsoft Entra ID.

### 2.3. Hybrid Azure AD Join (Technical Detail)

**How it works:** Devices (Windows 10/11, Server 2016+) are joined to on-premises AD DS and registered with Microsoft Entra ID.

**Prerequisites:**

* Azure AD Connect must be configured for device writeback.

* Service Connection Point (SCP) configured in on-premises AD DS for auto-registration.

* Outbound connectivity from devices to Microsoft Entra ID endpoints.

**Group Policy:** GPOs are used to enable device registration for specific OUs.

**Benefits:** Enables SSO to cloud resources, Conditional Access policies based on device state, and provides a Primary Refresh Token (PRT) for seamless access.

---

## 3. Step-by-Step Technical Migration Guide

### Phase 1: Planning and Prerequisites (Technical Focus)

1.  **On-Premises Active Directory Health & Readiness:**
    
    * **Run `DCDiag /c /v /e /q` and `Repadmin /showrepl`:** Address all errors, warnings, and replication issues. Ensure DNS is healthy and all domain controllers are reachable and replicating correctly.
    * **Cleanup Stale Objects:** Identify and remove or disable unused user accounts, computer accounts, and groups.
        * *Tooling:* `dsquery`, `Get-ADUser -Filter {Enabled -eq $false -and LastLogonTimestamp -lt (Get-Date).AddDays(-365)}` (PowerShell for inactive users).
    
    * **Schema Extensions:** Ensure no conflicting schema extensions (rare, but possible).
    
    * **Forest Functional Level:** Windows Server 2003 or later.
2.  **Domain and UPN Preparation:**
    
    * **Add UPN Suffixes:** If your on-premises AD uses a non-routable UPN suffix (e.g., `corp.local`), add your public, routable domain(s) (e.g., `yourcompany.com`) as UPN suffixes.
        * `Active Directory Domains and Trusts` -> Right-click "Active Directory Domains and Trusts" -> `Properties` -> Add your UPN suffixes.
    
    * **Update User UPNs:** Change user UPNs from `user@corp.local` to `user@yourcompany.com` for users who will be synchronized. This is crucial for seamless cloud sign-in.
        * *PowerShell:* `Get-ADUser -Filter * -SearchBase "OU=Users,DC=corp,DC=local" | ForEach-Object { $_.UserPrincipalName = $_.SamAccountName + "@yourcompany.com"; Set-ADUser -Instance $_ }` (Test this on a small OU first!).
    
    * **Verify Custom Domains in Microsoft Entra ID:**
        * Azure Portal -> Microsoft Entra ID -> Custom domain names. Add and verify your public domain(s).

3.  **Network and Firewall Configuration:**
    * **Outbound HTTPS (Port 443):**
        * From Azure AD Connect server to `*.msappproxy.net`, `*.servicebus.windows.net`, `login.microsoftonline.com`, `graph.microsoft.com`, `tenantId.portal.azure.com`, etc. (Refer to Microsoft 365 Common and Office Online URLs and IP address ranges for the complete list).
    * **DNS Resolution:** Ensure the Azure AD Connect server can resolve both on-premises AD DS and Microsoft Entra ID endpoints (public DNS).

4.  **Azure AD Connect Server Provisioning:**
    * **OS:** Windows Server 2016 or later (Standard/Datacenter).
    * **Hardware:** Refer to Microsoft's recommendations. For ~100k objects, 4-6 cores, 16-32GB RAM, 100GB+ disk space is a good starting point.
    * **Networking:** Static IP, domain joined, DNS configured to point to on-premises DNS servers.
    * **Group Policy:** Exclude the Azure AD Connect server from any GPOs that might restrict network connectivity or service startup (e.g., restrictive security baselines without proper exceptions).
    * **Antivirus Exclusions:** Configure AV exclusions for Azure AD Connect installation directory (`C:\Program Files\Microsoft Azure AD Sync`), the ADSync database files, and related processes.

### Phase 2: Azure AD Connect Installation and Configuration (Technical Steps)

1.  **Preparation:**
    * Log in to the Azure AD Connect server with a domain administrator account that has local administrator rights.
    * Disable Internet Explorer Enhanced Security Configuration (IE ESC) if enabled, or add required URLs to trusted sites.

2.  **Download Azure AD Connect:**
    * Go to Azure Portal -> Microsoft Entra ID -> Azure AD Connect. Download the latest version.

3.  **Installation (Custom Path - Highly Recommended):**
    * Run `AzureADConnect.msi`.
    * **"Welcome"** -> Accept license terms.
    * **"Express Settings" vs. "Customize":** Choose **"Customize"**. This is essential for fine-grained control for your scenario.
    * **"Install required components":**
        * **SQL Server:** Choose "Use an existing SQL Server" if you have a dedicated SQL instance (recommended for large environments or HA). Otherwise, "Use a local database (SQL Server Express)" will be installed (default, max 10 GB DB size).
        * **Custom Installation location:** `D:\Program Files\Microsoft Azure AD Sync` (or similar non-OS drive).
    * **"User sign-in":** Select your desired method:
        * **Password Hash Synchronization (PHS):** Select this if PHS is your choice. You'll need to enable "Enable password writeback" later if required.
        * **Pass-through authentication (PTA):** Select this. You will be prompted to install agents later.
        * **(Do NOT select AD FS unless you have a strong, existing reason for it).**
    * **"Connect to Azure AD":** Enter your Microsoft Entra ID Global Administrator credentials.
    * **"Connect your directories":**
        * Click "Add Directory" for your on-premises forest.
        * Select "Create new AD account" (recommended) and provide an Enterprise Admin credential for the installer to create the ADSync service account with necessary permissions. Or, provide pre-created credentials.
        * Click "Add Directory" for any other forests if applicable.
    * **"Azure AD sign-in configuration":** Review the UPN options. Ensure your chosen UPN suffix (e.g., `@yourcompany.com`) is selected for user login. If UPNs are not routable on-premises, select the `mail` attribute as the `User Principal Name` or ensure on-premises UPNs are corrected *before* this step.
    * **"Domain and OU filtering":** This is where you limit synchronization scope.
        * **Crucial Step:** Deselect the "Sync all domains and OUs" checkbox.
        * **Select specific OUs:** Navigate through your AD tree and *only* select the OUs that contain users, groups, and devices you intend to synchronize. This avoids syncing unnecessary objects (e.g., legacy accounts, specific service accounts, test OUs).
    * **"Uniquely identifying your users":** Default settings are usually fine.
    * **"Filter users and devices":** You can select "Synchronize only selected users and devices" here if you've already defined groups for filtering.
    * **"Optional features":** Select:
        * **Password writeback:** If you want users to be able to reset their Microsoft Entra ID password and have it written back to on-premises AD. (Requires Microsoft Entra ID P1/P2).
        * **Device writeback:** (Required for Hybrid Azure AD Join).
        * **Group writeback:** If needed for Microsoft 365 groups.
        * **Directory extension attribute sync:** If you need to sync custom schema attributes.
    * **"Ready to configure":**
        * **Highly Recommended:** Check "Enable staging mode." This allows you to perform a full sync and review results without exporting changes to Microsoft Entra ID. You will disable this later.
        * **If using PTA:** You'll be prompted to install Pass-through Authentication agents. Install at least two agents on separate servers for redundancy.
        * Click **"Install"**.

4.  **Initial Synchronization (in Staging Mode):**
    * Once installation is complete, Azure AD Connect will perform an initial full synchronization.
    * **Monitor progress:** Open `Synchronization Service Manager` (from Start Menu). Go to the "Operations" tab. Observe the "Full Import (Full)" and "Full Synchronization (Full)" steps for your AD Connector. This will populate the Metaverse.
    * **Review Export:** Crucially, check the "Export (Pending Export)" tab for your Azure AD Connector. In staging mode, it will show objects that *would* be exported, but aren't yet. Review these objects for any unexpected creations, deletions, or attribute flows. If issues are found, troubleshoot and re-run syncs.

### Phase 3: Verification and Testing (Technical Details)

1.  **Verification using Synchronization Service Manager:**
    * **Connector Space Object Viewer:** Select your AD Connector, go to "Search Connector Space," and view properties of individual objects to see how attributes are flowing.
    * **Metaverse Search:** Search for objects in the Metaverse to see their combined attributes from all connected directories. This is key for troubleshooting attribute flow.
    * **Synchronization Rules Editor:** (Advanced) Used to inspect default rules and create/modify custom rules if needed (e.g., for specific attribute transformations or filtering).

2.  **Verify Object Status in Microsoft Entra ID:**
    * **Azure Portal:** Go to Microsoft Entra ID -> Users. Filter by "Sync status" = "Synced from on-premises."
    * **PowerShell:** `Get-MsolUser -SynchronizedFromDirectory $true | Select-Object UserPrincipalName,DisplayName,@{N='SourceAnchor';E={$_.ImmutableId}}`
    * Verify `ImmutableId` (Source Anchor) is populated for synced users.
    * Verify `DirSyncEnabled` is `True` for synced users and groups.

3.  **Test Authentication:**
    * **Test User Accounts:** Use a few distinct test user accounts from different OUs (synced) for testing.
    * **Cloud Sign-in:** Attempt to sign in to:
        * `portal.office.com`
        * `portal.azure.com`
        * `outlook.office.com`
    * Verify SSO experience.

4.  **Test Password Writeback (if enabled):**
    * Ensure Microsoft Entra ID P1/P2 licenses are assigned to the test user.
    * Have the test user go to `myaccount.microsoft.com` or `aka.ms/sspr` and attempt a password reset.
    * Verify the password change is reflected in on-premises AD DS (e.g., by attempting to log in to an on-premises resource with the new password, or checking `pwdLastSet` attribute on the user object).
    * *Troubleshooting:* Check event logs on the Azure AD Connect server (Event Viewer -> Applications and Services Logs -> Directory Synchronization).

5.  **Test Hybrid Azure AD Join (if enabled):**
    * **Configure SCP:** Azure AD Connect automatically configures the Service Connection Point (SCP) in on-premises AD for auto-registration. Verify its presence using ADSI Edit:
        * Connect to `Configuration` naming context.
        * Navigate to `CN=Configuration,DC=<yourdomain>,DC=<com>` -> `CN=Services` -> `CN=Device Registration Configuration` -> `CN=<GUID>`. Look for `azureADCPublishedObject`.
    * **GPO for Device Registration:** Create a GPO linked to an OU containing test devices:
        * `Computer Configuration\Policies\Administrative Templates\Windows Components\Device Registration\Register domain joined computers as devices`. Enable this policy.
    * **Verify on Devices:**
        * Run `dsregcmd /status` in a command prompt. Look for `AzureAdJoined : YES` and `DomainJoined : YES`. Also, verify `TenantId` and `DeviceId`.
        * Check Event Viewer on the device (Applications and Services Logs -> Microsoft-Windows-User Device Registration -> Admin).
    * **Verify in Microsoft Entra ID:** Go to Microsoft Entra ID -> Devices. Look for the Hybrid Azure AD Joined status.

6.  **Test MFA (if configured via Conditional Access):**

    * Create a Conditional Access policy in Microsoft Entra ID that requires MFA for a test cloud application for a specific test group.
    * Add the test user to this group.
    * Have the test user attempt to access the application. They should be prompted for MFA registration and then subsequent MFA challenges.

### Phase 4: Post-Migration and Ongoing Management (Technical Operations)

1.  **Decommission Staging Mode:**
    * Once all testing is successful and you are ready to go live:
        * On the Azure AD Connect server, open PowerShell as Administrator.
        * `Set-ADSyncScheduler -StagingMode $false`
        * This will immediately kick off an export cycle, pushing all pending changes to Microsoft Entra ID.
2.  **Implement Monitoring:**
    * **Azure AD Connect Health:** Regularly check `portal.azure.com -> Microsoft Entra ID -> Azure AD Connect -> Azure AD Connect Health`. Configure email notifications for service health alerts, synchronization errors, and agent downtime.
    * **Event Logs:** Monitor `Application` and `Directory Synchronization` event logs on the Azure AD Connect server for errors (Event IDs 6900-6999 for sync, 9000-9999 for password writeback, etc.).
    * **PowerShell Monitoring:**
        * `Get-ADSyncScheduler`: Check sync status and last run.
        * `Get-ADSyncConnector | Get-ADSyncConnectorStatistics -Connector "Your AD Connector Name"`: Get detailed sync statistics.
3.  **Azure AD Connect Updates:**
    * Enable automatic upgrades if suitable for your environment (`Set-ADSyncScheduler -AutomaticUpgradeEnabled $true`).
    * Otherwise, regularly check for and manually install updates. Always review release notes.
4.  **Service Account Password Management:**
    * Do NOT manually change the passwords for the ADSync service accounts (both on-premises and Microsoft Entra ID) unless specifically following a documented process. Azure AD Connect manages these securely.
5.  **Disaster Recovery for Azure AD Connect:**
    * **Backup:** Regularly back up the Azure AD Connect server (VM snapshots, or traditional backup software). The ADSync database is critical.
    * **Secondary Staging Server:** Strongly consider deploying a second Azure AD Connect server in staging mode. In a disaster, you can quickly switch this server to active mode.
        * Install AADC on Server B in staging mode. Ensure it's identical in config (OUs, features) to Server A.
        * If Server A fails: `Set-ADSyncScheduler -StagingMode $false` on Server B, `Set-ADSyncScheduler -StagingMode $true` on Server A (if recoverable) or decommission Server A.
    * **Document Recovery Steps:** Create a clear runbook for recovering Azure AD Connect in various failure scenarios.
6.  **Attribute Management & Custom Rules (Advanced):**
    * If you need to synchronize custom attributes or apply complex transformations, use the "Synchronization Rules Editor."
    * **Best Practice:** Avoid modifying default synchronization rules directly. Instead, create new *precedence* rules (higher precedence) to override default behavior.
7.  **Decommission Old Identity Infrastructure (Post-Migration):**
    * Gradually phase out any legacy identity management tools or processes that are now handled by Azure AD Connect.
    * Once confident, remove the old UPN suffix from on-premises AD, ensuring all users are on the routable UPN.

---

## 5. Licensing Considerations (Technical Impact)

* **Microsoft Entra ID Free:** Supports PHS and PTA, basic sync.
* **Microsoft Entra ID P1/P2 (or Microsoft 365 E3/E5):**
    * **Password Writeback:** Requires P1/P2 licenses for users who utilize Self-Service Password Reset.
    * **Conditional Access:** Essential for fine-grained control over MFA, device compliance, etc. Requires P1/P2.
    * **Group Writeback:** Requires P1/P2.
    * **Microsoft Entra ID Protection:** Advanced risk-based authentication and reporting. Requires P2.
    * **Device Writeback (Hybrid Azure AD Join):** The feature itself is free, but P1/P2 licenses are needed for Conditional Access policies applied to these devices.

Ensure licensing covers all planned features for all users who will benefit from them.

---

## 6. Security Considerations (Technical Implementation)

* **Least Privilege for Service Accounts:** After initial setup, if Enterprise Admin was used, review and downgrade the permissions for the ADSync service account to the minimum required (Replicating Directory Changes, Read All Properties, etc.). Microsoft documentation provides a script for this.

* **Secure Azure AD Connect Server:**
    * Dedicated VM, no other roles.
    * Strong local administrator passwords.
    * Regularly patched.
    * Strict network segmentation and firewall rules (only necessary outbound ports).
    * Enable Windows Firewall.
    * Implement an Endpoint Detection and Response (EDR) solution.
    * Restrict interactive logins to only necessary administrators.

* **Multi-Factor Authentication (MFA):**
    * **Enforce for Global Admins:** Immediately enable MFA for *all* Microsoft Entra ID Global Administrator accounts.
    * **Conditional Access Policies:** Implement policies to require MFA for:
        * Access to administrative portals (Azure, M365 Admin Centers).
        * Access from untrusted locations.
        * Access to sensitive cloud applications.
        * Users who exhibit high sign-in risk.

* **Monitor for Compromise:** Integrate Microsoft Entra ID logs with your SIEM solution. Monitor for:
    * Suspicious sign-ins (impossible travel, unfamiliar locations).
    * Brute-force attacks.
    * Password spray attacks.
    * Changes to synchronization settings.
    * Excessive object deletions.

---

## 7. Contingency and Rollback Plan (Technical Specifics)

* **Pre-Migration Snapshots/Backups:** Take VM snapshots of all domain controllers and the Azure AD Connect server *before* starting the installation. Perform full AD backups (e.g., Windows Server Backup for System State).
* **Azure AD Connect Staging Mode:** This is your primary safeguard. Thoroughly review "pending exports" before taking it out of staging.
* **Disabling Synchronization:**
    * **Temporarily:** `Set-ADSyncScheduler -SyncCycleEnabled $false` (on the Azure AD Connect server).
    * **Fully Decommission:** Uninstall Azure AD Connect from the server. Then, from PowerShell in Microsoft Entra ID, remove the `MSOL_AD_Sync` service principal (though not strictly necessary, it cleans up).
* **Reverting UPN Changes (if necessary):** If UPN changes were made on-premises and caused issues, you would need to revert them using PowerShell commands similar to the ones used to change them.
* **Object Deletion Threshold:** Azure AD Connect has a default deletion threshold (500 objects). If a sync run would delete more than this number of objects, the sync pauses and requires manual approval. This prevents accidental mass deletions in Microsoft Entra ID.
    * `Get-ADSyncGlobalSetting` to see current threshold.
    * `Set-ADSyncGlobalSetting -SynchronizationSchedulerObjectReplicationCriticalThreshold [new value]`

## 8. Project Timeline & Key Milestones (Technical View)

| Phase                          | Key Technical Milestones                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| :----------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **1. Planning & Prerequisites** | AD DS health checks completed (`DCDiag`, `Repadmin` clean), DNS validated, UPN strategy defined, routable UPN suffixes added to AD DS, pilot users' UPNs updated, custom domains verified in Microsoft Entra ID, Azure AD Connect server provisioned & hardened, firewall rules documented & implemented, necessary service accounts identified/created. |
| **2. Installation & Config** | Azure AD Connect MSI installed (Custom Path), AADC connected to Microsoft Entra ID & on-premises AD, correct OUs selected for sync, authentication method (PHS/PTA) configured, optional features enabled (e.g., password writeback, device writeback), initial full synchronization completed in **staging mode**.                                                                                                                                                                                                                                                                                                                                                                                                             |
| **3. Verification & Testing** | `Synchronization Service Manager` reviewed (no pending errors/large deletions in staging export), specific test users/groups verified in Microsoft Entra ID, successful cloud login for pilot users, password writeback tested & confirmed, Hybrid Azure AD Join verification (`dsregcmd /status`, Azure Portal), MFA enforcement verified via Conditional Access for pilot users, all major applications tested with hybrid identity.                                                                                                                                                                                                                                                                              |
| **4. Post-Migration & Ops** | Staging mode disabled, Azure AD Connect Health configured for alerts, regular maintenance procedures established (updates, backups), secondary AADC server deployed in staging mode (HA/DR), comprehensive monitoring of sync health and security logs.                                                                                                                                                                                                                 
---
